# E2E Testing Makefile for Monstera Backend
# çµŒè²»ç”³è«‹ã‚·ã‚¹ãƒ†ãƒ ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨Makefile

.PHONY: help test-e2e test-e2e-api test-e2e-integration test-e2e-http test-e2e-full test-e2e-ci setup-e2e-env cleanup-e2e-env

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "Monstera Backend E2E Test Commands"
	@echo "=================================="
	@echo ""
	@echo "åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make test-e2e              - å…¨ã¦ã®E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make test-e2e-api          - API E2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-e2e-integration  - çµ±åˆE2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-e2e-http         - HTTP E2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-e2e-full         - å®Œå…¨ãªE2Eãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ"
	@echo ""
	@echo "ç’°å¢ƒç®¡ç†:"
	@echo "  make setup-e2e-env         - E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@echo "  make cleanup-e2e-env       - E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo ""
	@echo "CI/CD:"
	@echo "  make test-e2e-ci           - CIç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo ""
	@echo "ãƒ¬ãƒãƒ¼ãƒˆ:"
	@echo "  make test-e2e-report       - E2Eãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°:"
	@echo "  E2E_DATABASE_URL           - ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URL"
	@echo "  E2E_CLEANUP_AFTER_TEST     - ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (true/false)"
	@echo "  E2E_LOG_LEVEL             - ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« (debug/info/warn/error)"
	@echo "  RUN_E2E_TESTS             - E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ•ãƒ©ã‚° (CIç’°å¢ƒç”¨)"

# å¤‰æ•°å®šç¾©
GO_CMD = go
TEST_DIR = .
TEST_TIMEOUT = 30m
TEST_PARALLEL = 4
COVERAGE_FILE = coverage_e2e.out
REPORT_DIR = reports
LOG_DIR = logs

# E2E ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°
export E2E_DATABASE_URL ?= mysql://root:password@localhost:3306/monstera_e2e_test
export E2E_LOG_LEVEL ?= info
export E2E_CLEANUP_AFTER_TEST ?= true
export E2E_REQUEST_TIMEOUT ?= 30s
export E2E_MAX_CONCURRENT_REQUESTS ?= 10
export E2E_PERFORMANCE_THRESHOLD ?= 2s

# å…¨ã¦ã®E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test-e2e: setup-e2e-env
	@echo "ğŸš€ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) -parallel $(TEST_PARALLEL) \
		-run "TestExpense.*E2E" \
		-coverprofile=$(COVERAGE_FILE) \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_test.log
	@echo "âœ… E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# API E2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
test-e2e-api: setup-e2e-env
	@echo "ğŸ”— API E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run "TestExpenseAPIE2EComprehensive" \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_api_test.log
	@echo "âœ… API E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# çµ±åˆE2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
test-e2e-integration: setup-e2e-env
	@echo "ğŸ”„ çµ±åˆE2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run "TestExpenseIntegrationE2E" \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_integration_test.log
	@echo "âœ… çµ±åˆE2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# HTTP E2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
test-e2e-http: setup-e2e-env
	@echo "ğŸŒ HTTP E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run "TestExpenseHTTPE2EFlow" \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_http_test.log
	@echo "âœ… HTTP E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# å®Œå…¨ãªE2Eãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
test-e2e-full: setup-e2e-env
	@echo "ğŸ¯ å®Œå…¨E2Eãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout 60m -parallel $(TEST_PARALLEL) \
		-run "TestExpense.*E2E.*" \
		-coverprofile=$(COVERAGE_FILE) \
		-benchmem -bench=. \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_full_test.log
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."
	$(GO_CMD) tool cover -html=$(COVERAGE_FILE) -o $(REPORT_DIR)/e2e_coverage.html
	@echo "âœ… å®Œå…¨E2Eãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œå®Œäº†"

# CIç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test-e2e-ci:
	@echo "ğŸ¤– CIç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@export CI=true
	@export RUN_E2E_TESTS=true
	@export E2E_CLEANUP_AFTER_TEST=true
	@export E2E_LOG_LEVEL=error
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) -parallel 1 \
		-run "TestExpense.*E2E" \
		-coverprofile=$(COVERAGE_FILE) \
		-json \
		$(TEST_DIR) > $(REPORT_DIR)/e2e_test_results.json 2>&1
	@echo "ğŸ“‹ CIç”¨ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"

# E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup-e2e-env:
	@echo "ğŸ”§ E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹..."
	@echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª: $(E2E_DATABASE_URL)"
	@# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å­˜åœ¨ç¢ºèªï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯é©åˆ‡ãªDBæ¥ç¶šç¢ºèªã‚’å®Ÿè£…ï¼‰
	@echo "âœ… E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

# E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleanup-e2e-env:
	@echo "ğŸ§¹ E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹..."
	@# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@rm -f $(COVERAGE_FILE)
	@echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: $(LOG_DIR)/*.log"
	@echo "ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: $(REPORT_DIR)/*"
	@echo "âœ… E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# E2Eãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
test-e2e-report: 
	@echo "ğŸ“Š E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹..."
	@mkdir -p $(REPORT_DIR)
	@if [ -f $(COVERAGE_FILE) ]; then \
		echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ..."; \
		$(GO_CMD) tool cover -html=$(COVERAGE_FILE) -o $(REPORT_DIR)/e2e_coverage.html; \
		$(GO_CMD) tool cover -func=$(COVERAGE_FILE) > $(REPORT_DIR)/e2e_coverage.txt; \
	fi
	@if [ -f $(LOG_DIR)/e2e_test.log ]; then \
		echo "ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆ..."; \
		grep -E "(PASS|FAIL|RUN)" $(LOG_DIR)/e2e_test.log > $(REPORT_DIR)/e2e_test_summary.txt || true; \
	fi
	@echo "ğŸ“‹ E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
	@echo "ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:"
	@ls -la $(REPORT_DIR)/

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿å®Ÿè¡Œ
test-e2e-specific:
	@if [ -z "$(TEST_NAME)" ]; then \
		echo "âŒ TEST_NAMEå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä¾‹: make test-e2e-specific TEST_NAME=TestExpenseAPIE2E"; \
		exit 1; \
	fi
	@echo "ğŸ¯ ç‰¹å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: $(TEST_NAME)"
	@mkdir -p $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run "$(TEST_NAME)" \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_specific_test.log

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
test-e2e-performance: setup-e2e-env
	@echo "âš¡ E2Eãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@export E2E_MAX_CONCURRENT_REQUESTS=50
	@export E2E_PERFORMANCE_THRESHOLD=1s
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run ".*Performance.*" \
		-bench=. -benchmem \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_performance_test.log
	@echo "âœ… E2Eãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
test-e2e-security: setup-e2e-env
	@echo "ğŸ›¡ï¸ E2Eã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
	@mkdir -p $(REPORT_DIR) $(LOG_DIR)
	$(GO_CMD) test -v -timeout $(TEST_TIMEOUT) \
		-run ".*Security.*" \
		$(TEST_DIR) 2>&1 | tee $(LOG_DIR)/e2e_security_test.log
	@echo "âœ… E2Eã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
generate-e2e-testdata:
	@echo "ğŸ“ E2Eãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–‹å§‹..."
	@$(GO_CMD) run scripts/generate_e2e_testdata.go
	@echo "âœ… E2Eãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†"

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
health-check:
	@echo "ğŸ’“ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯..."
	@echo "Go version: $(shell $(GO_CMD) version)"
	@echo "Database URL: $(E2E_DATABASE_URL)"
	@echo "Log Level: $(E2E_LOG_LEVEL)"
	@echo "Test Timeout: $(TEST_TIMEOUT)"
	@echo "Max Parallel: $(TEST_PARALLEL)"
	@echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"

# é–‹ç™ºè€…å‘ã‘ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
dev-test: setup-e2e-env
	@echo "ğŸ‘¨â€ğŸ’» é–‹ç™ºè€…å‘ã‘ã‚¯ã‚¤ãƒƒã‚¯E2Eãƒ†ã‚¹ãƒˆ..."
	@export E2E_LOG_LEVEL=debug
	@export E2E_CLEANUP_AFTER_TEST=false
	$(GO_CMD) test -v -timeout 10m \
		-run "TestExpenseAPIE2EComprehensive" \
		$(TEST_DIR)

# ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ & ãƒ†ã‚¹ãƒˆ
clean-test: cleanup-e2e-env
	@echo "ğŸ”„ ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ & E2Eãƒ†ã‚¹ãƒˆ..."
	@$(GO_CMD) clean -testcache
	@make test-e2e

# ç¶™ç¶šçš„ç›£è¦–ãƒ†ã‚¹ãƒˆ
watch-test:
	@echo "ğŸ‘€ E2Eãƒ†ã‚¹ãƒˆç¶™ç¶šç›£è¦–ãƒ¢ãƒ¼ãƒ‰..."
	@which fswatch >/dev/null || (echo "fswatch ãŒå¿…è¦ã§ã™: brew install fswatch"; exit 1)
	@fswatch -o . | while read num; do \
		echo "å¤‰æ›´æ¤œçŸ¥ - E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."; \
		make test-e2e-api; \
	done

# Dockerç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test-e2e-docker:
	@echo "ğŸ³ Dockerç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆ..."
	@docker-compose -f docker-compose.e2e.yml up -d
	@sleep 10  # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿ
	@export E2E_DATABASE_URL=mysql://root:password@localhost:3307/monstera_e2e_test
	@make test-e2e
	@docker-compose -f docker-compose.e2e.yml down

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install-deps:
	@echo "ğŸ“¦ E2Eãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
	@$(GO_CMD) mod download
	@$(GO_CMD) mod tidy
	@echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"