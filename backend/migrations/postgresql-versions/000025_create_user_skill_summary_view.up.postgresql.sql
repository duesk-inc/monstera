-- user_skill_summaryビューの作成（シンプル版） -- 重複期間の厳密な除外は行わず、プロジェクト数と最長期間で近似値を計算 CREATE OR REPLACE VIEW user_skill_summary AS SELECT wh.user_id, wht.technology_name, tc.name as category_name, tc.display_name as category_display_name, -- 技術を使用したプロジェクトの総期間（重複あり） SUM(COALESCE(wh.duration_months, TIMESTAMPDIFF(MONTH, wh.start_date, COALESCE(wh.end_date, CURRENT_DATE())) )) as total_project_months, -- 実際の経験期間の近似値（最初から最後までの期間） TIMESTAMPDIFF(MONTH, MIN(wh.start_date), MAX(COALESCE(wh.end_date, CURRENT_DATE())) ) as total_experience_months, -- 年数と月数に分解 FLOOR(TIMESTAMPDIFF(MONTH, MIN(wh.start_date), MAX(COALESCE(wh.end_date, CURRENT_DATE())) ) / 12) as experience_years, TIMESTAMPDIFF(MONTH, MIN(wh.start_date), MAX(COALESCE(wh.end_date, CURRENT_DATE())) ) % 12 as experience_months, -- プロジェクト数 COUNT(DISTINCT wh.id) as project_count, -- 最初と最後の使用日 MIN(wh.start_date) as first_used_date, MAX(COALESCE(wh.end_date, CURRENT_DATE())) as last_used_date, -- 技術マスタから追加情報 COALESCE(tm.display_name, wht.technology_name) as technology_display_name, tm.usage_count as global_usage_count, COALESCE(tm.sort_order, 999) as technology_sort_order, -- ユーザー情報 u.email as user_email, CONCAT(u.last_name, ' ', u.first_name) as user_name FROM work_histories wh INNER JOIN work_history_technologies wht ON wh.id = wht.work_history_id INNER JOIN technology_categories tc ON wht.category_id = tc.id INNER JOIN users u ON wh.user_id = u.id LEFT JOIN technology_master tm ON wht.technology_name = tm.name AND tc.name = tm.category WHERE wh.deleted_at IS NULL AND u.deleted_at IS NULL GROUP BY wh.user_id, wht.technology_name, tc.name, tc.display_name, tc.sort_order, tm.display_name, tm.usage_count, tm.sort_order, u.email, u.last_name, u.first_name ORDER BY wh.user_id, tc.sort_order, total_experience_months DESC, wht.technology_name;
