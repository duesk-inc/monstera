# バグ修正計画: 領収書アップロードエラー

## 概要
- **バグ影響度**: 🔴 **重大** - 領収書アップロード機能が完全に利用不可
- **緊急度**: 🔴 **緊急** - 即座の修正が必要
- **修正の目的**: 領収書アップロード機能の復旧
- **期待効果**: 経費申請時の領収書添付が正常に動作
- **スコープ**: `src/lib/api/expense.ts` の626行目のみ

## 現状分析
### 根本原因の要約
- APIクライアント新形式移行時の設定ミス
- `generateUploadURL`関数で誤って`upload`プリセットを使用
- JSONリクエストなのに`Content-Type: multipart/form-data`が設定される

### 影響範囲の詳細
1. **直接的な影響**
   - 領収書アップロード機能の完全停止
   - 401 Unauthorizedエラーの発生
   
2. **利用箇所**
   - ReceiptUploaderコンポーネント
   - 経費申請画面の領収書添付

### 現在の回避策
なし（コード修正が必須）

## 修正計画

### Phase 1: 緊急対応（ホットフィックス）【10分】
#### Step 1.1: 現在の動作確認（2分）
```bash
# 開発環境での現在のエラー確認
cd frontend
npm run dev
# 経費申請画面で領収書アップロードを試みてエラーを確認
```

#### Step 1.2: プリセット修正（3分）
**修正対象**: `src/lib/api/expense.ts:626`
```typescript
// 修正前
const client = createPresetApiClient('upload');

// 修正後
const client = createPresetApiClient('auth');
```

#### Step 1.3: 動作確認（5分）
```bash
# 修正後の動作確認
npm run dev
# 経費申請画面で領収書アップロードが正常に動作することを確認
```

### Phase 2: 検証とテスト【15分】
#### Step 2.1: 関連機能の確認（5分）
- URL生成API: 正常動作確認
- ファイルアップロード: S3/MinIOへの実際のアップロード確認
- アップロード完了通知: 正常処理確認

#### Step 2.2: エラーハンドリング確認（5分）
```typescript
// エラーメッセージが適切に表示されることを確認
// - ネットワークエラー
// - ファイルサイズ超過
// - 無効なファイル形式
```

#### Step 2.3: TypeScriptビルド確認（5分）
```bash
npx tsc --noEmit
npm run lint
```

### Phase 3: 予防措置【20分】
#### Step 3.1: プリセット使用ガイドライン作成（10分）
**作成**: `docs/api-preset-guidelines.md`
```markdown
# APIプリセット使用ガイドライン

## プリセット選択基準
- `auth`: JSONリクエスト全般（認証付き）
- `upload`: 実際のファイルアップロード（multipart/form-data）
- `public`: 認証不要のパブリックAPI

## 使い分けの例
- URL生成、メタデータ送信 → `auth`
- ファイルのバイナリデータ送信 → `upload`
```

#### Step 3.2: 同様のプリセット誤用パターンの検索（5分）
```bash
# uploadプリセットを使用している箇所を確認
grep -r "createPresetApiClient('upload')" frontend/src/lib/api/
# 各使用箇所が適切かチェック
```

#### Step 3.3: メモリに修正パターンを記録（5分）
- Serenaメモリに今回の修正パターンを記録
- 同様の問題を防ぐための知見を保存

## テスト計画
### Step T1: 機能テスト（10分）
1. 領収書アップロードURLの生成
2. ファイルの選択とアップロード
3. アップロード進捗の表示
4. 完了通知の確認
5. アップロード済みファイルの削除

### Step T2: 異常系テスト（5分）
1. 大きなファイルサイズ
2. 無効なファイル形式
3. ネットワーク切断
4. 認証切れ

### Step T3: 既存テストの実行（5分）
```bash
npm test -- expense
```

## リスク管理
### 技術的リスク
- **リスクレベル**: 低
- **理由**: 単一行の変更のみで、ロジックに影響なし

### 影響範囲のリスク
- **リスクレベル**: 低
- **理由**: 他の関数は既に正しいプリセットを使用

### 緩和策
1. 修正前にgitでバックアップ
2. 開発環境で十分な動作確認
3. ロールバック手順の準備

## ロールバック計画
```bash
# 修正前にコミット
git add .
git commit -m "backup: before upload preset fix"

# 問題発生時
git revert HEAD
```

## 実装順序と時間見積もり
1. **Phase 1**: 10分（緊急対応）✓ 最優先
2. **Phase 2**: 15分（検証とテスト）
3. **Phase 3**: 20分（予防措置）
4. **テスト**: 20分

**合計所要時間**: 約65分

## 成功基準
- [ ] 領収書アップロードURLが正常に生成される
- [ ] ファイルが正常にアップロードされる
- [ ] 401エラーが発生しない
- [ ] TypeScriptのコンパイルが通る
- [ ] 既存テストがすべてパスする

## APIクライアント移行の注意点
### 今回の教訓
1. **関数名に惑わされない**
   - `generateUploadURL` → uploadではなくauth
   - 実際の処理内容で判断

2. **プリセットの役割を正確に理解**
   - `auth`: 認証付きJSON通信
   - `upload`: マルチパートフォームデータ

3. **移行時のチェックリスト**
   - [ ] リクエストボディの形式確認
   - [ ] レスポンスの形式確認
   - [ ] ヘッダーの要件確認

## 関連ドキュメント
- 調査レポート: `docs/investigate/bug-investigate_20250119_2013.md`
- APIクライアント移行ガイド: `frontend/CLAUDE.md`
- プリセット定義: `frontend/src/lib/api/factory/index.ts`

## 次のアクション
`BUG-FIX`フェーズへ移行し、Phase 1の緊急修正から開始する