# 経費申請画面APIクライアント修正計画

## 計画策定日時
- 2025年1月19日 17:22
- 策定者: Claude Code

## 1. 概要

### バグの影響度と緊急度
- **影響度**: 高（経費申請は金銭に関わる重要機能）
- **緊急度**: 中（機能は動作しているが、仕様違反状態）
- **優先度**: 高（統一仕様への準拠が必要）

### 修正の目的と期待効果
- frontend/CLAUDE.md仕様への完全準拠
- APIクライアントの統一による保守性向上
- エラーハンドリングの一貫性確保
- 他のexpense関連ファイルとの整合性

### スコープ
- 対象ファイル: `frontend/src/lib/api/expense.ts`
- 影響関数: 約20個のAPI関数
- 関連画面: 経費申請関連の5画面

## 2. 現状分析

### 根本原因の要約
旧形式APIクライアント実装を使用しており、以下の違反がある：
1. 独自apiRequest関数によるfetch直接使用
2. API_BASE_URLのハードコーディング
3. createPresetApiClientの未使用

### 影響範囲の詳細
- 経費CRUD操作（作成・読取・更新・削除）
- 領収書アップロード機能
- レポート生成機能
- 承認フロー（申請・承認・却下）
- テンプレート管理

### 現在の回避策
現時点では機能は動作しているが、仕様違反状態のため早急な修正が必要。

## 3. 修正計画（細分化された実装ステップ）

### Phase 1: 準備と影響調査（30分）

#### Step 1.1: 参考実装の確認（10分）
- `expenseApproverSetting.ts`の実装パターン確認
- `expenseSummary.ts`の実装パターン確認
- `expenseLimit.ts`の実装パターン確認
- 共通パターンの抽出

#### Step 1.2: 現在の実装のバックアップ（5分）
```bash
# 現在の状態をコミット
git add frontend/src/lib/api/expense.ts
git commit -m "backup: 修正前のexpense.ts実装"
```

#### Step 1.3: テスト環境の準備（15分）
- Docker環境の確認
- 経費申請画面へのアクセス確認
- 基本動作の事前確認

### Phase 2: 段階的な修正実装（90分）

#### Step 2.1: 基本設定の修正（15分）
```typescript
// 1. import文の追加
import { createPresetApiClient } from '@/lib/api';
import { handleApiError } from '@/lib/api/error';
import { convertSnakeToCamel, convertCamelToSnake } from '@/utils/apiUtils';

// 2. apiRequest関数の削除（163-191行）
// 3. API_BASE_URL定数の削除（160行）
```

#### Step 2.2: 基本CRUD関数の修正（30分）
優先度高の関数から順次修正：

1. **getExpenses / getExpenseList**（10分）
```typescript
export async function getExpenses(params: ExpenseSearchParams = {}): Promise<ExpenseListResponse> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.get('/expenses', { params });
    return mapBackendExpenseListToExpenseList(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費一覧取得');
  }
}
```

2. **createExpense**（5分）
```typescript
export async function createExpense(data: ExpenseCreateData): Promise<Expense> {
  try {
    const client = createPresetApiClient('auth');
    const requestData = convertCamelToSnake(data);
    const response = await client.post('/expenses', requestData);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費作成');
  }
}
```

3. **updateExpense**（5分）
```typescript
export async function updateExpense(data: ExpenseUpdateData): Promise<Expense> {
  try {
    const { id, ...updateData } = data;
    const client = createPresetApiClient('auth');
    const requestData = convertCamelToSnake(updateData);
    const response = await client.put(`/expenses/${id}`, requestData);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費更新');
  }
}
```

4. **deleteExpense**（5分）
```typescript
export async function deleteExpense(id: string): Promise<void> {
  try {
    const client = createPresetApiClient('auth');
    await client.delete(`/expenses/${id}`);
  } catch (error) {
    throw handleApiError(error, '経費削除');
  }
}
```

5. **getExpense**（5分）
```typescript
export async function getExpense(id: string): Promise<Expense> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.get(`/expenses/${id}`);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費詳細取得');
  }
}
```

#### Step 2.3: 承認フロー関数の修正（15分）

1. **submitExpense**（5分）
```typescript
export async function submitExpense(id: string): Promise<Expense> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.post(`/expenses/${id}/submit`);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費申請');
  }
}
```

2. **approveExpense**（5分）
```typescript
export async function approveExpense(id: string): Promise<Expense> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.post(`/expenses/${id}/approve`);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費承認');
  }
}
```

3. **rejectExpense**（5分）
```typescript
export async function rejectExpense(id: string, reason: string): Promise<Expense> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.post(`/expenses/${id}/reject`, { reason });
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, '経費却下');
  }
}
```

#### Step 2.4: アップロード関連の修正（20分）

1. **generateUploadURL**（5分）
```typescript
export async function generateUploadURL(data: UploadFileRequest): Promise<UploadFileResponse> {
  try {
    const client = createPresetApiClient('upload'); // uploadプリセット使用
    const requestData = convertCamelToSnake(data);
    const response = await client.post('/expenses/upload-url', requestData);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, 'アップロードURL生成');
  }
}
```

2. **uploadReceipts**（10分）
```typescript
export async function uploadReceipts(data: ReceiptUploadData): Promise<ReceiptUploadResponse> {
  try {
    const client = createPresetApiClient('upload'); // uploadプリセット使用
    const formData = new FormData();
    formData.append('expenseId', data.expenseId);
    data.files.forEach((file, index) => {
      formData.append(`files[${index}]`, file);
    });
    
    const response = await client.post('/expenses/receipts', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
    return response.data;
  } catch (error) {
    throw handleApiError(error, '領収書アップロード');
  }
}
```

3. **completeUpload**（5分）
```typescript
export async function completeUpload(data: CompleteUploadRequest): Promise<CompleteUploadResponse> {
  try {
    const client = createPresetApiClient('auth');
    const requestData = convertCamelToSnake(data);
    const response = await client.post('/expenses/upload-complete', requestData);
    return convertSnakeToCamel(response.data.data);
  } catch (error) {
    throw handleApiError(error, 'アップロード完了');
  }
}
```

#### Step 2.5: その他の関数の修正（10分）

1. **getExpenseStats**（3分）
2. **getExpenseCategories**（3分）
3. **generateExpenseReport**（4分）
```typescript
export async function generateExpenseReport(
  params: ExpenseSearchParams & { format: 'pdf' | 'excel' | 'csv' }
): Promise<Blob> {
  try {
    const client = createPresetApiClient('auth');
    const response = await client.get('/expenses/reports', {
      params,
      responseType: 'blob'
    });
    return response.data;
  } catch (error) {
    throw handleApiError(error, 'レポート生成');
  }
}
```

### Phase 3: テストと検証（30分）

#### Step 3.1: 単体動作確認（15分）
各画面での基本動作確認：
1. `/expenses` - 一覧表示
2. `/expenses/new` - 新規作成
3. `/expenses/[id]` - 詳細表示
4. `/expenses/[id]/edit` - 編集
5. `/admin/expenses/pending` - 承認待ち一覧

#### Step 3.2: エラーハンドリング確認（10分）
- ネットワークエラー時の動作
- 認証エラー時の動作
- バリデーションエラー時の動作

#### Step 3.3: パフォーマンス確認（5分）
- APIレスポンス時間の確認
- タイムアウト動作の確認

## 4. テスト計画

### 必須テスト項目
1. **機能テスト**
   - 経費の作成・読取・更新・削除
   - 承認フロー（申請・承認・却下）
   - 領収書アップロード
   - レポート生成

2. **エラーテスト**
   - ネットワーク切断時
   - 認証期限切れ
   - 不正なデータ送信

3. **互換性テスト**
   - 既存データとの互換性
   - snake_case/camelCase変換の正常動作

## 5. リスク管理

### 技術的リスク
- **リスク**: APIレスポンス形式の不一致
- **緩和策**: convertSnakeToCamel/convertCamelToSnakeの適切な使用

### 影響範囲のリスク
- **リスク**: 経費申請業務の停止
- **緩和策**: 段階的な修正と各ステップでの動作確認

### ロールバック計画
```bash
# 問題発生時は即座に前のコミットに戻す
git revert HEAD
docker-compose restart frontend
```

## 6. 実装順序と時間見積もり

| フェーズ | 作業内容 | 所要時間 |
|---------|---------|----------|
| Phase 1 | 準備と影響調査 | 30分 |
| Phase 2 | 段階的な修正実装 | 90分 |
| Phase 3 | テストと検証 | 30分 |
| **合計** | **全体** | **約2.5時間** |

## 7. チェックリスト

- [ ] 参考実装の確認完了
- [ ] バックアップコミット作成
- [ ] import文の修正
- [ ] apiRequest関数の削除
- [ ] API_BASE_URL定数の削除
- [ ] 基本CRUD関数の修正（5個）
- [ ] 承認フロー関数の修正（3個）
- [ ] アップロード関連の修正（3個）
- [ ] その他の関数の修正
- [ ] 単体動作確認
- [ ] エラーハンドリング確認
- [ ] パフォーマンス確認

## 8. 成功基準

1. 全てのAPI関数がcreatePresetApiClientを使用
2. fetchの直接使用が完全に排除
3. エラーハンドリングがhandleApiErrorで統一
4. 既存の機能が全て正常動作
5. frontend/CLAUDE.md仕様への完全準拠

## 9. 備考

- 他のexpense関連ファイルを参考にして実装の一貫性を保つ
- 金銭に関わる重要機能のため、慎重に作業を進める
- 各ステップで動作確認を行い、問題があれば即座にロールバック