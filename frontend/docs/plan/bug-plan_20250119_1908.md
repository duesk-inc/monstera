# バグ修正計画: 経費申請画面表示エラー

## 概要
- **バグ影響度**: 🔴 **重大** - 経費申請画面が完全に利用不可
- **緊急度**: 🔴 **緊急** - 即座の修正が必要
- **修正の目的**: 経費申請画面の表示を復旧し、型安全性を向上
- **期待効果**: 画面表示の正常化、今後の同様エラーの防止
- **スコープ**: `src/lib/api/expense.ts` の修正

## 現状分析
### 根本原因の要約
- `expense.ts`でプロパティ名の不整合（`expenses` vs `items`）
- 型定義の重複により、コンパイル時にエラーが検出されなかった
- mapperは正しい型定義（`items`）を使用しているが、APIクライアントは誤った型定義（`expenses`）を参照

### 影響範囲の詳細
1. **直接的な影響**
   - `getExpenseList`関数（212行目でエラー）
   - `getExpenses`関数（181行目で同じ問題）
   
2. **利用箇所**
   - `frontend/src/hooks/expense/useExpenses.ts` - 3箇所で使用
   - 経費申請一覧画面（完全に表示不可）

### 現在の回避策
なし（コード修正が必須）

## 修正計画

### Phase 1: 緊急対応（ホットフィックス）【15分】
#### Step 1.1: エラー再現確認（3分）
```bash
# 現在のエラーを確認
cd frontend
npm run dev
# ブラウザで経費申請画面を開いてエラー確認
```

#### Step 1.2: プロパティ名の緊急修正（5分）
**修正対象**: `src/lib/api/expense.ts`
- 181行目: `{ count: result.expenses.length }` → `{ count: result.items.length }`
- 212行目: `{ count: result.expenses.length }` → `{ count: result.items.length }`

#### Step 1.3: 動作確認（7分）
```bash
# 修正後の動作確認
npm run dev
# ブラウザで経費申請画面を開いて正常表示を確認
```

### Phase 2: 根本修正【20分】
#### Step 2.1: 型定義の重複解消（10分）
**修正対象**: `src/lib/api/expense.ts`

1. **削除**: 75-81行目の独自ExpenseListResponse型定義を削除
   ```typescript
   // 削除対象
   export interface ExpenseListResponse {
     expenses: Expense[];
     totalCount: number;
     page: number;
     limit: number;
     totalPages: number;
   }
   ```

2. **インポート修正**: 正式な型定義をインポート
   ```typescript
   import type { ExpenseListResponse } from '@/types/expense';
   ```

#### Step 2.2: 関数の型整合性確認（5分）
- `getExpenses`関数の戻り値型を確認
- `getExpenseList`関数の戻り値型を確認
- コンパイルエラーがないことを確認

#### Step 2.3: TypeScriptビルド確認（5分）
```bash
npx tsc --noEmit
```

### Phase 3: 予防措置【25分】
#### Step 3.1: 型チェックの強化（10分）
**作成**: `src/lib/api/__tests__/expense.test.ts`
```typescript
// バグ再現テスト
test('getExpenseList should return items array', async () => {
  const result = await getExpenseList();
  expect(result).toHaveProperty('items');
  expect(Array.isArray(result.items)).toBe(true);
});
```

#### Step 3.2: 同様パターンの検索（10分）
```bash
# 他のAPIファイルで同様の問題がないか確認
grep -r "expenses\\.length" frontend/src/lib/api/
grep -r "interface.*Response" frontend/src/lib/api/
```

#### Step 3.3: ドキュメント更新（5分）
- `frontend/CLAUDE.md` に型定義の一元管理ルールを追記
- Serenaメモリに修正パターンを記録

## テスト計画
### Step T1: 機能テスト（10分）
1. 経費申請一覧画面の表示
2. ページネーション動作
3. フィルタリング機能
4. 新規経費申請の作成

### Step T2: 既存テストの実行（5分）
```bash
npm test -- expense
```

### Step T3: リグレッションテスト（5分）
```bash
npm run lint
npx tsc --noEmit
```

## リスク管理
### 技術的リスク
- **リスクレベル**: 低
- **理由**: プロパティ名の変更のみで、ロジックに変更なし

### 影響範囲のリスク
- **リスクレベル**: 低
- **理由**: 影響箇所が明確で限定的

### 緩和策
1. 修正前にgitでバックアップ
2. 段階的な修正と各段階での動作確認
3. ロールバック手順の準備

## ロールバック計画
```bash
# 修正前にコミット
git add .
git commit -m "backup: before expense api fix"

# 問題発生時
git revert HEAD
```

## 実装順序と時間見積もり
1. **Phase 1**: 15分（緊急対応）✓ 最優先
2. **Phase 2**: 20分（根本修正）
3. **Phase 3**: 25分（予防措置）
4. **テスト**: 20分

**合計所要時間**: 約80分

## 成功基準
- [ ] 経費申請画面が正常に表示される
- [ ] コンソールにエラーが出力されない
- [ ] TypeScriptのコンパイルが通る
- [ ] 既存テストがすべてパスする

## 次のアクション
`BUG-FIX`フェーズへ移行し、Phase 1の緊急修正から開始する