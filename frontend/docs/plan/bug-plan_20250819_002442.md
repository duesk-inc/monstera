# バグ修正計画書 - Hydration Mismatchエラー

**計画策定日時**: 2025-01-19 00:24:42  
**計画策定者**: Claude Code  
**バグID**: HYDRATION-LOGIN-001  
**優先度**: 🟡 Medium  
**推定修正時間**: 2時間

## 1. 概要

### バグの影響度と緊急度
- **影響度**: Medium（パフォーマンスへの影響、UXの低下）
- **緊急度**: Medium（機能は動作するが、改善が必要）
- **影響ユーザー**: 全ユーザー（ログイン時）

### 修正の目的と期待効果
- Hydration errorの完全な解消
- 初回レンダリングのパフォーマンス改善（TTI 20%改善見込み）
- レイアウトシフトの防止によるUX向上

### スコープ
- 主要対象: `frontend/src/app/(auth)/login/page.tsx`
- 予防的対象: useSearchParams()を使用する他の4ページ

## 2. 現状分析

### 根本原因の要約
Next.js App RouterとMaterial-UI（emotion）の組み合わせによるSSR不整合。Suspenseとemotionのグローバルスタイルが競合し、サーバーとクライアントで異なるHTMLが生成される。

### 影響範囲の詳細
| ページ | useSearchParams使用 | Suspense使用 | リスク |
|--------|-------------------|--------------|--------|
| `/login` | ✓ | ✓ | High |
| `/project/detail` | ✓ | 未確認 | Medium |
| `/notifications/[id]` | ✓ | 未確認 | Medium |  
| `/leave` | ✓ | 未確認 | Medium |

### 現在の回避策
なし（ブラウザ側での自動再レンダリングに依存）

## 3. 修正計画

### 選択する修正アプローチ
**Suspenseの位置調整とコンポーネント分離**（調査結果の案1を採用）

理由：
- Next.js公式推奨パターンに準拠
- 最も根本的で安定した解決策
- 他のページにも適用可能な汎用パターン
- SSRを維持しつつ問題を解決

### Phase 1: 緊急対応（30分）

#### Step 1.1: バックアップとブランチ作成（5分）
```bash
git checkout -b fix/hydration-mismatch-login
git add -A && git commit -m "chore: backup before hydration fix"
```

#### Step 1.2: SearchParamsコンポーネントの分離（10分）
```typescript
// 新規作成: LoginSearchParams.tsx
'use client';

import { useSearchParams } from 'next/navigation';
import { useEffect } from 'react';

interface LoginSearchParamsProps {
  onError: (message: string) => void;
  onRedirect: (path: string) => void;
}

export function LoginSearchParams({ onError, onRedirect }: LoginSearchParamsProps) {
  const searchParams = useSearchParams();
  
  useEffect(() => {
    const errorParam = searchParams.get('error');
    const redirectParam = searchParams.get('redirect');
    
    if (errorParam === 'unauthorized') {
      onError('認証が必要です。ログインしてください。');
    } else if (errorParam === 'session_expired') {
      onError('セッションが期限切れです。再度ログインしてください。');
    }
    
    if (redirectParam) {
      onRedirect(decodeURIComponent(redirectParam));
    }
  }, [searchParams, onError, onRedirect]);
  
  return null;
}
```

#### Step 1.3: LoginPageContentの修正（10分）
```typescript
function LoginPageContent() {
  const router = useRouter();
  const { getToastMessage, getFieldErrors, getRecommendedAction } = useEnhancedErrorHandler();
  
  // 状態管理
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [redirectPath, setRedirectPath] = useState<string | null>(null);
  
  // Suspenseでラップしたコンポーネントを配置
  return (
    <PageContainer maxWidth="sm">
      {/* SearchParamsのみSuspenseでラップ */}
      <Suspense fallback={null}>
        <LoginSearchParams 
          onError={setError}
          onRedirect={setRedirectPath}
        />
      </Suspense>
      
      {/* 残りのコンテンツはSuspense外 */}
      <PageHeader title="ログイン" />
      <ContentCard>
        {/* ログインフォーム */}
      </ContentCard>
    </PageContainer>
  );
}

// LoginPageはシンプルに
export default function LoginPage() {
  return <LoginPageContent />;
}
```

#### Step 1.4: 動作確認（5分）
- 開発環境での動作確認
- Hydration errorが解消されていることを確認
- ログイン機能が正常に動作することを確認

### Phase 2: コード最適化（30分）

#### Step 2.1: console.log文の整理（10分）
- 本番環境でのconsole.log出力を防ぐ
- 開発環境のみでのデバッグ出力に限定

#### Step 2.2: コンポーネント構造の整理（10分）
- 不要なSuspenseラッパーを削除
- コンポーネントの責務を明確化

#### Step 2.3: TypeScriptの型定義強化（10分）
- SearchParamsの型定義追加
- エラーハンドリングの型安全性向上

### Phase 3: 予防的措置（60分）

#### Step 3.1: 他ページの調査（15分）
```bash
# useSearchParams使用箇所の確認
grep -r "useSearchParams" frontend/src/app --include="*.tsx"
```

#### Step 3.2: 共通パターンの作成（15分）
```typescript
// hooks/useSearchParamsHandler.ts
export function useSearchParamsHandler() {
  const [isReady, setIsReady] = useState(false);
  
  return {
    SearchParamsWrapper: ({ children, onReady }) => (
      <Suspense fallback={null}>
        <SearchParamsHandler onReady={onReady} />
        {isReady && children}
      </Suspense>
    ),
    isReady
  };
}
```

#### Step 3.3: 各ページへの適用（各10分 × 3ページ = 30分）
- `/project/detail`
- `/notifications/[id]`
- `/leave`

## 4. テスト計画

### Step T1: 単体テスト（20分）
```typescript
// __tests__/LoginPage.test.tsx
describe('LoginPage Hydration Fix', () => {
  it('should render without hydration errors', async () => {
    const { container } = render(<LoginPage />);
    // Hydration errorが発生しないことを確認
    expect(console.error).not.toHaveBeenCalledWith(
      expect.stringContaining('Hydration')
    );
  });
  
  it('should handle search params correctly', async () => {
    // URLパラメータのテスト
  });
});
```

### Step T2: E2Eテスト（15分）
```typescript
// e2e/login.spec.ts
test('login flow without hydration issues', async ({ page }) => {
  await page.goto('/login?error=unauthorized');
  // エラーメッセージが表示されることを確認
  await expect(page.getByText('認証が必要です')).toBeVisible();
  // Hydration errorがないことを確認
  const consoleErrors = [];
  page.on('console', msg => {
    if (msg.type() === 'error') consoleErrors.push(msg.text());
  });
  expect(consoleErrors).not.toContain('Hydration');
});
```

### Step T3: パフォーマンステスト（10分）
- Lighthouse CI でのスコア測定
- TTI（Time to Interactive）の改善確認
- CLS（Cumulative Layout Shift）の測定

## 5. リスク管理

### 技術的リスク
| リスク | 可能性 | 影響度 | 緩和策 |
|--------|--------|--------|--------|
| Suspense分離による副作用 | Low | Low | 段階的な適用と各段階での確認 |
| 他のProviderとの競合 | Low | Medium | 開発環境での十分なテスト |
| パフォーマンス劣化 | Very Low | Low | メトリクス測定による確認 |

### ロールバック計画
```bash
# 問題が発生した場合
git stash  # 現在の変更を一時保存
git checkout main  # メインブランチに戻る
git stash pop  # 必要に応じて変更を復元
```

### 影響範囲のリスク
- ログイン機能への影響: なし（構造変更のみ）
- 他のページへの影響: なし（独立した修正）
- SSRへの影響: 改善される

## 6. 成功基準

### 必須条件
- [ ] Hydration errorが完全に解消される
- [ ] ログイン機能が正常に動作する
- [ ] 既存のテストがすべてパスする

### 望ましい条件
- [ ] TTIが10%以上改善
- [ ] CLSスコアが0.1未満
- [ ] 他のページでも同様の問題が解消

## 7. フォローアップ

### ドキュメント更新
- [ ] 修正内容をREADMEに記載
- [ ] Serenaメモリに修正パターンを保存
- [ ] チーム向けのベストプラクティスガイド作成

### 監視項目
- エラー監視ツールでHydration errorの発生状況
- パフォーマンスメトリクスの継続的な測定
- ユーザーフィードバックの収集

## 8. 推定タイムライン

| フェーズ | 推定時間 | 累積時間 |
|---------|----------|----------|
| Phase 1: 緊急対応 | 30分 | 30分 |
| Phase 2: 最適化 | 30分 | 1時間 |
| Phase 3: 予防措置 | 60分 | 2時間 |
| テスト | 45分 | 2時間45分 |
| ドキュメント | 15分 | 3時間 |

**合計推定時間**: 3時間（バッファ込み）

## 9. 承認と開始

この計画は、Next.js App Routerのベストプラクティスに従い、最小限のリスクで最大の効果を得られるよう設計されています。段階的なアプローチにより、各ステップで動作確認が可能です。

**推奨アクション**: Phase 1から順次実施し、各フェーズ完了後に動作確認を行う。

---

**計画ステータス**: ✅ 策定完了  
**次のステップ**: BUG-FIX フェーズへ移行