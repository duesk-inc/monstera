# ãƒã‚°ä¿®æ­£è¨ˆç”»: notificationsãƒ†ãƒ¼ãƒ–ãƒ« recipient_idã‚«ãƒ©ãƒ æ¬ è½

## æ¦‚è¦
- **ãƒã‚°å½±éŸ¿åº¦**: ðŸ”´ **é‡å¤§** - é€šçŸ¥æ©Ÿèƒ½ãŒå®Œå…¨ã«åˆ©ç”¨ä¸å¯
- **ç·Šæ€¥åº¦**: ðŸ”´ **ç·Šæ€¥** - å³åº§ã®ä¿®æ­£ãŒå¿…è¦
- **ä¿®æ­£ã®ç›®çš„**: é€šçŸ¥æ©Ÿèƒ½ã®å®Œå…¨å¾©æ—§
- **æœŸå¾…åŠ¹æžœ**: çµŒè²»ç”³è«‹æ™‚ã®é€šçŸ¥ã‚’å«ã‚€ã€ã™ã¹ã¦ã®é€šçŸ¥æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œ
- **ã‚¹ã‚³ãƒ¼ãƒ—**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžã®ä¿®æ­£ã¨ãã®æ¤œè¨¼

## ç¾çŠ¶åˆ†æž
### æ ¹æœ¬åŽŸå› ã®è¦ç´„
- notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«`recipient_id`ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„
- ãƒ¢ãƒ‡ãƒ«å®šç¾©ï¼ˆnotification.goï¼‰ã«ã¯`RecipientID`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå®šç¾©æ¸ˆã¿
- ã“ã®ä¸æ•´åˆã«ã‚ˆã‚Šã€é€šçŸ¥ä½œæˆæ™‚ã«SQLå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ï¼ˆSQLSTATE 42703ï¼‰ãŒç™ºç”Ÿ

### å½±éŸ¿ç¯„å›²ã®è©³ç´°
1. **å³åº§ã«å½±éŸ¿ã‚’å—ã‘ã‚‹æ©Ÿèƒ½**
   - çµŒè²»ç”³è«‹ã®æå‡ºæ™‚ã®æ‰¿èªè€…ã¸ã®é€šçŸ¥
   - çµŒè²»ç”³è«‹ã®æ‰¿èª/å´ä¸‹é€šçŸ¥
   - çµŒè²»é™åº¦é¡è­¦å‘Šé€šçŸ¥
   - ãã®ä»–ã™ã¹ã¦ã®é€šçŸ¥æ©Ÿèƒ½

2. **ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹**
   - çµŒè²»ãƒ‡ãƒ¼ã‚¿: æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã‚‹ âœ“
   - é€šçŸ¥ãƒ‡ãƒ¼ã‚¿: ä½œæˆã•ã‚Œãªã„ âœ—
   - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿: å½±éŸ¿ãªã—ï¼ˆæ–°è¦ã‚«ãƒ©ãƒ ã¯nullableï¼‰

### ç¾åœ¨ã®å›žé¿ç­–
ãªã—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿®æ­£ãŒå¿…é ˆï¼‰

## ä¿®æ­£è¨ˆç”»

### Phase 1: ç·Šæ€¥å¯¾å¿œï¼ˆãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼‰ã€30åˆ†ã€‘

#### Step 1.1: ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒžç¢ºèªï¼ˆ5åˆ†ï¼‰
```bash
# PostgreSQLã«æŽ¥ç¶šã—ã¦ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒžã‚’ç¢ºèª
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"

# æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
docker-compose exec postgres psql -U postgres -d monstera -c "SELECT COUNT(*) FROM notifications"
```

#### Step 1.2: ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆ10åˆ†ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/migrations/300004_add_recipient_id_to_notifications.up.sql`
```sql
-- notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«recipient_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE notifications 
ADD COLUMN IF NOT EXISTS recipient_id VARCHAR(255) NULL;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼ˆæ¤œç´¢æ€§èƒ½å‘ä¸Šï¼‰
CREATE INDEX IF NOT EXISTS idx_notifications_recipient 
ON notifications(recipient_id);

-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºä¿ï¼‰
ALTER TABLE notifications
ADD CONSTRAINT fk_notifications_recipient 
FOREIGN KEY (recipient_id) 
REFERENCES users(id) 
ON DELETE CASCADE 
ON UPDATE CASCADE;

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON COLUMN notifications.recipient_id IS 'å—ä¿¡è€…IDï¼ˆCognito Subï¼‰';
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/migrations/300004_add_recipient_id_to_notifications.down.sql`
```sql
-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å‰Šé™¤
ALTER TABLE notifications 
DROP CONSTRAINT IF EXISTS fk_notifications_recipient;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
DROP INDEX IF EXISTS idx_notifications_recipient;

-- ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE notifications 
DROP COLUMN IF EXISTS recipient_id;
```

#### Step 1.3: ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆ10åˆ†ï¼‰
```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œ
docker-compose exec backend migrate \
  -path migrations \
  -database "postgres://postgres:postgres@postgres:5432/monstera?sslmode=disable" \
  up

# é©ç”¨çµæžœã®ç¢ºèª
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"
```

#### Step 1.4: åˆæœŸå‹•ä½œç¢ºèªï¼ˆ5åˆ†ï¼‰
```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’ç›£è¦–
docker-compose logs -f backend

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§çµŒè²»ç”³è«‹ã®æå‡ºã‚’è©¦è¡Œ
# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
```

### Phase 2: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆã€25åˆ†ã€‘

#### Step 2.1: é€šçŸ¥ä½œæˆã®å‹•ä½œç¢ºèªï¼ˆ10åˆ†ï¼‰
1. çµŒè²»ç”³è«‹ã®æ–°è¦ä½œæˆã¨æå‡º
2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèª
3. notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```sql
SELECT id, recipient_id, title, notification_type, created_at 
FROM notifications 
ORDER BY created_at DESC 
LIMIT 5;
```

#### Step 2.2: æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ç¢ºèªï¼ˆ10åˆ†ï¼‰
- çµŒè²»ä¸€è¦§ã®è¡¨ç¤º
- çµŒè²»è©³ç´°ã®è¡¨ç¤º
- çµŒè²»ã®ç·¨é›†
- çµŒè²»ã®å‰Šé™¤
- æ‰¿èªãƒ•ãƒ­ãƒ¼ã®å‹•ä½œ

#### Step 2.3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç¢ºèªï¼ˆ5åˆ†ï¼‰
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'notifications';

-- å®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
EXPLAIN SELECT * FROM notifications WHERE recipient_id = 'test-user-id';
```

### Phase 3: äºˆé˜²æŽªç½®ã€30åˆ†ã€‘

#### Step 3.1: ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒžæ•´åˆæ€§ç¢ºèªï¼ˆ15åˆ†ï¼‰
```bash
# ãƒ¢ãƒ‡ãƒ«å®šç¾©ã¨ã‚¹ã‚­ãƒ¼ãƒžã®æ¯”è¼ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
cat > /tmp/check_schema.sh << 'EOF'
#!/bin/bash
echo "=== Checking schema consistency ==="

# user_notificationsãƒ†ãƒ¼ãƒ–ãƒ«
echo "Checking user_notifications table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d user_notifications"

# notification_settingsãƒ†ãƒ¼ãƒ–ãƒ«
echo "Checking notification_settings table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d notification_settings"

# notification_historiesãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
echo "Checking notification_histories table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d notification_histories"
EOF

chmod +x /tmp/check_schema.sh
/tmp/check_schema.sh
```

#### Step 3.2: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ï¼ˆ10åˆ†ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/internal/service/notification_service_test.go`ã«è¿½åŠ 
```go
func TestCreateNotificationWithRecipient(t *testing.T) {
    // recipient_idãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
}
```

#### Step 3.3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆ5åˆ†ï¼‰
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †ã‚’READMEã«è¿½åŠ 
- ã‚¹ã‚­ãƒ¼ãƒžå¤‰æ›´å±¥æ­´ã‚’è¨˜éŒ²

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### Step T1: æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆ15åˆ†ï¼‰
1. **é€šçŸ¥ä½œæˆãƒ†ã‚¹ãƒˆ**
   - [ ] çµŒè²»ç”³è«‹æå‡ºæ™‚ã®é€šçŸ¥ä½œæˆ
   - [ ] æ‰¿èªæ™‚ã®é€šçŸ¥ä½œæˆ
   - [ ] å´ä¸‹æ™‚ã®é€šçŸ¥ä½œæˆ
   - [ ] é™åº¦é¡è­¦å‘Šã®é€šçŸ¥ä½œæˆ

2. **æ—¢å­˜æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**
   - [ ] çµŒè²»CRUDæ“ä½œ
   - [ ] æ‰¿èªãƒ•ãƒ­ãƒ¼
   - [ ] é€šçŸ¥ä¸€è¦§è¡¨ç¤º

### Step T2: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆ10åˆ†ï¼‰
1. **ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ**
   - [ ] å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã®é€šçŸ¥ä½œæˆ
   - [ ] nullã®recipient_idã§ã®é€šçŸ¥ä½œæˆï¼ˆå…¨ä½“é€šçŸ¥ï¼‰
   - [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„é•åã®ãƒ†ã‚¹ãƒˆ

### Step T3: è² è·ãƒ†ã‚¹ãƒˆï¼ˆ5åˆ†ï¼‰
```bash
# å¤§é‡ã®é€šçŸ¥ä½œæˆã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’ç¢ºèª
for i in {1..100}; do
  # é€šçŸ¥ä½œæˆAPIã‚’å‘¼ã³å‡ºã—
done
```

## ãƒªã‚¹ã‚¯ç®¡ç†

### æŠ€è¡“çš„ãƒªã‚¹ã‚¯
- **ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: ä½Ž
- **ç†ç”±**: 
  - NULLABLEã‚«ãƒ©ãƒ ã®è¿½åŠ ã®ãŸã‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—
  - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯CASCADEã§é©åˆ‡ã«è¨­å®š
- **ç·©å’Œç­–**: 
  - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®downãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™æ¸ˆã¿
  - æ®µéšŽçš„ãªå‹•ä½œç¢ºèª

### å½±éŸ¿ç¯„å›²ã®ãƒªã‚¹ã‚¯
- **ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: ä¸­
- **ç†ç”±**: é€šçŸ¥æ©Ÿèƒ½ã¯è¤‡æ•°ã®æ©Ÿèƒ½ã§ä½¿ç”¨ã•ã‚Œã‚‹
- **ç·©å’Œç­–**: 
  - å„æ©Ÿèƒ½ã§ã®å‹•ä½œç¢ºèªã‚’å®Ÿæ–½
  - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–å¼·åŒ–

### æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨ãƒªã‚¹ã‚¯
- **ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: ä¸­
- **ç†ç”±**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžå¤‰æ›´ã¯æ…Žé‡ãªä½œæ¥­ãŒå¿…è¦
- **ç·©å’Œç­–**:
  - äº‹å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§æ¤œè¨¼
  - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã®é©ç”¨
  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

```bash
# 1. å•é¡Œç™ºç”Ÿã‚’ç¢ºèª
docker-compose logs backend | grep ERROR

# 2. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
docker-compose exec backend migrate \
  -path migrations \
  -database "postgres://postgres:postgres@postgres:5432/monstera?sslmode=disable" \
  down 1

# 3. ã‚¹ã‚­ãƒ¼ãƒžã®ç¢ºèª
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"

# 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•
docker-compose restart backend
```

## å®Ÿè£…é †åºã¨æ™‚é–“è¦‹ç©ã‚‚ã‚Š
1. **Phase 1**: 30åˆ†ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰âœ“ æœ€å„ªå…ˆ
2. **Phase 2**: 25åˆ†ï¼ˆæ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆï¼‰
3. **Phase 3**: 30åˆ†ï¼ˆäºˆé˜²æŽªç½®ï¼‰
4. **ãƒ†ã‚¹ãƒˆ**: 30åˆ†

**åˆè¨ˆæ‰€è¦æ™‚é–“**: ç´„115åˆ†ï¼ˆç´„2æ™‚é–“ï¼‰

## æˆåŠŸåŸºæº–
- [ ] notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«recipient_idã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹
- [ ] çµŒè²»ç”³è«‹æå‡ºæ™‚ã«500ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã‚‹
- [ ] æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ãŒãªã„
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®åŠ£åŒ–ãŒãªã„

## æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨æ‰‹é †

### äº‹å‰æº–å‚™
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
2. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®æ¤œè¨¼å®Œäº†
3. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®è¨­å®š

### é©ç”¨æ‰‹é †
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
2. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
3. å‹•ä½œç¢ºèª
4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™

### äº‹å¾Œç¢ºèª
1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–ï¼ˆæœ€ä½Ž30åˆ†ï¼‰
2. é€šçŸ¥æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¢ºèª

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ: `docs/investigate/bug-investigate_20250119_2053.md`
- ãƒ¢ãƒ‡ãƒ«å®šç¾©: `backend/internal/model/notification.go`
- ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…: `backend/internal/service/notification_service.go`
- æ—¢å­˜ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: `backend/migrations/000012_create_notifications_tables.up.sql`

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
`BUG-FIX`ãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œã—ã€Phase 1ã®ç·Šæ€¥å¯¾å¿œã‹ã‚‰é–‹å§‹ã™ã‚‹