# バグ修正計画: notificationsテーブル recipient_idカラム欠落

## 概要
- **バグ影響度**: 🔴 **重大** - 通知機能が完全に利用不可
- **緊急度**: 🔴 **緊急** - 即座の修正が必要
- **修正の目的**: 通知機能の完全復旧
- **期待効果**: 経費申請時の通知を含む、すべての通知機能が正常動作
- **スコープ**: データベーススキーマの修正とその検証

## 現状分析
### 根本原因の要約
- notificationsテーブルに`recipient_id`カラムが存在しない
- モデル定義（notification.go）には`RecipientID`フィールドが定義済み
- この不整合により、通知作成時にSQL実行エラー（SQLSTATE 42703）が発生

### 影響範囲の詳細
1. **即座に影響を受ける機能**
   - 経費申請の提出時の承認者への通知
   - 経費申請の承認/却下通知
   - 経費限度額警告通知
   - その他すべての通知機能

2. **データの状態**
   - 経費データ: 正常に保存される ✓
   - 通知データ: 作成されない ✗
   - 既存データ: 影響なし（新規カラムはnullable）

### 現在の回避策
なし（データベース修正が必須）

## 修正計画

### Phase 1: 緊急対応（マイグレーション適用）【30分】

#### Step 1.1: 現在のスキーマ確認（5分）
```bash
# PostgreSQLに接続して現在のスキーマを確認
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"

# 既存データの確認
docker-compose exec postgres psql -U postgres -d monstera -c "SELECT COUNT(*) FROM notifications"
```

#### Step 1.2: マイグレーションファイル作成（10分）
**ファイル**: `backend/migrations/300004_add_recipient_id_to_notifications.up.sql`
```sql
-- notificationsテーブルにrecipient_idカラムを追加
ALTER TABLE notifications 
ADD COLUMN IF NOT EXISTS recipient_id VARCHAR(255) NULL;

-- インデックスを追加（検索性能向上）
CREATE INDEX IF NOT EXISTS idx_notifications_recipient 
ON notifications(recipient_id);

-- 外部キー制約を追加（データ整合性確保）
ALTER TABLE notifications
ADD CONSTRAINT fk_notifications_recipient 
FOREIGN KEY (recipient_id) 
REFERENCES users(id) 
ON DELETE CASCADE 
ON UPDATE CASCADE;

-- コメント追加
COMMENT ON COLUMN notifications.recipient_id IS '受信者ID（Cognito Sub）';
```

**ファイル**: `backend/migrations/300004_add_recipient_id_to_notifications.down.sql`
```sql
-- 外部キー制約を削除
ALTER TABLE notifications 
DROP CONSTRAINT IF EXISTS fk_notifications_recipient;

-- インデックスを削除
DROP INDEX IF EXISTS idx_notifications_recipient;

-- カラムを削除
ALTER TABLE notifications 
DROP COLUMN IF EXISTS recipient_id;
```

#### Step 1.3: マイグレーション適用（10分）
```bash
# バックエンドコンテナで実行
docker-compose exec backend migrate \
  -path migrations \
  -database "postgres://postgres:postgres@postgres:5432/monstera?sslmode=disable" \
  up

# 適用結果の確認
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"
```

#### Step 1.4: 初期動作確認（5分）
```bash
# バックエンドログを監視
docker-compose logs -f backend

# フロントエンドで経費申請の提出を試行
# エラーが発生しないことを確認
```

### Phase 2: 検証とテスト【25分】

#### Step 2.1: 通知作成の動作確認（10分）
1. 経費申請の新規作成と提出
2. バックエンドログでエラーが出ないことを確認
3. notificationsテーブルにデータが作成されることを確認
```sql
SELECT id, recipient_id, title, notification_type, created_at 
FROM notifications 
ORDER BY created_at DESC 
LIMIT 5;
```

#### Step 2.2: 既存機能への影響確認（10分）
- 経費一覧の表示
- 経費詳細の表示
- 経費の編集
- 経費の削除
- 承認フローの動作

#### Step 2.3: パフォーマンス確認（5分）
```sql
-- インデックスが正しく作成されているか確認
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'notifications';

-- 実行計画の確認
EXPLAIN SELECT * FROM notifications WHERE recipient_id = 'test-user-id';
```

### Phase 3: 予防措置【30分】

#### Step 3.1: 他のテーブルのスキーマ整合性確認（15分）
```bash
# モデル定義とスキーマの比較スクリプト作成
cat > /tmp/check_schema.sh << 'EOF'
#!/bin/bash
echo "=== Checking schema consistency ==="

# user_notificationsテーブル
echo "Checking user_notifications table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d user_notifications"

# notification_settingsテーブル
echo "Checking notification_settings table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d notification_settings"

# notification_historiesテーブル（存在する場合）
echo "Checking notification_histories table..."
docker-compose exec postgres psql -U postgres -d monstera -c "\d notification_histories"
EOF

chmod +x /tmp/check_schema.sh
/tmp/check_schema.sh
```

#### Step 3.2: テストケース追加（10分）
**ファイル**: `backend/internal/service/notification_service_test.go`に追加
```go
func TestCreateNotificationWithRecipient(t *testing.T) {
    // recipient_idが正しく保存されることを確認
    // 外部キー制約が機能することを確認
}
```

#### Step 3.3: ドキュメント更新（5分）
- マイグレーション実行手順をREADMEに追加
- スキーマ変更履歴を記録

## テスト計画

### Step T1: 機能テスト（15分）
1. **通知作成テスト**
   - [ ] 経費申請提出時の通知作成
   - [ ] 承認時の通知作成
   - [ ] 却下時の通知作成
   - [ ] 限度額警告の通知作成

2. **既存機能テスト**
   - [ ] 経費CRUD操作
   - [ ] 承認フロー
   - [ ] 通知一覧表示

### Step T2: エラーハンドリングテスト（10分）
1. **異常系テスト**
   - [ ] 存在しないユーザーIDでの通知作成
   - [ ] nullのrecipient_idでの通知作成（全体通知）
   - [ ] 外部キー制約違反のテスト

### Step T3: 負荷テスト（5分）
```bash
# 大量の通知作成でパフォーマンスを確認
for i in {1..100}; do
  # 通知作成APIを呼び出し
done
```

## リスク管理

### 技術的リスク
- **リスクレベル**: 低
- **理由**: 
  - NULLABLEカラムの追加のため既存データへの影響なし
  - 外部キー制約はCASCADEで適切に設定
- **緩和策**: 
  - ロールバック用のdownマイグレーション準備済み
  - 段階的な動作確認

### 影響範囲のリスク
- **リスクレベル**: 中
- **理由**: 通知機能は複数の機能で使用される
- **緩和策**: 
  - 各機能での動作確認を実施
  - エラーログの監視強化

### 本番環境への適用リスク
- **リスクレベル**: 中
- **理由**: データベーススキーマ変更は慎重な作業が必要
- **緩和策**:
  - 事前にステージング環境で検証
  - メンテナンスウィンドウでの適用
  - バックアップの取得

## ロールバック計画

```bash
# 1. 問題発生を確認
docker-compose logs backend | grep ERROR

# 2. マイグレーションのロールバック
docker-compose exec backend migrate \
  -path migrations \
  -database "postgres://postgres:postgres@postgres:5432/monstera?sslmode=disable" \
  down 1

# 3. スキーマの確認
docker-compose exec postgres psql -U postgres -d monstera -c "\d notifications"

# 4. アプリケーションの再起動
docker-compose restart backend
```

## 実装順序と時間見積もり
1. **Phase 1**: 30分（緊急対応）✓ 最優先
2. **Phase 2**: 25分（検証とテスト）
3. **Phase 3**: 30分（予防措置）
4. **テスト**: 30分

**合計所要時間**: 約115分（約2時間）

## 成功基準
- [ ] notificationsテーブルにrecipient_idカラムが追加される
- [ ] 経費申請提出時に500エラーが発生しない
- [ ] 通知データが正常に作成される
- [ ] 既存機能に影響がない
- [ ] パフォーマンスの劣化がない

## 本番環境への適用手順

### 事前準備
1. データベースのバックアップ取得
2. ステージング環境での検証完了
3. メンテナンスウィンドウの設定

### 適用手順
1. アプリケーションを読み取り専用モードに変更
2. マイグレーション適用
3. 動作確認
4. アプリケーションを通常モードに戻す

### 事後確認
1. エラーログの監視（最低30分）
2. 通知機能の動作確認
3. パフォーマンスメトリクスの確認

## 関連ドキュメント
- 調査レポート: `docs/investigate/bug-investigate_20250119_2053.md`
- モデル定義: `backend/internal/model/notification.go`
- サービス実装: `backend/internal/service/notification_service.go`
- 既存マイグレーション: `backend/migrations/000012_create_notifications_tables.up.sql`

## 次のアクション
`BUG-FIX`フェーズへ移行し、Phase 1の緊急対応から開始する