# バグ修正計画書 - ログイン時404エラー

**計画策定日時**: 2025-01-19 00:48:00  
**計画策定者**: Claude Code  
**バグID**: LOGIN-404-001  
**優先度**: 🔴 Critical  
**推定修正時間**: 45分

## 1. 概要

### バグの影響度と緊急度
- **影響度**: Critical（全ユーザーがシステムを利用不可）
- **緊急度**: Critical（即座の修正が必要）
- **影響ユーザー**: 全ユーザー（100%）

### 修正の目的と期待効果
- ログイン機能の完全復旧
- 認証関連機能の正常化
- ユーザーのシステムアクセス回復

### スコープ
- 主要対象: `frontend/src/lib/api/auth/index.ts`
- 修正関数: `login()`, `refreshToken()`, `logout()`, `getCurrentUser()`

## 2. 現状分析

### 根本原因の要約
`createPresetApiClient('auth')`使用時に`baseURL`を明示的に設定したことで、自動的な`/api/v1`付与機能が無効化されている。

### 影響範囲の詳細
| 関数 | 行番号 | 現在のパス | 正しいパス |
|------|--------|------------|------------|
| login() | 36-38, 41 | /auth/login | /api/v1/auth/login |
| refreshToken() | 111-113, 116 | /auth/refresh | /api/v1/auth/refresh |
| logout() | 181-183, 186 | /auth/logout | /api/v1/auth/logout |
| getCurrentUser() | 237-238, 242 | /auth/me | /api/v1/auth/me |

### 現在の回避策
なし（修正が必須）

## 3. 修正計画

### Phase 1: 緊急対応（15分）

#### Step 1.1: バックアップとブランチ作成（2分）
```bash
git checkout -b fix/login-404-error
git add -A && git commit -m "chore: backup before fixing login 404 error"
```

#### Step 1.2: auth/index.tsの修正（5分）
```typescript
// 修正箇所1: login関数（line 36-38）
// 変更前
const client = createPresetApiClient('auth', {
  baseURL: API_BASE_URL,
});

// 変更後
const client = createPresetApiClient('auth');
```

同様の修正を以下に適用：
- refreshToken関数（line 111-113）
- logout関数（line 181-183）
- getCurrentUser関数（line 237-238）

#### Step 1.3: 即座の動作確認（3分）
```bash
# 開発サーバー起動
npm run dev

# 別ターミナルでテスト
curl -X POST http://localhost:3001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test"}'
```

#### Step 1.4: コミット（2分）
```bash
git add -A
git commit -m "fix: remove baseURL override in auth API client to fix 404 errors

- Remove baseURL configuration from createPresetApiClient calls
- Affects login, refreshToken, logout, and getCurrentUser functions
- Fixes LOGIN-404-001"
```

#### Step 1.5: 手動テスト（3分）
1. ブラウザでログイン画面を開く
2. 有効な認証情報でログイン試行
3. ネットワークタブで正しいAPIパス（/api/v1/auth/login）を確認
4. ログイン成功を確認

### Phase 2: テストと検証（15分）

#### Step 2.1: 統合テストの実施（5分）
```bash
# 認証フロー全体のテスト
npm test -- auth
```

#### Step 2.2: E2Eテストの作成（10分）
```typescript
// e2e/auth-flow.test.ts
describe('Authentication Flow', () => {
  it('should login with correct API path', async () => {
    // ログインページへ遷移
    await page.goto('/login');
    
    // 認証情報入力
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'testpass');
    
    // ネットワークリクエストを監視
    const requestPromise = page.waitForRequest(
      request => request.url().includes('/api/v1/auth/login')
    );
    
    // ログインボタンクリック
    await page.click('[type="submit"]');
    
    // 正しいパスでリクエストが送信されることを確認
    const request = await requestPromise;
    expect(request.url()).toContain('/api/v1/auth/login');
  });
});
```

### Phase 3: 予防措置（15分）

#### Step 3.1: APIクライアント使用ガイドラインの強化（5分）
CLAUDE.frontend.mdに以下を追加：
```markdown
### ⚠️ 重要な注意事項
createPresetApiClientを使用する際は、絶対にbaseURLを設定しないでください。
プリセットが自動的に適切なbaseURLを設定します。

❌ 間違い:
const client = createPresetApiClient('auth', {
  baseURL: API_BASE_URL  // これは禁止！
});

✅ 正しい:
const client = createPresetApiClient('auth');
```

#### Step 3.2: ESLintルールの追加（5分）
```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'no-restricted-syntax': [
      'error',
      {
        selector: 'CallExpression[callee.name="createPresetApiClient"] > ObjectExpression:has(Property[key.name="baseURL"])',
        message: 'createPresetApiClientでbaseURLを設定することは禁止されています。'
      }
    ]
  }
};
```

#### Step 3.3: 単体テストの追加（5分）
```typescript
// __tests__/api/auth.test.ts
describe('Auth API Client', () => {
  it('should not override baseURL in createPresetApiClient', () => {
    const mockCreateClient = jest.spyOn(factory, 'createPresetApiClient');
    
    login({ email: 'test@example.com', password: 'test' });
    
    expect(mockCreateClient).toHaveBeenCalledWith('auth');
    expect(mockCreateClient).not.toHaveBeenCalledWith(
      expect.anything(),
      expect.objectContaining({ baseURL: expect.anything() })
    );
  });
});
```

## 4. テスト計画

### Step T1: 単体テスト（5分）
- [ ] login関数が正しいAPIパスを使用
- [ ] refreshToken関数が正しいAPIパスを使用
- [ ] logout関数が正しいAPIパスを使用
- [ ] getCurrentUser関数が正しいAPIパスを使用

### Step T2: 統合テスト（5分）
- [ ] ログイン → ダッシュボード遷移
- [ ] トークンリフレッシュ
- [ ] ログアウト → ログイン画面遷移

### Step T3: リグレッションテスト（5分）
- [ ] 既存の認証テストがすべてパス
- [ ] 他のAPIクライアントが影響を受けていない

## 5. リスク管理

### 技術的リスク
| リスク | 可能性 | 影響度 | 緩和策 |
|--------|--------|--------|--------|
| 修正による他の機能への影響 | Low | Medium | 全API機能のテスト実施 |
| キャッシュによる古い設定の残存 | Low | Low | ブラウザキャッシュクリア |
| 環境変数の不整合 | Very Low | High | 環境変数の確認 |

### ロールバック計画
```bash
# 問題が発生した場合
git revert HEAD
git push origin fix/login-404-error
```

### 影響範囲のリスク
- auth/index.ts以外のファイルには同様の問題がないことを確認済み
- 修正は認証機能のみに限定
- 他のAPIクライアントには影響なし

## 6. 成功基準

### 必須条件
- [ ] ログインが正常に動作する
- [ ] APIパスが`/api/v1/auth/*`になっている
- [ ] 404エラーが解消される
- [ ] 既存のテストがすべてパスする

### 望ましい条件
- [ ] ESLintルールで今後の問題を防止
- [ ] E2Eテストで継続的な監視
- [ ] ドキュメントの更新完了

## 7. フォローアップ

### ドキュメント更新
- [ ] CLAUDE.frontend.mdに注意事項追加
- [ ] API_CLIENT_MIGRATION_GUIDE.mdの更新
- [ ] Serenaメモリに修正パターンを記録

### 監視項目
- エラー監視ツールで404エラーの発生状況
- ログイン成功率のメトリクス
- APIレスポンスタイムの監視

## 8. 推定タイムライン

| フェーズ | 推定時間 | 累積時間 |
|---------|----------|----------|
| Phase 1: 緊急対応 | 15分 | 15分 |
| Phase 2: テストと検証 | 15分 | 30分 |
| Phase 3: 予防措置 | 15分 | 45分 |

**合計推定時間**: 45分

## 9. 承認と開始

この修正は単純明快で、リスクも低いため、即座に実施可能です。baseURLの設定を削除するだけで問題が解決します。

**推奨アクション**: Phase 1を即座に実施し、システムを復旧させる。

---

**計画ステータス**: ✅ 策定完了  
**次のステップ**: BUG-FIX フェーズへ移行