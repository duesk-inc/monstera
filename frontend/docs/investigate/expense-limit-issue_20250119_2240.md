# 経費申請エラー調査レポート: 月次上限超過

## 発生日時
2025-01-19 22:37

## エラー概要
経費申請作成時に500エラーが発生。ただし、これは**バグではなく正常な動作**。

## エラー詳細
### フロントエンドエラー
- **HTTPステータス**: 500 (Internal Server Error)
- **エラーメッセージ**: `経費作成の取得に失敗しました: 不明なエラー`
- **発生箇所**: expense.ts:266 (createExpense関数)

### バックエンドエラー
- **エラーコード**: `EXPENSE_MONTHLY_LIMIT_EXCEEDED`
- **エラーメッセージ**: `月次上限を超過します（残り: 15600円）`
- **ユーザーID**: 37f4ba88-80e1-7053-57f9-84c245af87df

## 原因分析
### 経費上限設定
```sql
-- 全社設定
月次上限: 50,000円
年次上限: 600,000円
```

### 現在の使用状況
- **今月の使用額**: 34,400円（5件）
- **残り枠**: 15,600円
- **申請しようとした金額**: 15,600円を超える金額

## 結論
これは**正常な動作**であり、バグではありません。
システムは経費上限チェックを正しく行い、上限を超える申請を拒否しています。

## 対処法
### テスト環境での回避方法
1. **月次上限を増やす**
```sql
UPDATE expense_limits 
SET amount = 100000 
WHERE limit_type = 'monthly' AND limit_scope = 'company';
```

2. **既存の経費を削除**
```sql
UPDATE expenses 
SET deleted_at = NOW() 
WHERE user_id = '37f4ba88-80e1-7053-57f9-84c245af87df' 
AND DATE_TRUNC('month', expense_date) = DATE_TRUNC('month', CURRENT_DATE);
```

3. **別のユーザーでテスト**
異なるユーザーIDでログインして経費申請を行う。

## 通知機能の修正状況
本来の問題であった通知機能のバグは以下のマイグレーションで修正済み：
- 300004: recipient_idカラム追加
- 300005: status, metadata, read_atカラム追加

## 推奨事項
### フロントエンドの改善
- エラーメッセージを「不明なエラー」ではなく「月次経費上限を超過しています」と表示すべき
- 残り枠を事前に表示する機能の追加

### バックエンドの改善
- HTTPステータスコードを500ではなく400（Bad Request）または422（Unprocessable Entity）にすべき
- エラーレスポンスに詳細情報を含める

## ステータス
**調査完了** - バグではなく正常動作であることを確認