# バグ調査レポート - Hydration Mismatchエラー

**調査日時**: 2025-01-19 00:18:21  
**調査者**: Claude Code  
**バグID**: HYDRATION-LOGIN-001  
**重要度**: 🟡 Medium（機能は動作するが、パフォーマンスに影響）

## 1. エラー概要

### 症状
- ログインページ（`/login`）でHydration failedエラーが発生
- サーバーサイドレンダリング（SSR）とクライアントサイドのHTMLが不一致
- ツリーがクライアントサイドで再生成される（パフォーマンス低下）

### エラーメッセージ
```
Uncaught Error: Hydration failed because the server rendered HTML didn't match the client.
As a result this tree will be regenerated on the client.

at LoginPage (page.tsx:261:5)

差分:
+ <Suspense fallback={<LoginPageLoading>}>
- <style data-emotion="css-global h0mbd2" data-s="">
```

## 2. 根本原因

### 原因の特定
**Next.js App RouterとMaterial-UI（emotion）の組み合わせによるSSR不整合**

**問題の発生箇所**: `frontend/src/app/(auth)/login/page.tsx:261`

### 技術的詳細

1. **Suspenseとemotionのスタイル競合**
   - サーバー側: emotionのグローバルスタイルタグがレンダリング
   - クライアント側: Suspenseコンポーネントがレンダリング
   - この順序の不一致がHydration errorを引き起こす

2. **コンポーネント構造**
```typescript
// page.tsx:259-264
export default function LoginPage() {
  return (
    <Suspense fallback={<LoginPageLoading />}>  // Line 261
      <LoginPageContent />
    </Suspense>
  );
}
```

3. **関連する設定**
   - `app/providers.tsx`: `CssBaseline`がグローバルスタイルを注入
   - `app/layout.tsx`: サーバーコンポーネント
   - `app/(auth)/login/page.tsx`: クライアントコンポーネント（'use client'）

## 3. 問題の要因

### 直接的な要因
1. **useSearchParams()の使用**
   - LoginPageContentでuseSearchParams()フックを使用
   - Next.js 13+ではSuspenseでラップが必要（実装済み）
   - しかし、emotionのSSRとの相互作用で問題発生

2. **Material-UI/emotionのSSR設定**
   - emotionのSSR設定が適切に構成されていない
   - Next.js App Routerに最適化されていない

### 間接的な要因
- console.log文の存在（開発/本番で動作が異なる可能性）
- 複数のProviderのネスト構造

## 4. 影響範囲

### 影響を受ける機能
| 機能 | ファイル | 影響度 |
|------|----------|--------|
| ログインページ | `(auth)/login/page.tsx` | Medium |
| 初回レンダリング | 全体 | Low |

### パフォーマンスへの影響
- クライアントサイドでの再レンダリングが発生
- 初回表示時のちらつき（フラッシュ）
- TTI（Time to Interactive）の増加

### ユーザー体験への影響
- ログイン画面の初回表示時に短時間のレイアウトシフト
- 機能自体は正常に動作

## 5. 修正方針

### 推奨される修正案

#### 案1: Suspenseの位置を調整（推奨）
```typescript
// LoginPageContent内でSuspenseを使用
function LoginPageContent() {
  const router = useRouter();
  // useSearchParams()を別コンポーネントに分離
  
  return (
    <PageContainer>
      <Suspense fallback={<div>Loading...</div>}>
        <SearchParamsHandler />
      </Suspense>
      {/* 残りのコンテンツ */}
    </PageContainer>
  );
}

// 別コンポーネントでuseSearchParams()
function SearchParamsHandler() {
  const searchParams = useSearchParams();
  // searchParams処理
}
```

#### 案2: emotion SSR設定の追加
```typescript
// app/emotion.tsx (新規作成)
'use client';

import createCache from '@emotion/cache';
import { CacheProvider } from '@emotion/react';
import { useServerInsertedHTML } from 'next/navigation';
import { useState } from 'react';

export function EmotionCacheProvider({ children }) {
  const [cache] = useState(() => {
    const cache = createCache({ key: 'css', prepend: true });
    cache.compat = true;
    return cache;
  });

  useServerInsertedHTML(() => {
    // SSR時のスタイル注入
  });

  return <CacheProvider value={cache}>{children}</CacheProvider>;
}
```

#### 案3: dynamic importの使用
```typescript
import dynamic from 'next/dynamic';

const LoginPageContent = dynamic(
  () => import('./LoginPageContent'),
  { 
    ssr: false,  // SSRを無効化
    loading: () => <LoginPageLoading />
  }
);
```

## 6. 類似の問題

### 他のページでの発生可能性
- 多くのページでSuspenseパターンが使用されている
- 同様の問題が他のページでも発生する可能性がある

## 7. 回避策

### 一時的な回避策
1. ブラウザのキャッシュをクリア
2. 開発環境では問題が顕著でない場合がある
3. 本番環境では初回アクセス時のみ発生

## 8. テスト項目

修正後に以下を確認：
1. Hydration errorが解消されること
2. ログイン機能が正常に動作すること
3. ページのちらつきがないこと
4. パフォーマンスメトリクスの改善

## 9. 参考情報

### 関連リンク
- [React Hydration Mismatch](https://react.dev/link/hydration-mismatch)
- [Next.js App Router with Material-UI](https://mui.com/material-ui/guides/nextjs/)
- [emotion SSR Guide](https://emotion.sh/docs/ssr)

## 10. 結論

このバグは、Next.js App RouterとMaterial-UI（emotion）の組み合わせで発生する既知の問題です。Suspenseとemotionのグローバルスタイルの競合が原因で、サーバーとクライアントでレンダリング結果が異なります。

機能自体は動作しますが、パフォーマンスとユーザー体験に影響があるため、修正を推奨します。

**次のアクション**: BUG-FIX フェーズへ移行し、Suspenseの構造を調整