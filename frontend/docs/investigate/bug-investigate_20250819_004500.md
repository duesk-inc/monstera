# バグ調査レポート - ログイン時404エラー

**調査日時**: 2025-01-19 00:45:00  
**調査者**: Claude Code  
**バグID**: LOGIN-404-001  
**重要度**: 🔴 Critical（ログイン機能が完全に動作しない）

## 1. エラー概要

### 症状
- ログイン時に404 Not Foundエラーが発生
- エラーメッセージ: `POST http://localhost:8080/auth/login 404 (Not Found)`
- ユーザーには「ネットワークエラーが発生しました」と表示される

### エラーの流れ
1. ユーザーがログインフォームにメールアドレスとパスワードを入力
2. フロントエンドが`http://localhost:8080/auth/login`にPOSTリクエスト送信
3. バックエンドが404を返す（エンドポイントが存在しない）
4. フロントエンドがネットワークエラーとして処理

## 2. 根本原因

### 原因の特定
**APIクライアントの設定ミス - baseURLの誤った上書き**

**問題箇所**: `frontend/src/lib/api/auth/index.ts:36-38`

```typescript
// 現在の実装（誤り）
const client = createPresetApiClient('auth', {
  baseURL: API_BASE_URL,  // ← これが問題！
});
```

### 技術的詳細

1. **正しい仕様**（CLAUDE.mdに記載）:
   - `createPresetApiClient('auth')`を使用すると`/api/v1`が自動付与される
   - APIパスは`/auth/login`のように記述する（`/api/v1`は含めない）

2. **現在の問題**:
   - `baseURL: API_BASE_URL`で明示的にbaseURLを上書きしている
   - `API_BASE_URL`は`http://localhost:8080`（`/api/v1`が含まれていない）
   - 結果として`http://localhost:8080/auth/login`にリクエストが送信される

3. **バックエンドの実態**:
   - 正しいエンドポイント: `http://localhost:8080/api/v1/auth/login`
   - 現在のリクエスト: `http://localhost:8080/auth/login` → 404エラー

## 3. 検証結果

### バックエンドの動作確認
```bash
# 正しいパス → 401（認証エラー、エンドポイントは存在）
curl -X POST http://localhost:8080/api/v1/auth/login

# 問題のパス → 404（エンドポイントが存在しない）
curl -X POST http://localhost:8080/auth/login
```

## 4. 影響範囲

### 影響を受ける機能
| 機能 | ファイル | 影響度 |
|------|----------|--------|
| ログイン | `auth/index.ts:login()` | Critical |
| トークンリフレッシュ | `auth/index.ts:refreshToken()` | Critical |
| ログアウト | `auth/index.ts:logout()` | Critical |
| 現在のユーザー取得 | `auth/index.ts:getCurrentUser()` | Critical |

### 影響を受けるユーザー
- **全ユーザー** - ログインができないため、システムを利用できない

## 5. 修正方針

### 推奨される修正案

#### 修正案1: baseURL設定を削除（推奨）
```typescript
// 修正後
export const login = async (credentials: LoginRequest): Promise<LoginResponse> => {
  try {
    // baseURLの設定を削除
    const client = createPresetApiClient('auth');
    
    // APIパスは/api/v1を含めない
    const response = await client.post<LoginResponse>('/auth/login', credentials);
    
    // ...
  }
};
```

#### 修正対象関数
- `login()` - `/auth/login`
- `refreshToken()` - `/auth/refresh`
- `logout()` - `/auth/logout`
- `getCurrentUser()` - `/auth/me`

## 6. 関連ファイルの問題点

### API_BASE_URLの定義（constants/api.ts）
```typescript
// 現在の定義（問題あり）
export const API_BASE_URL = LEGACY_URL ? LEGACY_URL.replace(/\/api\/v\d+$/, '') : API_HOST;
```
これは`/api/v1`を削除してしまうため、問題の原因となっている。

### 環境変数設定（env.ts）
```typescript
// baseUrlの構築ロジック
const baseUrl = legacyUrl || `${host}/api/${version}`;
```
legacyUrlが存在する場合、それをそのまま使用する仕様になっている。

## 7. 回避策

### 一時的な回避策
なし（修正が必要）

## 8. テスト項目

修正後に以下を確認：
1. ログイン機能が正常に動作すること
2. 認証トークンが正しく取得されること
3. ログアウトが正常に動作すること
4. トークンリフレッシュが正常に動作すること
5. 認証後のAPIコールが正常に動作すること

## 9. 参考情報

### 関連ドキュメント
- [CLAUDE.frontend.md](../../CLAUDE.md) - APIクライアントの正しい使用方法
- [API_CLIENT_MIGRATION_GUIDE.md](../API_CLIENT_MIGRATION_GUIDE.md) - 移行ガイド

### デバッグログ
```
POST http://localhost:8080/auth/login 404 (Not Found)
エラー: {code: 'NOT_FOUND', message: '404 page not found'}
```

## 10. 結論

このバグは、APIクライアントのbaseURLを誤って上書きしたことが原因です。`createPresetApiClient('auth')`は自動的に`/api/v1`を付与する設計になっていますが、`baseURL`を明示的に設定することでこの機能が無効化されています。

修正は簡単で、`baseURL`の設定を削除するだけで解決します。

**次のアクション**: BUG-FIX フェーズへ移行し、auth/index.tsの修正を実施