# バグ調査報告書 - 週報画面表示エラー

## 調査日時
2025-08-18 23:03:49

## バグの症状
週報画面を表示時に以下のエラーが発生:
- `RangeError: Invalid time value`
- WeekSelectorコンポーネント（36行目）でエラー発生
- startDateとendDateがInvalid Dateになる

## エラーログ分析
```javascript
// APIレスポンス（生データ）
{
  reports: Array(0),
  total: 0,
  page: 1,
  limit: 10
}

// 変換後のデータ（エラー）
{
  id: undefined,
  startDate: Invalid Date,
  endDate: Invalid Date,
  dailyRecords: Array(0),
  weeklyRemarks: '',
  // ...
}
```

## 根本原因
### 直接的な原因
`getWeeklyReportByDateRange`関数の誤った修正により、APIレスポンス形式の不一致が発生

### 詳細な原因分析
1. **誤った修正内容**（前回の修正）
   - 修正前: `/api/v1/weekly-reports/by-date-range`
   - 修正後: `/api/v1/weekly-reports`
   
2. **レスポンス形式の違い**
   - `/weekly-reports`: 週報リストを返す（`{reports: [], total, page, limit}`）
   - 期待される形式: 単一の週報データ（`{id, startDate, endDate, dailyRecords, ...}`）

3. **影響の流れ**
   ```
   getWeeklyReportByDateRange() 
   → リスト形式のレスポンスを受信
   → 単一週報として処理しようとする
   → startDate/endDateプロパティが存在しない
   → Invalid Date
   → WeekSelectorでformat()失敗
   → RangeError
   ```

## 影響範囲
- 週報画面の表示（完全に機能しない）
- 週の切り替え機能（前週・次週ボタン）
- 週報の作成・編集・提出機能

## 問題の発生条件
- 週報画面にアクセスした時点で必ず発生
- すべてのユーザーに影響

## 修正方法

### オプション1: getWeeklyReportByDateRange関数の修正（推奨）
```typescript
// src/lib/api/weeklyReport.ts
export const getWeeklyReportByDateRange = async (startDate: string, endDate: string, signal?: AbortSignal): Promise<ApiWeeklyReport | null> => {
  try {
    const client = createPresetApiClient('auth');
    const params = new URLSearchParams({
      start_date: startDate,
      end_date: endDate
    });
    
    // リスト形式のレスポンスを取得
    const response = await client.get(`${WEEKLY_REPORT_API.LIST}?${params.toString()}`, { signal });
    
    // レスポンスからreports配列を取得
    const data = response.data;
    if (data.reports && data.reports.length > 0) {
      // 最初の週報を返す（日付範囲に一致する週報は通常1つ）
      const convertedReport = convertSnakeToCamel<ApiWeeklyReport>(data.reports[0]);
      const { weeklyMood, ...rest } = convertedReport;
      return rest;
    }
    
    // 週報が見つからない場合はnullを返す（新規作成モード）
    return null;
  } catch (error) {
    // エラーハンドリング（既存のまま）
    // ...
  }
};
```

### オプション2: バックエンドに専用エンドポイント追加
新規エンドポイント `/weekly-reports/by-date-range` を作成し、単一の週報を返すようにする。
（バックエンドの変更が必要で工数が大きい）

## 以前の修正の問題点
前回の404エラー修正で、エンドポイントURLを変更しましたが、レスポンス形式の違いを考慮していませんでした:
- `/by-date-range`エンドポイントが存在しないと判断
- 代わりに`/weekly-reports`を使用するよう変更
- しかし、レスポンス形式が異なることを見落とし

## 回避策
現時点では回避策なし。修正が必要。

## 推奨アクション
1. getWeeklyReportByDateRange関数を修正（オプション1）
2. 修正後、以下をテスト:
   - 週報画面の初期表示
   - 前週・次週ボタンの動作
   - 新規週報作成
   - 既存週報の編集

## 学習事項
- APIエンドポイント変更時は、レスポンス形式も必ず確認する
- リスト形式と単一オブジェクト形式の違いに注意
- エラーログの詳細な分析が重要（今回はレスポンスデータの形式違いが明確に出ていた）