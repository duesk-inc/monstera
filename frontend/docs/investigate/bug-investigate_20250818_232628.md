# バグ調査報告書 - 認証APIパス重複エラー

## 調査日時
2025-08-18 23:26:28

## バグの症状
1. 週報画面表示時に404エラーが発生
2. エラーメッセージ: `Error in loadWeeklyReport` / `code: 'NOT_FOUND'`
3. 時間経過後、画面がリロードされユーザーメニューに「？」と表示される

## エラーログ分析

### フロントエンドログ
```javascript
errorUtils.ts:195 🚨 Error in loadWeeklyReport
Error object: {
  error: {code: 'NOT_FOUND', message: '404 page not found', details: {...}}
  status: 404
  timestamp: "2025-08-18T14:19:06.343Z"
}
```

### バックエンドログ
```
HTTP Request {"method": "GET", "path": "/api/v1/api/v1/auth/me", "status": 404}
```

## 根本原因
APIパスの重複により404エラーが発生

### 問題箇所
`frontend/src/lib/api/auth/index.ts:242`
```typescript
const response = await client.get('/api/v1/auth/me');
```

### 原因の詳細
1. `createPresetApiClient('auth')`で作成されたクライアントは既に`baseURL`として`/api/v1`を持っている
2. そのクライアントに対して`/api/v1/auth/me`を指定している
3. 結果として`/api/v1/api/v1/auth/me`という重複したパスでリクエストが送信される

### APIクライアント構築フロー
```
1. createPresetApiClient('auth')
   ↓
2. UnifiedApiFactory.buildBaseURL()
   → `${host}/api/${version}` = "http://localhost:8080/api/v1"
   ↓
3. client.get('/api/v1/auth/me')
   ↓
4. 最終URL: "http://localhost:8080/api/v1/api/v1/auth/me" ❌
```

## 影響範囲
- **直接的影響**: 
  - ユーザー認証情報の取得失敗
  - ユーザーメニューの表示異常（「？」表示）
  - 週報画面の機能制限

- **影響箇所**: 
  - `/lib/api/auth/index.ts`の`getCurrentUser`関数のみ
  - 他のAPIエンドポイントには同様の問題なし（確認済み）

## 修正方法

### 修正箇所
`frontend/src/lib/api/auth/index.ts:242`

### 修正前
```typescript
const response = await client.get('/api/v1/auth/me');
```

### 修正後
```typescript
const response = await client.get('/auth/me');
```

## 関連ファイル
1. `frontend/src/lib/api/auth/index.ts` - 問題のあるコード
2. `frontend/src/lib/api/factory/index.ts` - APIクライアントファクトリ
3. `frontend/src/lib/api/config/env.ts` - 環境設定

## テスト項目
1. ユーザー認証情報の取得が正常に動作すること
2. ユーザーメニューが正しく表示されること
3. 週報画面が正常に表示されること
4. 404エラーが発生しないこと

## 類似問題の確認
以下のコマンドで他の箇所に同様の問題がないことを確認：
```bash
# GETメソッド
grep -r "client\.get(['\"]\/api\/v1" src/
# 結果: 1件のみ（今回の問題箇所）

# その他のHTTPメソッド
grep -r "client\.(post|put|delete|patch)(['\"]\/api\/v1" src/
# 結果: 0件
```

## 学習事項
1. **APIクライアントのbaseURL認識**: `createPresetApiClient`で作成されたクライアントは既にベースパスを持っている
2. **パス指定の原則**: プリセットクライアントを使用する場合、`/api/v1`を含めずにエンドポイントのパスのみを指定する
3. **統一的な使用方法**: 
   - 正しい: `client.get('/auth/me')`
   - 誤り: `client.get('/api/v1/auth/me')`

## 回避策
修正が適用されるまでの回避策はなし。修正が必要。

## 推奨アクション
1. `getCurrentUser`関数のパスを修正
2. 修正後、フロントエンドコンテナを再起動
3. 動作確認（認証情報取得、ユーザーメニュー表示）
4. 同様の問題を防ぐため、コーディング規約に追加