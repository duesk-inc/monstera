# バグ調査レポート - ログイン画面404エラー

**調査日時**: 2025-01-19 00:02:18  
**調査者**: Claude Code  
**バグID**: AUTH-LOGIN-404  
**重要度**: 🔴 Critical（ログイン不可）

## 1. エラー概要

### 症状
- ログイン画面でCognito認証を実行時に404エラーが発生
- エラーURL: `/api/v1/api/v1/auth/login` （パスの重複）
- ユーザーはシステムにログインできない状態

### エラーログ
```
:8080/api/v1/api/v1/auth/login:1  Failed to load resource: the server responded with a status of 404 (Not Found)
logger.ts:444 === API レスポンスエラー API エラー ===
logger.ts:447 エラー: Request failed with status code 404
```

## 2. 根本原因

### 原因の特定
**APIパスの二重付与問題**

認証APIクライアント実装において、APIパスに`/api/v1`プレフィックスが二重に付与されている。

**問題のコード位置**: `frontend/src/lib/api/auth/index.ts`

1. **ログイン処理** (Line 41):
```typescript
// 問題のコード
const response = await client.post<LoginResponse>('/api/v1/auth/login', credentials);
```

2. **トークンリフレッシュ処理** (Line 116):
```typescript
// 問題のコード  
const response = await client.post<RefreshTokenResponse>('/api/v1/auth/refresh');
```

3. **ログアウト処理** (Line 186):
```typescript
// 問題のコード
const response = await client.post<LogoutResponse>('/api/v1/auth/logout');
```

### 技術的背景
- `createPresetApiClient('auth')` は内部で `baseURL: http://localhost:8080/api/v1` を設定
- 上記のコードで `/api/v1/auth/login` を指定すると、最終的なURLは:
  - baseURL + path = `http://localhost:8080/api/v1` + `/api/v1/auth/login`
  - 結果: `http://localhost:8080/api/v1/api/v1/auth/login` (重複)

## 3. 影響範囲

### 影響を受ける機能
| 機能 | ファイル | 行番号 | 影響度 |
|------|----------|--------|--------|
| ログイン | `auth/index.ts` | 41 | Critical |
| トークンリフレッシュ | `auth/index.ts` | 116 | Critical |
| ログアウト | `auth/index.ts` | 186 | High |

### 影響を受けるユーザー
- **全ユーザー**: ログイン機能が完全に動作しない
- **セッション管理**: トークンリフレッシュが失敗するため、セッション維持不可
- **セキュリティ**: ログアウトが正常に実行されない

### データ整合性への影響
- なし（APIエンドポイントに到達できないため、データ操作は発生しない）

### セキュリティへの影響
- 直接的な脆弱性はないが、ログアウトが失敗することでセッション管理に問題が生じる可能性

## 4. 修正方針

### 推奨される修正
```typescript
// 修正前
const response = await client.post<LoginResponse>('/api/v1/auth/login', credentials);

// 修正後
const response = await client.post<LoginResponse>('/auth/login', credentials);
```

### 修正対象
1. `login` 関数: `/api/v1/auth/login` → `/auth/login`
2. `refreshToken` 関数: `/api/v1/auth/refresh` → `/auth/refresh`
3. `logout` 関数: `/api/v1/auth/logout` → `/auth/logout`

## 5. 関連する過去の修正

### 類似パターンの修正履歴
- **2025-01-18**: 週報APIクライアントで同様のパス重複問題を修正
  - `weeklyReport.ts`: Line 242, 384, 495で同じパターンの問題を解決
  - 修正ドキュメント: `docs/api-client-fixes-2025-01-18.md`

## 6. 回避策

### 一時的な回避策
現在、回避策はありません。コードの修正が必要です。

## 7. テスト項目

修正後に以下のテストを実施：
1. ログイン機能の動作確認
2. トークンリフレッシュの動作確認
3. ログアウト機能の動作確認
4. APIパスが正しく構築されることの確認（ネットワークタブで検証）

## 8. 予防策

### 今後の対策
1. **コーディング規約の徹底**
   - `createPresetApiClient` 使用時は相対パス（例: `/auth/login`）を使用
   - `/api/v1` プレフィックスは付けない

2. **APIクライアント実装ガイドライン**
   - `CLAUDE.frontend.md` に記載されている規約の遵守
   - プリセットクライアントの正しい使用方法の周知

3. **自動テスト**
   - APIパスの重複を検出するユニットテストの追加
   - E2Eテストでのログインフローの確認

## 9. 結論

このバグは、APIクライアントの移行時に発生した実装ミスです。`createPresetApiClient` が既にベースパスを含んでいることを考慮せず、フルパスを指定したことが原因です。

修正は単純で、影響範囲も明確です。同様のパターンは週報APIで既に修正済みのため、その修正を参考に実装可能です。

**次のアクション**: BUG-FIX フェーズへ移行し、修正を実施