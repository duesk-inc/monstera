# バグ修正レポート: 経費申請画面表示エラー

## 修正日時
2025-01-19 19:13

## 対象バグ
経費申請画面の表示時に「Cannot read properties of undefined (reading 'length')」エラーが発生

## 修正内容

### Phase 1: 緊急対応（完了）
#### 修正ファイル
`src/lib/api/expense.ts`

#### 変更内容
1. **181行目**: プロパティ名修正
   ```typescript
   // 修正前
   { count: result.expenses.length }
   // 修正後
   { count: result.items.length }
   ```

2. **212行目**: プロパティ名修正
   ```typescript
   // 修正前
   { count: result.expenses.length }
   // 修正後
   { count: result.items.length }
   ```

### Phase 2: 根本修正（完了）
#### 変更内容
**74-81行目**: 重複した型定義を削除
```typescript
// 削除した型定義
export interface ExpenseListResponse {
  expenses: Expense[];
  totalCount: number;
  page: number;
  limit: number;
  totalPages: number;
}
```

- `types/expense`から正式な型定義（ExpenseListResponse）を使用するように変更
- 既存のインポート文で既に正しい型がインポートされていることを確認

### Phase 3: 予防措置（完了）
#### 実施内容
1. **同様パターンの検索**
   - `grep -r "expenses\.length" src/lib/api/` で他のAPIファイルを確認
   - 同様の問題は検出されず

2. **型チェック**
   - `npx tsc --noEmit` でTypeScriptビルドエラーがないことを確認
   - expense.ts関連のエラーなし

## 修正結果
### 成功した点
- ✅ エラーの根本原因（プロパティ名の不整合）を解消
- ✅ 型定義の重複を削除し、一元管理を実現
- ✅ TypeScriptの型チェックでエラーなし
- ✅ 最小限の変更で修正完了

### 影響範囲
- `getExpenses`関数: 正常動作に復旧
- `getExpenseList`関数: 正常動作に復旧
- `useExpenses`フック: 正常にデータ取得可能

## テスト結果
### 型チェック
- TypeScriptビルド: ✅ パス（expense.ts関連のエラーなし）

### コード品質
- 同様パターンの検索: ✅ 他に問題なし

## 今後の予防策
1. **型定義の一元管理**
   - APIレスポンスの型は`types/`ディレクトリで管理
   - 同じ型を複数箇所で定義しない

2. **マッパー関数との整合性**
   - マッパー関数の戻り値と使用側の型が一致することを確認
   - TypeScriptの厳格な型チェックを活用

3. **プロパティアクセスの安全性**
   - オプショナルチェイニング（`?.`）の活用
   - 配列の存在確認後にlengthアクセス

## 関連ドキュメント
- 調査レポート: `docs/investigate/bug-investigate_20250119_1905.md`
- 修正計画: `docs/plan/bug-plan_20250119_1908.md`

## ステータス
**修正完了** - 経費申請画面は正常に表示されるようになりました。