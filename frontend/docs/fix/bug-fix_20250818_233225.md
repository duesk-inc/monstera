# バグ修正報告書 - 認証APIパス重複エラー

## 修正日時
2025-08-18 23:32:25

## 修正したバグ
認証APIの呼び出しでパスが重複し、404エラーが発生していた問題

## 根本原因
`createPresetApiClient('auth')`で作成されたクライアントは既にbaseURL（`/api/v1`）を持っているにも関わらず、APIコール時に再度`/api/v1`を含むパスを指定していたため、`/api/v1/api/v1/auth/me`という重複したパスでリクエストが送信されていた。

## 修正内容

### 修正ファイル
- `frontend/src/lib/api/auth/index.ts`

### 修正箇所
242行目の`getCurrentUser`関数内のAPI呼び出し

### 修正前のコード
```typescript
// 現在のユーザー情報を取得
const response = await client.get('/api/v1/auth/me');
```

### 修正後のコード
```typescript
// 現在のユーザー情報を取得
const response = await client.get('/auth/me');
```

## 修正の影響範囲
以下の機能が正常に動作するようになった：
- ユーザー認証情報の取得
- ユーザーメニューの正常表示（「？」表示の解消）
- 週報画面の正常動作
- その他の認証が必要な機能全般

## テスト結果

### APIエンドポイントテスト
```bash
# 正しいエンドポイント (/api/v1/auth/me)
実際のリクエスト: http://localhost:8080/api/v1/auth/me
結果: 200 OK ✓

# 誤ったエンドポイント (/api/v1/api/v1/auth/me)
実際のリクエスト: http://localhost:8080/api/v1/api/v1/auth/me
結果: 404 Not Found ✓（期待通りエラー）
```

### 動作確認
- Dockerコンテナの再起動: ✅ 完了
- 認証APIの正常動作: ✅ 確認済み
- 404エラーの解消: ✅ 確認済み

## リグレッションテスト
- 他のAPIエンドポイントへの影響: なし（単一箇所の修正）
- 認証フローへの影響: 改善（正常動作に回復）

## 学習事項

### 1. APIクライアントのbaseURL理解
`createPresetApiClient`で作成されたクライアントは、ファクトリ内で以下のようにbaseURLを構築している：
```typescript
baseURL = `${host}/api/${version}` // 例: http://localhost:8080/api/v1
```

### 2. 正しいパス指定方法
- **誤り**: `client.get('/api/v1/auth/me')` → `/api/v1/api/v1/auth/me`
- **正解**: `client.get('/auth/me')` → `/api/v1/auth/me`

### 3. コーディング規約への追加提案
プリセットAPIクライアント使用時のパス指定ルール：
- `createPresetApiClient`を使用する場合、パスに`/api/v1`を含めない
- エンドポイントのパスのみを指定する（例: `/auth/me`, `/users`, `/weekly-reports`）

## 今後の改善提案

### 1. ESLintルールの追加
APIクライアントのパス指定で`/api/v1`が含まれている場合に警告を出すカスタムルール

### 2. TypeScript型定義の強化
```typescript
type EndpointPath = `/${string}` & { _brand: 'EndpointPath' };
// /api/v1 を含むパスをコンパイルエラーにする
```

### 3. 開発環境でのデバッグログ強化
実際のリクエストURLをログ出力して、パス重複を早期発見

## 関連ドキュメント
- 調査報告: `docs/investigate/bug-investigate_20250818_232628.md`
- メモリ: `api_client_path_duplication_pattern`
- テストスクリプト: `test-auth-api.sh`

## クリーンアップ
テストスクリプトを削除：
```bash
rm test-auth-api.sh
```