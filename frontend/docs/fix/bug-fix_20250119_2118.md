# バグ修正レポート: notificationsテーブル recipient_idカラム追加

## 修正日時
2025-01-19 21:18

## 対象バグ
経費申請提出時の500エラー（通知作成失敗）

## 修正内容

### Phase 1: 緊急対応（完了）
#### 修正ファイル
1. `backend/migrations/300004_add_recipient_id_to_notifications.up.sql` (新規作成)
2. `backend/migrations/300004_add_recipient_id_to_notifications.down.sql` (新規作成)

#### 実施内容

##### Step 1.1: 現在のスキーマ確認（完了）
- notificationsテーブルに`recipient_id`カラムが存在しないことを確認
- 既存データ4件の存在を確認

##### Step 1.2: マイグレーションファイル作成（完了）
**upマイグレーション**:
```sql
-- notificationsテーブルにrecipient_idカラムを追加
ALTER TABLE notifications 
ADD COLUMN IF NOT EXISTS recipient_id VARCHAR(255) NULL;

-- インデックスを追加（検索性能向上）
CREATE INDEX IF NOT EXISTS idx_notifications_recipient 
ON notifications(recipient_id);

-- 外部キー制約を追加（データ整合性確保）
ALTER TABLE notifications
ADD CONSTRAINT fk_notifications_recipient 
FOREIGN KEY (recipient_id) 
REFERENCES users(id) 
ON DELETE CASCADE 
ON UPDATE CASCADE;

-- コメント追加
COMMENT ON COLUMN notifications.recipient_id IS '受信者ID（Cognito Sub）';
```

**downマイグレーション**:
```sql
-- 外部キー制約を削除
ALTER TABLE notifications 
DROP CONSTRAINT IF EXISTS fk_notifications_recipient;

-- インデックスを削除
DROP INDEX IF EXISTS idx_notifications_recipient;

-- カラムを削除
ALTER TABLE notifications 
DROP COLUMN IF EXISTS recipient_id;
```

##### Step 1.3: マイグレーション適用（完了）
- マイグレーション番号: 300004
- 実行時間: 47.452417ms
- 適用結果: 成功

##### Step 1.4: 初期動作確認（完了）
- スキーマ変更の確認: ✅
  - recipient_idカラム追加
  - idx_notifications_recipientインデックス作成
  - fk_notifications_recipient外部キー制約追加
- 既存データの確認: ✅
  - 4件のデータすべてrecipient_id=NULLで正常
- バックエンド再起動: ✅

## 修正結果
### 成功した点
- ✅ recipient_idカラムの追加に成功
- ✅ 既存データへの影響なし（NULLABLEカラムとして追加）
- ✅ 外部キー制約とインデックスの適切な設定
- ✅ ロールバック可能な設計（downマイグレーション準備済み）

### 影響範囲
- notificationsテーブル: スキーマ変更（カラム追加）
- 通知作成機能: 正常動作への復旧見込み
- 既存データ: 影響なし

## テスト結果
### スキーマ検証
- [ ] recipient_idカラムの存在確認 → ✅ 完了
- [ ] インデックスの作成確認 → ✅ 完了
- [ ] 外部キー制約の確認 → ✅ 完了

### 機能テスト（ユーザー確認待ち）
- [ ] 経費申請の「作成して提出」 → 確認待ち
- [ ] 500エラーが発生しないこと → 確認待ち
- [ ] 通知データの作成確認 → 確認待ち

## 今後の作業

### Phase 2: 検証とテスト（次のステップ）
1. 通知作成の動作確認
2. 既存機能への影響確認
3. パフォーマンス確認

### Phase 3: 予防措置（将来的な作業）
1. 他のテーブルのスキーマ整合性確認
2. テストケース追加
3. ドキュメント更新

## ロールバック手順（必要な場合）
```bash
# マイグレーションのロールバック
docker-compose exec backend migrate \
  -path migrations \
  -database "postgres://postgres:postgres@postgres:5432/monstera?sslmode=disable" \
  down 1

# バックエンド再起動
docker-compose restart backend
```

## 関連ドキュメント
- 調査レポート: `docs/investigate/bug-investigate_20250119_2053.md`
- 修正計画: `docs/plan/bug-plan_20250119_2100.md`
- マイグレーション: `backend/migrations/300004_add_recipient_id_to_notifications.up.sql`

## 追加修正（2025-01-19 22:30）

### 追加で発見された問題
モデル定義には`Status`フィールドも定義されているが、データベーススキーマには存在しなかった。
同様に`Metadata`と`ReadAt`フィールドも欠落していた。

### 追加マイグレーション
**ファイル**: `backend/migrations/300005_add_status_metadata_to_notifications.up.sql`
```sql
-- notificationsテーブルにstatusカラムを追加
ALTER TABLE notifications 
ADD COLUMN IF NOT EXISTS status VARCHAR(20) NOT NULL DEFAULT 'unread';

-- statusカラムの値を制限するCHECK制約を追加
ALTER TABLE notifications
ADD CONSTRAINT notifications_status_check 
CHECK (status IN ('unread', 'read', 'hidden'));

-- インデックスを追加（検索性能向上）
CREATE INDEX IF NOT EXISTS idx_notifications_status 
ON notifications(status);

-- metadataカラムを追加（JSON型）
ALTER TABLE notifications
ADD COLUMN IF NOT EXISTS metadata JSON;

-- read_atカラムを追加
ALTER TABLE notifications
ADD COLUMN IF NOT EXISTS read_at TIMESTAMP(3);
```

- マイグレーション番号: 300005
- 実行時間: 29.830625ms
- 適用結果: 成功

## ステータス
**Phase 1完了（追加修正含む）** - 動作確認待ち