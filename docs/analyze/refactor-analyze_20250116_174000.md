# リファクタリング分析報告書 - スキルシート編集ダイアログ

## 分析日時
2025-01-16 17:40:00

## 分析対象
`frontend/src/components/features/skillSheet/WorkHistoryEditDialog.tsx`の保存ボタン構成

## 現状分析

### 現在のボタン構成
```
最終ステップ（ステップ3）のボタン配置:
├─ [戻る] - 前のステップに戻る
├─ [個別保存] - 職務経歴を保存（アウトラインボタン）
├─ [キャンセル] - ダイアログを閉じる
└─ [保存して閉じる] - 職務経歴を保存してダイアログを閉じる（プライマリボタン）
```

### 問題点

#### 1. 機能の重複
- **「個別保存」ボタン**（line 872-891）
  - `handleIndividualSave()`を実行
  - ツールチップ: "この職務経歴のみを保存"
  
- **「保存して閉じる」ボタン**（line 910-916）
  - 同じ`handleIndividualSave()`を実行
  - 実質的に同じ処理

**両ボタンが同じ関数を呼び出しているため、機能が完全に重複している**

#### 2. UXの問題
- ユーザーが2つの保存ボタンの違いを理解しにくい
- 両方とも同じ処理をするなら、なぜ2つあるのか混乱を招く
- 確認なしで即座に保存されるため、誤操作のリスクがある

#### 3. 設計上の問題
- 確認ダイアログがない
- 保存後に自動的にダイアログが閉じる（ユーザーの意図と異なる可能性）
- エラー時のリカバリーが考慮されていない

### 共存している理由
過去の実装の名残と推測される：
1. 当初は異なる機能を想定していた可能性
2. フィーチャーフラグ対応時に追加されたが、統合されなかった
3. 「保存して閉じる」と「保存のみ」を区別する予定だったが、実装されなかった

## 改善提案

### 1. ボタンの統一
- 「個別保存」ボタンを削除
- 「保存して閉じる」を「保存する」に変更
- 1つの明確な保存ボタンのみを提供

### 2. 確認ダイアログの追加
```typescript
// 新しいstate
const [showSaveConfirm, setShowSaveConfirm] = useState(false);

// 保存ボタンクリック時
const handleSaveClick = () => {
  setShowSaveConfirm(true);
};

// 確認ダイアログでOK時
const handleConfirmSave = async () => {
  setShowSaveConfirm(false);
  await handleIndividualSave();
};
```

### 3. 処理フローの改善
現在:
```
[保存ボタン] → バリデーション → API呼び出し → 成功 → ダイアログを閉じる
```

改善後:
```
[保存ボタン] → 確認ダイアログ → [OK] → バリデーション → API呼び出し → 成功 → トースト通知
                     ↓
                 [キャンセル] → 何もしない
```

### 4. 保存後の動作
- ダイアログは開いたままにする
- 成功メッセージを表示
- ユーザーが明示的に「閉じる」または「キャンセル」を押すまで継続編集可能

## 必要な作業

### Phase 1: UIの簡潔化
1. 「個別保存」ボタンの削除（line 872-891）
2. 「保存して閉じる」ラベルを「保存する」に変更

### Phase 2: 確認ダイアログの実装
1. 保存確認用のstate追加
2. ConfirmDialogコンポーネントの追加
3. 保存フローの変更

### Phase 3: 保存後の動作改善
1. `handleIndividualSave`から`onClose()`の呼び出しを削除
2. 成功時のフィードバック強化
3. エラー時のリトライ機能追加（オプション）

## リスク評価
- **リスクレベル**: 低
- **影響範囲**: 編集ダイアログのみ
- **破壊的変更**: なし
- **ユーザー影響**: UX改善

## 実装の優先順位
1. **高**: ボタンの統一（即座に実装可能）
2. **高**: 確認ダイアログの追加（ユーザー要望）
3. **中**: 保存後の動作改善

## 結論
現在の2つの保存ボタンは機能が重複しており、ユーザーを混乱させる原因となっている。
ボタンを1つに統一し、確認ダイアログを追加することで、より直感的で安全な操作を提供できる。