# バックエンド開発標準仕様書

## 目次

1. [アーキテクチャの原則](#アーキテクチャの原則)
2. [ディレクトリ構造](#ディレクトリ構造)
3. [レイヤー設計](#レイヤー設計)
4. [共通パッケージ概要](#共通パッケージ概要)
5. [認証システム](#認証システム)
6. [ユーザー管理機能](#ユーザー管理機能)
7. [エラーハンドリング](#エラーハンドリング)
8. [型定義とDTO](#型定義とdto)
9. [命名規則](#命名規則)
10. [テスト方針](#テスト方針)
11. [パフォーマンス最適化](#パフォーマンス最適化)
12. [環境別の処理](#環境別の処理)
13. [実装統一ルール](#実装統一ルール)
14. [新機能追加ガイドライン](#新機能追加ガイドライン)
15. [ファイル作成・配置基準](#ファイル作成配置基準)

## アーキテクチャの原則

当プロジェクトでは以下の原則に基づいたバックエンド開発を行います：

- **レイヤー分離**: ハンドラー、サービス、リポジトリの責務を明確に分離
- **依存性注入**: インターフェースによる疎結合な設計
- **トランザクション管理**: 一貫したデータ整合性の確保
- **エラーハンドリング**: 統一されたエラー処理パターン
- **ログ記録**: 適切なレベルでの詳細なログ記録
- **テスト容易性**: モック化とテストしやすいコード構造

## ディレクトリ構造

```
backend/
├── cmd/               # エントリーポイント
│   ├── server/        # サーバー起動コード
│   ├── batch/         # バッチ処理エントリーポイント
│   └── migrate-users/ # ユーザー移行ツール
├── internal/          # 内部パッケージ
│   ├── auth/          # 認証実装
│   ├── batch/         # バッチ処理コンポーネント
│   ├── cache/         # Redisキャッシュ層
│   ├── common/        # 共通機能
│   ├── config/        # アプリケーション設定
│   ├── constants/     # エラーコード定義
│   ├── db/            # データベース接続管理
│   ├── dto/           # データ転送オブジェクト
│   ├── errors/        # エラーハンドリング
│   ├── handler/       # HTTPリクエストハンドラー
│   ├── logger/        # ロギングユーティリティ
│   ├── message/       # メッセージ定数
│   ├── metrics/       # Prometheusメトリクス
│   ├── middleware/    # HTTPミドルウェア
│   ├── model/         # データモデル（60+ファイル）
│   ├── repository/    # データアクセス層
│   ├── routes/        # ルート定義
│   ├── security/      # セキュリティユーティリティ
│   ├── service/       # ビジネスロジック
│   ├── testutils/     # テストユーティリティ
│   ├── utils/         # 各種ユーティリティ
│   └── validator/     # バリデーションロジック
├── migrations/        # DBマイグレーションファイル
├── templates/         # HTMLテンプレート（PDF生成用）
└── 設定ファイル (go.mod, go.sum等)
```

### ディレクトリ配置の原則

- **機能単位のグループ化**: 関連するファイルは機能単位でまとめる
- **レイヤー別分離**: 各レイヤーは独立したディレクトリに配置
- **共通と固有の分離**: 共通機能と機能固有のファイルを明確に分離

## レイヤー設計

### ハンドラー層（Handler）

HTTPリクエストを受け付け、適切なサービス層のメソッドを呼び出し、レスポンスを生成する責務を持ちます。

#### 主な責務
- リクエストのバリデーション
- 認証・認可チェック
- サービス層の呼び出し
- レスポンスの整形
- エラーハンドリング

#### 設計原則
- インターフェースと実装の分離
- 統一されたエラーレスポンス
- 適切なステータスコードの返却
- コンテキストの伝播

詳細仕様: [ハンドラー層実装ガイド](./backend-handler-implementation.md)

### サービス層（Service）

ビジネスロジックを実装し、必要に応じて複数のリポジトリを組み合わせて処理を行います。

#### 主な責務
- ビジネスルールの実装
- トランザクション管理
- DTO⇔モデル間の変換
- 複数リポジトリの調整
- 詳細なログ記録

#### 設計原則
- 単一責任の原則
- トランザクション境界の適切な設定
- エラーのラッピングと詳細化
- 再利用可能な処理の共通化

詳細仕様: [サービス層実装ガイド](./backend-service-implementation.md)

### リポジトリ層（Repository）

データアクセスを担当し、データベースとの通信を抽象化します。

#### 主な責務
- データベースアクセス
- クエリの最適化
- データの永続化
- トランザクション制御

#### 設計原則
- 共通リポジトリ機能の活用
- パフォーマンス最適化
- エラーハンドリングの統一
- テスト容易性の確保

詳細仕様: [リポジトリ層実装ガイド](./backend-repository-implementation.md)

## 共通パッケージ概要

### BaseRepository

基本的なデータベース操作を提供する共通インターフェースです。

- **WithContext**: コンテキスト付きクエリ実行
- **ExecuteInTransaction**: トランザクション内関数実行
- **ValidateID**: ID妥当性検証
- **NewID**: UUID生成

### TransactionManager

一貫したトランザクション管理を提供します。

- **統一されたトランザクション制御**
- **エラー時の自動ロールバック**
- **ネストしたトランザクションの管理**

### Logger

標準化されたロギング機能を提供します。

- **構造化ログ**
- **レベル別ログ記録**
- **エラーラッピング機能**

詳細仕様: [共通パッケージ仕様](./backend-common-packages.md)

## 認証システム

### 認証方式

ハイブリッド認証システムを採用しています：

#### Cognito認証
- **アクセストークン**: 標準的な有効期限（1時間）
- **リフレッシュトークン**: 長期間（30日間）の有効期限
- **HTTPOnlyクッキー**: XSS攻撃対策

#### AWS Cognito認証（オプション）
- **統合認証**: AWS Cognitoとの連携
- **MFA対応**: 多要素認証のサポート
- **認証ファクトリー**: `auth_factory.go`による認証方式の切り替え

### セキュリティ特徴

- **XSS攻撃からの保護**: HTTPOnlyクッキーによるトークン保護
- **トークン漏洩リスクの低減**: 短期間アクセストークン
- **シームレスな認証更新**: 自動リフレッシュ機能
- **クライアント側の簡素化**: サーバー側でのトークン管理

詳細仕様: [認証システム実装](./backend-auth-implementation.md)

## ユーザー管理機能

### アカウント有効/無効機能

ユーザーアカウントには`active`フラグが設定されており、アカウントの有効/無効を管理しています。

#### 機能仕様

- **データベース**: `users`テーブルの`active`カラム（BOOLEAN型、デフォルト: true）
- **認証時の検証**: ログイン時およびトークンリフレッシュ時にアカウントの有効性を確認
- **エラーメッセージ**: 無効化されたアカウントでのログイン試行時は「このアカウントは現在無効化されています」を返却

#### 実装箇所

- **認証サービス**: `auth_service.go`の`Login`および`RefreshToken`メソッドで有効性チェック
- **ユーザーモデル**: `user.go`の`Active`フィールド（bool型）

#### 運用方法

1. **アカウント無効化**: 管理者がDBの`active`フィールドを`false`に更新
2. **アカウント有効化**: 管理者がDBの`active`フィールドを`true`に更新
3. **影響**: 無効化されたユーザーは新規ログインおよびトークンリフレッシュが不可

### 今後の拡張計画

- 管理画面からのアカウント有効/無効切り替え機能
- アカウント無効化理由の記録機能
- 無効化履歴の管理機能

## エラーハンドリング

### エラー処理の原則

1. **一貫性**: 統一されたエラーハンドリングパターン
2. **階層化**: システム、ビジネス、認証エラーの分類
3. **ログ記録**: 適切なレベルでのエラーログ記録
4. **ユーザー体験**: 適切なエラーメッセージの提供

### エラー種別

- **システムエラー**: データベース接続エラー、内部処理エラー
- **ビジネスエラー**: ビジネスルール違反、バリデーションエラー
- **認証・認可エラー**: 権限不足、認証失敗

### 統一レスポンス形式

```go
type ErrorResponse struct {
    Error   string            `json:"error"`
    Code    string            `json:"code,omitempty"`
    Details map[string]string `json:"details,omitempty"`
}
```

## 型定義とDTO

### DTO設計原則

1. **命名規則**: JSONタグはスネークケース（snake_case）で統一
2. **データベース整合性**: DBカラム名との一致
3. **フロントエンド連携**: 変換処理による対応
4. **日付形式**: 統一された日付フォーマット

### 日付・時刻データの取り扱い

- **完全な日付**: `YYYY-MM-DD`形式
- **年月のみ**: `YYYY-MM`形式  
- **日時**: ISO 8601形式

### ステータスデータの取り扱い

- **新規実装**: 文字列型として定義（データベースのENUM値と一致）
- **既存実装の移行**: INT型から文字列型への段階的移行をサポート
- **型定義**: string型を使用し、定数で値を管理

### 実装例

```go
// ステータス定数の定義（constants/status.go）
const (
    StatusDraft     = "draft"
    StatusSubmitted = "submitted"
    StatusApproved  = "approved"
    StatusRejected  = "rejected"
)

// エラーコード定義（constants/error_codes.go）
const (
    // 経費申請基本操作 (E001)
    ErrExpenseTitleRequired = "E001V001" // 件名は必須です
    ErrExpenseAmountInvalid = "E001V002" // 金額は1円以上1000万円以下で入力してください
    
    // 承認フロー管理 (E002)
    ErrAlreadyApproved     = "E002B001" // この申請は既に承認済みです
    ErrNoApprovalAuthority = "E002B003" // 承認権限がありません
)

// DTO定義
type UserRequest struct {
    Name      string `json:"name"`
    Email     string `json:"email"`
    Status    string `json:"status"`    // ENUM値と一致する文字列
    CreatedAt string `json:"created_at"` // ISO 8601形式
}

// 既存INT型との互換性維持（移行期間中のみ）
func ConvertLegacyStatus(intStatus int) string {
    switch intStatus {
    case 1:
        return StatusDraft
    case 2:
        return StatusSubmitted
    case 3:
        return StatusApproved
    case 4:
        return StatusRejected
    default:
        return StatusDraft
    }
}
```

## 命名規則

### ファイル命名

- **ハンドラー**: `<機能名>_handler.go`
- **サービス**: `<機能名>_service.go`
- **リポジトリ**: `<機能名>_repository.go`
- **DTO**: `<機能名>_dto.go`
- **モデル**: `<機能名>.go`

### 変数・関数命名

- **変数**: camelCase（例: `userData`）
- **関数**: PascalCase（エクスポート）、camelCase（非エクスポート）
- **定数**: PascalCase（エクスポート）、camelCase（非エクスポート）
- **型**: PascalCase（例: `UserData`）

### インターフェース命名

- **Handler**: `<機能名>Handler`
- **Service**: `<機能名>Service`
- **Repository**: `<機能名>Repository`

## テスト方針

### テスト戦略

1. **ユニットテスト**: 各レイヤーの個別テスト
2. **統合テスト**: レイヤー間の連携テスト
3. **E2Eテスト**: API全体のワークフローテスト

### テストパターン

- **リポジトリテスト**: 実DBを使用したデータアクセステスト
- **サービステスト**: リポジトリをモック化したビジネスロジックテスト
- **ハンドラーテスト**: サービスをモック化したHTTPテスト

### テストツール

- **testing**: Go標準テストフレームワーク
- **testify**: アサーションとモック
- **go-sqlmock**: データベースモック

## パフォーマンス最適化

### 最適化手法

1. **クエリ最適化**: 適切なインデックス設計とクエリチューニング
2. **N+1問題の回避**: Preloadとバッチ処理
3. **コネクションプール**: 適切なDB接続管理
4. **メモリ管理**: 効率的なデータ構造の使用
5. **キャッシュ活用**: Redisによる頻繁アクセスデータのキャッシュ
6. **デュアル接続**: 読み書き分離によるDB負荷分散

### 監視項目

- **レスポンス時間**: APIエンドポイント別測定
- **スループット**: 秒間リクエスト処理数
- **リソース使用量**: CPU、メモリ、DB接続数
- **Prometheusメトリクス**: カスタムメトリクスによる詳細監視

## 環境別の処理

### 環境変数管理

- **Docker環境**: `docker-compose.yml`内で直接定義
- **本番環境**: 環境変数または設定ファイル

### 設定項目（config/config.go）

- **データベース**: PostgreSQL/MySQL接続設定、コネクションプール
- **Redis**: キャッシュ設定、永続化オプション
- **認証**: トークン有効期限、認証設定
- **Cognito**: AWS設定、ユーザープールID
- **バッチ**: スケジュール設定、実行間隔
- **外部API**: Freee API、Slack、メール設定
- **セキュリティ**: ClamAV、暗号化設定
- **メトリクス**: Prometheus設定

### 環境別設定

- **データベース接続**: 環境に応じたDB設定
- **ログレベル**: 開発環境では詳細、本番では警告以上
- **デバッグ機能**: 開発環境でのみ有効化

## 実装統一ルール

### 既存実装の優先利用

- **共通処理の再利用**: 既存機能の優先利用
- **ユーティリティの活用**: `internal/common/`の積極活用
- **重複コードの排除**: 類似機能の統合とリファクタリング

### 一貫性のある実装パターン

- **処理方針の統一**: 同一階層での統一されたパターン
- **共通処理の利用方法**: 引数順序と戻り値の統一
- **レイヤー間の責務分離**: 適切なレイヤーでの処理実装

### 機能別パッケージ構成

- **機能単位のグループ化**: 関連コードの機能別配置
- **インターフェースと実装の分離**: 依存性注入の実現
- **命名の一貫性**: 統一された命名規則の適用

## 実装済み機能モジュール

### 業務機能
- **週報管理**: 週次報告書の作成・提出・承認フロー
- **休暇管理**: 休暇申請・承認・残日数管理
- **経費申請**: 経費申請・承認・精算処理
- **エンジニア管理**: エンジニア情報・スキル・経歴管理
- **案件管理**: プロジェクト・クライアント情報管理
- **営業管理**: 提案・見積・商談管理
- **請求書管理**: 請求書作成・発行・管理
- **スキルシート**: スキルシートPDF生成・管理

### システム機能
- **バッチ処理**: 
  - アラート通知（Slack連携）
  - メトリクス集計
  - リマインダー送信
  - データアーカイブ
  - 通知クリーンアップ
- **キャッシュ層**: Redisによる高速データアクセス
- **監査ログ**: 全操作の詳細なログ記録
- **ウイルススキャン**: ClamAVによるファイルスキャン
- **メール配信**: テンプレート管理・一括送信
- **レート制限**: API利用制限
- **Webhook**: 外部連携用Webhook

### 外部連携
- **Freee API**: 会計システム連携
- **Slack**: 通知・アラート送信
- **AWS Services**: S3（ファイル保存）、Cognito（認証）

## 新機能追加ガイドライン

### 実装手順

1. **要件分析**: 機能要件と技術要件の明確化
2. **設計検討**: 既存アーキテクチャとの整合性確認
3. **実装**: 本仕様書に従った実装
4. **テスト**: 十分なテストカバレッジの確保
5. **ドキュメント更新**: 仕様書の更新

### 実装順序

```
1. モデル定義 (model/<機能名>.go)
2. DTO定義 (dto/<機能名>_dto.go)
3. リポジトリ実装 (repository/<機能名>_repository.go)
4. サービス実装 (service/<機能名>_service.go)
5. ハンドラー実装 (handler/<機能名>_handler.go)
6. ルーティング設定
7. テスト実装
```

### 考慮事項

- **既存機能への影響**: 破壊的変更の回避
- **パフォーマンス**: 新機能による性能劣化の防止
- **セキュリティ**: 認証・認可の適切な実装

## ファイル作成・配置基準

### ファイル作成時の判断基準

1. **再利用性**: 複数箇所で使用される場合は共通化
2. **責任範囲**: 単一責任の原則に従ったファイル分割
3. **依存関係**: 循環依存の回避
4. **テスト容易性**: テストしやすい粒度での分割

### 配置ディレクトリの選択

- **機能固有**: 特定機能でのみ使用される場合は機能ディレクトリ内
- **共通**: 複数機能で使用される場合は`internal/common/`
- **設定**: アプリケーション設定は`internal/config/`

---

## 詳細実装への参照

本仕様書で概要を説明したコンポーネントの詳細実装については、以下の個別仕様書を参照してください：

### レイヤー別実装ガイド
- [ハンドラー層実装ガイド](./implementation/handler-implementation.md)
- [サービス層実装ガイド](./implementation/service-implementation.md)
- [リポジトリ層実装ガイド](./implementation/repository-implementation.md)

### システム実装
- [認証システム実装](./implementation/auth-implementation.md)
- [共通パッケージ仕様](./implementation/common-packages.md)

---

**最終更新日**: 2025/07/11（実装状況を反映して大幅更新）