# バグ修正報告書: Phase 2 - 経費申請エラーハンドリング完全修正

## 修正日時
2025年1月20日 09:03

## 実施フェーズ
Phase 2: 根本修正

## 修正概要
経費申請関連の全6箇所のswitch文に月次・年次上限超過エラーハンドリングを追加し、HTTPステータスコード500から400への修正を完了しました。

## 修正内容詳細

### Phase 2で修正した5つのメソッド

#### 1. CreateWithReceipts（行1075-1083）
**メソッド**: 領収書付き経費申請の作成
```go
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
```

#### 2. UpdateWithReceipts（行1134-1143）
**メソッド**: 領収書付き経費申請の更新
```go
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
```

#### 3. GetExpenseReceipts（行1185-1193）
**メソッド**: 経費申請の領収書一覧取得
```go
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
```

#### 4. DeleteExpenseReceipt（行1240-1250）
**メソッド**: 経費申請の領収書削除
```go
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
```

#### 5. UpdateReceiptOrder（行1301-1311）
**メソッド**: 領収書の表示順序更新
```go
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
```

## 修正の総括

### 完了した作業
1. **Phase 1（緊急対応）**: SubmitExpenseメソッドの修正
2. **Phase 2（根本修正）**: 残り5つのメソッドの修正

### 全修正箇所
- **合計6箇所**のswitch文を修正
- すべてのエラーハンドリングで統一された処理を実装
- HTTPステータスコード500 → 400への変更を完了

## 技術的詳細

### エラーコードとHTTPステータス
- `dto.ErrCodeMonthlyLimitExceeded` → HTTP 400 (Bad Request)
- `dto.ErrCodeYearlyLimitExceeded` → HTTP 400 (Bad Request)

### 使用した定数
- `constants.ErrMonthlyLimitExceeded` = "E003B001"
- `constants.ErrYearlyLimitExceeded` = "E003B002"

## 影響範囲

### 修正により改善されるAPI
1. `POST /api/v1/expenses/{id}/submit` - 経費申請提出
2. `POST /api/v1/expenses/with-receipts` - 領収書付き経費申請作成
3. `PUT /api/v1/expenses/{id}/with-receipts` - 領収書付き経費申請更新
4. `GET /api/v1/expenses/{id}/receipts` - 領収書一覧取得
5. `DELETE /api/v1/expenses/{id}/receipts/{receiptId}` - 領収書削除
6. `PUT /api/v1/expenses/{id}/receipts/order` - 領収書表示順序更新

## リスク評価

### 低リスク
- 既存のエラーハンドリングには影響なし
- エラーレスポンスの形式は変更なし
- ビジネスロジックの変更なし

### 注意事項
- フロントエンドが500エラーを前提とした処理をしている場合、400エラーに対応する調整が必要
- ただし、適切なエラーハンドリングを実装していれば影響は最小限

## テスト状況

### 実施済み
- 構文エラーチェック: ✅ エラーなし
- コンパイルチェック: ✅ expense_handler.goはエラーなし

### 未実施
- 統合テスト（環境制約により未実行）
- E2Eテスト

## コミット情報

### Phase 1
- コミットID: ddae053
- メッセージ: "fix(expense): Phase 1 - 月次・年次上限超過エラーのHTTPステータスコードを修正"

### Phase 2
- コミットID: 05981e7
- メッセージ: "fix(expense): Phase 2 - 残り5つのswitch文に月次・年次上限エラーハンドリングを追加"

## 次のステップ

### Phase 3: 予防措置（推奨）
1. **テストケースの追加**
   - 各メソッドの月次・年次上限エラーテスト
   - HTTPステータスコードの検証テスト

2. **ドキュメント更新**
   - APIドキュメントのエラーレスポンス例を更新
   - エラーコード一覧に上限エラーを明記

3. **同様のパターンの調査**
   - 他のハンドラーで同様の問題がないか確認
   - エラーハンドリングの統一化

## 成果
Phase 1とPhase 2の完了により、経費申請関連のすべてのAPIで月次・年次上限超過エラーが適切にHTTP 400として返されるようになりました。これにより、ユーザーは明確なエラーメッセージと適切なステータスコードを受け取ることができます。

## 結論
バグ修正は成功裏に完了しました。全6箇所のエラーハンドリングが統一され、システムエラー（500）とビジネスエラー（400）が適切に区別されるようになりました。