# ログイン認証エラーメッセージ修正報告書

## 修正日時
2025年1月4日

## 対応したバグ
調査報告書: `docs/investigate/bug-investigate_20250104_login_error.md`

## 修正概要
Cognitoに登録されていないユーザーでログインした際に表示される不適切なエラーメッセージを改善しました。

### 変更前
- 「認証に失敗しました」→ フロントエンドで「ログインの取得に失敗しました: 不明なエラー」と表示

### 変更後
- 「メールアドレスまたはパスワードが正しくありません」→ ユーザーフレンドリーなメッセージを表示

## 修正内容

### 1. CognitoAuthService.Login メソッドの修正
**ファイル**: `backend/internal/service/cognito_auth_service.go`

```go
// 修正前（185-187行目）
return nil, fmt.Errorf("認証に失敗しました")

// 修正後
return nil, fmt.Errorf("メールアドレスまたはパスワードが正しくありません")
```

### 2. 認証結果取得エラーメッセージの改善
**ファイル**: `backend/internal/service/cognito_auth_service.go`

```go
// 修正前（165, 194行目）
return nil, fmt.Errorf("認証結果が取得できませんでした")

// 修正後
return nil, fmt.Errorf("ログインに失敗しました。しばらく待ってから再度お試しください")
```

### 3. テストケースの追加
**ファイル**: `backend/internal/service/cognito_auth_service_test.go` (新規作成)

- 存在しないユーザーでのログインテスト
- パスワード間違いのテスト
- 無効なメールアドレス形式のテスト
- 空のメールアドレス/パスワードのテスト
- エラーメッセージの一貫性確認テスト

### 4. CognitoConfig構造体の修正
**ファイル**: `backend/internal/config/cognito.go`

TokenExpiration フィールドの定義が壊れていたため修正しました。

## セキュリティ考慮事項

### 採用した方針
セキュリティ重視の実装を採用しました：
- 存在しないユーザーとパスワード間違いで同じエラーメッセージを返す
- ユーザー列挙攻撃を防ぐため、詳細なエラー情報は返さない
- ログにはエラーの詳細を記録するが、ユーザーには汎用的なメッセージを表示

## 影響範囲

### 直接の影響
- `CognitoAuthService.Login` メソッド
- 認証エラー時のユーザー体験

### 間接的な影響
- `internal/service/user_service.go` の `Login` メソッド
- `internal/service/user_service.go` の `ChangePassword` メソッド

これらのメソッドは`CognitoAuthService.Login`を呼び出していますが、エラーメッセージの改善により、より適切なエラーハンドリングが可能になりました。

## テスト状況

### 実装したテスト
- エラーメッセージの期待値を定義したテストケースを作成
- セキュリティ観点でのメッセージ一貫性テストを実装

### 今後必要なテスト
- Cognitoクライアントのモック実装が必要
- 統合テストでの動作確認

## コミット情報
- ブランチ: `bugfix/login-error-message`
- コミットハッシュ: `4a82f0b`

## 次のステップ
1. プルリクエストの作成
2. レビューとフィードバックの反映
3. 本番環境へのデプロイ
4. ユーザーフィードバックの収集

## 追加の改善提案

### 短期的改善
1. フロントエンドでのエラー表示の最適化
2. レート制限の実装（ブルートフォース攻撃対策）

### 長期的改善
1. エラーコードシステムの実装
2. 多言語対応
3. 詳細なログ記録とモニタリング

## まとめ
本修正により、ユーザーがログイン失敗時により適切なフィードバックを受けられるようになりました。セキュリティを維持しながら、ユーザー体験を改善することができました。