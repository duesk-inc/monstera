# 通知優先度制約違反エラー修正完了

## 修正日時
2025年1月20日 11:40

## 修正概要
データベース制約違反により通知作成が失敗していた問題を修正。全6箇所の`NotificationPriorityNormal`を適切な優先度に変更。

## 修正前の問題
```
ERROR: new row for relation "notifications" violates check constraint "notifications_priority_check" (SQLSTATE 23514)
```
- DBテーブル: `notifications.priority`は`'low'`, `'medium'`, `'high'`のみ許可
- コード: `NotificationPriorityNormal`（値: `'normal'`）を使用していた

## 修正内容

### 1. notification_service.go（4箇所）
| 行番号 | 関数名 | 修正前 | 修正後 | 理由 |
|--------|--------|--------|--------|------|
| 148 | NotifyProposalStatusChange | Normal | Medium | 通常業務通知 |
| 207 | NotifyQuestionAnswered | Normal | Medium | 通常業務通知 |
| 281 | NotifyExpenseApproved | Normal | Medium | 通常業務通知 |
| 404 | NotifyExpenseApprovalReminder | Normal | High | 要対応・催促 |

### 2. expense_service.go（1箇所）
| 行番号 | 関数名 | 修正前 | 修正後 | 理由 |
|--------|--------|--------|--------|------|
| 3721 | ProcessExpenseReminders | Normal | High | 期限関連・重要 |

### 3. expense_monthly_close_service.go（1箇所）
| 行番号 | 関数名 | 修正前 | 修正後 | 理由 |
|--------|--------|--------|--------|------|
| 175 | NotifyMonthlyCloseReminder | Normal | High | 期限関連・重要 |

## 修正方針の根拠

### 優先度マッピング基準
- **Low**: 情報通知、FYI
- **Medium**: 通常の業務通知（アクション不要）
- **High**: 要対応項目、期限関連、催促

### 具体的な判断
- 提案/質問関連: 通常業務フロー → Medium
- 経費承認完了: 情報通知 → Medium
- 承認催促/期限リマインダー: 要対応 → High
- 月次締め: 重要な期限処理 → High

## テスト結果
- [x] コードのコンパイル成功
- [x] Dockerコンテナのビルド成功
- [x] バックエンドサービスの起動確認
- [x] エラーログなし

## 影響範囲
- 提案管理機能の通知
- 経費申請機能の通知全般
- 月次締め処理の通知

## 今後の推奨事項

### 1. コード規約の統一
```go
// NotificationPriorityNormalは廃止
// 以下のいずれかを使用すること：
- model.NotificationPriorityLow
- model.NotificationPriorityMedium  
- model.NotificationPriorityHigh
```

### 2. 定数の削除検討
`model.NotificationPriorityNormal`の定義自体を削除し、コンパイル時エラーで検出可能にする

### 3. データベース制約との整合性チェック
定期的にコード定数とDB制約の整合性を確認する仕組みの導入

## コミット情報
```bash
git status
# modified: backend/internal/service/notification_service.go
# modified: backend/internal/service/expense_service.go
# modified: backend/internal/service/expense_monthly_close_service.go

git add -A
git commit -m "fix: 通知優先度制約違反エラーを修正

- NotificationPriorityNormalをMedium/Highに変更（全6箇所）
- DB制約（low/medium/high）との整合性確保
- 通知種別に応じた適切な優先度設定

fixes #notification-priority-bug"
```

## 関連ドキュメント
- 調査結果: `docs/investigate/notification-priority-bug_20250820_1123.md`
- 初回修正: `docs/fix/notification-priority-fix_20250820_1106.md`

## ステータス
✅ **修正完了** - 全箇所の修正とデプロイが完了