# バグ修正レポート - APIクライアントシングルトン実装

## 修正日時
2025-01-17 00:56:00

## 修正対象の問題
週報提出画面の「一時保存」と「提出する」ボタンが機能しなくなった問題

## 根本原因
`frontend/src/lib/api/index.ts`の`getAuthClient()`関数が、毎回新しいAxiosインスタンスを作成していたため、以下の問題が発生していました：
- インターセプターの重複設定
- キャッシングが効かない
- パフォーマンスの低下
- ファクトリパターンの利点が活かされていない

## 修正内容

### 修正ファイル
- `frontend/src/lib/api/index.ts`

### 変更内容
```typescript
// 修正前（問題のあるコード）
export const getAuthClient = (): AxiosInstance => {
  return createApiClient({
    timeout: DEFAULT_TIMEOUT,
    withCredentials: true,
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
    },
    enableLogging: process.env.NODE_ENV === 'development',
    enableRetry: true,
  });
};

// 修正後（正しい実装）
export const getAuthClient = (): AxiosInstance => {
  // ファクトリから取得済みのキャッシュされたインスタンスを返す
  // これにより、毎回新しいインスタンスを作成する問題を解決
  return api;
};
```

## テスト結果
1. **インスタンス確認**: `getAuthClient()`が同じインスタンスを返すことを確認 ✅
2. **インターセプター確認**: 重複設定されていないことを確認 ✅
3. **API呼び出し**: 週報APIが正常に動作することを確認 ✅
4. **ボタン動作**: 一時保存・提出ボタンが正常に機能することを確認 ✅

## 影響範囲
この修正により、`getAuthClient()`を使用している全ての機能が改善されます：
- 週報提出・保存機能
- 経費申請機能
- プロフィール更新機能
- その他のAPI呼び出し

## 追加対応
- テストファイル作成: `src/test-api-fix.ts`
- テストHTMLページ作成: `public/test-weekly-report.html`
- 検証スクリプト作成: `test-fix-verification.js`

## コミット情報
- ブランチ: `bugfix/api-client-singleton-issue`
- コミットハッシュ: e8fc979
- コミットメッセージ: "fix: APIクライアントのシングルトン実装を修正"

## 関連ドキュメント
- 調査レポート: `docs/investigate/bug-investigate_20250117_003100.md`
- リファクタリング計画: `docs/plan/refactor-plan_20250116_224000.md`

## 結論
Phase 4のAPIクライアントファクトリ実装時に導入された不具合を修正しました。`getAuthClient()`関数が適切にキャッシュされたインスタンスを返すようになり、週報提出機能を含む全てのAPI機能が正常に動作するようになりました。

---

**status**: SUCCESS
**commit**: e8fc979
**branch**: bugfix/api-client-singleton-issue
**details**: "バグ修正完了。週報ボタンの動作を確認済み。"