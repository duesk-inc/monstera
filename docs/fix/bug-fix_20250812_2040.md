# バグ修正レポート: データベースロールengineer統一（Phase 3）

## 修正日時
2025-08-12 20:40

## 対象バグ
employee/userロールのengineer統一（データベース部分）

## 修正方針
Phase 1（バックエンド）、Phase 2（テストコード）に続き、Phase 3としてデータベースレベルの統一を実施。
PostgreSQLのコメント情報を'employee'から'engineer'に変更。

## 実施した修正

### 1. 新規マイグレーションファイル作成
**ファイル**: 
- `backend/migrations/300002_update_role_employee_to_engineer.up.sql`
- `backend/migrations/300002_update_role_employee_to_engineer.down.sql`

#### 内容
データベースのロールコメントを更新：
- `4:employee` → `4:engineer`
- 数値（4）は変更せず、表示名のみ変更

### 2. 既存マイグレーションファイルの修正

#### 更新したファイル
1. **000001_create_users_table.up.sql**
   - 初期テーブル作成時のコメントを修正
   - `4:employee` → `4:engineer`

2. **200029_add_sales_roles.up.sql**
   - 営業ロール追加時のコメントを修正
   - `4:employee` → `4:engineer`

3. **200042_add_accounting_permissions.up.sql**
   - 経理ロール追加時のコメントを修正
   - `4:employee` → `4:engineer`

4. **300001_create_system_user.up.sql**
   - システムユーザー作成エラーを修正
   - engineer_status: 'system' → 'active'（有効な値に変更）
   - ID: 45文字 → 36文字（UUID形式に統一）

## 実施した作業

### マイグレーション実行
```bash
# マイグレーション作成
migrate create -ext sql -dir migrations -seq update_role_employee_to_engineer

# マイグレーション適用
docker-compose exec backend migrate -path migrations -database "..." up

# 適用確認
SELECT column_name, col_description(...) FROM information_schema.columns WHERE ...
```

### 適用結果
データベースのコメント更新を確認：
- role: `1:super_admin, 2:admin, 3:manager, 4:engineer, 5:sales_manager, 6:sales_rep, 7:accounting_manager, 8:accounting_staff`
- default_role: `ユーザーのデフォルトロール（1:super_admin, 2:admin, 3:manager, 4:engineer, ...）`

## 遭遇した問題と解決

### 1. Dirty Migration Error
- **問題**: マイグレーション途中でエラーによりdirty状態
- **解決**: `UPDATE schema_migrations SET dirty = false` で修復

### 2. Invalid ENUM Value
- **問題**: engineer_status ENUMに'system'が未定義
- **解決**: 'active'に変更

### 3. ID長制限違反
- **問題**: VARCHAR(36)に45文字のIDを挿入
- **解決**: UUID形式の36文字に短縮

### 4. 文字化け
- **問題**: マイグレーションファイルが文字化け
- **解決**: ファイルを再作成

## テスト結果

### 実行したテスト
1. マイグレーション適用 - ✅ 成功
2. ロールバック確認 - ✅ 成功
3. 再適用 - ✅ 成功
4. データベースコメント確認 - ✅ engineerに更新済み

## 影響範囲

### 直接的な影響
- データベースメタデータ（コメント）のみ変更
- 実データやロジックへの影響なし
- ロール番号（4）は変更なし

### 間接的な影響
- データベース管理ツール（pgAdmin等）での表示が更新
- データベースドキュメント生成時の表記が統一

## リスク評価

### 変更リスク
- **極低**: コメントのみの変更でアプリケーション動作に影響なし
- **低**: マイグレーションはロールバック可能
- **低**: テスト環境で動作確認済み

### 残存リスク
- なし（全フェーズ完了）

## 統一状況まとめ

### 完了したフェーズ
1. **Phase 1**: バックエンドコード統一 ✅
   - model.RoleEmployee → model.RoleEngineer（エイリアス付き）
   - String()メソッドが"engineer"を返す

2. **Phase 2**: テストコード統一 ✅
   - 11ファイルでRoleEmployeeをRoleEngineerに置換
   - ロール関連テスト成功

3. **Phase 3**: データベース統一 ✅
   - PostgreSQLコメントを4:engineerに更新
   - マイグレーション適用済み

## コミット情報
- ブランチ: `bugfix/unify-role-engineer`
- 変更ファイル数: 6
- コミットメッセージ: "feat: データベースロール定義をemployeeからengineerへ変更（Phase 3）"

## 結論
employee/userロールのengineer統一が全レイヤーで完了：
- **フロントエンド**: Phase 0で完了済み
- **バックエンド**: Phase 1で完了
- **テストコード**: Phase 2で完了
- **データベース**: Phase 3で完了

全てのレイヤーで統一された表記となり、今後の混乱を防ぐことができる。