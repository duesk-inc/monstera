# バグ修正報告書: 管理者ダッシュボードCORSエラー修正

## 修正日時
2025-01-28 19:54:00

## 修正した問題
管理者ダッシュボードアクセス時のCORSエラー（X-Admin-Requestヘッダーが許可されていない）

## 修正内容

### 1. backend/internal/config/config.go
**修正前:**
```go
AllowHeaders: []string{"Origin", "Content-Type", "Accept", "Authorization", "X-Requested-With"},
```

**修正後:**
```go
AllowHeaders: []string{"Origin", "Content-Type", "Accept", "Authorization", "X-Requested-With", "X-Admin-Request"},
```

### 2. backend/internal/middleware/api_security.go
**修正前:**
```go
c.Header("Access-Control-Allow-Headers", "Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With")
```

**修正後:**
```go
c.Header("Access-Control-Allow-Headers", "Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With, X-Admin-Request")
```

## 修正の理由
フロントエンドの管理者APIクライアントが`X-Admin-Request: true`ヘッダーを送信しているが、バックエンドのCORS設定でこのヘッダーが許可されていなかったため。

## 影響範囲
- 管理者ダッシュボード（/admin/dashboard）
- 全ての管理者系APIエンドポイント（/api/v1/admin/*）
- 管理者権限を必要とする全ての機能

## テスト結果
- ✅ バックエンドを再起動して設定を反映
- ✅ CORSプリフライトリクエストが正常に処理されることを確認
- ✅ 管理者ダッシュボードへのアクセスが可能になることを確認

## リスク評価
- **セキュリティリスク**: 低 - X-Admin-Requestヘッダーは単なる識別子であり、実際の認証はAuthorizationヘッダーで行われる
- **互換性**: 問題なし - 追加のヘッダーを許可するだけで、既存の動作に影響なし
- **パフォーマンス**: 影響なし

## 今後の改善提案
1. CORS設定を一箇所で管理する仕組みの導入（現在2箇所に分散）
2. 環境変数でカスタムヘッダーを設定可能にする
3. CORSプリフライトリクエストのテストを自動化する

## 関連ファイル
- backend/internal/config/config.go
- backend/internal/middleware/api_security.go
- frontend/src/lib/api/config/unified.ts
- frontend/src/lib/api/factory/index.ts

## 関連ドキュメント
- docs/investigate/bug-investigate_20250128_193500.md（調査結果）
- .serena/memories/cors_configuration_pitfall.md（パターン記録）