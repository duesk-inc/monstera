# 領収書アップロード二重ダイアログバグ 修正報告書

## 修正日時
2025年1月15日

## 1. バグ概要
- **問題**: 経費新規作成画面で領収書アップロード時にファイル選択ダイアログが2回開く
- **影響**: ユーザビリティに重大な影響（ユーザーの混乱を招く）
- **原因**: イベントバブリングによるクリックハンドラーの重複実行

## 2. 根本原因
`ReceiptUploader.tsx`において、Paper要素とButton要素の両方に同じ`handleButtonClick`を呼び出すonClickイベントが設定されていた。

### 問題のメカニズム
1. ユーザーが「ファイルを選択」ボタンをクリック
2. Button要素のonClickイベントが発火（1回目のダイアログ）
3. イベントバブリングによりPaper要素のonClickも発火（2回目のダイアログ）

## 3. 修正内容

### 修正ファイル
```
frontend/src/components/features/expense/ReceiptUploader.tsx
```

### 修正箇所（Line 386-397）
```diff
         <Button
           variant="outlined"
           startIcon={<AttachFileIcon />}
-          onClick={handleButtonClick}
+          onClick={(e) => {
+            e.stopPropagation();
+            handleButtonClick();
+          }}
           disabled={disabled}
           sx={{ mb: 1 }}
         >
           ファイルを選択
         </Button>
```

### 修正方法
Button要素のonClickハンドラーに`e.stopPropagation()`を追加し、イベントの伝播を停止。

## 4. テスト結果

### ビルドテスト
- ✅ コンパイル成功
- ✅ 修正による新たなエラーなし
- ⚠️ 既存のlintエラーはあるが、今回の修正とは無関係

### 動作確認項目
1. **ボタンクリックによるファイル選択**
   - ファイル選択ダイアログが1回だけ開くこと
   - 選択したファイルが正しくアップロードされること

2. **Paper領域クリックによるファイル選択**  
   - ドロップゾーン全体のクリックでファイル選択が可能なこと
   - ファイル選択ダイアログが1回だけ開くこと

3. **ドラッグ&ドロップ**
   - ドラッグ&ドロップが正常に動作すること

4. **無効化状態**
   - disabled時にファイル選択ができないこと

## 5. 影響範囲
- **修正ファイル**: 1ファイル
- **影響する画面**:
  - 経費新規作成画面（`/expenses/new`）
  - 経費編集画面（`/expenses/[id]/edit`）
- **副作用**: なし

## 6. リスク評価
- **リスクレベル**: 低
- **理由**: 
  - イベント伝播の停止のみの軽微な修正
  - 他の機能への影響なし
  - ドラッグ&ドロップ機能は独立したイベントハンドラーで実装

## 7. 今後の推奨事項
1. 他の画面でも同様のパターン（親子要素での重複イベントハンドラー）がないか確認
2. UIコンポーネント開発時のイベントバブリングへの考慮をガイドラインに追加

## ステータス
**status**: SUCCESS  
**result**: バグ修正完了  
**files_modified**: 1  
**lines_changed**: 5