# 経費申請の下書き機能実装詳細（フェーズ3）

## 実装日時
2025-07-27 22:45:00

## 概要
経費申請の下書き機能フェーズ3を実装した。実装計画（`docs/plan/plan_20250727_204211.md`）に基づき、作成時に「下書き保存」と「作成して提出」の選択肢を提供する機能を追加した。

## 実装内容

### フェーズ3: 作成時に「下書き保存」と「作成して提出」の選択肢を提供

#### タスク3-1: ExpenseFormコンポーネントの作成モード改善

**ファイル**: `/frontend/src/components/features/expense/ExpenseForm.tsx`

**変更内容**:
1. handleCreateAndSubmit関数の追加
   ```typescript
   const handleCreateAndSubmit = async (e: React.FormEvent) => {
     e.preventDefault();
     setSubmitAttempted(true);
     
     // バリデーション実行
     const validationErrors = validateForm();
     if (validationErrors.length > 0) {
       const errorMap: Record<string, string> = {};
       validationErrors.forEach(error => {
         errorMap[error.field] = error.message;
       });
       setErrors(errorMap);
       return;
     }
     
     try {
       // 1. まず作成
       const createdExpense = await createExpense(formData);
       
       // 2. 次に提出
       const submittedExpense = await submitExpense(createdExpense.id);
       
       // 成功時の処理
       if (onSuccess) {
         onSuccess(submittedExpense);
       } else {
         router.push('/expenses');
       }
     } catch (error) {
       handleSubmissionError(error, '経費申請の作成と提出');
     }
   };
   ```

2. 作成モードのボタンUI変更
   - 従来の「作成」ボタンを「下書き保存」に変更
   - 「作成して提出」ボタンを新規追加
   - 2つのボタンを横並びに配置

#### タスク3-2: フォーム送信処理の分岐

**実装内容**:
1. 下書き保存ボタン（type="submit"）
   - 従来通りhandleSubmit関数を実行
   - createExpense APIのみ呼び出し
   - draftステータスで保存

2. 作成して提出ボタン（onClick={handleCreateAndSubmit}）
   - 新規作成したhandleCreateAndSubmit関数を実行
   - createExpense → submitExpenseを連続実行
   - submittedステータスへ遷移

## 技術的な判断

### 1. ボタンの配置とスタイル
- 「下書き保存」: variant="outlined"（補助的なアクション）
- 「作成して提出」: variant="contained"（主要なアクション）
- 色は両方ともprimaryで統一（一貫性のため）

### 2. エラーハンドリング
- 連続API呼び出しのエラーは適切にキャッチ
- 作成は成功したが提出が失敗した場合も考慮
- エラーメッセージは「経費申請の作成と提出」として明確化

### 3. ローディング状態の管理
- 既存のisLoading変数を活用
- 両方のボタンで同じローディング状態を共有

## 実装結果

### ユーザー体験の向上
1. 作成時の選択肢が明確になった
2. 下書き保存と即座の提出を1画面で選択可能
3. ワークフローに応じた柔軟な対応が可能

### コードの品質
1. 既存の関数（createExpense, submitExpense）を再利用
2. エラーハンドリングの一貫性を保持
3. UIの一貫性を維持（週報機能との整合性）

## 完了した全フェーズのまとめ

### フェーズ1（完了）
- 経費申請詳細画面に「提出」ボタンを追加
- draftステータスの判定と条件付き表示
- 提出APIの呼び出し実装

### フェーズ2（完了）
- StatusChipにアイコン追加
- 経費申請一覧のステータスフィルター機能
- 「下書きのみ」専用フィルター

### フェーズ3（完了）
- 作成モードで2つのボタンを提供
- 連続API呼び出しの実装
- 適切なエラーハンドリング

## 残課題

### テスト
- 単体テストの作成
- 統合テストの実施
- E2Eテストの追加

### ドキュメント
- ユーザーマニュアルの更新
- API仕様書の更新

### その他の改善点
- パフォーマンス最適化（必要に応じて）
- アクセシビリティの向上
- 国際化対応（将来的に）

## コミット情報
- コミットハッシュ: 33fa2b8
- コミットメッセージ: `feat(frontend): 経費申請作成時に「下書き保存」と「作成して提出」の選択肢を提供 - フェーズ3`

## プルリクエスト
- PR番号: #57
- URL: https://github.com/duesk-inc/monstera/pull/57
- ステータス: Draft（全フェーズ完了）

## 参考資料
- 実装計画: `docs/plan/plan_20250727_204211.md`
- フェーズ1実装詳細: `docs/implement/implement_20250727_220542.md`
- フェーズ2実装詳細: `docs/implement/implement_20250727_222143.md`
- 関連Issue: #56