# 経費申請の下書き機能実装詳細

## 実装日時
2025-07-27 22:05:42

## 概要
経費申請の下書き機能をフロントエンドに実装した。実装計画（`docs/plan/plan_20250727_204211.md`）に基づき、フェーズ1の実装を完了した。

## 実装内容

### フェーズ1: 経費申請詳細画面に「提出」ボタンを追加

#### 1. useExpenseSubmitフックの拡張

**ファイル**: `/frontend/src/hooks/expense/useExpenseSubmit.ts`

**変更内容**:
1. インターフェース定義の拡張
   - `UseExpenseSubmitReturn`に`submitExpense`関数と`isSubmitting`状態を追加

2. submitMutation の実装
   ```typescript
   const submitMutation = useMutation({
     mutationFn: async (id: string) => {
       const response = await expenseApi.submitExpense(id);
       return transformResponseToExpenseData(response);
     },
     onSuccess: (data) => {
       setError(null);
       queryClient.invalidateQueries({ queryKey: ['expenses'] });
       queryClient.invalidateQueries({ queryKey: ['expense', data.id] });
       if (options.onSuccess) {
         options.onSuccess(data);
       }
     },
     onError: (error: any) => {
       const errorObj = error instanceof Error ? error : new Error('経費申請の提出に失敗しました');
       setError(errorObj);
       if (options.onError) {
         options.onError(errorObj);
       }
     },
   });
   ```

3. submitExpense関数の実装
   - APIエラーをハンドリング
   - 成功時にキャッシュを無効化

#### 2. ExpenseFormコンポーネントの修正

**ファイル**: `/frontend/src/components/features/expense/ExpenseForm.tsx`

**変更内容**:
1. useExpenseSubmitフックから新しい関数をインポート
   ```typescript
   const { createExpense, updateExpense, submitExpense, isCreating, isUpdating, isSubmitting } = useExpenseSubmit();
   ```

2. draftステータス判定の追加
   ```typescript
   const isDraft = expense?.status === 'draft' || expense?.status === '下書き';
   ```

3. 提出ハンドラーの実装
   ```typescript
   const handleSubmitExpense = async () => {
     try {
       if (!expense?.id) {
         throw new Error('経費申請IDが見つかりません');
       }
       const result = await submitExpense(expense.id);
       if (onSuccess) {
         onSuccess(result);
       } else {
         router.push('/expenses');
       }
     } catch (error) {
       handleSubmissionError(error, '経費申請の提出');
     }
   };
   ```

4. UIの修正
   - 編集モードでdraftステータスの場合のみ「提出」ボタンを表示
   - ローディング中は適切なインジケーターを表示

## 技術的な判断

### 1. ステータス判定の方法
`draft`と`下書き`の両方を判定している理由：
- バックエンドからは`draft`が返される
- フロントエンドでは日本語にマッピングされる可能性がある
- 両方を判定することで確実性を高める

### 2. エラーハンドリング
- 既存の`useEnhancedErrorHandler`フックを使用
- 統一されたエラー処理フローを維持

### 3. 成功時の処理
- `onSuccess`コールバックが存在する場合はそれを呼び出す
- 存在しない場合は一覧画面へ遷移

## テスト結果

### ビルドテスト
- TypeScriptのコンパイル: 成功（warningはあるが、今回の変更に関連なし）
- Next.jsビルド: 成功

### 手動テスト（未実施）
- draftステータスの経費で提出ボタンが表示されることを確認（要実施）
- 提出処理が正常に動作することを確認（要実施）
- エラー時の表示を確認（要実施）

## 残課題

### フェーズ2: 経費申請一覧でdraft状態を識別しやすくする
- ステータスチップの視覚的改善
- フィルター機能の追加

### フェーズ3: 作成時に「下書き保存」と「作成して提出」の選択肢を提供
- フォームのボタン配置変更
- 連続API呼び出しの実装

### テスト
- 単体テストの作成
- 統合テストの実施
- E2Eテストの作成

## コミット情報
- コミットハッシュ: 9e7d7d0
- コミットメッセージ: `feat(frontend): 経費申請の下書き機能を実装 - フェーズ1`

## プルリクエスト
- PR番号: #57
- URL: https://github.com/duesk-inc/monstera/pull/57
- ステータス: Draft

## 参考資料
- 調査結果: `docs/investigate/investigate_20250727_202616.md`
- 実装計画: `docs/plan/plan_20250727_204211.md`
- 関連Issue: #56