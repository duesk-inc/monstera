# 実装詳細: 経費一覧APIレスポンスマッピング

## 実装日時
2025年7月27日 16:50

## 概要
経費申請一覧が表示されない問題を修正。バックエンドのレスポンス形式とフロントエンドの型定義の不一致を解消するため、マッピング処理を実装。

## 背景
調査の結果、以下の問題が判明：
- バックエンドAPIは正しく2件のデータを返している
- フロントエンドのExpenseData型とバックエンドのレスポンスのフィールド名が一致していない
  - バックエンド: `expense_date` → フロントエンド期待: `date`
  - バックエンド: `receipt_url` → フロントエンド期待: `receiptUrls`（配列）
  - バックエンド: `user_id` → フロントエンド期待: `userId`

## 実装方針
2つの選択肢を検討：
1. フロントエンドのExpenseData型定義を修正
2. APIレスポンスをマッピングする処理を追加

コードベース調査の結果、以下の理由から**方針2**を採用：
- ExpenseData型は15以上のファイルで使用されており、変更の影響が大きい
- 既存のマッピング処理は見当たらない
- APIレスポンスをマッピングすることで既存コンポーネントへの影響を最小限に抑えられる

## 実装内容

### 1. バックエンドレスポンス型の定義追加
**ファイル**: `frontend/src/types/expense.ts`

```typescript
// バックエンドからのレスポンス型
export interface ExpenseBackendResponse {
  id: string;
  user_id: string;
  title: string;
  category: string;
  amount: number;
  expense_date: string;
  status: string;
  description: string;
  receipt_url?: string;
  // ... その他のフィールド
}

// バックエンド経費一覧レスポンス
export interface ExpenseListBackendResponse {
  items: ExpenseBackendResponse[];
  total: number;
  page: number;
  limit: number;
  total_pages?: number;
}
```

### 2. マッピング関数の実装
**ファイル**: `frontend/src/utils/expenseMappers.ts`（新規作成）

```typescript
export function mapBackendExpenseToExpenseData(backendExpense: ExpenseBackendResponse): ExpenseData {
  return {
    id: backendExpense.id,
    userId: backendExpense.user_id,
    category: backendExpense.category,
    amount: backendExpense.amount,
    currency: 'JPY', // デフォルト値
    date: backendExpense.expense_date,
    description: backendExpense.description,
    // ... その他のマッピング
    receiptUrls: backendExpense.receipt_url ? [backendExpense.receipt_url] : [],
    // ... 残りのフィールド
  };
}

export function mapBackendExpenseListToExpenseList(backendResponse: ExpenseListBackendResponse): ExpenseListResponse {
  return {
    items: backendResponse.items.map(mapBackendExpenseToExpenseData),
    total: backendResponse.total,
    page: backendResponse.page,
    limit: backendResponse.limit,
    totalPages: backendResponse.total_pages,
  };
}
```

### 3. API関数の修正
**ファイル**: `frontend/src/lib/api/expense.ts`

```typescript
export async function getExpenseList(
  params: ExpenseSearchParams = {},
  signal?: AbortSignal
): Promise<ExpenseListResponse> {
  const searchParams = new URLSearchParams();
  
  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null) {
      searchParams.append(key, value.toString());
    }
  });

  const endpoint = `${EXPENSE_API_ENDPOINTS.EXPENSES}?${searchParams.toString()}`;
  const backendResponse = await apiRequest<{ data: ExpenseListBackendResponse }>(endpoint, { signal });
  
  // バックエンドレスポンスをフロントエンドの形式に変換
  return mapBackendExpenseListToExpenseList(backendResponse.data);
}
```

## 主な変更点のまとめ
1. **型定義の追加**: バックエンドレスポンス用の型を定義
2. **マッピング層の実装**: バックエンドとフロントエンドの型の差異を吸収
3. **API関数の修正**: レスポンスを受け取った後にマッピング処理を追加

## フィールドマッピング対応表
| バックエンド | フロントエンド | 備考 |
|---|---|---|
| expense_date | date | 日付フィールド |
| user_id | userId | ユーザーID |
| receipt_url | receiptUrls | 単一文字列を配列に変換 |
| created_at | createdAt | 作成日時 |
| updated_at | updatedAt | 更新日時 |

## デフォルト値の設定
以下のフィールドはバックエンドレスポンスに含まれないため、デフォルト値を設定：
- currency: 'JPY'
- paymentMethod: 'card'
- taxRate: 10
- taxAmount: 金額の10%で計算
- isBusinessTrip: false

## 次のステップ
1. 動作確認テストの実施
2. 他のAPI（経費詳細、作成、更新など）も同様のマッピングが必要か確認
3. TODOコメントで記載した追加フィールドの実装検討

## 関連ファイル
- 調査結果: `docs/investigate/investigate_20250726_165000.md`
- 型定義: `frontend/src/types/expense.ts`
- マッピング関数: `frontend/src/utils/expenseMappers.ts`
- API関数: `frontend/src/lib/api/expense.ts`

## コミット情報
- ブランチ: `fix/expense-list-mapping`
- コミットID: ef9ef48