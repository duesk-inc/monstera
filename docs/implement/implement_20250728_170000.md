# 経費申請「作成して提出」機能の500エラー修正実装

## 実装日時
2025-07-28 17:00:00

## 実装概要
経費申請の「作成して提出」機能で発生していた500エラーを修正。トランザクション内で承認者設定リポジトリのコンテキストが正しく伝播されていなかった問題を解決。

## 実装内容

### 1. リポジトリインターフェースの更新
**ファイル**: `backend/internal/repository/expense_approval_repository.go`

**変更内容**:
- `CreateApprovalFlow`メソッドのシグネチャに`settingRepo ExpenseApproverSettingRepository`パラメータを追加

```go
// 変更前
CreateApprovalFlow(ctx context.Context, expenseID uuid.UUID, amount int) error

// 変更後
CreateApprovalFlow(ctx context.Context, expenseID uuid.UUID, amount int, settingRepo ExpenseApproverSettingRepository) error
```

### 2. CreateApprovalFlowメソッドの実装修正
**ファイル**: `backend/internal/repository/expense_approval_repository.go`

**変更内容**:
- メソッド内で新しいリポジトリを作成する処理を削除
- 引数として渡されたリポジトリを使用するように変更

```go
// 変更前
func (r *ExpenseApprovalRepositoryImpl) CreateApprovalFlow(ctx context.Context, expenseID uuid.UUID, amount int) error {
    // ...
    settingRepo := NewExpenseApproverSettingRepository(r.db, r.logger)
    // ...
}

// 変更後
func (r *ExpenseApprovalRepositoryImpl) CreateApprovalFlow(ctx context.Context, expenseID uuid.UUID, amount int, settingRepo ExpenseApproverSettingRepository) error {
    // settingRepoは引数として受け取るため、新規作成不要
    // ...
}
```

### 3. サービス層でトランザクション用リポジトリを追加
**ファイル**: `backend/internal/service/expense_service.go`

**変更内容**:
- `SubmitExpense`メソッドのトランザクション内で`ExpenseApproverSettingRepository`を作成

```go
// トランザクション内で処理
err = s.db.Transaction(func(tx *gorm.DB) error {
    // リポジトリをトランザクション用に作成
    txExpenseRepo := repository.NewExpenseRepository(tx, s.logger)
    txApprovalRepo := repository.NewExpenseApprovalRepository(tx, s.logger)
    txApproverSettingRepo := repository.NewExpenseApproverSettingRepository(tx, s.logger) // 追加
```

### 4. CreateApprovalFlow呼び出し箇所の修正
**ファイル**: `backend/internal/service/expense_service.go`

**変更内容**:
- `CreateApprovalFlow`呼び出し時に新しい引数を追加

```go
// 変更前
if err := txApprovalRepo.CreateApprovalFlow(ctx, expense.ID, expense.Amount); err != nil {

// 変更後
if err := txApprovalRepo.CreateApprovalFlow(ctx, expense.ID, expense.Amount, txApproverSettingRepo); err != nil {
```

## 技術的詳細

### 問題の原因
トランザクション内で`CreateApprovalFlow`メソッドが新しい`ExpenseApproverSettingRepository`を作成していたため、トランザクションコンテキストが伝播されず、承認者設定データが見えない状態になっていた。

### 解決方法
トランザクション用のリポジトリをサービス層で作成し、それを`CreateApprovalFlow`メソッドに渡すことで、同一トランザクション内でデータを参照できるようにした。

## 影響範囲
- `ExpenseApprovalRepository`インターフェース
- `ExpenseApprovalRepositoryImpl`実装
- `expenseService.SubmitExpense`メソッド

## テスト対象
1. 経費申請の「作成して提出」機能が正常に動作すること
2. 承認者が設定されていない場合に適切なエラーメッセージが表示されること
3. トランザクションの一貫性が保たれること

## 次のステップ
1. Docker環境でのコンパイルとテスト実行
2. ブラウザでの動作確認
3. エラーハンドリングの確認