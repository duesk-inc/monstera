# ActiveRoleContext プロバイダー エラー調査結果

## 調査日時
2025-07-19 22:38:32

## 調査実施者
Claude Code

## エラー概要
フロントエンドアプリケーションで「useActiveRole must be used within an ActiveRoleProvider」エラーが発生

## エラー詳細
```
monstera-frontend | Error: useActiveRole must be used within an ActiveRoleProvider
monstera-frontend |     at useActiveRole (src/context/ActiveRoleContext.tsx:162:10)
monstera-frontend |     at useAuth (src/hooks/useAuth.ts:43:47)
monstera-frontend |     at AuthContextProvider (src/app/providers.tsx:33:42)
```

## 調査対象・スコープ
1. コンテキストプロバイダーの順序と依存関係
2. `useAuth`フックと`useActiveRole`フックの相互依存関係
3. 認証フローの初期化処理

## 問題の根本原因
1. **プロバイダーの順序問題**
   - `AuthContextProvider`が`useAuth`フックを呼び出している
   - `useAuth`フック内で`useActiveRole`フックを使用している
   - しかし、`ActiveRoleProvider`が`AuthContextProvider`の子要素として配置されている
   - このため、`useActiveRole`が実行される時点でコンテキストが存在しない

2. **依存関係の循環**
   ```
   Providers
   └── AuthContextProvider (useAuth を使用)
       └── ActiveRoleProvider
   
   useAuth → useActiveRole → ActiveRoleContext (まだ存在しない)
   ```

## 技術的制約・可能性
1. **ActiveRoleProviderの独立性**
   - 他のプロバイダーに依存していない
   - 最初に配置しても問題ない

2. **解決策の選択肢**
   - プロバイダーの順序を変更（推奨）
   - useAuthから useActiveRoleの直接使用を削除
   - 両プロバイダーを統合

## 既存システムとの整合性
- `(authenticated)/layout.tsx`など他のコンポーネントは正常に`useActiveRole`を使用
- プロバイダーの順序変更による既存機能への影響はない

## 解決方針
**推奨解決策：プロバイダーの順序変更**
```tsx
// 変更前
<AuthContextProvider>
  <ActiveRoleProvider>
    {children}
  </ActiveRoleProvider>
</AuthContextProvider>

// 変更後
<ActiveRoleProvider>
  <AuthContextProvider>
    {children}
  </AuthContextProvider>
</ActiveRoleProvider>
```

## リスク評価
- **低リスク**: ActiveRoleProviderは独立しており、順序変更による副作用はない
- **影響範囲**: providers.tsxファイルのみ

## 次フェーズへの推奨事項
1. **即座に実装可能**
   - providers.tsxファイルの修正のみで解決
   - テストによる動作確認を推奨

2. **追加の改善案**
   - コンテキストプロバイダーの依存関係を明確化するドキュメント作成
   - 将来的な循環依存を防ぐためのガイドライン策定

## 結論
プロバイダーの順序を変更することで、エラーを解消できる。実装は簡単で、リスクも低い。