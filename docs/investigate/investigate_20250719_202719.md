# 調査レポート: ログイン後のユーザーメニュー表示不具合

## 調査日時
2025-07-19 20:27:19

## 調査対象
- **問題**: ログインした後のトップバーにあるユーザーメニューが「ログイン」ボタンしか表示されない
- **期待される動作**: ログイン後は、ユーザー名、メールアドレス、ロール、ログアウトボタンなどが表示されるべき

## 調査結果

### 1. 根本原因
システム内に複数の認証状態管理システムが存在し、それぞれが異なるローカルストレージキーとユーザー情報の型を使用しているため、認証状態が正しく同期されていない。

#### 発見された3つの認証システム:

1. **useAuthフック** (`/hooks/useAuth.ts`)
   - ローカルストレージキー: `monstera_user`
   - ユーザー型: `User` (first_name, last_name)
   - 使用箇所: SharedLayoutWrapper

2. **useAuthContext** (`/app/providers.tsx`)
   - ローカルストレージキー: `user`
   - ユーザー型: `User` (first_name, last_name)
   - 使用箇所: TopBar

3. **AuthContext** (`/context/AuthContext.tsx`)
   - ローカルストレージキー: `user`
   - ユーザー型: `UserData` (name, department, gender)
   - 使用箇所: 不明（おそらく未使用または一部で使用）

### 2. 問題の詳細分析

#### コンポーネント間の不整合:
- `TopBar.tsx`: `useAuthContext`を使用してユーザー情報を取得
- `SharedLayoutWrapper.tsx`: `useAuth`フックを使用してユーザー情報を取得し、`SharedUserMenu`に渡す
- `SharedUserMenu.tsx`: 親コンポーネントから受け取ったユーザー情報を表示

この結果、TopBarとSharedUserMenuが異なる認証状態を参照している可能性があり、ログイン後もSharedUserMenuにはユーザー情報が渡されていない。

### 3. 技術的制約
- 既存のコンポーネントが複数の認証システムに依存している
- ローカルストレージのキーが統一されていない
- ユーザー情報の型定義が統一されていない
- ActiveRoleProviderとの連携も考慮する必要がある

### 4. 既存システムとの整合性
- `/lib/api/auth`でのログイン処理は`useAuth`フックで使用されている
- ActiveRoleProviderは`useAuth`フックと連携して動作している
- 多くのコンポーネントが既に特定の認証システムに依存している可能性がある

## 解決方針

### 推奨される解決方法:
認証システムを統一し、一つの認証コンテキストで管理する。

### 具体的な実装案:

#### 方法1: useAuthフックに統一（推奨）
1. `TopBar.tsx`を修正し、`useAuthContext`の代わりに`useAuth`フックを使用
2. `providers.tsx`のAuthContextを削除または`useAuth`フックのラッパーとして実装
3. 不要な`/context/AuthContext.tsx`を削除

**メリット**:
- 最小限の変更で済む
- 既存のActiveRoleProviderとの連携が保たれる
- ログイン/ログアウト処理の変更が不要

**デメリット**:
- providers.tsxに依存しているコンポーネントの修正が必要

#### 方法2: 新しい統一認証コンテキストを作成
1. 新しい統一認証コンテキストを作成
2. 全てのコンポーネントを新しいコンテキストを使用するように修正
3. ローカルストレージキーを統一

**メリット**:
- クリーンな実装
- 将来的な拡張性が高い

**デメリット**:
- 大規模な変更が必要
- 既存の全コンポーネントの修正が必要

## 次のステップ（Planフェーズ）への推奨事項

1. **方法1（useAuthフックに統一）を採用することを推奨**
   - 変更範囲が限定的
   - リスクが低い
   - 実装時間が短い

2. **実装タスク**:
   - TopBar.tsxの修正
   - providers.tsxのAuthContext実装の見直し
   - 不要なAuthContext.tsxの削除
   - テストの実施

3. **テスト項目**:
   - ログイン後のユーザーメニュー表示
   - ログアウト機能
   - ロール切り替え機能
   - ページリロード後の認証状態保持

## 作成ブランチ
- ブランチ名: `feature/fix-user-menu`
- 作成元: `main`

## 調査完了時刻
2025-07-19 20:27:19