# QUERY_KEYS.NOTIFICATIONS エラー調査結果

## 調査実施日時
2025-01-19 15:22:30

## 調査概要
エンジニア専用サイドバー実装後、ダッシュボードアクセス時に発生するTypeErrorの原因調査と修正

## エラー内容
```
TypeError: QUERY_KEYS.NOTIFICATIONS is not iterable
    at useNotifications (/src/hooks/common/useNotifications.ts:38:16)
    at NotificationBell (/src/components/common/NotificationBell.tsx:41:7)
```

## 調査結果

### 1. 根本原因
`useNotifications.ts`内で`QUERY_KEYS.NOTIFICATIONS`の使用方法に誤りがあった：

1. **Line 38**: `[...QUERY_KEYS.NOTIFICATIONS, 'unread']`でスプレッド演算子を使用
   - `QUERY_KEYS.NOTIFICATIONS`はオブジェクトであり、配列ではない
   - 正しくは`QUERY_KEYS.NOTIFICATIONS.UNREAD`を使用すべき

2. **Lines 44-45**: 存在しない`CACHE_STRATEGIES.NOTIFICATIONS`を参照
   - `CACHE_STRATEGIES`は戦略タイプの定義であり、機能別の設定は含まない
   - 直接的な時間値を使用すべき

3. **Lines 58, 73**: `queryKey: QUERY_KEYS.NOTIFICATIONS`で無効化
   - オブジェクトではなく配列を渡すべき
   - 正しくは`QUERY_KEYS.NOTIFICATIONS.ALL`を使用

### 2. QUERY_KEYSの構造
```typescript
QUERY_KEYS = {
  NOTIFICATIONS: {
    ALL: ['notifications'],
    LIST: ['notifications', 'list'],
    UNREAD: ['notifications', 'unread'],
    DETAIL: (id: string) => ['notifications', 'detail', id],
  },
  // ... 他のキー
}
```

### 3. エンジニアサイドバー実装との関係
- このエラーは直接的にはエンジニアサイドバー実装とは無関係
- しかし、ダッシュボードアクセス時に発生するため、サイドバー実装のテスト中に発見された

## 実施した修正

### 1. import文の修正
不要な`CACHE_STRATEGIES`のインポートを削除

### 2. queryKeyの修正
```typescript
// 修正前
queryKey: [...QUERY_KEYS.NOTIFICATIONS, 'unread'],

// 修正後
queryKey: QUERY_KEYS.NOTIFICATIONS.UNREAD,
```

### 3. キャッシュ時間の修正
```typescript
// 修正前
staleTime: CACHE_STRATEGIES.NOTIFICATIONS.staleTime,
gcTime: CACHE_STRATEGIES.NOTIFICATIONS.gcTime,

// 修正後
staleTime: 60 * 1000, // 1分
gcTime: 2 * 60 * 1000, // 2分
```

### 4. クエリ無効化の修正
```typescript
// 修正前
queryClient.invalidateQueries({ queryKey: QUERY_KEYS.NOTIFICATIONS });

// 修正後
queryClient.invalidateQueries({ queryKey: QUERY_KEYS.NOTIFICATIONS.ALL });
```

## 影響範囲
- `/frontend/src/hooks/common/useNotifications.ts`のみ
- NotificationBellコンポーネントは影響なし（useNotificationsフックを使用しているのみ）

## テスト確認事項
1. ダッシュボードが正常に表示される
2. 通知ベルアイコンが正常に動作する
3. 通知の取得・既読処理が正常に動作する
4. エンジニアサイドバーと同時に動作する

## 結論
QUERY_KEYSの使用方法の誤りによるTypeErrorを修正。エンジニアサイドバー実装とは直接関係ないが、同じブランチで修正を実施。