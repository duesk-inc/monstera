# バグ調査報告書 - スキルシート個別保存機能

## 調査日時
2025-01-16 17:30:00

## 報告されたバグ
スキルシート画面の個別保存ボタンを押下しても変更内容が保存されていない

## 調査結果

### 根本原因
**設計上の問題: カード上の保存ボタンは編集されていないデータを保存している**

### 詳細分析

#### 1. 現在の実装構造
```
[職務経歴カード]
  ├─ [保存ボタン] → handleSaveWorkHistory() → フォームの現在値を保存
  ├─ [編集ボタン] → 編集ダイアログを開く
  └─ [削除ボタン] → 削除処理
  
[編集ダイアログ]
  ├─ 各種入力フィールド
  └─ [保存して閉じる] → handleIndividualSave() → 変更を保存してダイアログを閉じる
```

#### 2. 問題の流れ

**パターン1: カード上の保存ボタンを直接押す場合**
1. ユーザーがカード上の緑色の保存ボタンをクリック
2. `handleSaveWorkHistory()`が実行される
3. `getValues('workHistory')`で現在のフォームデータを取得
4. しかし、カード上では編集できないため、データは変更されていない
5. 結果: 変更がないまま保存される

**パターン2: 編集後にカード上の保存ボタンを押す場合**
1. ユーザーが編集ボタンをクリックして編集ダイアログを開く
2. ダイアログ内で変更を行う
3. 「キャンセル」または×ボタンでダイアログを閉じる
4. カード上の保存ボタンをクリック
5. 編集ダイアログの変更はフォームに反映されていない
6. 結果: 古いデータが保存される

#### 3. コードの問題箇所

**WorkHistoryContentCards.tsx (Line 171-214)**
```typescript
const handleSaveWorkHistory = useCallback(async (index: number) => {
  const currentValues = getValues('workHistory') || [];  // 現在のフォームデータを取得
  const targetHistory = currentValues[index];
  
  // このデータは編集ダイアログで変更されていない限り、元のままのデータ
  if (targetHistory?.id && userId) {
    // 変更されていないデータをそのまま保存
    await updateWorkHistory(targetHistory.id, updateData, ...);
  }
}, [...]);
```

**WorkHistoryEditDialog.tsx (Line 338-436)**
```typescript
const handleIndividualSave = useCallback(async () => {
  // 編集ダイアログ内のデータを取得して保存
  const workHistoryData = getValues(`workHistory.${workHistoryIndex}`);
  // ここで正しく保存処理が行われる
  await update(workHistoryId, requestData, ...);
  onSave();  // フォームを更新
  onClose(); // ダイアログを閉じる
}, [...]);
```

### 影響範囲
- スキルシート画面の職務経歴編集機能
- ユーザー体験の混乱（保存ボタンを押しても変更が反映されない）

### 推奨される修正方法

#### オプション1: カード上の保存ボタンを削除（推奨）
- カード上の保存ボタンは役割が不明確
- 編集は編集ダイアログ内でのみ可能なため、保存も編集ダイアログ内で完結すべき

#### オプション2: カード上で直接編集可能にする
- カード上でインライン編集機能を追加
- 編集後に保存ボタンが有効になる仕組みを実装

#### オプション3: 保存ボタンの動作を改善
- 変更がない場合は「変更がありません」と通知
- 編集ダイアログを開くよう促すメッセージを表示

## 結論
このバグは実装上のミスではなく、**UIデザインの問題**です。カード上の保存ボタンは、編集機能がないのに存在しているため、ユーザーを混乱させています。

最も簡単で効果的な修正は、**カード上の保存ボタンを削除**し、編集ダイアログ内でのみ保存を行うようにすることです。