# Cognito Localデバッグログ継続出力問題の調査

調査日時: 2025-07-18 13:10:00

## 問題の概要

monstera-cognito-localコンテナから以下のようなログが約1秒間隔で継続的に出力されている：

```
[1752811911071] DEBUG: 96bf226c NONE request completed 
{"method":"GET","url":"/json/version","statusCode":404}

[1752811911087] DEBUG: 7a3e0a60 NONE request completed 
{"method":"GET","url":"/json/list","statusCode":404}
```

これらのログが大量に出力され続けることで、以下の問題が発生：
1. ログファイルの肥大化
2. 本来重要なログの埋没
3. コンテナのヘルスチェックがunhealthy状態

## 調査結果

### 根本原因

1. **ポート競合問題**
   - cognito-localがポート9229で動作している
   - 9229はNode.jsの標準デバッガーポート（Chrome DevTools Protocol）
   - 開発ツール（VS Code、IntelliJ IDEA等）がこのポートを自動検出

2. **自動接続試行**
   - IDEやデバッガーツールがNode.jsプロセスを探して自動接続を試みる
   - `/json/version`と`/json/list`はChrome DevTools Protocolのエンドポイント
   - cognito-localはこれらのエンドポイントを実装していないため404エラー

3. **デバッグモード**
   - docker-compose.ymlで`DEBUG=1`が設定されている
   - すべてのHTTPリクエストがデバッグログとして出力される

### 影響範囲

- **機能への影響**: なし（cognito-localの認証機能は正常に動作）
- **パフォーマンスへの影響**: 軽微（ログ出力のオーバーヘッド）
- **運用への影響**: ログの可読性低下、ディスク容量の圧迫

### 技術的詳細

アクセス元：
- IPアドレス: 192.168.65.1（Docker Desktop for Macのホストアドレス）
- アクセス頻度: 約1秒間隔
- リクエストパターン: `/json/version`と`/json/list`を交互にリクエスト

## 解決方針

### 推奨案: ポート番号の変更

cognito-localのポートを9229から別のポート（例：9230）に変更する。

**メリット:**
- 根本的な解決
- Node.jsデバッガーとの競合を完全に回避
- 将来的な問題の予防

**デメリット:**
- 全環境での設定変更が必要
- ドキュメントの更新が必要

### 代替案: デバッグログの無効化

docker-compose.ymlから`DEBUG=1`環境変数を削除する。

**メリット:**
- 実装が簡単
- 既存の設定への影響が最小限

**デメリット:**
- 問題の根本解決にならない
- デバッグ時にログが必要な場合に不便

## 関連ファイル

1. **設定ファイル**
   - `/docker-compose.yml` - cognito-localサービス定義
   - `/docker-compose.e2e.yml` - E2Eテスト環境（ポート9230使用）
   - `/cognito/README.md` - Cognito Local設定ドキュメント

2. **影響を受けるコード**
   - `/backend/internal/config/cognito.go` - エンドポイント設定
   - `/backend/test/cognito/test_config.go` - テスト設定
   - 各種シェルスクリプト（scripts/auth/以下）

3. **環境変数**
   - `COGNITO_ENDPOINT=http://cognito-local:9229`
   - 上記を使用している全ての設定ファイル

## 推奨事項

1. **短期対応**
   - `DEBUG=1`環境変数を削除してログ出力を抑制
   - 開発チームへの周知

2. **長期対応**
   - cognito-localのポートを9230に変更
   - 全環境での動作確認
   - ドキュメントの更新

3. **追加検討事項**
   - ログローテーションの設定
   - 開発環境のログレベル管理
   - モニタリングツールの導入

## 次のステップ

本調査結果を基に、以下のアクションを推奨：

1. 開発チームでの方針決定
2. 実装計画（Plan）フェーズへの移行
3. 段階的な修正の実施

---

調査担当: Claude
ブランチ: feature/fix-cognito-debug-logs