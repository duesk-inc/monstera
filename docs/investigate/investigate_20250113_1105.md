# 経費申請機能 調査報告書

作成日: 2025-01-13
調査者: Claude Code

## 1. 調査概要

### 1.1 調査目的
経費申請機能を設計書に従って正常に動作するように完成させるため、現在の実装状況と設計書との差分を調査する。

### 1.2 調査範囲
- 基本設計書・詳細設計書の要件
- 既存の実装状況（バックエンド・フロントエンド）
- ロールベースアクセス制御の実装状況
- 申請者（エンジニア）と承認者（管理者）の画面分離状況

## 2. 設計書の要件まとめ

### 2.1 基本要件
1. **エンジニア（申請者）の機能**
   - 経費申請の作成・編集・削除（下書き状態のみ）
   - 経費申請の提出
   - 申請履歴の確認
   - 領収書のアップロード

2. **承認者の機能**
   - 承認待ち申請の一覧表示
   - 申請の承認・却下
   - 管理部承認（5万円未満）と役員承認（5万円以上）の2段階承認

3. **システム要件**
   - カテゴリマスタ管理
   - 申請上限管理（月次・年次）
   - 承認フロー管理
   - S3を使用した領収書管理

## 3. 現在の実装状況

### 3.1 データベース
✅ **実装済み**
- expenses テーブル（経費申請）
- expense_approvals テーブル（承認履歴）
- expense_categories テーブル（カテゴリマスタ）
- expense_limits テーブル（申請上限）
- expense_receipts テーブル（複数領収書対応）
- expense_deadline_settings テーブル（期限設定）
- expense_approver_settings テーブル（承認者設定）

### 3.2 バックエンド実装

#### 3.2.1 APIエンドポイント

**エンジニア向けAPI** (`/api/expenses`)
✅ 実装済み:
- POST /expenses - 経費申請作成
- GET /expenses - 経費申請一覧取得
- GET /expenses/:id - 経費申請詳細取得
- PUT /expenses/:id - 経費申請更新
- DELETE /expenses/:id - 経費申請削除
- POST /expenses/:id/submit - 申請提出
- POST /expenses/:id/cancel - 申請取消
- POST /expenses/upload-url - 領収書アップロードURL生成
- GET /expenses/summary - 集計情報取得
- GET /expenses/check-limits - 上限チェック

**管理者向けAPI** (`/api/admin/engineers/expenses`)
✅ 実装済み:
- GET /admin/engineers/expenses/pending - 承認待ち一覧取得
- PUT /admin/engineers/expenses/:id/approve - 承認処理
- PUT /admin/engineers/expenses/:id/reject - 却下処理
- GET /admin/engineers/expenses/export - CSVエクスポート

#### 3.2.2 サービス層
✅ **ExpenseService** - 包括的な経費申請サービスが実装済み
- CRUD操作
- 承認フロー制御
- 上限チェック
- 通知機能との連携
- S3連携（領収書アップロード）

### 3.3 フロントエンド実装

#### 3.3.1 エンジニア画面
✅ **実装済み**:
- `/expenses` - 経費申請一覧
- `/expenses/new` - 新規作成
- `/expenses/[id]` - 詳細表示
- `/expenses/[id]/edit` - 編集

✅ **コンポーネント**:
- ExpenseList - 一覧表示（フィルタリング、ページネーション対応）
- ExpenseForm - 作成・編集フォーム（バリデーション、自動保存機能付き）
- ExpenseDetail - 詳細表示（提出・取消機能付き）
- ReceiptUploader - 領収書アップロード

#### 3.3.2 管理者画面
✅ **実装済み**:
- `/admin/expenses/pending` - 承認待ち一覧
- 管理部承認と役員承認のタブ切り替え
- 承認・却下処理のダイアログ
- フィルタリング機能

### 3.4 ロールベースアクセス制御
✅ **実装済み**:
- ルーティングレベルでの分離
  - `(authenticated)/(engineer)/expenses/*` - エンジニア用
  - `(authenticated)/(admin)/admin/expenses/*` - 管理者用
- バックエンドでの認証・認可
  - AdminRequired ミドルウェア
  - ロール別のアクセス制御

## 4. 設計書との差分分析

### 4.1 機能面での差分
基本的な機能はほぼ実装済みで、設計書の要件を満たしている。

### 4.2 潜在的な改善点
1. **承認フロー**
   - 現在の実装では承認者の自動判定ロジックが見当たらない
   - expense_approver_settings テーブルを活用した動的な承認者設定が必要

2. **通知機能**
   - 申請提出時の承認者への通知
   - 承認・却下時の申請者への通知
   - これらはNotificationServiceとの連携で実装可能

3. **期限管理**
   - expense_deadline_settings を活用した申請期限管理
   - 期限切れ申請の自動処理

## 5. 技術的制約・課題

### 5.1 確認された課題
1. **APIクライアント**
   - フロントエンドのadminExpenseApiで、rejectExpenseのパラメータが`reason`となっているが、`comment`に統一すべき（179行目）

2. **エラーハンドリング**
   - 楽観的ロックのバージョン管理が未実装（version: 1 が固定値）

### 5.2 セキュリティ考慮事項
✅ 適切に実装されている:
- S3 Pre-signed URLによる安全なファイルアップロード
- ロールベースアクセス制御
- 認証ミドルウェア

## 6. 推奨事項

### 6.1 即座に対応すべき事項
1. **承認者自動判定の実装**
   - expense_approver_settings を活用した承認者の自動設定
   - 部門・役職に基づく承認フローの実装

2. **通知機能の統合**
   - 申請提出時の通知
   - 承認・却下時の通知

3. **エラーメッセージの改善**
   - より具体的なエラーメッセージの提供
   - ユーザーフレンドリーなフィードバック

### 6.2 今後の機能拡張
1. **一括承認機能**
   - 複数の申請を一度に承認する機能（APIは実装済み）

2. **詳細な集計・分析機能**
   - 部門別・カテゴリ別の集計
   - 予算管理機能

3. **モバイル対応**
   - レスポンシブデザインの改善
   - モバイルアプリの検討

## 7. 結論

経費申請機能の基本的な実装は完了しており、設計書の要件をほぼ満たしています。エンジニアは申請のみ可能で、管理者は別画面で承認処理を行う構造が確立されています。

主な改善点は承認者の自動判定と通知機能の統合であり、これらを実装することで、より使いやすいシステムになることが期待されます。

## 8. 次のステップ

1. **Phase 1: 承認者自動判定の実装**
   - ExpenseServiceに承認者判定ロジックを追加
   - 申請提出時に自動的に承認者を設定

2. **Phase 2: 通知機能の統合**
   - 各種イベントでの通知実装
   - メール・Slack通知の設定

3. **Phase 3: UI/UXの改善**
   - エラーメッセージの改善
   - ローディング状態の改善
   - モバイルレスポンシブ対応

以上