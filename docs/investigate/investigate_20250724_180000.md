# 調査報告書: 経費申請画面の年度制限機能

## 調査概要

- **調査日時**: 2025-07-24 18:00
- **調査者**: Claude Code
- **対象ブランチ**: feature/expense-current-year-filter
- **調査内容**: 経費申請画面で現在年度（1月〜12月）のみを表示・申請可能にする機能の実現可能性

## 要件詳細

1. **表示制限**: 経費申請履歴を現在年度（1月〜12月）のみ表示
2. **申請制限**: 申請可能期間を現在年度のみに制限
3. **申請期限**: 経費申請期限を翌月10日までに設定

## 現状分析

### フロントエンド

#### 1. 経費申請一覧画面（/expenses/page.tsx）
- **現状**: fiscalYearが'2023'にハードコード
- **問題点**: 動的な年度設定が実装されていない

#### 2. ExpenseHistoryViewコンポーネント
- **現状**: 年度選択オプションが2021、2022、2023年度に固定
- **問題点**: 現在年度の動的計算がない

#### 3. useExpensesフック
- **良好な点**: 年度フィルタリング機能は既に実装済み
  - updateYearFilter（カレンダー年）
  - updateFiscalYearFilter（会計年度）
  - year、fiscalYear、monthパラメータ対応
- **未使用**: 現在のページではこれらの機能が活用されていない

#### 4. ExpenseFormコンポーネント
- **日付バリデーション**: 
  - 未来の日付は選択不可（実装済み）
  - 年度制限なし（未実装）
- **申請期限**: 30日以内（EXPENSE_DEADLINES.SUBMISSION_DAYS）

### バックエンド

#### 1. GetExpenseListハンドラー
- **良好な点**: 日付範囲フィルターは実装済み（start_date、end_date）
- **未実装**: year、fiscalYearパラメータのハンドリング

#### 2. ExpenseFilterRequest DTO
- **良好な点**: year、fiscalYear、monthフィールドは定義済み
- **機能**: GetDateRange()メソッドで会計年度の日付範囲計算可能
  - 会計年度: 4月1日〜翌年3月31日
  - カレンダー年: 1月1日〜12月31日

#### 3. 申請期限設定（ExpenseDeadlineSetting）
- **現状**: 日数ベースの期限設定（DefaultDeadlineDays）
- **問題点**: 「翌月10日まで」という固定日付期限には非対応

## 技術的実現可能性

### 実装容易度: 高

1. **フロントエンド年度フィルタリング**: 既存機能の活用のみ
2. **バックエンド対応**: DTOは準備済み、ハンドラーの軽微な修正のみ
3. **申請期限の実装**: 新規ロジックが必要だが、複雑性は低い

## 実装方針

### フェーズ1: 年度制限機能

1. **フロントエンド修正**
   - ExpensesPageで現在年度を動的に設定
   - ExpenseHistoryViewの年度オプションを現在年度のみに変更
   - useExpensesのupdateYearFilterを活用

2. **バックエンド修正**
   - GetExpenseListハンドラーでyear/fiscalYearパラメータを処理
   - ExpenseServiceのListメソッドで年度フィルタリングを実装

3. **新規申請の制限**
   - ExpenseFormで現在年度外の日付選択を無効化
   - バリデーションロジックの追加

### フェーズ2: 申請期限機能

1. **期限計算ロジック**
   - 「経費発生月の翌月10日」を計算する関数を実装
   - 月末処理の考慮（例: 1月31日の経費→2月10日まで）

2. **バリデーション強化**
   - フロントエンド: 期限切れ申請の警告表示
   - バックエンド: 期限切れ申請の拒否

3. **既存データの扱い**
   - 過去の申請データは読み取り専用で表示
   - 編集・削除は現在年度のみ許可

## リスクと対策

### リスク1: 既存データへの影響
- **影響**: 過去年度のデータが見えなくなる
- **対策**: 管理者画面では全年度表示を維持

### リスク2: 年度切り替わり時の処理
- **影響**: 1月1日に突然前年データが見えなくなる
- **対策**: 移行期間の設定（例: 1月は前年12月分も申請可能）

### リスク3: タイムゾーンの問題
- **影響**: 日付判定の不整合
- **対策**: サーバー側で一元的に日付判定

## 推奨事項

1. **段階的実装**
   - まず表示制限から実装
   - 動作確認後に申請制限を追加

2. **設定の外部化**
   - 年度制限のON/OFF切り替え
   - 申請期限日数の設定可能化

3. **ユーザビリティ**
   - 制限理由の明確な表示
   - 期限切れ警告の事前通知

## 次のステップ

1. 実装計画書（Plan）の作成
2. UIデザインの検討
3. テスト計画の策定

## 結論

要求される機能は、既存システムの基盤を活用して実装可能です。特に年度フィルタリング機能は既に部分的に実装されているため、比較的少ない工数で実現できると判断します。

## 調査完了

調査者: Claude Code
調査完了時刻: 2025-07-24 18:00
ブランチ: feature/expense-current-year-filter