# バグ調査レポート - 週報提出機能不具合

## 調査日時
2025-01-17 00:31:00

## 問題の概要
週報提出画面の「一時保存」と「提出する」ボタンが機能しなくなった。
APIクライアントアーキテクチャのリファクタリング（Phase 1-4）が原因の可能性が高い。

## 調査方法
1. 関連コンポーネントの特定
2. APIクライアントの使用箇所の確認
3. リファクタリング前後の実装差分の分析
4. 根本原因の特定

## 調査結果

### 1. 関連ファイルの特定
```
- frontend/src/app/(authenticated)/(engineer)/weekly-report/page.tsx  // 週報画面
- frontend/src/hooks/weeklyReport/useWeeklyReport.ts                 // 週報フック
- frontend/src/hooks/weeklyReport/useWeeklyReportData.ts            // データ処理フック
- frontend/src/lib/api/weeklyReport.ts                              // 週報API
- frontend/src/lib/api/index.ts                                     // APIクライアント
- frontend/src/lib/api/client.ts                                    // ファクトリ実装
```

### 2. 処理フローの分析

#### ボタンクリック時の処理フロー
```
1. ユーザーが「一時保存」または「提出する」ボタンをクリック
   ↓
2. page.tsx: handleOpenSaveDialog / handleOpenSubmitDialog
   ↓
3. useWeeklyReport: handleSaveDraft / handleSubmit
   ↓
4. useWeeklyReportData: saveWeeklyReportDraft / submitWeeklyReport
   ↓
5. weeklyReport.ts: saveWeeklyReportAsDraft / saveAndSubmitWeeklyReport
   ↓
6. APIクライアント: getAuthClient()で取得したクライアントを使用
```

### 3. 根本原因の特定

#### 問題の核心
`lib/api/index.ts`の`getAuthClient`関数の実装に問題があります。

**現在の実装（問題あり）**:
```typescript
export const getAuthClient = (): AxiosInstance => {
  // 毎回新しいインスタンスを作成している
  return createApiClient({
    timeout: DEFAULT_TIMEOUT,
    withCredentials: true,
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
    },
    enableLogging: process.env.NODE_ENV === 'development',
    enableRetry: true,
  });
};
```

**問題点**:
1. **毎回新しいAxiosインスタンスを作成**: 呼び出すたびに新しいインスタンスが作成される
2. **インターセプターの重複設定**: 複数のインターセプターが設定される可能性
3. **キャッシングが効かない**: ファクトリパターンの利点が活かされていない
4. **パフォーマンスの低下**: 不要なインスタンス生成によるオーバーヘッド

### 4. 影響範囲
この問題は週報提出機能だけでなく、`getAuthClient()`を使用している全ての機能に影響します：

- 週報提出・保存機能
- 経費申請機能
- プロフィール更新機能
- その他のAPI呼び出し

### 5. エラーの症状
- ボタンをクリックしても反応がない
- APIリクエストが正しく送信されない
- インターセプターが正しく動作しない可能性

## 推奨される修正方法

### 修正案
`getAuthClient`関数を修正して、ファクトリから適切にクライアントを取得するようにする：

```typescript
// lib/api/index.ts
export const getAuthClient = (): AxiosInstance => {
  // ファクトリのデフォルトクライアントを使用（キャッシュされている）
  return api; // すでに定義されている factoryClient を使用
};
```

または、より明示的に：

```typescript
export const getAuthClient = (): AxiosInstance => {
  // ファクトリから直接取得
  return factoryClient;
};
```

### 修正の利点
1. インスタンスの再利用によるパフォーマンス向上
2. インターセプターの重複を防ぐ
3. ファクトリパターンの正しい利用
4. メモリ使用量の削減

## 確認事項
1. 環境変数の設定が正しいこと
   - `NEXT_PUBLIC_API_HOST`: http://localhost:8080
   - `NEXT_PUBLIC_API_VERSION`: v1
   - `NEXT_PUBLIC_API_URL`: http://localhost:8080/api/v1

2. APIエンドポイントの定義が正しいこと
   - Phase 3で`/api/v1`プレフィックスを削除済み
   - 相対パスのみを使用

## 結論
Phase 4の実装で、`getAuthClient`関数が誤って毎回新しいAxiosインスタンスを作成するようになってしまった。これにより、APIクライアントが正しく動作せず、週報の保存・提出機能が機能しなくなった。

修正は単純で、既存の`api`（factoryClient）インスタンスを返すように変更するだけで解決できる。

---

**status**: SUCCESS
**next**: BUG-FIX
**details**: "バグの根本原因を特定。bug-investigate_20250117_003100.mdに詳細記録。修正フェーズへ移行。"