# バグ調査レポート - ログイン画面における audit_logs 外部キー制約違反

## 調査概要
- **調査日時**: 2025-08-14 01:32:48
- **調査対象**: ログイン画面(/login)アクセス時に発生するaudit_logs外部キー制約違反エラー
- **エラー内容**: `insert or update on table "audit_logs" violates foreign key constraint "fk_audit_logs_user"`
- **問題のユーザーID**: `00000000-0000-0000-0000-000000000099`

## 根本原因

### 1. 主要原因
開発モードで使用される仮想ユーザー（`user_id=00000000-0000-0000-0000-000000000099`）が、`users`テーブルに存在しないにも関わらず、audit_logsテーブルへの挿入時に外部キー制約により失敗している。

### 2. 発生条件
- 開発環境でのアクセス
- ログイン画面（`/login`）への初回アクセス
- 特定のメールアドレス以外でのアクセス（デフォルトケース発動）

## 詳細な問題発生フロー

### フロントエンド
1. **ログイン画面アクセス**: `/login`ページにアクセス
2. **AuthContext初期化**: React AuthContextがマウント
3. **自動認証チェック**: `useEffect`で`refreshAuth()`が実行される
4. **API呼び出し**: `getCurrentUser()`により`/api/v1/auth/me`エンドポイントにリクエスト送信

### バックエンド
1. **認証ミドルウェア実行**: `cognito_auth.go`の処理開始
2. **開発モード判定**: 開発環境のため仮想ユーザーを生成
3. **デフォルトユーザー設定**: 特定メールアドレスに該当しないため`userID = "00000000-0000-0000-0000-000000000099"`を設定
4. **ハンドラー実行**: `authHandler.Me`がユーザー情報を返却
5. **監査ログミドルウェア実行**: `audit_log.go`が処理される
6. **データベースエラー**: audit_logsテーブルへの挿入時に外部キー制約違反が発生

## 関連コード箇所

### 認証ミドルウェア (`backend/internal/middleware/cognito_auth.go`)
```go
// 527行目付近 - デフォルトケース
default:
    // デフォルトまたは環境変数から開発用ロールを取得
    devRole = model.Role(m.config.Cognito.DevUserRole)
    if devRole < 1 || devRole > 4 {
        devRole = model.RoleAdmin // 無効な値の場合はAdminを使用
    }
    firstName = "開発"
    lastName = "ユーザー"
    userID = "00000000-0000-0000-0000-000000000099" // 問題のユーザーID
```

### 監査ログミドルウェア (`backend/internal/middleware/audit_log.go`)
```go
// 88行目付近 - ユーザーID取得処理
userIDInterface, exists := c.Get("user_id")
var userID string
if !exists {
    // 未認証の場合の処理
    // ...
} else {
    userID = userIDInterface.(string) // ここで問題のユーザーIDが設定される
}
```

### フロントエンド AuthContext (`frontend/src/context/AuthContext.tsx`)
```typescript
// 67行目付近 - 初回マウント時の認証チェック
useEffect(() => {
    refreshAuth(); // ログイン画面でも実行される
}, [refreshAuth]);

// 44行目付近 - 認証状態確認
const response = await getCurrentUser(); // /api/v1/auth/meを呼び出し
```

## データベース状況

### audit_logsテーブル制約
```sql
-- backend/migrations/200018_create_audit_logs_table.up.sql
CONSTRAINT fk_audit_logs_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

### usersテーブル
- `00000000-0000-0000-0000-000000000001` ～ `00000000-0000-0000-0000-000000000008`: 存在（テストフィクスチャ）
- `00000000-0000-0000-0000-000000000099`: **存在しない**（問題の原因）

## 影響範囲

### 直接的な影響
- ログイン画面アクセス時にエラーが発生
- 開発環境でのユーザビリティの低下
- デバッグログに大量のエラーメッセージが出力される

### 潜在的な影響
- 同様のパターンを使用する他のページでも発生する可能性
- 開発効率の低下
- 本番環境では影響なし（Cognito認証を使用）

## 修正方針の提案

### 方針1: データベースに開発用ユーザーを追加
**推奨度: 高**
- 開発用デフォルトユーザー（`00000000-0000-0000-0000-000000000099`）をusersテーブルに追加
- マイグレーションファイルまたはシードデータで対応

### 方針2: ログイン画面での認証チェック無効化
**推奨度: 中**
- ログイン画面では認証状態チェックを行わない
- AuthContextの初期化ロジックを修正

### 方針3: 監査ログの外部キー制約の緩和
**推奨度: 低**
- 開発用ユーザーの場合は監査ログをスキップ
- または外部キー制約を一時的に無効化

## チェックリスト

- [x] エラーの直接的な原因: audit_logs外部キー制約違反
- [x] エラーが発生する条件: ログイン画面アクセス時の認証チェック
- [x] 影響を受ける機能・ユーザー: 開発環境の全ユーザー
- [x] データ整合性への影響: なし（開発環境のみ）
- [x] セキュリティへの影響: なし
- [x] 関連する過去の修正履歴: Cognito移行に関連
- [x] 回避策の有無: 特定のメールアドレス使用による回避可能

## 次のステップ
1. **BUG-FIXフェーズへ移行**: 修正方針1を推奨
2. **マイグレーションファイル作成**: 開発用デフォルトユーザーの追加
3. **テスト実行**: 修正後の動作確認

## 関連ファイル
- `/backend/internal/middleware/cognito_auth.go`
- `/backend/internal/middleware/audit_log.go`
- `/backend/internal/handler/auth_handler.go`
- `/frontend/src/context/AuthContext.tsx`
- `/frontend/src/lib/api/auth/index.ts`
- `/backend/migrations/200018_create_audit_logs_table.up.sql`