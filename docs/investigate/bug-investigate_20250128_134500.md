# バグ調査報告書: サイドバーのデスクトップ/モバイル表示問題

## 調査日時
2025-01-28 13:45:00

## 報告された問題
デスクトップ環境でサイドバーがモバイルのデザイン（アコーディオン形式）で表示される

## 調査結果

### 1. コード分析

#### BaseSidebar.tsx
- **mobile propのデフォルト値**: `false` ✓
- **レンダリング分岐**:
  - `mobile === true`: Collapseによるアコーディオン形式（282-289行目）
  - `mobile === false`: Popoverによるホバー表示（212-281行目）
- **デバッグログ追加**: mobile, collapsedプロパティを出力するように修正（76-88行目）

#### SharedLayoutWrapper.tsx
- **isMobile判定**: `useMediaQuery(theme.breakpoints.down('md'))` (39行目)
  - mdブレイクポイント = 960px以下でモバイル扱い
- **サイドバーレンダリング条件**: `!isMobile` (83行目)
- **mobile prop明示的指定**: `mobile: false`を追加済み（86行目）✓

#### AdminSidebar.tsx / EngineerSidebar.tsx
- initialExpandedItems削除済み ✓
- BaseSidebarへのprops伝播は正常

### 2. 問題の可能性

#### 可能性1: ブレイクポイントによる誤判定
- **症状**: 画面幅960px以下でデスクトップでもモバイル扱い
- **確認方法**: ブラウザの幅を960px以上にして確認

#### 可能性2: Popover表示条件の不成立
- **表示条件**: `hasChildren && isHovered && !mobile && !collapsed`
- **考えられる原因**:
  - isHoveredがfalseのまま（マウスイベントが発火しない）
  - collapsedがtrueになっている
  - z-indexやCSSの干渉でPopoverが見えない

#### 可能性3: 実際にはCollapseが表示されている
- mobileプロパティが何らかの理由でtrueになっている
- React.cloneElementでのprops上書きが失敗している

### 3. 推奨される確認手順

1. **ブラウザの開発者ツール**で以下を確認:
   ```javascript
   // コンソールで確認
   console.log('BaseSidebar Debug:')
   // mobile, collapsed の値を確認
   ```

2. **画面幅の確認**:
   - 現在の画面幅が960px以上であることを確認
   - レスポンシブモードになっていないか確認

3. **要素の検証**:
   - 子メニューが `<div class="MuiCollapse-root">` (Collapse) か
   - `<div class="MuiPopover-root">` (Popover) かを確認

### 4. 修正案

#### 修正案1: ブレイクポイントの調整
```typescript
// SharedLayoutWrapper.tsx
const isMobile = useMediaQuery(theme.breakpoints.down('sm')); // 600px以下に変更
```

#### 修正案2: Popover表示条件の簡略化（テスト用）
```typescript
// BaseSidebar.tsx
// 一時的にホバー条件を削除してPopoverが表示されるか確認
{hasChildren && !mobile && !collapsed && ( // isHovered条件を削除
```

#### 修正案3: 強制的なデバッグ
```typescript
// BaseSidebar.tsx
console.log('Popover条件:', {
  hasChildren,
  isHovered,
  mobile,
  collapsed,
  shouldShow: hasChildren && isHovered && !mobile && !collapsed
});
```

### 5. 根本原因の仮説

最も可能性が高いのは：
1. **画面幅が960px以下**でisMobile=trueになっている
2. または、**Popoverのホバー判定**が正しく動作していない

## 次のステップ

1. デバッグログで`mobile`プロパティの実際の値を確認
2. 画面幅とisMobileの関係を検証
3. Popoverの表示条件を段階的に確認
4. 必要に応じて修正実装

## 影響範囲
- 管理者画面のサイドバー
- エンジニア画面のサイドバー
- デスクトップユーザーのUX

## 優先度
高 - デスクトップユーザーの主要なナビゲーション機能に影響