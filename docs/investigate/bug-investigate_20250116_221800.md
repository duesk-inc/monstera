# バグ調査報告書 - スキルシート保存時の404エラー

## 調査日時
2025-01-16 22:18:00

## 問題の概要
スキルシート作成ダイアログで最後に保存するボタンを押下した際、バックエンドが404エラーを返す。

## エラー詳細
```
Method: POST
Path: /work-history
Status: 404 (Not Found)
```

## 調査プロセス

### 1. バックエンドのルート定義確認
`backend/cmd/server/main.go` (line 648-656)
```go
workHistory := api.Group("/work-history")
workHistory.Use(authMiddlewareFunc)
{
    // 基本CRUD
    workHistory.GET("", workHistoryHandler.GetWorkHistories)         // 一覧取得
    workHistory.GET("/:id", workHistoryHandler.GetWorkHistory)       // 個別取得
    workHistory.POST("", workHistoryHandler.CreateWorkHistory)       // 作成 ← 定義されている
    workHistory.PUT("/:id", workHistoryHandler.UpdateWorkHistory)    // 更新
    workHistory.DELETE("/:id", workHistoryHandler.DeleteWorkHistory) // 削除
}
```
→ **バックエンドには`/api/v1/work-history`にPOSTエンドポイントが正しく定義されている**

### 2. フロントエンドのAPIコール確認
`frontend/src/lib/api/workHistory.ts` (line 50-52)
```typescript
create: async (data: WorkHistoryCreateRequest): Promise<WorkHistory> => {
    const response = await apiClient.post('/work-history', data)
    return response.data.work_history
}
```
→ **`apiClient`を使用して`/work-history`にPOSTリクエストを送信**

### 3. APIクライアントの設定確認
`frontend/src/lib/api/config.ts` (line 7)
```typescript
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api/v1';
```
→ **環境変数が設定されていない場合、デフォルトで正しいURLを使用**

### 4. 環境変数の確認
`frontend/.env.local` (line 4)
```
NEXT_PUBLIC_API_URL=http://localhost:8080
```
→ **問題発見！ `/api/v1`サフィックスが欠落している**

## 根本原因
**環境変数`NEXT_PUBLIC_API_URL`の設定ミス**
- 現在の設定: `http://localhost:8080`
- 正しい設定: `http://localhost:8080/api/v1`

この設定ミスにより、以下のような不正なリクエストが発生：
- 実際のリクエスト: `POST http://localhost:8080/work-history`
- 期待されるリクエスト: `POST http://localhost:8080/api/v1/work-history`

## 影響範囲
### 直接的な影響
- 職務経歴の新規作成機能が動作しない
- 職務経歴の更新機能が動作しない
- 職務経歴の削除機能が動作しない

### 潜在的な影響
- **全てのAPIエンドポイントが影響を受けている可能性がある**
  - プロファイル関連API
  - スキルシート関連API
  - 認証関連API
  - その他全てのAPIエンドポイント

### データ整合性への影響
- データの不整合は発生していない（リクエストが到達していないため）

## セキュリティへの影響
- なし（認証は正常に機能している）

## 回避策
### 一時的な回避策
1. `.env.local`ファイルを手動で修正
2. フロントエンドサーバーを再起動

### 恒久的な対策が必要
- 環境変数のバリデーション追加
- デフォルト値の見直し

## 関連するコード
- `frontend/.env.local` - 環境変数設定
- `frontend/src/lib/api/config.ts` - APIクライアント設定
- `frontend/src/lib/api/workHistory.ts` - 職務経歴API
- `backend/cmd/server/main.go` - バックエンドルート定義

## 推奨される修正方法
1. **即座の修正**（優先度：高）
   ```
   # frontend/.env.local
   NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
   ```

2. **追加の改善案**（優先度：中）
   - 環境変数のバリデーション追加
   - エラーメッセージの改善（URLを含める）
   - 開発環境のセットアップドキュメント更新

## テスト項目
修正後、以下のテストを実施：
1. [ ] 職務経歴の新規作成
2. [ ] 職務経歴の更新
3. [ ] 職務経歴の削除
4. [ ] 職務経歴の一覧取得
5. [ ] その他のAPIエンドポイントの動作確認

## まとめ
環境変数の設定ミスという単純だが重大なバグ。すべてのAPIコールに影響する可能性があるため、即座の修正が必要。