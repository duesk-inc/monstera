# 調査報告書: API_TIMEOUTS 定数不足エラー解決

## 調査概要

**調査日時**: 2025-07-17 11:28:35  
**調査者**: Claude Code  
**ブランチ**: feature/fix-auth-constants-error (継続)  
**対象問題**: API_TIMEOUTSが@/constants/delaysに定義されていない  
**調査目標**: 不足定数の特定と実装方針策定

## 報告された問題

### エラー詳細
```
Export API_TIMEOUTS doesn't exist in target module

./src/lib/api/index.ts (4:1)

The export API_TIMEOUTS was not found in module [project]/src/constants/delays.ts [app-client] (ecmascript).
Did you mean to import API_DELAYS?
```

### 影響範囲
- **発生箇所**: src/lib/api/index.ts:4
- **インポート**: `import { API_TIMEOUTS, TIME_THRESHOLDS, UI_DELAYS } from '@/constants/delays'`
- **影響ファイル**: lib/api/index.ts経由で複数のコンポーネントに波及

## 詳細調査結果

### 1. 不足定数の特定

#### 1.1 API_TIMEOUTS 不足
**要求されている使用箇所:**
- **Line 37**: `timeout: API_TIMEOUTS.SHORT` (axios設定)
- **Line 45**: `const DEFAULT_TIMEOUT = API_TIMEOUTS.DEFAULT`

**現在の代替定数:**
- `constants/delays.ts`: `API_DELAYS.REQUEST_TIMEOUT: 30000`
- `constants/network.ts`: `NETWORK_TIMEOUTS.DEFAULT: 30000, SHORT: 5000`

#### 1.2 TIME_THRESHOLDS 不足
**要求されている使用箇所:**
- **Line 121**: `if (timeDiff < TIME_THRESHOLDS.IMMEDIATE)`

**コンテキスト:** エラーメッセージ表示の3秒以内重複チェック

#### 1.3 UI_DELAYS 拡張不足
**要求されている使用箇所:**
- **Line 149**: `}, UI_DELAYS.THROTTLE)`
- **Line 150**: `}, UI_DELAYS.DEBOUNCE)`

**現在のUI_DELAYS:** TOOLTIP_SHOW, TOOLTIP_HIDE等のみ定義済み
**既存代替定数:** 
- `THROTTLE_DELAYS.CLICK: 300`
- `DEBOUNCE_DELAYS.INPUT: 500`

### 2. ビルドエラー確認

```bash
npm run build
```

**エラー出力:**
```
./src/lib/api/index.ts
Attempted import error: 'API_TIMEOUTS' is not exported from '@/constants/delays' (imported as 'API_TIMEOUTS').

Import trace for requested module:
./src/lib/api/index.ts
./src/lib/axios.ts
./src/app/(authenticated)/(admin)/approval-reminder/page.tsx
```

### 3. 技術的制約分析

#### 3.1 既存アーキテクチャ
- **分離された定数管理**: delays, network, storage等のファイル別管理
- **TypeScript型安全性**: `as const`による型推論
- **一貫性原則**: 既存の命名規則とパターンを踏襲

#### 3.2 互換性要件
- **後方互換性**: 既存のAPI_DELAYSとの共存
- **インポート一貫性**: 単一ファイルからの一括インポート
- **値の妥当性**: 実用的なタイムアウト値の設定

### 4. 解決方針策定

#### 4.1 追加すべき定数

**API_TIMEOUTS定数:**
```typescript
export const API_TIMEOUTS = {
  SHORT: 5000,    // 短時間API用 (5秒)
  DEFAULT: 30000, // 標準タイムアウト (30秒)
} as const;
```

**TIME_THRESHOLDS定数:**
```typescript
export const TIME_THRESHOLDS = {
  IMMEDIATE: 3000, // 即時判定閾値 (3秒)
} as const;
```

**UI_DELAYS拡張:**
```typescript
export const UI_DELAYS = {
  // 既存プロパティ...
  THROTTLE: 300,  // UIスロットル遅延
  DEBOUNCE: 500,  // UIデバウンス遅延
} as const;
```

#### 4.2 値の根拠

**API_TIMEOUTS値:**
- `SHORT: 5000`: 高速APIレスポンス想定、ユーザー体験を優先
- `DEFAULT: 30000`: 既存のNETWORK_TIMEOUTS.DEFAULTと整合

**TIME_THRESHOLDS値:**
- `IMMEDIATE: 3000`: コード内コメント「3秒以内」に基づく

**UI_DELAYS値:**
- `THROTTLE: 300`: 既存THROTTLE_DELAYS.CLICKと整合
- `DEBOUNCE: 500`: 既存DEBOUNCE_DELAYS.INPUTと整合

### 5. 実装の影響範囲

#### 5.1 修正対象ファイル
- **主要**: `constants/delays.ts`

#### 5.2 影響を受けるファイル
- `src/lib/api/index.ts` (直接)
- `src/lib/axios.ts` (間接)
- `src/app/(authenticated)/(admin)/approval-reminder/page.tsx` (間接)
- その他、lib/api/index.tsを使用する全コンポーネント

#### 5.3 副次的効果
- ✅ 一貫したタイムアウト管理
- ✅ 型安全性の向上
- ✅ 開発者体験の改善

### 6. 技術的検証

#### 6.1 型定義
```typescript
export type ApiTimeouts = typeof API_TIMEOUTS;
export type TimeThresholds = typeof TIME_THRESHOLDS;
```

#### 6.2 後方互換性
- ✅ 既存のAPI_DELAYSは保持
- ✅ 既存のTHROTTLE_DELAYS, DEBOUNCE_DELAYSは保持
- ✅ 新規定数のみ追加、既存機能に影響なし

#### 6.3 将来性
- ✅ 拡張可能な設計
- ✅ 明確な命名規則
- ✅ 適切な値の範囲

### 7. 代替案検討

#### 案A: インポート変更
```typescript
// 変更前
import { API_TIMEOUTS, TIME_THRESHOLDS, UI_DELAYS } from '@/constants/delays';

// 変更後
import { API_DELAYS, UI_DELAYS } from '@/constants/delays';
import { NETWORK_TIMEOUTS } from '@/constants/network';
```

**評価**: ❌ 複数ファイルインポート、一貫性欠如

#### 案B: 新規定数追加 (推奨)
```typescript
// constants/delays.tsに不足定数を追加
export const API_TIMEOUTS = { SHORT: 5000, DEFAULT: 30000 } as const;
export const TIME_THRESHOLDS = { IMMEDIATE: 3000 } as const;
// UI_DELAYSにTHROTTLE、DEBOUNCEを追加
```

**評価**: ✅ 期待される期待されるAPIインターフェース維持、一貫性確保

#### 案C: エイリアス作成
```typescript
export const API_TIMEOUTS = {
  SHORT: NETWORK_TIMEOUTS.SHORT,
  DEFAULT: NETWORK_TIMEOUTS.DEFAULT,
} as const;
```

**評価**: △ 参照の複雑化、デバッグ困難

### 8. セキュリティ・パフォーマンス考慮

#### 8.1 セキュリティ
- ✅ タイムアウト値は適切な範囲
- ✅ DoS攻撃リスクの軽減
- ✅ 機密情報なし

#### 8.2 パフォーマンス
- ✅ 定数参照のみ、実行時コストなし
- ✅ Tree-shakingに対応
- ✅ バンドルサイズへの影響微小

### 9. テスト戦略

#### 9.1 単体テスト
- 定数値の妥当性検証
- 型安全性の確認

#### 9.2 統合テスト
- lib/api/index.tsの正常動作確認
- タイムアウト設定の動作確認

#### 9.3 回帰テスト
- 既存機能への影響確認
- ビルド成功確認

## 実装推奨事項

### Phase 1: 定数追加
1. `constants/delays.ts`にAPI_TIMEOUTS追加
2. `constants/delays.ts`にTIME_THRESHOLDS追加
3. `constants/delays.ts`のUI_DELAYSを拡張

### Phase 2: 検証
1. ビルドエラー解消確認
2. TypeScript型チェック
3. 開発サーバー起動確認

### Phase 3: テスト
1. 基本動作テスト
2. タイムアウト動作テスト
3. 既存機能回帰テスト

## 結論

**調査結論**: API_TIMEOUTS、TIME_THRESHOLDS、UI_DELAYS拡張の不足により、lib/api/index.tsでビルドエラーが発生している。

**推奨解決策**: constants/delays.tsに不足定数を追加することで、期待されるAPIインターフェースを完成させ、既存コードとの互換性を保つ。

**実装優先度**: High - ビルドエラーのため即座の対応が必要

**リスク評価**: Low - 新規定数追加のみ、既存機能への影響なし

---

## 技術仕様詳細

### 追加定数仕様

#### API_TIMEOUTS
```typescript
export const API_TIMEOUTS = {
  SHORT: 5000,     // 短時間API用タイムアウト (ミリ秒)
  DEFAULT: 30000,  // 標準タイムアウト (ミリ秒)
} as const;
```

#### TIME_THRESHOLDS
```typescript
export const TIME_THRESHOLDS = {
  IMMEDIATE: 3000, // 即時判定閾値 (ミリ秒)
} as const;
```

#### UI_DELAYS拡張
```typescript
export const UI_DELAYS = {
  TOOLTIP_SHOW: 500,
  TOOLTIP_HIDE: 100,
  DROPDOWN_SHOW: 100,
  DROPDOWN_HIDE: 150,
  MODAL_SHOW: 200,
  MODAL_HIDE: 200,
  ALERT_AUTO_HIDE: 5000,
  NOTIFICATION_AUTO_HIDE: 4000,
  SNACKBAR_AUTO_HIDE: 3000,
  THROTTLE: 300,   // 新規追加
  DEBOUNCE: 500,   // 新規追加
} as const;
```

### 型定義追加
```typescript
export type ApiTimeouts = typeof API_TIMEOUTS[keyof typeof API_TIMEOUTS];
export type TimeThresholds = typeof TIME_THRESHOLDS[keyof typeof TIME_THRESHOLDS];
```

---

**調査完了日時**: 2025-07-17 11:28:35  
**次フェーズ**: Plan - 実装計画策定  
**推奨事項**: 即座の実装開始