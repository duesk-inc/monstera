# バグ調査レポート - 週報提出ボタン処理実行問題

## 調査日時
2025-01-17 10:07:00

## 問題の概要
週報提出画面の「提出する」ボタンをクリックしても処理が実行されない。
ブラウザコンソールに「[Violation] 'click' handler took 252ms」というエラーが表示される。
APIクライアントのリファクタリング実施後に発生。

## 調査方法
1. 週報コンポーネントの実装確認
2. イベントハンドラーの処理フロー追跡
3. APIクライアントの実装調査
4. インターセプターの動作確認
5. 二重処理の検出

## 調査結果

### 1. 処理フローの特定
```
1. ユーザーが「提出する」ボタンをクリック
   ↓
2. page.tsx: handleOpenSubmitDialog (351行目)
   ↓
3. validateForm() でバリデーション
   ↓
4. ダイアログを表示
   ↓
5. useWeeklyReport: handleSubmit (150-163行目)
   ↓
6. checkSameWorkTimes() で時間チェック
   ↓
7. submitWeeklyReport() を呼び出し
   ↓
8. saveAndSubmitWeeklyReport() (weeklyReport.ts:462行目)
   ↓
9. createWeeklyReport() または updateWeeklyReport()
   ↓
10. getAuthClient() でAPIクライアント取得
   ↓
11. client.post() でAPIリクエスト
```

### 2. 根本原因の特定

#### 問題：二重の401エラー処理

**1. client.ts (275-289行目)**
```typescript
client.interceptors.response.use(
  (response) => response,
  (error: AxiosError) => {
    // 401エラーの場合、ログイン画面へリダイレクト
    if (error.response?.status === 401) {
      if (typeof window !== 'undefined') {
        const currentPath = window.location.pathname;
        if (!currentPath.startsWith('/auth/')) {
          // 即座にリダイレクト
          window.location.href = `/auth/login?redirect=${encodeURIComponent(currentPath)}`;
        }
      }
    }
    return Promise.reject(error);
  }
);
```

**2. index.ts (142-175行目)**
```typescript
api.interceptors.response.use(
  (response: AxiosResponse) => {
    return response;
  },
  async (error: AxiosError) => {
    // 401エラーの場合 - リフレッシュトークンでリトライ
    if (error.response && error.response.status === 401) {
      try {
        await refreshToken();
        originalRequest._isRetry = true;
        return api(originalRequest);
      } catch {
        return handleAuthError(error);
      }
    }
    return Promise.reject(error);
  }
);
```

### 3. 問題の詳細

1. **インターセプターの競合**
   - `client.ts`のインターセプターが先に実行される
   - 401エラーで即座にリダイレクトを試みる
   - `window.location.href`の変更処理が252msかかる
   - `index.ts`のリフレッシュトークン処理が実行されない

2. **処理の中断**
   - リダイレクト処理により、後続の処理が中断される
   - ユーザーには何も起きていないように見える
   - 実際にはリダイレクト処理が内部で実行されている

3. **パフォーマンスへの影響**
   - 252msの遅延は`window.location.href`の変更処理に起因
   - ブラウザがリダイレクトを準備するが、実際には実行されない可能性

### 4. 影響範囲
この問題は以下の機能すべてに影響します：
- 週報の提出機能
- 週報の一時保存機能
- その他401エラーが発生する可能性のあるすべてのAPI呼び出し

### 5. 追加の問題点

1. **getAuthClient()の実装**
   - 現在の実装は正しくキャッシュされたインスタンスを返している
   - しかし、インターセプターが二重に設定されている

2. **エラーハンドリングの不整合**
   - 2つの異なるアプローチで401エラーを処理
   - 一方は即座にリダイレクト、もう一方はトークンリフレッシュ

## 推奨される修正方法

### 修正案1：client.tsの401処理を削除
```typescript
// client.ts のインターセプターから401処理を削除
// index.ts の処理に統一する
```

### 修正案2：処理の統合
```typescript
// どちらか一方のファイルで401処理を統一
// リフレッシュトークン → 失敗時のみリダイレクト
```

### 修正案3：フラグによる制御
```typescript
// リダイレクト処理中フラグを共有
// 二重実行を防ぐ
```

## テスト結果
- デバッグツール作成: `test-submit-debug.html`
- 401エラーでリダイレクト処理が発生することを確認
- インターセプターの二重登録を確認

## 結論
APIクライアントのリファクタリング時に、401エラー処理が二重に実装されたことが原因。
`client.ts`と`index.ts`の両方で401エラーをインターセプトしており、
`client.ts`の即座のリダイレクト処理が252msの遅延を引き起こし、
週報提出ボタンが機能しなくなっている。

## 次のステップ
二重インターセプター問題を修正し、401エラー処理を統一する必要がある。

---

**status**: SUCCESS
**next**: BUG-FIX
**details**: "二重インターセプター問題を特定。bug-investigate_20250117_100700.mdに詳細記録。修正フェーズへ移行。"