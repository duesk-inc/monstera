# 監査ログContext Canceledエラー調査報告書

## 調査日時
2025年7月13日 15:32:53

## 調査担当
Claude

## 調査ブランチ
fix/audit-log-context

## 調査概要
監査ログ記録時に発生している`context canceled`エラーの原因を調査し、解決方針を策定。

## エラー内容
```
monstera-backend | 2025-07-13T15:03:30.942+0900 ERROR repository/audit_log_repository.go:78 
Failed to create audit log {"error": "context canceled", "user_id": "c1df157f-94ff-4d76-afd5-0b660292e2a7", 
"action": "NOTIFICATION_VIEW", "resource_type": "NOTIFICATION"}
```

## 問題の詳細

### 発生箇所
- ログイン後の通知取得時（/api/v1/notifications）
- HTTPリクエスト処理後の監査ログ記録時

### スタックトレース
```
main.setupRouter.AuditLogMiddleware.func5.1
    /app/internal/middleware/audit_log.go:105
github.com/duesk/monstera/internal/service.(*auditLogService).LogHTTPRequest
    /app/internal/service/audit_log_service.go:157
github.com/duesk/monstera/internal/service.(*auditLogService).LogActivity
    /app/internal/service/audit_log_service.go:109
github.com/duesk/monstera/internal/repository.(*auditLogRepository).Create
    /app/internal/repository/audit_log_repository.go:78
```

## 根本原因

### 1. 非同期処理でのコンテキスト問題
```go
// middleware/audit_log.go:104-119
go func() {
    if err := auditService.LogHTTPRequest(
        c,  // HTTPリクエストのGinコンテキスト
        userID.(uuid.UUID),
        model.AuditActionType(action),
        model.ResourceType(resourceType),
        resourceID,
        duration,
    ); err != nil {
        // エラー処理
    }
}()
```

### 2. キャンセルされたコンテキストの使用
```go
// service/audit_log_service.go:157
return s.LogActivity(c.Request.Context(), params)  // HTTPリクエストのコンテキストを使用
```

### 3. 問題のフロー
1. HTTPリクエストが処理される
2. レスポンスが返される
3. goroutineで監査ログ記録が開始される
4. この時点でHTTPリクエストのコンテキストはキャンセル済み
5. データベース操作でcontext canceledエラーが発生

## 技術的制約と可能性

### Goの標準的なパターン
- 非同期処理では新しいコンテキストを作成するのが一般的
- プロジェクト内の他の非同期処理でも`context.Background()`が使用されている

### 例：バッチ処理での実装
```go
// internal/batch/metrics_collector.go:72
ctx := context.Background()
```

## 解決方針

### 1. ミドルウェアの修正
goroutine内で新しいバックグラウンドコンテキストを作成し、サービス層に渡す。

### 2. サービス層の修正
HTTPリクエストのコンテキストではなく、新しいコンテキストを受け取るように修正。

### 3. 必要な情報の事前抽出
HTTPリクエストから必要な情報（IPアドレス、User-Agent等）を事前に抽出し、構造体として渡す。

## 影響範囲
- backend/internal/middleware/audit_log.go
- backend/internal/service/audit_log_service.go
- 既存の監査ログ記録機能への影響はなし（エラーが解消されるのみ）

## リスク評価
- **低リスク**: 監査ログは非同期で記録されるため、メイン処理への影響なし
- **セキュリティ**: 監査ログの記録が確実に行われるようになる

## 推奨事項

### 実装手順
1. ミドルウェアでバックグラウンドコンテキストを作成
2. サービス層のインターフェースを調整
3. テストケースの追加
4. 動作確認

### 追加考慮事項
- タイムアウトの設定（必要に応じて）
- エラーハンドリングの強化
- メトリクスの追加（監査ログ記録の成功/失敗率）

## 次フェーズ
PLANフェーズでの詳細な実装計画策定を推奨。