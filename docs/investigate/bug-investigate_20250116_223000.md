# バグ調査報告書 - APIクライアント実装の徹底的深層調査

## 調査日時
2025-01-16 22:30:00

## 調査概要
職務経歴APIの404エラーについて、正常動作している週報・休暇申請APIとの実装差異を徹底的に調査し、根本原因と統一方針を明確化した。

## 1. 現状のAPIクライアント構成

### A. 正常動作しているAPI群（週報、休暇申請、スキルシート等）

#### 実装パターン
```typescript
// 週報API例 (frontend/src/lib/api/admin/weeklyReport.ts)
import axios from '@/lib/axios';  // = getAuthClient()
const ADMIN_BASE_PATH = '/api/v1/admin';
await axios.get(`${ADMIN_BASE_PATH}/engineers/weekly-reports`);

// 休暇申請API例 (frontend/src/components/admin/leave/LeaveRequestList.tsx)
import apiClient from '@/lib/axios';
await apiClient.get('/api/v1/leave/types');

// スキルシートAPI例 (frontend/src/lib/api/skillSheet.ts)
import { getAuthClient } from '@/lib/api';
import { SKILL_SHEET_API } from '@/constants/api';
const client = getAuthClient();
await client.get(SKILL_SHEET_API.GET);  // = '/api/v1/skill-sheet'
```

**共通点：パスに`/api/v1`をハードコードしている**

#### 使用しているAPIクライアント
- **`@/lib/axios`** (getAuthClient()のエイリアス)
- **`@/lib/api/index.ts`** で定義
- **baseURL**: `process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080'`
- **使用箇所**: 14ファイル（主要なAPI実装の大部分）

### B. 動作していないAPI（職務経歴API）

#### 実装パターン
```typescript
// 職務経歴API (frontend/src/lib/api/workHistory.ts)
import { apiClient } from './config';
await apiClient.post('/work-history', data);  // /api/v1が含まれない
```

**問題点：相対パスを使用し、baseURLに依存**

#### 使用しているAPIクライアント
- **`./config`** のapiClient（独自実装）
- **`/lib/api/config.ts`** で定義
- **baseURL**: `process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api/v1'`
- **使用箇所**: 1ファイルのみ（職務経歴API）

## 2. 根本原因の分析

### 主要な問題
1. **環境変数の設定ミス**
   ```
   # frontend/.env.local
   NEXT_PUBLIC_API_URL=http://localhost:8080  # /api/v1が欠落
   ```

2. **APIクライアントの重複と不統一**
   - 3つの異なる場所でAPI_BASE_URLを定義
   - デフォルト値が統一されていない
   - 職務経歴APIのみが異なるクライアントを使用

### なぜ他のAPIは動作しているのか？
**重要な発見：動作しているAPIは全てパスに`/api/v1`を含めているため、環境変数の影響を受けない**

```typescript
// 動作する（パスがハードコード）
await axios.get('/api/v1/weekly-reports');

// 動作しない（baseURLに依存）
await apiClient.post('/work-history');
// 実際のリクエスト: http://localhost:8080/work-history ← 404エラー
```

## 3. APIクライアント利用状況の全体像

### ファイル別使用状況
| APIクライアント | 使用ファイル数 | 主な用途 |
|---|---|---|
| `@/lib/axios` (getAuthClient) | 14ファイル | 週報、休暇、通知、管理画面等 |
| `./config` のapiClient | 1ファイル | 職務経歴APIのみ |
| 直接getAuthClient() | 10ファイル | プロファイル、スキルシート等 |

### API実装の分類
| カテゴリ | 実装方法 | 動作状況 |
|---|---|---|
| 管理画面API | `@/lib/axios` + ハードコードパス | ✅ 正常 |
| 週報API | `@/lib/axios` + ハードコードパス | ✅ 正常 |
| 休暇申請API | `@/lib/axios` + ハードコードパス | ✅ 正常 |
| スキルシートAPI | getAuthClient() + 定数パス | ✅ 正常 |
| 職務経歴API | 独自apiClient + 相対パス | ❌ エラー |

## 4. 不要ファイルの特定

### 削除候補
1. **`/lib/api/config.ts`** のapiClient実装
   - 職務経歴APIのみで使用
   - 他のAPIと実装が異なる
   - 混乱の元

### 統合候補
1. **`/constants/api.ts`** のAPI_BASE_URL定義
   - `/lib/api/index.ts`と重複
   - デフォルト値が異なる

## 5. 統一方針と推奨事項

### 短期対策（即座の修正）
1. **環境変数の修正**
   ```bash
   # frontend/.env.local
   NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
   ```

2. **職務経歴APIの修正**
   ```typescript
   // frontend/src/lib/api/workHistory.ts
   - import { apiClient } from './config'
   + import apiClient from '@/lib/axios'
   
   // パスは相対パスのまま（baseURLが正しければ動作）
   await apiClient.post('/work-history', data)
   ```

### 中期対策（コードベースの改善）
1. **APIクライアントの統一**
   - 全てのAPIで`@/lib/axios`を使用
   - 独自実装の`./config`を削除

2. **環境変数の分離とバージョン管理**
   ```bash
   # より保守性の高い設定
   NEXT_PUBLIC_API_HOST=http://localhost:8080
   NEXT_PUBLIC_API_VERSION=v1
   # NEXT_PUBLIC_API_URL は廃止（動的生成）
   ```

3. **ハードコードされた`/api/v1`の段階的削除**
   ```typescript
   // 現在（冗長）
   await apiClient.get('/api/v1/weekly-reports')
   
   // 改善後（DRY原則）
   await apiClient.get('/weekly-reports')
   ```

4. **不要ファイルの削除**
   - `/lib/api/config.ts`のapiClient部分
   - 重複するAPI_BASE_URL定義

### 長期対策（アーキテクチャ改善）
1. **APIクライアントファクトリパターンの導入**
   ```typescript
   interface ApiConfig {
     version?: string;
     timeout?: number;
     customPath?: string;
   }
   
   export const createApiClient = (config: ApiConfig = {}) => {
     const host = process.env.NEXT_PUBLIC_API_HOST || 'http://localhost:8080';
     const version = config.version || process.env.NEXT_PUBLIC_API_VERSION || 'v1';
     const basePath = config.customPath || '/api';
     
     const baseURL = `${host}${basePath}/${version}`;
     
     return axios.create({
       baseURL,
       timeout: config.timeout || 30000,
       withCredentials: true,
     });
   };
   
   // 使用例
   const defaultClient = createApiClient();  // /api/v1
   const v2Client = createApiClient({ version: 'v2' });  // /api/v2
   const adminClient = createApiClient({ customPath: '/admin/api' });  // /admin/api/v1
   ```

2. **環境変数のバリデーション強化**
   ```typescript
   const buildApiUrl = (host: string, version: string): string => {
     if (!host) {
       console.warn('API host not configured, using default');
       host = 'http://localhost:8080';
     }
     if (!version) {
       console.warn('API version not configured, using v1');
       version = 'v1';
     }
     return `${host}/api/${version}`;
   };
   ```

### 移行計画
| Phase | 作業内容 | 影響範囲 | リスク |
|---|---|---|---|
| 1 | 環境変数修正 + 職務経歴API修正 | 1ファイル | 低 |
| 2 | 環境変数の分離（HOST/VERSION） | 設定ファイル | 低 |
| 3 | ハードコード`/api/v1`の削除 | 14ファイル | 中 |
| 4 | APIクライアントファクトリ導入 | 全API | 中 |

### メリット
- **バージョン管理**: 環境変数1箇所で制御
- **マルチバージョン対応**: 段階的移行が可能
- **環境別設定**: HOST/VERSION/PATHを個別管理
- **保守性向上**: DRY原則に従った実装
- **将来性**: GraphQL等への移行も柔軟に対応

## 6. テスト計画

### 修正後の確認項目
1. [ ] 職務経歴の作成・更新・削除
2. [ ] 既存の週報機能（影響がないこと）
3. [ ] 既存の休暇申請機能（影響がないこと）
4. [ ] スキルシート機能（影響がないこと）
5. [ ] 全APIエンドポイントの疎通確認

## 7. 影響範囲とリスク評価

### 影響範囲
- **直接的影響**: 職務経歴API
- **潜在的影響**: なし（他のAPIはハードコードパスのため）

### リスク評価
- **短期対策のリスク**: 低（環境変数の修正のみ）
- **中期対策のリスク**: 中（コード変更が必要）
- **移行の複雑さ**: 低（1ファイルのみの変更）

## 8. 結論

### 問題の本質
1. **環境変数の設定ミス**が直接的な原因
2. **APIクライアントの実装不統一**が問題を複雑化
3. **パス管理の不一致**（ハードコード vs 相対パス）が根本的な設計問題

### 成功パターン
- 動作しているAPIは全て`/api/v1`をパスに含めている
- `@/lib/axios`（getAuthClient）を使用している
- 環境変数の影響を受けない実装

### 推奨アクション
1. **即座**: 環境変数を修正
2. **次期**: 職務経歴APIを統一パターンに移行
3. **将来**: APIクライアント実装を完全統一

## 添付資料

### APIクライアントファイル一覧
```
frontend/src/lib/
├── api/
│   ├── index.ts         # メインAPIクライアント（getAuthClient）✅
│   ├── config.ts        # 独自apiClient ❌ 削除候補
│   └── workHistory.ts   # 唯一の問題API ❌ 要修正
├── axios.ts             # getAuthClientのエイリアス ✅
└── constants/
    └── api.ts           # API定数定義 ⚠️ 要整理
```

### 移行コード例

#### Phase 1: 最小限の修正
```typescript
// Before（動作しない）
import { apiClient } from './config';
await apiClient.post('/work-history', data);

// After（動作する - 環境変数修正後）
import apiClient from '@/lib/axios';
await apiClient.post('/work-history', data);  // baseURLに/api/v1が含まれる
```

#### Phase 2: 環境変数の分離
```bash
# Before
NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1

# After
NEXT_PUBLIC_API_HOST=http://localhost:8080
NEXT_PUBLIC_API_VERSION=v1
```

#### Phase 3: ハードコードの削除
```typescript
// Before（冗長）
await apiClient.get('/api/v1/weekly-reports');
await apiClient.post('/api/v1/leave/apply');

// After（DRY）
await apiClient.get('/weekly-reports');
await apiClient.post('/leave/apply');
```

#### Phase 4: 高度なバージョン管理
```typescript
// 複数バージョンの並行運用
const v1Client = createApiClient({ version: 'v1' });
const v2Client = createApiClient({ version: 'v2' });

// 古いエンドポイント
await v1Client.get('/legacy-reports');

// 新しいエンドポイント
await v2Client.get('/reports');
```