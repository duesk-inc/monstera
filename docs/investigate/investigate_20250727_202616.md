# 経費申請のdraftステータス削除に関する調査

## 調査日時
2025-07-27 20:26:16

## 調査概要
経費申請において、新規作成時のステータスが「下書き（draft）」になっているが、下書き機能が実装されていないため、ステータスから削除する要件について調査した。

## 問題の背景
- 経費申請を作成すると、ステータスが「下書き」になる
- 実際には下書き機能（一時保存など）は実装されていない
- ユーザーは「申請中」または「申請済み」のステータスを期待している

## 調査結果

### 1. 現状分析

#### 1.1 ステータス定義
経費申請のステータスは以下の箇所で定義されている：

**バックエンド:**
- `/backend/internal/model/expense.go` - ExpenseStatusDraft = "draft"
- 新規作成時のデフォルトステータスとして使用

**フロントエンド:**
- `/frontend/src/constants/expense.ts` - EXPENSE_STATUS.DRAFT = "draft"
- `/frontend/src/utils/expenseMappers.ts` - "draft" → "下書き" のマッピング

**データベース:**
- マイグレーションファイルでDEFAULT 'draft'として定義
- CHECK制約に含まれている

#### 1.2 実装状況
- **バックエンド**: 下書き→提出のAPIエンドポイント（`/api/v1/expenses/{id}/submit`）は実装済み
- **フロントエンド**: UIに「提出」ボタンが実装されていない
- **現在のフロー**: 作成 → 自動的にdraft → 提出機能がUIにないため、draftのまま

### 2. 問題の根本原因
1. バックエンドでは下書き機能が完全に実装されている
2. フロントエンドのUIで下書き機能が未実装
3. 結果として、すべての経費申請がdraft状態で止まっている

### 3. 影響範囲

#### 3.1 draftステータス削除の直接的影響
1. **データベース**
   - マイグレーションの作成が必要
   - CHECK制約の更新
   - 既存データの移行

2. **バックエンド**
   - モデル定義の変更
   - サービス層の新規作成ロジック変更
   - CanEdit(), CanSubmit()メソッドの見直し
   - SubmitExpenseメソッドの削除または変更
   - テストコードの大幅な修正

3. **フロントエンド**
   - 型定義・定数の変更
   - 作成フローの変更
   - UIの文言変更
   - テストコードの修正

#### 3.2 システム全体への影響
- **週報機能**: 同様にdraftステータスを使用しており、UIで「下書き保存」ボタンが実装されている
- **UI/UXの一貫性**: 週報では下書き機能があるのに、経費申請ではない状態になる
- **将来の拡張性**: 他の申請系機能でも同様の問題が発生する可能性

### 4. 解決方針の選択肢

#### オプション1: フロントエンドに下書き機能を実装（推奨）
**メリット:**
- バックエンドの変更が不要
- システム全体の一貫性を保てる
- 週報との操作性の統一
- ユーザーが入力途中のデータを保存できる

**デメリット:**
- フロントエンドの開発工数が必要

**必要な実装:**
1. 経費申請詳細画面に「提出」ボタンを追加
2. 経費申請一覧でdraft状態を識別しやすくする
3. 作成時に「下書き保存」と「作成して提出」の選択肢を提供

#### オプション2: draftステータスを削除し、直接submitted状態で作成
**メリット:**
- 現在のユーザーの期待に合致
- シンプルなフロー

**デメリット:**
- 大規模な変更が必要（DB、バックエンド、フロントエンド、テスト）
- 週報との一貫性が失われる
- 入力途中のデータ保存機能がなくなる

#### オプション3: 段階的な移行
**メリット:**
- リスクを最小限に抑えられる
- ユーザーフィードバックを収集できる

**デメリット:**
- 一時的に機能間で不整合が発生
- 移行期間中の混乱

### 5. 技術的制約
1. データベースのCHECK制約を変更する場合、既存データの移行が必要
2. APIの後方互換性を考慮する必要がある
3. テストコードの大幅な修正が必要

### 6. 推奨事項

**短期的対応（推奨）:**
フロントエンドに下書き機能を実装する（オプション1）
- 実装工数: 小〜中規模
- リスク: 低
- システムの一貫性: 維持される

**理由:**
1. バックエンドは既に実装済みで、フロントエンドの実装のみで解決
2. 週報との一貫性を保てる
3. ユーザーにとって有用な機能（入力途中の保存）を提供できる
4. 将来的な要件変更に柔軟に対応できる

**長期的検討:**
システム全体でのステータス管理方針の見直し
- ローカルストレージを使用した自動保存機能の導入
- 統一的な申請フローの設計

## 次のアクション
1. フロントエンドの下書き機能実装の詳細設計（PLANフェーズ）
2. 実装スケジュールの策定
3. テスト計画の作成

## 結論
draftステータスの削除は技術的に可能だが、影響範囲が大きく、システムの一貫性を損なう。代わりに、フロントエンドに下書き機能を実装することで、既存の設計を活かしつつ、ユーザーの期待に応えることができる。