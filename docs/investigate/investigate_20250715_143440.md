# ActiveRoleProvider Missing Error 調査結果

## 調査概要
- **日時**: 2025-07-15 14:34:40
- **対象**: Runtime Error - useActiveRole must be used within an ActiveRoleProvider
- **ブランチ**: fix/sidebar-component-import (継続)
- **エラー内容**: `Error: useActiveRole must be used within an ActiveRoleProvider`

## エラー詳細
```
Error: useActiveRole must be used within an ActiveRoleProvider

src/context/ActiveRoleContext.tsx (162:11) @ useActiveRole
  160 |   const context = useContext(ActiveRoleContext);
  161 |   if (context === undefined) {
> 162 |     throw new Error('useActiveRole must be used within an ActiveRoleProvider');
      |           ^
  163 |   }
  164 |   return context;
  165 | };

Call Stack:
useActiveRole (src/context/ActiveRoleContext.tsx:162:11)
useAuth (src/hooks/useAuth.ts:43:48)  
SharedLayoutWrapper (src/components/common/layout/SharedLayoutWrapper.tsx:45:61)
RootLayout (src/app/(authenticated)/layout.tsx:29:5)
```

## 根本原因分析

### 1. エラー発生の仕組み
- **コールスタック分析**:
  1. `(authenticated)/layout.tsx` がSharedLayoutWrapperを使用 (line 29)
  2. `SharedLayoutWrapper.tsx` がuseAuthフックを使用 (line 45)
  3. `useAuth.ts` がuseActiveRoleフックを使用 (line 43)
  4. `useActiveRole` がActiveRoleContextを要求 (line 160-162)
  5. **ActiveRoleProviderが存在しないためエラー発生**

### 2. Provider設定の現状分析

#### ✅ providers.tsx - 正しく設定されている
```typescript
// src/app/providers.tsx (line 70-74)
<ActiveRoleProvider>
  <QueryErrorBoundary>
    {children}
  </QueryErrorBoundary>
</ActiveRoleProvider>
```

#### ❌ app/layout.tsx - Providersが使用されていない
```typescript
// src/app/layout.tsx (line 25-31)
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable}`}>
        {children}  // Providersでラップされていない！
      </body>
    </html>
  );
}
```

### 3. 期待される構造 vs 実際の構造

#### 期待される構造
```
app/layout.tsx
  └─ Providers
      └─ ActiveRoleProvider
          └─ (authenticated)/layout.tsx
              └─ SharedLayoutWrapper
                  └─ useAuth → useActiveRole ✅
```

#### 実際の構造
```
app/layout.tsx
  └─ (authenticated)/layout.tsx (Providersなし)
      └─ SharedLayoutWrapper
          └─ useAuth → useActiveRole ❌ (Providerが存在しない)
```

## 技術的詳細分析

### 1. ActiveRoleContext実装の確認
- **定義場所**: `src/context/ActiveRoleContext.tsx`
- **Provider**: `ActiveRoleProvider` - 正常に実装済み
- **Hook**: `useActiveRole` - Context存在チェック付き (line 160-162)
- **機能**: 役割切り替え、権限管理、セッションストレージ連携

### 2. useAuth依存関係
```typescript
// src/hooks/useAuth.ts (line 43)
const { initializeActiveRole } = useActiveRole();
```
- **目的**: ユーザーログイン時のロール初期化
- **依存**: ActiveRoleProviderが必須

### 3. 影響範囲

#### 直接影響 - レイアウトファイル
- `src/app/(authenticated)/layout.tsx` - useAuth使用
- `src/app/(admin)/layout.tsx` - useAuth使用

#### 間接影響 - useActiveRole使用コンポーネント
- `src/components/ui/RoleSwitcher.tsx`
- `src/components/features/profile/ProfileTabbedContent.tsx` 
- `src/components/features/profile/AccountSettingsSection.tsx`

#### 二次影響 - SharedLayoutWrapper依存
- 全ての認証済みページ
- 全ての管理者ページ

## 解決方針

### A. 推奨解決策（必須修正）
**app/layout.txをProvidersでラップ**

```typescript
// Before
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable}`}>
        {children}
      </body>
    </html>
  );
}

// After  
import { Providers } from './providers';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable}`}>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
```

### B. 実装手順
1. `src/app/layout.tsx`にProvidersインポートを追加
2. childrenをProvidersコンポーネントでラップ
3. 動作確認とテスト実行

### C. 代替案（非推奨）
- 各レイアウトファイルで個別にActiveRoleProviderを設定
- **問題**: コード重複、状態の不整合リスク

## 実装時の考慮事項

### 1. Server/Client Component対応
- **app/layout.tsx**: Server Component (デフォルト)
- **providers.tsx**: 'use client' ディレクティブ付き Client Component
- **互換性**: Next.js 13+ App Router で正常に動作

### 2. Provider階層の確認
```typescript
// src/app/providers.tsx の構造
GlobalErrorBoundary
  └─ QueryClientProvider
      └─ ThemeProvider
          └─ ToastProvider
              └─ AuthErrorHandler  
              └─ AuthContext.Provider
                  └─ ActiveRoleProvider ← 対象
                      └─ QueryErrorBoundary
                          └─ children
```

### 3. パフォーマンスへの影響
- **初期化コスト**: React Context作成・初期化
- **再レンダリング**: Role変更時のみ発生
- **メモリ使用量**: セッションストレージのロール情報のみ
- **総合評価**: 軽微、無視できるレベル

## リスク分析・対策

### 1. 既存機能への影響 (Low)
- **リスク**: 既存のContext依存コンポーネントへの影響
- **対策**: providers.tsxは既に全てのContext設定済み、影響なし

### 2. SSR/Hydration 関連 (Very Low)  
- **リスク**: Server/Client間での状態不整合
- **対策**: ActiveRoleProviderはクライアントサイドのみで動作設計済み

### 3. 認証フロー影響 (Very Low)
- **リスク**: ログイン・ログアウトフローへの影響
- **対策**: 既存の認証ロジックは変更なし、Context提供のみ

### 4. 設定ファイル依存関係 (Very Low)
- **リスク**: providers.tsxのインポートエラー
- **対策**: 既存ファイルで動作確認済み

## 検証・テスト戦略

### 1. 修正後の動作確認
- [ ] ログインページの正常表示
- [ ] 認証後ページの正常表示  
- [ ] 管理者ページの正常表示
- [ ] ロール切り替え機能の動作

### 2. エラー解消確認
- [ ] Runtime Errorの解消
- [ ] Console Errorの確認
- [ ] ブラウザ Developer Tools でのContext確認

### 3. 回帰テスト
- [ ] 既存機能の正常動作
- [ ] 認証フローの確認
- [ ] ユーザー権限制御の確認

## 関連ファイル

### 修正対象ファイル
- `src/app/layout.tsx` (主要修正)

### 参照・確認ファイル  
- `src/app/providers.tsx` (Provider設定)
- `src/context/ActiveRoleContext.tsx` (Context定義)
- `src/hooks/useAuth.ts` (依存関係)
- `src/components/common/layout/SharedLayoutWrapper.tsx` (使用箇所)
- `src/app/(authenticated)/layout.tsx` (エラー発生箇所)
- `src/app/(admin)/layout.tsx` (類似実装)

### useActiveRole使用箇所
- `src/components/ui/RoleSwitcher.tsx`
- `src/components/features/profile/ProfileTabbedContent.tsx`
- `src/components/features/profile/AccountSettingsSection.tsx`

## 次フェーズへの推奨事項

### 1. 即座の実装（必須）
- `app/layout.tsx`のProviders追加による緊急修正
- 最小限の変更でエラー解消

### 2. 動作確認（推奨）
- 全レイアウトでの動作テスト
- ロール関連機能の確認
- パフォーマンスチェック

### 3. 品質保証（推奨）
- TypeScript型チェック
- リント確認
- 既存テストの実行

## 完了基準

### 必須基準
- [ ] Runtime Errorの完全解消
- [ ] 認証済みページの正常表示
- [ ] 管理者ページの正常表示
- [ ] TypeScriptコンパイルの通過

### 推奨基準  
- [ ] ロール切り替え機能の正常動作
- [ ] パフォーマンス劣化の不在
- [ ] 既存テストの通過
- [ ] セキュリティ機能の正常動作

## ログ
- **エラー発生**: 認証済みレイアウトでのRuntime Error
- **調査開始**: 2025-07-15 14:34:40
- **根本原因特定**: app/layout.tsxでのProviders未使用
- **次フェーズ**: PLAN (実装計画策定)