# 調査報告書: 経費申請画面のカテゴリ選択時バリデーションエラー

## 調査日時
2025年7月26日 16:50

## 報告された問題
経費申請の新規作成画面でカテゴリを選択した後に、画面の下部に「入力内容に誤りがあります。」（VALIDATION_ERROR）が表示される。操作に誤りはないはずであるにも関わらず、エラーメッセージが表示される。

## 調査スコープ
- フロントエンド（ExpenseForm.tsx）のバリデーションロジック
- エラーメッセージ表示条件
- フィールドのタッチ状態管理

## 技術的な詳細分析

### 1. 問題の発生フロー
1. ユーザーが経費申請の新規作成画面を開く
2. カテゴリのドロップダウンを選択
3. カテゴリ選択後、フォーカスが外れる（onBlur）
4. 画面下部に「入力内容に誤りがあります。」が表示される

### 2. コードの動作分析

#### 現在の実装（ExpenseForm.tsx）

```tsx
// エラーメッセージ表示部分（459行目）
{Object.keys(errors).length > 0 && touched.categoryId && (
  <Grid size={12}>
    <Alert severity="error">
      {EXPENSE_MESSAGES.VALIDATION_ERROR}
    </Alert>
  </Grid>
)}
```

#### カテゴリフィールドの実装（354-362行目）
```tsx
onChange={(e) => {
  const selectedId = e.target.value;
  const selectedCategory = categories.find(cat => cat.id === selectedId);
  handleFieldChange('categoryId', selectedId);
  if (selectedCategory) {
    handleFieldChange('categoryCode', selectedCategory.code);
  }
}}
onBlur={() => handleFieldBlur('categoryId')}
```

#### handleFieldBlurの実装（205-216行目）
```tsx
const handleFieldBlur = useCallback((field: string) => {
  setTouched(prev => ({ ...prev, [field]: true }));
  
  // 単一フィールドのバリデーション
  const validationErrors = validateForm();
  const fieldError = validationErrors.find(error => error.field === field);
  
  setErrors(prev => ({
    ...prev,
    [field]: fieldError?.message || '',
  }));
}, [validateForm]);
```

### 3. 根本原因
カテゴリを選択してフォーカスが外れた時の動作：

1. `handleFieldBlur('categoryId')` が呼ばれる
2. `categoryId` が `touched` 状態になる
3. `validateForm()` が実行され、**すべてのフィールド**が検証される
4. 初期状態では以下のフィールドが空：
   - amount: 0（エラー: "金額を入力してください"）
   - description: ""（エラー: "内容は必須です"）
5. これらのエラーが `errors` オブジェクトに格納される
6. 条件 `Object.keys(errors).length > 0 && touched.categoryId` が真になる
7. グローバルエラーメッセージが表示される

### 4. 問題点
現在の実装では、カテゴリIDがタッチされたことだけを確認して、他のフィールドのエラーも含めてグローバルエラーメッセージを表示してしまっている。これは以下の問題を引き起こす：

- ユーザーがまだ入力していないフィールドのエラーで警告が出る
- カテゴリを選択しただけでエラーが表示され、UXが悪い
- エラーの内容が不明確（どのフィールドに問題があるか分からない）

## 解決策の提案

### 案1: フォーム送信時のみグローバルエラーを表示（推奨）
```tsx
// submitAttemptedという状態を追加
const [submitAttempted, setSubmitAttempted] = useState(false);

// エラーメッセージ表示条件を修正
{Object.keys(errors).length > 0 && submitAttempted && (
  <Grid size={12}>
    <Alert severity="error">
      {EXPENSE_MESSAGES.VALIDATION_ERROR}
    </Alert>
  </Grid>
)}

// handleSubmit内でsubmitAttemptedをtrueに設定
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setSubmitAttempted(true);
  // 以下既存の処理
}
```

### 案2: すべての必須フィールドがタッチされた場合のみ表示
```tsx
// 必須フィールドのリスト
const requiredFields = ['categoryId', 'amount', 'description', 'expenseDate'];

// すべてタッチされているかチェック
const allFieldsTouched = requiredFields.every(field => touched[field]);

// エラーメッセージ表示条件を修正
{Object.keys(errors).length > 0 && allFieldsTouched && (
  // ...
)}
```

### 案3: グローバルエラーメッセージを削除し、個別エラーのみ表示
各フィールドに既に個別のエラー表示があるため、グローバルエラーメッセージ自体を削除する。

## 推奨事項
案1（フォーム送信時のみグローバルエラーを表示）を推奨します。理由：

1. ユーザーがフォーム入力中に不要なエラーメッセージが表示されない
2. 送信ボタンを押した時点で全体的なバリデーションエラーがあることが明確になる
3. 実装が簡単で、他のフォームでも同様のパターンを適用できる
4. UXが向上し、ユーザーの混乱を避けられる

## 次のステップ
1. 実装計画の策定（PLANフェーズ）
2. 修正の実装
3. テストケースの作成と実行
4. 他のフォームコンポーネントでも同様の問題がないか確認