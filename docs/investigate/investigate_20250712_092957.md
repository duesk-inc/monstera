# ダッシュボード画面エラー調査結果

## 調査日時
2025-07-12 09:29:57

## 調査対象
- ログイン後のダッシュボード画面遷移時に発生するエラー
- 経費申請データ取得エラー
- 通知一覧取得エラー

## エラー内容

### 1. バックエンドエラー
```
monstera-backend | 2025-07-12T09:01:42.417+0900 ERROR userutil/userutil.go:25 ユーザーIDの型が無効です {"userID": "b3a24525-7198-4643-b607-ebf16e2fe8b6"}
```

### 2. フロントエンドエラー
- 経費申請データの取得に失敗しました
- 通知一覧の取得に失敗しました: サーバーからの応答がありません

## 根本原因

### ユーザーID型の不整合
1. **cognito_auth.go**（111行目、155行目）: 
   ```go
   c.Set("user_id", user.ID.String())  // 文字列として設定
   ```

2. **userutil.go**（22行目）:
   ```go
   userID, ok := userIDValue.(uuid.UUID)  // UUID型として取得を試みる
   ```

この型の不整合により、型アサーションが失敗し、すべてのAPIリクエストが401 Unauthorizedエラーとなる。

### 影響範囲
- すべての認証が必要なAPIエンドポイント
  - `/api/v1/expenses/summary` - 経費申請集計
  - `/api/v1/notifications` - 通知一覧
  - その他すべての認証必須API

## 技術的詳細

### 処理フロー
1. Cognito認証ミドルウェアでJWTトークンを検証
2. ユーザー情報を取得し、コンテキストに設定
3. ハンドラーで`GetAuthenticatedUserID`を呼び出し
4. `userutil.GetUserIDFromContext`でユーザーIDを取得
5. 型アサーション失敗により401エラー

### 関連ファイル
- `/backend/internal/middleware/cognito_auth.go`
- `/backend/internal/common/userutil/userutil.go`
- `/backend/internal/handler/handler_util.go`
- `/backend/internal/handler/notification_handler.go`
- `/backend/internal/handler/expense_handler.go`

## 解決方針

### 推奨解決策: cognito_auth.goの修正
cognito_auth.goでuser_idをUUID型として設定する：

```go
// 現在のコード（111行目、155行目）
c.Set("user_id", user.ID.String())

// 修正後
c.Set("user_id", user.ID)  // UUID型のまま設定
```

### 代替解決策: userutil.goの修正
userutil.goで文字列からUUIDへの変換を行う：

```go
// 文字列として取得してからUUIDに変換
userIDStr, ok := userIDValue.(string)
if !ok {
    // UUID型の場合はそのまま使用
    userID, ok := userIDValue.(uuid.UUID)
    if !ok {
        logger.Error("ユーザーIDの型が無効です", zap.Any("userID", userIDValue))
        return uuid.Nil, false
    }
    return userID, true
}

// 文字列からUUIDに変換
userID, err := uuid.Parse(userIDStr)
if err != nil {
    logger.Error("ユーザーIDの変換に失敗しました", zap.String("userID", userIDStr), zap.Error(err))
    return uuid.Nil, false
}
```

## リスク評価

### 推奨解決策のリスク
- **低リスク**: すべてのハンドラーがUUID型を期待しているため、cognito_auth.goの修正は最も安全
- 影響範囲: cognito_auth.goのみ

### 代替解決策のリスク
- **中リスク**: 既存コードとの互換性を保ちながら、両方の型に対応可能
- 影響範囲: userutil.goのみ

## テスト項目
1. ログイン後のダッシュボード表示
2. 経費申請データの取得
3. 通知一覧の取得
4. その他の認証必須APIの動作確認

## 次のステップ
1. Plan フェーズで詳細な実装計画を策定
2. 推奨解決策の実装
3. ユニットテストの追加
4. 統合テストの実施