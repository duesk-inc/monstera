# PostgreSQL設定ファイルエラー調査報告

## 発生日時
2025年8月6日 10:00頃

## 問題の概要
`docker-compose up` 実行時にPostgreSQLコンテナが起動しない

## エラーメッセージ
```
2025-08-06 00:54:41.294 GMT [37] LOG:  input in flex scanner failed at file "/etc/postgresql/postgresql.conf" line 1
2025-08-06 00:54:41.294 GMT [37] FATAL:  configuration file "/etc/postgresql/postgresql.conf" contains errors
dependency failed to start: container monstera-postgres is unhealthy
```

## 根本原因
1. `docker/postgres/postgresql-development.conf` ファイルが削除されている
2. docker-compose.ymlで削除されたファイルをマウントしようとしている
3. 実際にはディレクトリがマウントされ、PostgreSQLが設定ファイルとして読み込めない

## 調査内容

### 1. エラーログの分析
- PostgreSQLが設定ファイル `/etc/postgresql/postgresql.conf` の読み込みに失敗
- "input in flex scanner failed" エラーは、ファイルがディレクトリの場合に発生

### 2. ファイル構造の確認
```bash
$ ls -la docker/postgres/
drwxr-xr-x  2 user  staff    64  8  6 09:54 postgresql-development.conf
```
- `postgresql-development.conf` がディレクトリとして存在（本来はファイルであるべき）

### 3. Git履歴の確認
```bash
$ git log --diff-filter=D --summary | grep postgresql-development.conf
delete mode 100644 docker/postgres/postgresql-development.conf
```
- 最近のコミットで設定ファイルが削除されている

### 4. docker-compose.ymlの問題箇所
```yaml
volumes:
  - ./docker/postgres/postgresql-development.conf:/etc/postgresql/postgresql.conf
  - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
```

## 解決策
PostgreSQLのデフォルト設定を使用するように変更

### 修正内容
docker-compose.ymlから以下を削除：
1. 設定ファイルのマウント（2行）
2. カスタムcommandセクション

修正後：
```yaml
volumes:
  - postgres_data:/var/lib/postgresql/data
  - ./docker/postgres/init:/docker-entrypoint-initdb.d
networks:
  - monstera-network
```

## 検証結果
- PostgreSQLコンテナが正常に起動
- デフォルト設定で問題なく動作
- `pg_isready` コマンドで接続確認済み

## 影響範囲
- 開発環境のみ
- データベースのパフォーマンスチューニングは適用されないが、開発環境では問題なし
- 本番環境への影響なし

## 推奨事項
1. 開発環境ではデフォルト設定で十分
2. 本番環境では適切な設定ファイルを作成・管理
3. 不要なファイル削除時は、docker-compose.ymlも同時に更新すること

## ステータス
- **状態**: 解決済み
- **修正済みファイル**: docker-compose.yml
- **追加作業**: 不要