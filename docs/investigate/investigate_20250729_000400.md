# 経費申請「作成して提出」機能の500エラー調査結果

## 調査日時
2025-07-29 00:04:00

## 調査対象
経費申請の「作成して提出」機能実行時に発生する500 Internal Server Errorの別の原因

## 背景
- 前回の調査で、トランザクションコンテキストの伝播に関する修正を実装
- しかし、修正後も500エラーが継続して発生
- 別の原因による500エラーの解消が必要

## 調査プロセス

### 1. ログレベルをDEBUGに変更
- 環境変数`LOG_LEVEL=debug`を設定
- docker-compose.ymlに環境変数を追加
- 詳細なログを取得可能に

### 2. エラーログの詳細分析
```
Failed to update monthly summary {"error": "ERROR: column \"expense_count\" of relation \"expense_summaries\" does not exist (SQLSTATE 42703)"}
```

### 3. 根本原因の特定
- `expense_summaries`テーブルに`expense_count`カラムが存在しない
- モデル定義には`ExpenseCount`フィールドが存在
- データベーススキーマとモデル定義の不一致が原因

### 4. 詳細な原因分析
- `updateMonthlySummary`メソッドで`summary.ExpenseCount++`等の操作を実行
- GORMがINSERT/UPDATE時に全フィールドをSQL文に含める
- 存在しないカラムへのアクセスでSQLエラーが発生
- トランザクション全体がロールバックされ、500エラーとして返される

## 実装した解決策

### 1. ExpenseCountフィールドの更新を無効化
```go
// 金額を更新
switch action {
case "submit":
    summary.PendingAmount += amountDelta
    summary.TotalAmount += amountDelta
    // summary.ExpenseCount++ // データベースにカラムが存在しないためコメントアウト
case "cancel":
    summary.PendingAmount += amountDelta // マイナス値
    summary.TotalAmount += amountDelta   // マイナス値
    // if summary.ExpenseCount > 0 {
    //     summary.ExpenseCount--
    // }
// ...
}
```

### 2. データベース操作時にexpense_countカラムを除外
```go
// 保存
if summary.ID == uuid.Nil {
    // 新規作成（expense_countカラムを除外）
    if err := tx.Omit("expense_count").Create(summary).Error; err != nil {
        return err
    }
} else {
    // 更新（expense_countカラムを除外）
    if err := tx.Omit("expense_count").Save(summary).Error; err != nil {
        return err
    }
}
```

## 修正ファイル

### 1. backend/internal/service/expense_service.go
- `updateMonthlySummary`メソッドの修正
- ExpenseCount関連の操作をコメントアウト
- GORMの`Omit`メソッドを使用してカラムを除外

### 2. backend/internal/repository/expense_approval_repository.go
- デバッグログの追加（問題特定のため）

### 3. docker-compose.yml
- LOG_LEVEL環境変数の追加

### 4. .env
- LOG_LEVEL=debugの追加

## テスト結果

### テストスクリプト実行結果
```
=== 経費申請「作成して提出」機能のテスト ===
実行時刻: 2025-07-29 00:04:25

1. ユーザー認証テスト...
✓ ログイン成功

2. カテゴリ一覧の取得...
✓ カテゴリID取得成功: af65458e-7dca-4db2-b9c4-75b355aedca5

3. 経費申請作成テスト...
✓ 経費申請作成成功 (ID: 03563a1a-7781-4fc4-9761-c2fcc6400ceb, Status: draft)

4. 経費申請提出テスト（修正箇所）...
✓ 経費申請の提出成功（ステータス: submitted）
✓ 500エラーが解消されました！

5. 承認者設定の確認...
2件の承認者設定が存在
```

## 今後の推奨事項

### 1. データベーススキーマの整合性確保
- マイグレーションファイルを作成して`expense_count`カラムを追加
- または、モデルから`ExpenseCount`フィールドを削除
- 長期的にはスキーマとモデルの整合性を保つ仕組みの導入を推奨

### 2. CI/CDパイプラインの改善
- データベーススキーマとモデル定義の整合性チェックを追加
- マイグレーション漏れを防ぐための自動チェック機能

### 3. エラーハンドリングの改善
- データベースエラーの詳細をログに記録
- 開発環境では詳細なエラー情報を返すモードの実装

### 4. テストの追加
- 月次集計更新のユニットテスト
- データベーススキーマ整合性のテスト

## まとめ
- 500エラーの原因は`expense_summaries`テーブルのスキーマ不整合
- `expense_count`カラムが存在しないにも関わらず、コードで更新しようとしていた
- GORMの`Omit`メソッドを使用して、該当カラムを除外することで解決
- テスト実行により、経費申請の提出機能が正常に動作することを確認

## 技術的な教訓
1. データベーススキーマとモデル定義の整合性は常に確認が必要
2. ORMは便利だが、生成されるSQLを理解することが重要
3. トランザクション内のエラーは適切にログ出力することで調査が容易になる
4. 段階的なデバッグログの追加は問題特定に有効