# 経費申請機能のエンドポイント送信問題調査結果

## 調査日時
2025-07-14 18:51:14

## 調査対象
経費申請機能が現在実際にエンドポイントへ送信されていない問題

## 調査概要
ユーザーからの要求により、経費申請機能が現在実際にエンドポイントへ送信されず、バックエンドに正常にリクエストが飛ばない問題を調査しました。

## 現在の状況

### 1. 作成ブランチ
- **ブランチ名**: `feature/expense-api-fix`
- **基準ブランチ**: `main`
- **作成日時**: 2025-07-14 18:51:14

### 2. 問題の根本原因

#### 主要問題: ページコンポーネントでのモック処理
`/frontend/src/app/(authenticated)/(engineer)/expense/page.tsx`の`handleSubmit`関数（146-199行）で、**意図的にモック処理**が実装されており、実際のAPI呼び出しが無効化されています。

**問題箇所 (147-156行)**:
```typescript
try {
    await new Promise(resolve => setTimeout(resolve, 2000)); // 2秒待機
    setSnackbar({
      open: true,
      message: '経費申請を送信しました（開発中のため実際には送信されません）',
      severity: 'info',
    });
    formMethods.reset();
    setReceiptFile(null);
    return; // ←ここでreturnしているため、実際のAPI呼び出し処理に到達しない
```

**コメントアウトされた実際のAPI呼び出し (171-174行)**:
```typescript
// API呼び出し
// const response = await fetch('/api/expense', {
//   method: 'POST',
//   body: formData,
// });
```

#### 副次的問題: 適切な実装が使用されていない
完璧に実装された`useExpenseSubmit`フックや`expense.ts`APIが存在するにも関わらず、ページコンポーネントで使用されていません。

### 3. 現在の実装状況

#### 完全実装済み（使用されていない）
1. **`useExpenseSubmit.ts`**: 経費申請の作成・更新・削除・提出・取消を管理するカスタムフック
2. **`expense.ts`**: 経費申請API呼び出し処理（createExpense等）
3. **`getAuthClient()`**: 認証済みAPIクライアント
4. **EXPENSE_API**: エンドポイント定数定義
5. **バックエンドハンドラー**: `expense_handler.go`で完全実装

#### 問題のある実装（現在使用中）
- **`page.tsx`**: モック処理で実際のAPI呼び出しを阻止

## 技術的詳細

### 正しく実装されているAPI呼び出しフロー
1. **`useExpenseSubmit`フック** → `createExpense(data)` 
2. **`expense.ts`** → `getAuthClient().post(EXPENSE_API.CREATE, snakeData)`
3. **認証ヘッダー付きリクエスト** → `Authorization: Bearer ${token}`
4. **バックエンドエンドポイント** → `POST /api/v1/expenses`
5. **レスポンス処理** → TypeScript型安全な変換

### 現在の設定状況
- **API_BASE_URL**: `process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080'`
- **EXPENSE_API.CREATE**: `/api/v1/expenses`
- **認証**: `getAuthClient()`で適切に設定
- **CORS**: withCredentials設定済み
- **エラーハンドリング**: 完全実装済み

### バックエンド実装状況
- **ハンドラー**: `expense_handler.go`で完全実装
- **エンドポイント**: `POST /api/v1/expenses`で受付
- **サービス・リポジトリ**: 完全実装済み
- **認証**: `authMiddlewareFunc`で保護済み

## 技術的制約・可能性

### 制約
1. **モック処理による阻止**: 現在のページコンポーネントでAPI呼び出しが意図的に無効化
2. **.envファイル未確認**: 実際の環境変数設定が未確認
3. **開発サーバー起動状況**: バックエンドサーバーの起動状況が未確認

### 可能性
1. **即座に修正可能**: モック処理削除だけで解決
2. **完璧な実装の活用**: 既存の`useExpenseSubmit`フックをそのまま使用可能
3. **既存インフラの活用**: 認証・エラーハンドリング・型安全性がすべて実装済み
4. **最小限の変更**: ページコンポーネントの修正のみで完了

## 既存システムとの整合性

### 整合性確認結果
1. **フロントエンド**: React Query、TypeScript、認証フロー
2. **バックエンド**: Go、Gin、PostgreSQL、JWT認証
3. **API設計**: RESTful API、統一的なエラーハンドリング
4. **セキュリティ**: 認証必須、CORS設定、CSRF対策

### 影響範囲
- **修正対象**: 1ファイル（`page.tsx`）のみ
- **既存機能への影響**: なし
- **API仕様変更**: 不要
- **データベース変更**: 不要

## 問題の根本原因分析

### 直接原因
1. **開発中の状態**: ページコンポーネントで意図的にモック処理を実装
2. **return文による処理停止**: 156行目のreturn文で実際のAPI呼び出しに到達しない

### 間接原因
1. **実装の二重化**: 正しい実装（`useExpenseSubmit`）とモック実装が並存
2. **開発フェーズの混在**: 実際のAPI実装が完了しているにも関わらず、開発中の処理が残存

### システム設計上の問題
1. **一貫性の欠如**: 他の機能では適切にAPIを呼び出しているが、経費申請のみモック
2. **開発プロセス**: 完成した実装への移行が未完了

## 解決方針

### 1. 基本アプローチ
- **モック処理の削除**: 147-156行の開発中処理を完全削除
- **適切な実装の採用**: `useExpenseSubmit`フックを使用
- **既存実装の活用**: 新規実装は不要、既存の完璧な実装を活用

### 2. 具体的解決手順
1. **モック処理削除**: 147-156行とreturn文を削除
2. **`useExpenseSubmit`フック導入**: ページコンポーネントで使用
3. **ハンドラー変更**: `handleSubmit`で`createExpense`を呼び出し
4. **エラーハンドリング**: 既存の実装をそのまま活用
5. **テスト実行**: 実際のAPI呼び出しの動作確認

### 3. 修正の影響範囲
- **最小限の変更**: 1ファイルの修正のみ
- **既存機能への影響**: なし
- **新規実装**: 不要（既存実装を活用）
- **テスト**: 既存のテストコードが利用可能

## 実装推奨度

### 高い実装推奨度の理由
1. **問題の明確性**: 根本原因が特定済み
2. **解決の確実性**: 既存の完璧な実装を活用するだけ
3. **最小限の変更**: リスクが極めて低い
4. **即座の効果**: 修正後すぐに正常動作

### 技術的実現性
- **実現性**: 極めて高い（95%以上）
- **所要時間**: 15-30分程度
- **難易度**: 低（既存実装の活用のみ）
- **リスク**: 極めて低い

## 関連ファイル一覧

### 修正対象ファイル
- `/frontend/src/app/(authenticated)/(engineer)/expense/page.tsx` - モック処理削除・実装変更

### 活用する既存ファイル（修正不要）
- `/frontend/src/hooks/expense/useExpenseSubmit.ts` - 完全実装済み
- `/frontend/src/lib/api/expense.ts` - 完全実装済み
- `/frontend/src/lib/api/index.ts` - 認証クライアント実装済み
- `/frontend/src/constants/api.ts` - エンドポイント定義済み
- `/backend/internal/handler/expense_handler.go` - 完全実装済み

### 設定ファイル（確認が必要）
- `/frontend/.env` - 環境変数設定（API_BASE_URL等）
- バックエンドサーバーの起動状況

## 次フェーズ（Plan）への推奨事項

### 実装推奨
以下の理由により、経費申請API送信問題の修正実装を強く推奨します：

1. **問題の重要性**: 経費申請機能は業務システムの核心機能
2. **解決の確実性**: 根本原因が明確で、解決方法が確立済み
3. **実装コスト**: 最小限（1ファイルの修正のみ）
4. **既存資産の活用**: 完璧に実装されたコードをそのまま使用可能

### 実装方針
1. **段階1**: モック処理の削除
2. **段階2**: `useExpenseSubmit`フックの導入
3. **段階3**: ハンドラー関数の修正
4. **段階4**: 動作確認とテスト
5. **段階5**: 環境設定の確認

### 優先度
- **緊急度**: 高（業務機能が動作しない状態）
- **重要度**: 高（経費申請は重要な業務機能）
- **実装難易度**: 低（既存実装の活用）
- **リスク**: 低（最小限の変更）

## 結論

経費申請機能のエンドポイント送信問題は、ページコンポーネントで意図的に実装されたモック処理が原因です。バックエンド・フロントエンドの実際のAPI処理は完璧に実装されており、モック処理を削除して適切な実装（`useExpenseSubmit`フック）を使用するだけで即座に解決できます。

この修正により、経費申請機能が正常にバックエンドAPIに送信され、業務システムとして機能するようになります。

次フェーズでの実装計画策定を強く推奨します。