# バグ調査報告書: 管理者ダッシュボードCORSエラー

## 調査日時
2025-01-28 19:35:00

## 報告された問題
管理者側のダッシュボード画面を表示時にCORSエラーが発生し、APIアクセスがブロックされる

## エラー内容
```
Access to XMLHttpRequest at 'http://localhost:8080/api/v1/admin/dashboard' from origin 'http://localhost:3000' has been blocked by CORS policy: 
Request header field x-admin-request is not allowed by Access-Control-Allow-Headers in preflight response.
```

## 調査結果

### 根本原因
フロントエンドが送信する`X-Admin-Request`ヘッダーが、バックエンドのCORS設定で許可されていない。

### 詳細分析

#### 1. フロントエンド側の実装
以下のファイルで`X-Admin-Request`ヘッダーが設定されている：

**frontend/src/lib/api/config/unified.ts:114**
```typescript
headers: {
  'X-Admin-Request': 'true',
}
```

**frontend/src/lib/api/factory/index.ts:413**
```typescript
headers: {
  'X-Admin-Request': 'true',
}
```

このヘッダーは管理者権限のAPIリクエストを識別するために使用されている。

#### 2. バックエンド側のCORS設定

**backend/internal/config/config.go:352**
```go
AllowHeaders: []string{"Origin", "Content-Type", "Accept", "Authorization", "X-Requested-With"},
```

**backend/internal/middleware/api_security.go:45**
```go
c.Header("Access-Control-Allow-Headers", "Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With")
```

どちらの設定にも`X-Admin-Request`が含まれていない。

### 影響範囲
- 全ての管理者系APIエンドポイント（`/api/v1/admin/*`）
- 管理者ダッシュボード
- 管理者権限を必要とする全ての機能

### エラー発生のフロー
1. フロントエンドが管理者APIにアクセス
2. `X-Admin-Request: true`ヘッダーを含むリクエストを送信
3. ブラウザがCORSプリフライトリクエスト（OPTIONS）を送信
4. バックエンドがAccess-Control-Allow-Headersを返す（X-Admin-Requestなし）
5. ブラウザがCORSポリシー違反と判断してリクエストをブロック
6. フロントエンドでNETWORK_ERRORとして処理される

## 修正方法

### 方法1: バックエンドのCORS設定を更新（推奨）

**backend/internal/config/config.go**
```go
AllowHeaders: []string{
    "Origin", 
    "Content-Type", 
    "Accept", 
    "Authorization", 
    "X-Requested-With",
    "X-Admin-Request"  // 追加
},
```

**backend/internal/middleware/api_security.go**
```go
c.Header("Access-Control-Allow-Headers", 
    "Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, accept, origin, Cache-Control, X-Requested-With, X-Admin-Request")
```

### 方法2: フロントエンドのヘッダーを削除
`X-Admin-Request`ヘッダーが本当に必要かを確認し、不要であれば削除する。

## セキュリティへの影響
- CORSエラー自体はセキュリティ機能が正常に動作している証拠
- `X-Admin-Request`ヘッダーを許可することによるセキュリティリスクは低い（単なる識別子）

## 緊急度
**高** - 管理者機能が完全に使用不可能になっているため、早急な修正が必要

## テスト項目
1. 管理者ダッシュボードへのアクセス
2. 全ての管理者APIエンドポイントの動作確認
3. 通常ユーザーAPIには影響がないことを確認
4. CORSプリフライトリクエストが正常に処理されることを確認

## 再発防止策
1. フロントエンドで新しいヘッダーを追加する際は、バックエンドのCORS設定も同時に更新する
2. CI/CDでCORS設定のテストを追加する
3. 開発環境と本番環境でCORS設定を統一する