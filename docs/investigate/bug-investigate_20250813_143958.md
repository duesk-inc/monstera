# バグ調査レポート: ログイン失敗問題

## 調査日時
2025-08-13 14:39:58

## 報告内容
- **対象ユーザー**: engineer_test@duesk.co.jp
- **パスワード**: EmployeePass123!
- **期待されるCognito Sub**: 37f4ba88-80e1-7053-57f9-84c245af87df
- **症状**: ログイン画面からログインできない

## 調査結果

### 根本原因
開発モードにおいて複数の相互関連する問題が存在：

#### 1. ユーザーID長の不一致
- **問題**: 開発モードで生成されるユーザーIDが44文字（`dev-00000000-0000-0000-0000-000000000004`）
- **影響**: audit_logsテーブルのuser_idカラムはCHAR(36)のため、INSERTが失敗
- **エラー**: `ERROR: value too long for type character(36) (SQLSTATE 22001)`

#### 2. トークン形式の不一致
- **問題**: 開発モードのトークンが`dev-access-token-{userID}-{timestamp}`形式
- **影響**: フロントエンドがJWT形式（header.payload.signature）を期待するため検証失敗
- **現象**: `Cognitoトークンのセグメント数が不正: 1`

### 詳細分析

#### データベース定義
```sql
-- backend/migrations/200018_create_audit_logs_table.up.sql
CREATE TABLE IF NOT EXISTS audit_logs (
    id CHAR(36) PRIMARY KEY DEFAULT (gen_random_uuid()::text),
    user_id CHAR(36) NOT NULL,  -- 36文字制限
    ...
);
```

#### 開発モードのユーザーID生成
```go
// backend/internal/service/cognito_auth_service.go:602
case "engineer_test@duesk.co.jp":
    role = model.RoleEngineer
    firstName = "開発"
    lastName = "エンジニア"
    userID = "dev-00000000-0000-0000-0000-000000000004"  // 44文字
```

#### シードデータの定義
```sql
-- backend/migrations/300000_seed_cognito_users.up.sql
test_user_id VARCHAR(255) := '17a40a68-a061-7028-e5a0-db2da1ee6e6d';  -- 36文字（正しい形式）
```

#### フロントエンドのトークン検証
```typescript
// frontend/src/middleware.ts:31-34
const parts = token.split('.');
if (parts.length !== 3) {
    debugLog('Cognitoトークンのセグメント数が不正:', parts.length);
    return false;
}
```

## 影響範囲
1. **開発環境でのログイン**: 全ユーザーがログインできない
2. **監査ログ**: audit_logsテーブルへの記録が失敗
3. **セッション管理**: トークン検証の失敗によりセッション維持不可

## 修正方針
ユーザーの要望に基づき以下の修正が必要：

1. **開発モードのユーザーID形式を変更**
   - `dev-`接頭辞を削除
   - Cognito Sub形式（36文字UUID）を使用
   - 例: `37f4ba88-80e1-7053-57f9-84c245af87df`

2. **開発モードのトークン形式を変更**
   - JWT形式に準拠した3セグメント構造に変更
   - または、フロントエンドの検証ロジックを開発モード用に調整

3. **シードデータとの整合性確保**
   - シードデータで定義されているユーザーIDを使用

## 推奨される次のステップ
1. `cognito_auth_service.go`の開発モードユーザーID生成を修正
2. 開発モード用のトークン生成ロジックを改善
3. フロントエンドのトークン検証を開発モードに対応
4. 修正後のテスト実施