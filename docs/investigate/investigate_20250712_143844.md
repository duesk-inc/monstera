# 週報提出時の型変換エラー調査報告書

## 調査日時
2025-07-12 14:38:44

## エラー概要
週報提出時（POST /api/v1/weekly-reports）にサーバーサイドで型変換エラーが発生し、リクエストが失敗する。

### エラー詳細
```
interface conversion: interface {} is *model.Role, not string
```

発生箇所：
- `/app/internal/handler/weekly_report_handler.go:81`
- `/app/internal/handler/weekly_report_handler.go:306` (Updateメソッドでも同様)

## 問題の根本原因

### 1. 認証ミドルウェアの設定
`internal/middleware/cognito_auth.go:113` で以下のように設定：
```go
c.Set("role", user.DefaultRole) // 互換性のため
```

`user.DefaultRole` の型は `*model.Role`（ポインタ型）

### 2. ハンドラー側の処理
`weekly_report_handler.go` の81行目と306行目で：
```go
UserRole: userRole.(string),  // 直接string型にキャスト（エラー発生）
```

### 3. 期待される型
`pkg/debug/logger.go` の `RequestDebugData` 構造体：
```go
UserRole string `json:"user_role,omitempty"`
```

## 技術的分析

### 既存の処理パターン
同ファイル内の他の箇所（387、606、1225行目）では適切に型チェックを実施：
```go
if roleStr, ok := userRole.(string); ok {
    // 文字列として処理
}
```

### Role型の実装
`internal/model/role.go` に `String()` メソッドが実装されており、文字列変換が可能：
```go
func (r Role) String() string {
    switch r {
    case RoleSuperAdmin: return "super_admin"
    case RoleAdmin: return "admin"
    case RoleManager: return "manager"
    case RoleEmployee: return "employee"
    default: return "unknown"
    }
}
```

## 解決方針

### 修正内容
1. 81行目と306行目の型キャストを安全な方法に変更
2. `*model.Role` 型の場合の処理を追加
3. nilチェックを含む適切なエラーハンドリング

### 修正コード例
```go
// ユーザーロールの文字列表現を取得
var userRoleStr string
if userRole != nil {
    switch v := userRole.(type) {
    case string:
        userRoleStr = v
    case *model.Role:
        if v != nil {
            userRoleStr = v.String()
        } else {
            userRoleStr = "unknown"
        }
    default:
        userRoleStr = "unknown"
    }
} else {
    userRoleStr = "unknown"
}

// デバッグログに使用
h.debugLogger.RequestStart(
    // ...
    debug.RequestDebugData{
        // ...
        UserRole: userRoleStr,
    },
)
```

## 影響範囲
- `backend/internal/handler/weekly_report_handler.go`
  - `Create` メソッド（81行目）
  - `Update` メソッド（306行目）

## リスク評価
- **影響度**: 高（週報機能が利用不可）
- **緊急度**: 高（本番環境で発生している場合は即座の対応が必要）
- **修正難易度**: 低（局所的な修正で対応可能）

## 推奨事項

### 短期対応
1. 上記の修正を `weekly_report_handler.go` に適用
2. ユニットテストを追加して型変換の動作を保証
3. 手動テストで週報作成・更新機能の動作確認

### 中長期対応
1. **型の一貫性確保**
   - 認証ミドルウェアで設定する role の型を統一（文字列 or Role型）
   - システム全体で一貫した型の使用

2. **ヘルパー関数の作成**
   - ロール情報の取得と文字列変換を行うユーティリティ関数の実装
   - 例：`GetRoleString(c *gin.Context) string`

3. **コードレビュー**
   - 他のハンドラーでも同様の問題がないか確認
   - 型アサーションの使用箇所を洗い出し

## 関連ファイル
- `/backend/internal/handler/weekly_report_handler.go`
- `/backend/internal/middleware/cognito_auth.go`
- `/backend/internal/model/role.go`
- `/backend/internal/model/user.go`
- `/backend/pkg/debug/logger.go`

## 次のステップ
PLANフェーズに移行し、具体的な実装計画を策定することを推奨します。