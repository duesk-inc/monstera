# ユーザーメニュー表示不具合調査結果

## 調査日時
2025-07-20 11:07:33

## 調査概要
admin@duesk.co.jp でログイン後、ユーザーメニューが正しく表示されない問題の調査

## 問題の詳細

### 1. 画面表示の問題
- **？アイコンの重複表示**: ヘッダーに「？」アイコンが2つ表示される
- **「ログイン」テキストの表示**: ログイン済みなのに「ログイン」リンクが表示される

### 2. 関連ファイル
- `/frontend/src/components/ui/TopBar.tsx`
- `/frontend/src/components/common/layout/UserAvatar.tsx`
- `/frontend/src/components/common/layout/SharedUserMenu.tsx`
- `/frontend/src/hooks/useAuth.ts`
- `/frontend/src/components/common/layout/SharedLayoutWrapper.tsx`

## 根本原因

### 1. ？アイコンの重複表示
- **原因1**: TopBarコンポーネントの72行目で、HelpIcon（？アイコン）が独立したIconButtonとして表示されている
- **原因2**: UserAvatarコンポーネントで、userがnullの場合に'?'を返している（27行目、49行目）
- **結果**: 認証初期化中はuserがnullのため、2つの？アイコンが表示される

### 2. 認証状態の初期化遅延
- **原因**: クライアントサイドレンダリング時、認証情報の取得が非同期で行われる
- **影響**: 初期レンダリング時にuserがnullの状態で一時的に表示される
- **結果**: SharedUserMenuでuserがnullと判定され、「ログイン」リンクが表示される（172-178行目）

### 3. ローディング状態の未活用
- **問題**: useAuthフックのisLoadingフラグが、TopBarコンポーネントで使用されていない
- **影響**: 認証初期化中でも通常の表示が行われ、不適切なUIが表示される

## 技術的制約

1. **非同期認証処理**: 認証情報の取得がクライアントサイドで非同期に行われる
2. **SSR/CSRの混在**: Next.jsの'use client'ディレクティブによるクライアントサイドレンダリング
3. **Context依存関係**: ActiveRoleContextとuseAuthフックの相互依存

## 解決方針

### 1. 即時対応（UI修正）
- TopBarのHelpIconを条件付き表示に変更（ユーザーがログインしている場合は非表示）
- UserAvatarのnull時の表示をローディング状態に変更
- SharedUserMenuでisLoadingを考慮し、ローディング中は「ログイン」リンクを表示しない

### 2. 中期対応（状態管理改善）
- 認証初期化の完了を待ってからUIを表示する仕組みの導入
- ローディングスケルトンの実装
- 認証状態のサスペンス対応

### 3. 長期対応（アーキテクチャ改善）
- 認証状態の初期化をサーバーサイドで行う検討
- 認証情報のプリフェッチ機構の導入

## リスクと注意事項

1. **互換性**: 既存の認証フローを変更する際は、全ページでの動作確認が必要
2. **パフォーマンス**: ローディング表示の追加により、体感速度が低下する可能性
3. **UX**: 頻繁なローディング表示はユーザー体験を損なう可能性がある

## 次のステップ

1. PLANフェーズで具体的な実装計画を策定
2. 修正実装とテスト
3. 全ページでの動作確認
4. 本番環境へのデプロイ

## 参考情報

- 現在のブランチ: `feature/fix-user-menu`
- 最新コミット: `db8d8e4 fix(frontend): プロバイダーの順序を修正してActiveRoleContextエラーを解消`
- 関連PR: 認証システムの統一に関する修正が既に行われているが、問題が残存