# バグ調査報告書 - スキルシート保存時の404エラー（追加調査）

## 調査日時
2025-01-16 22:22:00

## 問題の概要
スキルシート作成ダイアログで最後に保存するボタンを押下した際、バックエンドが404エラーを返す。

## エラー詳細
```
Method: POST
Path: /work-history
Status: 404 (Not Found)
```

## 調査プロセス

### 1. バックエンドのルート定義確認
`backend/cmd/server/main.go` (line 648-656)
```go
workHistory := api.Group("/work-history")
workHistory.Use(authMiddlewareFunc)
{
    workHistory.POST("", workHistoryHandler.CreateWorkHistory)  // 作成エンドポイントは存在
}
```
→ **バックエンドには`/api/v1/work-history`にPOSTエンドポイントが正しく定義されている**

### 2. 複数のAPIクライアント設定ファイルの発見
プロジェクト内に3つの異なるAPI設定ファイルが存在：

#### A. `frontend/src/lib/api/config.ts`
```typescript
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api/v1';
```
→ **デフォルト値は正しい（`/api/v1`を含む）**

#### B. `frontend/src/constants/api.ts`
```typescript
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';
export const API_VERSION = 'v1';
```
→ **デフォルト値は不完全（`/api/v1`を含まない）**

#### C. `frontend/src/lib/api/index.ts`
```typescript
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';
```
→ **デフォルト値は不完全（`/api/v1`を含まない）**

### 3. 職務経歴APIの実装経路
1. `WorkHistoryEditDialog.tsx` → `useWorkHistoryMutation` フック使用
2. `useWorkHistoryMutation.ts` → `workHistoryApi.create()` 呼び出し
3. `workHistoryApi` (`frontend/src/lib/api/workHistory.ts`) → `apiClient` 使用
4. `apiClient` (`frontend/src/lib/api/config.ts`) → **このファイルの設定を使用**

### 4. 環境変数の確認
`frontend/.env.local` (line 4)
```
NEXT_PUBLIC_API_URL=http://localhost:8080
```
→ **問題の核心：環境変数に`/api/v1`が欠落**

## 根本原因
### 主要な問題
**環境変数`NEXT_PUBLIC_API_URL`の設定ミス**
- 現在の設定: `http://localhost:8080`
- 正しい設定: `http://localhost:8080/api/v1`

### 副次的な問題
**APIクライアント設定の不統一**
- 3つの異なるファイルで`API_BASE_URL`を定義
- デフォルト値が統一されていない（1つは正しい、2つは間違い）
- 環境変数が設定されると、全てのファイルで間違った値を使用

## 影響範囲
### 確認された影響
- 職務経歴の作成・更新・削除が動作しない（`/work-history`エンドポイント）

### 潜在的な影響（他のAPIクライアントも同じ環境変数を使用）
- `frontend/src/lib/api/index.ts`を使用するすべてのAPI
- `frontend/src/constants/api.ts`の定数を直接使用するコード（あれば）
- 認証、プロファイル、スキルシート、週報など、すべてのAPI呼び出し

## 推奨される修正方法
### 1. 即座の修正（優先度：最高）
```bash
# frontend/.env.local
NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
```

### 2. コードベースの改善（優先度：高）
#### A. APIクライアント設定の統一
- 単一の設定ファイルに統合
- すべてのAPIクライアントが同じ設定を使用するように修正

#### B. デフォルト値の統一
```typescript
// すべてのファイルで同じデフォルト値を使用
export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080/api/v1';
```

#### C. 環境変数のバリデーション追加
```typescript
const validateApiUrl = (url: string): string => {
  if (!url.includes('/api/v1')) {
    console.warn('API URL does not contain /api/v1 path');
  }
  return url;
};
```

### 3. ドキュメントの更新（優先度：中）
- `.env.example`ファイルに正しい値を記載
- READMEに環境変数の説明を追加

## テスト項目
修正後、以下のテストを実施：
1. [ ] 職務経歴の新規作成
2. [ ] 職務経歴の更新
3. [ ] 職務経歴の削除
4. [ ] プロファイル関連API
5. [ ] スキルシート関連API
6. [ ] 認証関連API
7. [ ] 週報関連API

## 関連ファイル
- `frontend/.env.local` - 環境変数設定
- `frontend/src/lib/api/config.ts` - メインAPIクライアント設定
- `frontend/src/constants/api.ts` - API定数定義
- `frontend/src/lib/api/index.ts` - 代替APIクライアント
- `frontend/src/lib/api/workHistory.ts` - 職務経歴API実装
- `backend/cmd/server/main.go` - バックエンドルート定義

## まとめ
環境変数の設定ミスが根本原因だが、複数のAPIクライアント設定ファイルが存在し、デフォルト値が統一されていないことが問題を複雑化している。即座の修正は簡単だが、長期的にはコードベースの改善が必要。