# 経費申請API送信機能修正 実装計画書

## 計画策定日時
2025-07-14 18:59:00

## 基本情報

### プロジェクト名
経費申請機能のエンドポイント送信問題修正

### 対象ブランチ
- **作業ブランチ**: `feature/expense-api-fix`
- **基準ブランチ**: `main`

### 関連調査
- **調査結果**: `docs/investigate/investigate_20250714_185114.md`

## 実装概要

### 問題
経費申請ページ(`/frontend/src/app/(authenticated)/(engineer)/expense/page.tsx`)でモック処理が実装されており、実際のAPI呼び出しが阻止されている。

### 解決方針
- モック処理（147-156行）を削除
- 既存の完璧に実装された`useExpenseSubmit`フックを活用
- 最小限の変更で最大の効果を実現

### 技術的アプローチ
- **新規実装不要**: 既存の完璧な実装を活用
- **変更範囲**: 1ファイルのみ
- **リスク**: 極めて低い

## 詳細実装タスク

### Phase 1: 準備・環境確認 (優先度: 高)
1. **環境設定確認**
   - `.env`ファイルの確認
   - バックエンドサーバー起動確認 (`make dev`)
   - API_BASE_URL等の環境変数確認

2. **既存実装の理解**
   - `useExpenseSubmit`フックの動作確認
   - `expense.ts` API実装の確認

### Phase 2: コード修正 (優先度: 高)
1. **モック処理削除**
   - 147-156行のモック処理とreturn文を削除
   - コメントアウトされたAPI呼び出し部分を有効化

2. **useExpenseSubmitフック導入**
   - インポート文の追加
   - フック使用のための変数宣言
   - エラーハンドリングの適用

3. **handleSubmit関数修正**
   - モック処理の代わりに`createExpense`呼び出し
   - 成功・失敗時の適切なフィードバック

### Phase 3: テスト・検証 (優先度: 高)
1. **統合テスト**
   - 実際の経費申請送信テスト
   - 認証フローの確認
   - エラーケースの動作確認

2. **E2Eテスト**
   - フォーム送信からバックエンド処理まで
   - UI フィードバックの確認

## ファイル変更計画

### 修正対象ファイル
1. **`/frontend/src/app/(authenticated)/(engineer)/expense/page.tsx`**
   - **変更内容**: モック処理削除、`useExpenseSubmit`フック導入
   - **変更行数**: 約10-15行
   - **影響範囲**: ページコンポーネントのみ

### 活用する既存ファイル（修正不要）
- `/frontend/src/hooks/expense/useExpenseSubmit.ts` - 完全実装済み
- `/frontend/src/lib/api/expense.ts` - 完全実装済み
- `/frontend/src/lib/api/index.ts` - 認証クライアント実装済み
- `/frontend/src/constants/api.ts` - エンドポイント定義済み
- `/backend/internal/handler/expense_handler.go` - 完全実装済み

### 確認が必要なファイル
- `/frontend/.env` - 環境変数設定

## 具体的な実装変更

### 1. インポート文の追加
```typescript
import { useExpenseSubmit } from '@/hooks/expense/useExpenseSubmit';
```

### 2. フック使用のための変数宣言
```typescript
const { createExpense, isLoading: isSubmitting } = useExpenseSubmit();
```

### 3. モック処理の削除（147-156行）
```typescript
// 削除対象
try {
  await new Promise(resolve => setTimeout(resolve, 2000));
  setSnackbar({
    open: true,
    message: '経費申請を送信しました（開発中のため実際には送信されません）',
    severity: 'info',
  });
  formMethods.reset();
  setReceiptFile(null);
  return; // ←この行により実際のAPI呼び出しに到達しない
```

### 4. 実際のAPI呼び出しの実装
```typescript
try {
  await createExpense(expenseData);
  setSnackbar({
    open: true,
    message: '経費申請を送信しました',
    severity: 'success',
  });
  formMethods.reset();
  setReceiptFile(null);
} catch (error) {
  setSnackbar({
    open: true,
    message: 'エラーが発生しました。再度お試しください。',
    severity: 'error',
  });
}
```

## テスト戦略

### 1. 単体テスト
- **対象**: `useExpenseSubmit`フック、`expense.ts` API
- **状況**: 既に実装済み
- **追加作業**: 不要

### 2. 統合テスト
- **対象**: フロントエンドからバックエンドへのAPI呼び出し
- **内容**:
  - 経費申請データの送信
  - 認証フローの確認
  - エラーハンドリングの確認
- **実行環境**: Docker環境

### 3. E2Eテスト
- **対象**: 経費申請フォームの送信フロー
- **内容**:
  - フォーム入力からAPIレスポンスまで
  - 成功・失敗時のUIフィードバック
  - ページの状態変更

### 4. 環境テスト
- **対象**: 開発環境での動作確認
- **内容**:
  - バックエンドサーバーとの接続確認
  - 環境変数の設定確認
  - CORS設定の確認

## リスク分析

### 低リスク（確率: 低、影響: 低）
1. **既存機能への影響**: 1ファイルのみの修正で影響範囲が限定的
2. **実装の複雑性**: 既存の完璧な実装を活用するため複雑性なし
3. **API仕様変更**: 不要（既存APIをそのまま使用）

### 中リスク（確率: 中、影響: 中）
1. **環境設定の問題**:
   - **リスク**: `.env`ファイルの設定不備、バックエンドサーバーの未起動
   - **対策**: 事前の環境確認、`make dev`による起動確認

2. **認証トークンの問題**:
   - **リスク**: 認証が正しく動作しない場合
   - **対策**: 既存の`getAuthClient()`は完全実装済み、動作確認済み

### 対策
1. **段階的実装**: 各フェーズでテスト実行
2. **ロールバック計画**: 元のモック処理をコメントで保持
3. **詳細な動作確認**: 各ステップでの動作確認

### 全体的なリスク評価
**極めて低い** - 既存の完璧な実装を活用し、最小限の変更で実現

## 実装手順

### Step 1: 環境準備 (5分)
1. バックエンドサーバーの起動確認: `make dev`
2. `.env`ファイルの確認
3. ブランチの確認: `feature/expense-api-fix`

### Step 2: コード修正 (10分)
1. `page.tsx`のモック処理削除
2. `useExpenseSubmit`フックの導入
3. `handleSubmit`関数の修正

### Step 3: 動作確認 (10分)
1. フロントエンド起動: `cd frontend && npm run dev`
2. 経費申請フォームでの実際の送信テスト
3. 成功・失敗ケースの確認

### Step 4: 最終検証 (5分)
1. ログの確認
2. データベースの確認
3. UIフィードバックの確認

## 成功基準

### 機能要件
1. **正常送信**: 経費申請フォームから実際にバックエンドAPIに送信される
2. **データ保存**: 送信されたデータがデータベースに正しく保存される
3. **UI フィードバック**: 成功・失敗時に適切なメッセージが表示される

### 技術要件
1. **認証**: JWT認証が正しく動作する
2. **エラーハンドリング**: 適切なエラー処理とユーザーフィードバック
3. **型安全性**: TypeScriptの型安全性が保たれる

### 品質要件
1. **パフォーマンス**: レスポンス時間が許容範囲内
2. **セキュリティ**: 既存のセキュリティ機能が維持される
3. **保守性**: コードの可読性と保守性が向上する

## 所要時間見積もり

### 総所要時間: 30分

- **環境準備**: 5分
- **コード修正**: 10分
- **動作確認**: 10分
- **最終検証**: 5分

### 前提条件
- 開発環境が正常に動作している
- バックエンドサーバーが起動可能
- 必要な環境変数が設定済み

## 実装後の影響

### 正の影響
1. **機能完成**: 経費申請機能が実際に動作する
2. **コード品質向上**: モック処理が削除され、実装が統一される
3. **開発効率向上**: 既存の完璧な実装を活用

### 懸念される影響
1. **なし**: 最小限の変更で既存機能への影響なし

## 次フェーズへの推奨事項

### 即座の実装推奨
以下の理由により、この修正の即座の実装を強く推奨します：

1. **重要性**: 経費申請は業務システムの核心機能
2. **実現性**: 確実に解決可能（95%以上の成功確率）
3. **効率性**: 最小限の工数で最大の効果
4. **リスク**: 極めて低いリスク

### 実装優先度
- **緊急度**: 高（業務機能が動作しない状態）
- **重要度**: 高（経費申請は重要な業務機能）
- **実装難易度**: 低（既存実装の活用）
- **投資対効果**: 極めて高い

## 結論

経費申請API送信機能の修正は、モック処理を削除して既存の完璧な実装を活用するだけで解決できる、低リスク・高効果の修正です。30分程度の工数で業務システムの重要機能を完全に動作させることができます。

**実装推奨度: 最高**