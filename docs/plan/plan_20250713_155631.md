# 監査ログContext Canceledエラー修正実装計画書

## 実装計画日時
2025年7月13日 15:56:31

## 計画担当
Claude

## 実装ブランチ
fix/audit-log-context

## 実装概要
監査ログ記録時に発生している`context canceled`エラーを解消するため、非同期処理でバックグラウンドコンテキストを使用するように修正する。

## 調査結果参照
- 調査結果ファイル: `docs/investigate/investigate_20250713_153253.md`

## 実装方針

### 基本方針
1. goroutine内でバックグラウンドコンテキストを作成
2. HTTPリクエストから必要な情報を事前に抽出
3. 既存の機能への影響を最小限に抑える
4. 包括的なテストで品質を保証

### 技術的アプローチ
- `context.Background()`を使用して新しいコンテキストを作成
- Ginコンテキストから必要な情報をパラメータとして渡す
- インターフェースの変更は最小限に留める

## 実装タスク詳細

### 1. ミドルウェアの修正 (優先度: 高)
**ファイル**: `backend/internal/middleware/audit_log.go`

**変更内容**:
```go
// 変更前
go func() {
    if err := auditService.LogHTTPRequest(
        c,
        userID.(uuid.UUID),
        model.AuditActionType(action),
        model.ResourceType(resourceType),
        resourceID,
        duration,
    ); err != nil {
        // エラー処理
    }
}()

// 変更後
go func() {
    // バックグラウンドコンテキストを作成
    ctx := context.Background()
    
    if err := auditService.LogHTTPRequest(
        ctx,
        c,
        userID.(uuid.UUID),
        model.AuditActionType(action),
        model.ResourceType(resourceType),
        resourceID,
        duration,
    ); err != nil {
        // エラー処理
    }
}()
```

**推定工数**: 15分

### 2. サービスインターフェースの修正 (優先度: 高)
**ファイル**: `backend/internal/service/audit_log_service.go`

**変更内容**:
```go
// インターフェース変更
type AuditLogService interface {
    LogActivity(ctx context.Context, params LogActivityParams) error
    LogHTTPRequest(ctx context.Context, c *gin.Context, userID uuid.UUID, action model.AuditActionType, resourceType model.ResourceType, resourceID *string, duration time.Duration) error
    // その他のメソッドは変更なし
}

// LogHTTPRequestメソッドの実装変更
func (s *auditLogService) LogHTTPRequest(ctx context.Context, c *gin.Context, userID uuid.UUID, action model.AuditActionType, resourceType model.ResourceType, resourceID *string, duration time.Duration) error {
    // HTTPリクエストの情報を事前に抽出
    ipAddress := s.getClientIP(c)
    userAgent := c.GetHeader("User-Agent")
    
    params := LogActivityParams{
        UserID:       userID,
        Action:       action,
        ResourceType: resourceType,
        ResourceID:   resourceID,
        Method:       c.Request.Method,
        Path:         c.Request.URL.Path,
        StatusCode:   c.Writer.Status(),
        IPAddress:    &ipAddress,
        UserAgent:    &userAgent,
        Duration:     &duration,
    }
    
    // リクエストボディの取得（POSTやPUTの場合）
    if c.Request.Method == "POST" || c.Request.Method == "PUT" || c.Request.Method == "PATCH" {
        if bodyData, exists := c.Get("request_body"); exists {
            params.RequestBody = bodyData
        }
    }
    
    // エラーメッセージの取得
    if errors := c.Errors; len(errors) > 0 {
        errorMsg := errors.String()
        params.ErrorMessage = &errorMsg
    }
    
    // バックグラウンドコンテキストを使用してログを記録
    return s.LogActivity(ctx, params)
}
```

**推定工数**: 30分

### 3. テストケースの作成 (優先度: 高)
**ファイル**: `backend/internal/service/audit_log_service_test.go` (新規作成)

**実装内容**:
- LogHTTPRequestメソッドのテスト
- コンテキストキャンセル時の動作確認
- 正常系・異常系のテストケース

**推定工数**: 45分

### 4. 統合テストの実施 (優先度: 中)
**内容**:
- Dockerコンテナを起動して実際の環境でテスト
- ログイン→通知取得のフローでエラーが発生しないことを確認
- 監査ログが正しく記録されることを確認

**推定工数**: 30分

## ファイル変更計画

### 修正ファイル
1. `backend/internal/middleware/audit_log.go` - goroutine内でバックグラウンドコンテキストを作成
2. `backend/internal/service/audit_log_service.go` - LogHTTPRequestメソッドのシグネチャ変更

### 新規作成ファイル
1. `backend/internal/service/audit_log_service_test.go` - 単体テスト

### 削除ファイル
なし

## テスト戦略

### 単体テスト
- `audit_log_service_test.go`を新規作成
- LogHTTPRequestメソッドの動作確認
- コンテキストキャンセル時の挙動確認

### 統合テスト
- Docker環境でのエンドツーエンドテスト
- 実際のログイン→通知取得フローでの動作確認

### 手動テスト
- ブラウザからログイン
- 開発者ツールでネットワークエラーがないことを確認
- バックエンドログでcontext canceledエラーが発生しないことを確認

## リスク分析

### リスク1: インターフェース変更による影響
**影響度**: 低
**発生確率**: 低
**対策**: 呼び出し箇所は1箇所のみ（ミドルウェア内）のため影響は限定的

### リスク2: パフォーマンスへの影響
**影響度**: 低
**発生確率**: 低
**対策**: goroutineの使用は変わらないため、パフォーマンスへの影響は最小限

### リスク3: 監査ログの欠落
**影響度**: 中
**発生確率**: 低
**対策**: エラーハンドリングを強化し、ログの記録を確実にする

## 推定作業時間
- 実装: 約1時間30分
- テスト: 約1時間
- 合計: 約2時間30分

## 次のステップ
1. 実装フェーズに移行
2. ミドルウェアの修正から開始
3. テストで動作を確認
4. PRを作成してレビューを依頼

## 備考
- 既存の監査ログ機能への影響は最小限
- セキュリティ面でのメリット：監査ログが確実に記録される
- 将来的にはタイムアウトの設定も検討可能