# ダッシュボード画面エラー修正実装計画

## 計画日時
2025-07-12 09:40:32

## 問題概要
ダッシュボード画面で経費申請データと通知一覧の取得に失敗する問題。
原因はCognito認証ミドルウェアとuserutilの間でユーザーID型の不整合。

## 実装方針
**推奨解決策を採用**: cognito_auth.goでuser_idをUUID型として設定する（低リスク）

### 選定理由
1. 影響範囲が最小（cognito_auth.goのみ）
2. すべてのハンドラーがUUID型を期待している
3. 型の一貫性が保たれる
4. 将来的な保守性が高い

## 実装タスク

### 1. コード修正（優先度: 高）
#### タスク1.1: cognito_auth.goの修正
- **ファイル**: `/backend/internal/middleware/cognito_auth.go`
- **修正箇所**: 111行目、155行目
- **修正内容**:
  ```go
  // 修正前
  c.Set("user_id", user.ID.String())
  
  // 修正後
  c.Set("user_id", user.ID)
  ```
- **推定時間**: 15分

### 2. テスト実装（優先度: 高）
#### タスク2.1: ミドルウェアのユニットテスト追加
- **ファイル**: `/backend/internal/middleware/cognito_auth_test.go`（新規作成）
- **テスト内容**:
  - user_idがUUID型でコンテキストに設定されることを確認
  - JWTトークン検証の成功・失敗ケース
- **推定時間**: 45分

#### タスク2.2: 統合テストの更新
- **ファイル**: `/backend/test/e2e_expense_api_test.go`
- **テスト内容**:
  - 経費申請集計APIのテスト
  - 認証トークンを使用した正常系テスト
- **推定時間**: 30分

#### タスク2.3: 通知APIの統合テスト追加
- **ファイル**: `/backend/test/e2e_notification_api_test.go`（新規作成）
- **テスト内容**:
  - 通知一覧取得APIのテスト
  - 認証トークンを使用した正常系テスト
- **推定時間**: 30分

### 3. 動作確認（優先度: 高）
#### タスク3.1: Docker環境での動作確認
- **確認項目**:
  1. ログイン後のダッシュボード表示
  2. 経費申請データの取得成功
  3. 通知一覧の取得成功
  4. その他の認証必須APIの動作
- **推定時間**: 20分

## ファイル変更計画

### 修正ファイル
1. `/backend/internal/middleware/cognito_auth.go`
   - 111行目: user_id設定を修正
   - 155行目: user_id設定を修正

### 新規作成ファイル
1. `/backend/internal/middleware/cognito_auth_test.go`
   - ミドルウェアのユニットテスト
2. `/backend/test/e2e_notification_api_test.go`
   - 通知APIの統合テスト

### 削除ファイル
なし

## テスト戦略

### ユニットテスト
- **対象**: cognito_auth.go
- **フレームワーク**: Go標準のtestingパッケージ
- **モック**: gomockを使用してリポジトリをモック化
- **カバレッジ目標**: 80%以上

### 統合テスト
- **対象**: APIエンドポイント
- **環境**: Docker Compose環境
- **ツール**: httptest
- **確認項目**:
  - 認証成功時のレスポンス
  - 認証失敗時の401エラー

### E2Eテスト
- **対象**: ダッシュボード画面
- **必要性**: 低（バックエンドのみの修正のため）
- **実施**: 手動での動作確認で代替

## リスク分析

### 技術的リスク
1. **リスク**: 他の場所でuser_idを文字列として期待している箇所がある可能性
   - **対策**: 全体検索で確認し、必要に応じて修正
   - **確率**: 低
   - **影響**: 中

2. **リスク**: UUID型への変更によるメモリ使用量の増加
   - **対策**: パフォーマンステストで確認
   - **確率**: 極低
   - **影響**: 低

### 運用リスク
1. **リスク**: デプロイ時の一時的なサービス中断
   - **対策**: ローリングアップデートで対応
   - **確率**: 低
   - **影響**: 低

## 実装スケジュール

### フェーズ1: コード修正（30分）
1. cognito_auth.goの修正
2. ローカルでの動作確認

### フェーズ2: テスト実装（2時間）
1. ユニットテストの作成
2. 統合テストの作成・更新
3. テストの実行と確認

### フェーズ3: 検証（30分）
1. Docker環境での総合テスト
2. ドキュメントの更新

### 合計推定時間: 3時間

## 成功基準
1. すべてのテストが成功すること
2. ダッシュボード画面でエラーが発生しないこと
3. 経費申請データと通知一覧が正常に取得できること
4. 既存の他のAPIに影響がないこと

## ロールバック計画
問題が発生した場合は、以下の手順でロールバック：
1. gitでfeature/dashboard-errorブランチの変更を元に戻す
2. Dockerイメージを前のバージョンに戻す
3. 動作確認を実施

## 次のステップ
1. 実装フェーズへ移行
2. コード修正の実施
3. テストの作成と実行
4. PRの作成とレビュー依頼