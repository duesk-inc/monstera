# 実装計画書：経費申請新規作成後の遷移エラー修正

## 計画概要
- **計画日時**: 2025-07-26 08:35:00
- **計画者**: Claude
- **対象機能**: 経費申請の新規作成機能
- **対象ブランチ**: fix/expense-create-redirect
- **調査報告書**: [investigate_20250726_083000.md](../investigate/investigate_20250726_083000.md)

## 実装方針

### 段階的アプローチの採用
調査結果に基づき、即座の修正から段階的に改善していく方針を採用します。

#### Phase 1: 即座の修正（高優先度）
1. 新規作成後の遷移先を一覧画面に変更
2. APIレスポンス処理を修正して`response.data`を正しく参照

#### Phase 2: 日付フォーマットの修正（中優先度）
1. 日付フォーマットをISO8601形式に戻す
2. バックエンドとの整合性を確保

#### Phase 3: API全体の統一（低優先度）
1. すべてのAPIクライアント関数でレスポンス形式を統一
2. 型安全性の向上

## 実装タスク

### Phase 1: 即座の修正

#### タスク1.1: 遷移先の修正
- **ファイル**: `/frontend/src/app/(authenticated)/(engineer)/expenses/new/page.tsx`
- **内容**: 
  - `handleSuccess`関数の遷移先を`/expenses/${expense.id}`から`/expenses`に変更
  - 一覧画面のキャッシュをクリアして最新データを表示

#### タスク1.2: APIレスポンス処理の修正
- **ファイル**: `/frontend/src/lib/api/expense.ts`
- **内容**:
  - `createExpense`関数でレスポンスの`data`フィールドを参照
  - `updateExpense`関数でも同様の修正を適用

### Phase 2: 日付フォーマットの修正

#### タスク2.1: useExpenseSubmitの修正
- **ファイル**: `/frontend/src/hooks/expense/useExpenseSubmit.ts`
- **内容**:
  - `expense_date`フィールドをISO8601形式に戻す
  - 日付変換処理を元に戻す

### Phase 3: API全体の統一（将来対応）

#### タスク3.1: APIレスポンス型の定義
- **内容**:
  - 共通のレスポンス型を定義
  - すべてのAPIクライアント関数で統一

## ファイル変更計画

### 修正するファイル
1. `/frontend/src/app/(authenticated)/(engineer)/expenses/new/page.tsx`
   - `handleSuccess`関数の遷移先を変更
   - キャッシュクリア処理を追加

2. `/frontend/src/lib/api/expense.ts`
   - `createExpense`関数のレスポンス処理を修正
   - `updateExpense`関数のレスポンス処理を修正

3. `/frontend/src/hooks/expense/useExpenseSubmit.ts`
   - 日付フォーマットをISO8601形式に修正

### 新規作成するファイル
なし

### 削除するファイル
なし

## テスト戦略

### 単体テスト
1. **APIクライアントのテスト**
   - `createExpense`関数のレスポンス処理
   - `updateExpense`関数のレスポンス処理

2. **フックのテスト**
   - `useExpenseSubmit`の日付変換処理

### 統合テスト
1. **経費申請作成フロー**
   - 新規作成 → 一覧画面への遷移
   - 作成されたデータの確認

### E2Eテスト
1. **新規作成シナリオ**
   - フォーム入力
   - 送信
   - 一覧画面への遷移
   - 作成されたデータの表示確認

## リスク分析と対策

### リスク1: 他の画面での影響
- **リスク**: 経費申請の編集画面でも同様の問題が存在する可能性
- **対策**: 
  - 編集画面の動作確認
  - 必要に応じて同様の修正を適用

### リスク2: キャッシュの不整合
- **リスク**: 一覧画面に遷移後、新規作成したデータが表示されない
- **対策**:
  - React Queryのキャッシュを適切にinvalidate
  - 遷移前にキャッシュクリアを確実に実行

### リスク3: 日付フォーマットの互換性
- **リスク**: 既存データとの互換性問題
- **対策**:
  - 段階的な修正
  - バックエンドでの柔軟な日付パース対応

## 実装スケジュール

### Day 1（即座の対応）
- Phase 1の実装（タスク1.1, 1.2）
- 動作確認とテスト

### Day 2（追加修正）
- Phase 2の実装（タスク2.1）
- 統合テストの実施

### Day 3（将来対応の検討）
- Phase 3の設計
- ドキュメント更新

## 成功基準

1. **即座の成功基準**
   - 新規作成後に一覧画面（`/expenses`）に遷移する
   - 一覧画面に新規作成したデータが表示される
   - エラーログが出力されない

2. **完全な成功基準**
   - すべてのAPIレスポンスが統一された形式で処理される
   - 日付フォーマットが一貫している
   - TypeScriptの型チェックでエラーが発生しない

## コミュニケーション計画

1. **修正完了後**
   - PRを作成し、変更内容を明確に記載
   - 動作確認手順を記載

2. **レビュー依頼**
   - 影響範囲の説明
   - テスト結果の共有

## 参考資料
- [調査報告書](../investigate/investigate_20250726_083000.md)
- [エラーハンドリング実装規則](../06_standards/error-handling.md)
- [API設計規則](../06_standards/api-design.md)

## 次のステップ
実装フェーズ（IMPLEMENT）への移行