# ActiveRoleContext プロバイダー修正 実装計画

## 計画作成日時
2025-07-19 23:17:23

## 計画作成者
Claude Code

## 調査結果参照
- `docs/investigate/investigate_20250719_223832.md`

## 実装概要
ReactコンテキストプロバイダーのRender順序を修正して、`useActiveRole must be used within an ActiveRoleProvider`エラーを解消する。

## 実装方針
プロバイダーの順序を変更する単純な修正。ActiveRoleProviderをAuthContextProviderの外側に配置することで、useAuth内でuseActiveRoleが使用可能になる。

## 詳細実装タスク

### 1. プロバイダー順序の変更（優先度：高）
**ファイル**: `frontend/src/app/providers.tsx`
**変更内容**:
```tsx
// 変更前（63-69行目）
<AuthContextProvider>
  <ActiveRoleProvider>
    <QueryErrorBoundary>
      {children}
    </QueryErrorBoundary>
  </ActiveRoleProvider>
</AuthContextProvider>

// 変更後
<ActiveRoleProvider>
  <AuthContextProvider>
    <QueryErrorBoundary>
      {children}
    </QueryErrorBoundary>
  </AuthContextProvider>
</ActiveRoleProvider>
```

### 2. 動作確認（優先度：高）
- アプリケーションを起動して正常に動作することを確認
- ログインページ、ダッシュボードページがエラーなく表示されること
- ユーザーメニューが正常に表示されること

## ファイル変更計画
| ファイルパス | 変更種別 | 説明 |
|------------|----------|------|
| `frontend/src/app/providers.tsx` | 修正 | プロバイダーの順序を変更 |

## テスト戦略

### 1. 手動テスト（必須）
- **開発環境での起動確認**
  - `make dev`でアプリケーション起動
  - エラーが発生しないことを確認
  
- **ページアクセステスト**
  - `/login` ページにアクセス
  - `/dashboard` ページにアクセス
  - エラーが表示されないことを確認

- **認証フローテスト**
  - ログイン動作の確認
  - ロール切り替え機能の確認（複数ロールを持つユーザーで）

### 2. 既存テストの実行
- `make test-frontend` で既存のテストが通ることを確認

## リスク分析と対策

### リスク
1. **低リスク**: プロバイダーの順序変更のみ
   - ActiveRoleProviderは他のプロバイダーに依存していない
   - 既存の機能に影響なし

### 対策
1. **実装前のバックアップ**: gitで変更を管理
2. **段階的なテスト**: 変更後即座に動作確認
3. **ロールバック準備**: 問題発生時は即座に元に戻せる

## 実装時間見積もり
- **実装**: 5分
- **テスト**: 10分
- **合計**: 15分

## 実装後の推奨事項
1. **ドキュメント更新**
   - コンテキストプロバイダーの依存関係を明確化
   - 今後同様のエラーを防ぐためのガイドライン作成

2. **長期的な改善**
   - プロバイダーの依存関係を自動でチェックする仕組みの検討
   - コンテキストの初期化順序に関するテストの追加

## 結論
シンプルな修正で問題を解決できる。リスクは低く、実装時間も短い。即座に実装可能。