# ActiveRoleProvider 実装プラン

## 概要
- **日時**: 2025-07-15 23:54:11
- **対象**: ActiveRoleProvider Missing Error の解決
- **ブランチ**: fix/sidebar-component-import (継続)
- **根本原因**: `app/layout.tsx`でProvidersが使用されていない

## 調査結果サマリー

### エラー内容
```
Error: useActiveRole must be used within an ActiveRoleProvider
```

### 根本原因
- `src/app/layout.tsx`で`children`が`Providers`でラップされていない
- `ActiveRoleProvider`は`src/app/providers.tsx`で正常に設定済み
- 認証済みレイアウトが`useAuth`→`useActiveRole`を使用するが、Providerが存在しない

### 影響範囲
- 全ての認証済みページ (`(authenticated)/layout.tsx`)
- 全ての管理者ページ (`(admin)/layout.tsx`)
- ActiveRoleを使用する全コンポーネント

## 実装方針

### 採用する解決策
**A. app/layout.tsx をProvidersでラップ（推奨）**
- 最小限の変更でエラー解消
- 既存のProvider設定を活用
- アプリケーション全体でContextを利用可能

## 詳細実装タスク

### 1. 緊急修正（必須）
**優先度: 高**
```typescript
// src/app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={`${geistSans.variable} ${geistMono.variable}`}>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
```

### 2. 動作確認（必須）
**優先度: 高**
- [ ] ログインページの正常表示
- [ ] 認証後ページの正常表示
- [ ] 管理者ページの正常表示
- [ ] Runtime Errorの解消確認

### 3. 回帰テスト（推奨）
**優先度: 中**
- [ ] 既存機能の正常動作
- [ ] 認証フローの確認
- [ ] ロール切り替え機能の動作
- [ ] TypeScriptコンパイルの通過

### 4. 品質保証（推奨）
**優先度: 中**
- [ ] リント確認
- [ ] パフォーマンスチェック
- [ ] セキュリティ機能の正常動作

## ファイル変更計画

### 修正対象ファイル
- **src/app/layout.tsx** (主要修正)
  - `Providers`インポート追加
  - `children`を`<Providers>`でラップ

### 参照・確認ファイル
- **src/app/providers.tsx** (Provider設定 - 変更なし)
- **src/context/ActiveRoleContext.tsx** (Context定義 - 変更なし)
- **src/hooks/useAuth.ts** (依存関係 - 変更なし)

## テスト戦略

### 1. 単体テスト
**対象**: 修正箇所の動作確認
- `app/layout.tsx`でのProviders正常動作
- Context提供の確認

### 2. 統合テスト
**対象**: 認証フロー全体
- ログイン → 認証済みページ遷移
- ロール切り替え機能
- 権限制御の動作

### 3. E2Eテスト
**対象**: ユーザー操作シナリオ
- ログインからダッシュボードまでの流れ
- 管理者機能の利用
- 各レイアウトでのエラー発生確認

### 4. Docker環境での実行
```bash
# 開発環境での動作確認
make dev

# テスト実行
make test-frontend
cd frontend && npm run test:coverage

# 品質チェック
make lint
make format
```

## リスク分析・対策

### 1. 既存機能への影響 (Low)
**リスク**: 既存のContext依存コンポーネントへの影響
**対策**: `providers.tsx`は既に全てのContext設定済み、影響なし

### 2. SSR/Hydration関連 (Very Low)
**リスク**: Server/Client間での状態不整合
**対策**: ActiveRoleProviderはクライアントサイドのみで動作設計済み

### 3. 認証フロー影響 (Very Low)
**リスク**: ログイン・ログアウトフローへの影響
**対策**: 既存の認証ロジックは変更なし、Context提供のみ

### 4. パフォーマンス影響 (Very Low)
**リスク**: 初期化コストの増加
**対策**: React Context作成・初期化のみ、軽微な影響

## 実装手順

### フェーズ1: 緊急修正（必須）
1. `src/app/layout.tsx`の現状確認
2. `Providers`インポートの追加
3. `children`のラップ修正
4. TypeScriptコンパイル確認

### フェーズ2: 動作確認（必須）
1. 開発環境での動作確認
2. Runtime Errorの解消確認
3. 認証済みページの表示確認
4. 管理者ページの表示確認

### フェーズ3: 品質保証（推奨）
1. 既存テストの実行
2. リント・フォーマット確認
3. 回帰テストの実施
4. パフォーマンス確認

## 完了基準

### 必須基準
- [ ] Runtime Errorの完全解消
- [ ] 認証済みページの正常表示
- [ ] 管理者ページの正常表示
- [ ] TypeScriptコンパイルの通過

### 推奨基準
- [ ] ロール切り替え機能の正常動作
- [ ] パフォーマンス劣化の不在
- [ ] 既存テストの通過
- [ ] セキュリティ機能の正常動作

## 関連ファイル

### 実装対象
- `src/app/layout.tsx`

### 依存関係
- `src/app/providers.tsx`
- `src/context/ActiveRoleContext.tsx`
- `src/hooks/useAuth.ts`
- `src/components/common/layout/SharedLayoutWrapper.tsx`

### 影響範囲
- `src/app/(authenticated)/layout.tsx`
- `src/app/(admin)/layout.tsx`
- `src/components/ui/RoleSwitcher.tsx`
- `src/components/features/profile/ProfileTabbedContent.tsx`
- `src/components/features/profile/AccountSettingsSection.tsx`

## 次フェーズ

### 実装フェーズ移行条件
- [ ] 本プランの承認
- [ ] 実装担当者の決定
- [ ] 実装スケジュールの確定

### 実装フェーズでの注意事項
1. **最小変更原則**: 必要最小限の修正に留める
2. **既存コード尊重**: 既存の実装パターンを踏襲
3. **段階的実装**: 緊急修正 → 動作確認 → 品質保証の順

## ログ
- **調査完了**: 2025-07-15 14:34:40
- **プラン策定**: 2025-07-15 23:54:11
- **次フェーズ**: IMPLEMENT (実装実行)