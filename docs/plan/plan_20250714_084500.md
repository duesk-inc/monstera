# 経費申請機能 実装計画書

## 1. 計画概要

### 1.1 背景
経費申請機能の調査結果（investigate_20250714_082407.md）から、設計書に記載された機能の多くは既に実装されているが、一部機能が未実装または改善が必要であることが判明した。

### 1.2 調査結果の検証
コードベースの再確認により、以下の実装状況が判明：

- **実装済み機能**
  - 承認フロー機能（CreateApprovalFlow）：実装済み
  - 通知機能（NotifyExpenseSubmitted）：実装済み
  - 領収書アップロード統合：実装済み（ReceiptUploaderコンポーネント）
  - バッチ処理（期限管理）：ProcessExpiredExpenses, ProcessExpenseReminders実装済み

- **未実装機能**
  - PDFエクスポート機能
  - 月次締めバッチ処理
  - ウイルススキャン（構造体には含まれるが実装状況不明）

### 1.3 実装目標
1. PDFエクスポート機能の実装
2. 月次締めバッチ処理の実装
3. ウイルススキャン機能の確認と必要に応じた実装
4. 既存機能のテスト充実と品質向上

## 2. 実装方針

### 2.1 優先度
- **Phase 1**（高優先度）
  - PDFエクスポート機能の実装
  - 月次締めバッチ処理の実装
  - 既存機能のテスト充実

- **Phase 2**（中優先度）
  - ウイルススキャン機能の実装
  - パフォーマンス最適化

### 2.2 技術選定
- **PDFエクスポート**: `github.com/johnfercher/maroto/v2`（Go用PDFライブラリ）
- **バッチ処理**: 既存のバッチ処理フレームワークを活用
- **テスト**: 既存のテストフレームワーク（testify, gomock）を使用

## 3. 詳細実装タスク

### 3.1 PDFエクスポート機能（優先度：高）

#### タスク内容
1. PDF生成ライブラリの導入
2. 経費明細PDF生成機能の実装
3. APIエンドポイントの追加
4. フロントエンドのダウンロード機能実装

#### 実装詳細
```go
// backend/internal/service/expense_pdf_service.go
type ExpensePDFService interface {
    GenerateExpensePDF(ctx context.Context, expenseID uuid.UUID) ([]byte, error)
    GenerateExpenseListPDF(ctx context.Context, filter *dto.ExpenseFilterRequest) ([]byte, error)
}
```

### 3.2 月次締めバッチ処理（優先度：高）

#### タスク内容
1. 月次締め処理サービスの実装
2. 自動実行スケジューラーの設定
3. 処理結果の通知機能

#### 実装詳細
```go
// backend/internal/service/expense_monthly_close_service.go
type ExpenseMonthlyCloseService interface {
    ProcessMonthlyClose(ctx context.Context, year int, month int) error
    GetMonthlyCloseStatus(ctx context.Context, year int, month int) (*model.MonthlyCloseStatus, error)
}
```

### 3.3 ウイルススキャン機能（優先度：中）

#### タスク内容
1. 現在の実装状況を確認
2. ClamAV統合またはクラウドサービス（AWS S3スキャン）の選定
3. アップロード時のスキャン実装

### 3.4 テスト充実（優先度：高）

#### タスク内容
1. 承認フローの統合テスト追加
2. 通知機能のモックテスト強化
3. PDF生成機能の単体テスト
4. バッチ処理の結合テスト

## 4. ファイル変更計画

### 4.1 新規作成ファイル
- `backend/internal/service/expense_pdf_service.go`
- `backend/internal/service/expense_monthly_close_service.go`
- `backend/internal/handler/expense_pdf_handler.go`
- `backend/test/service/expense_pdf_service_test.go`
- `backend/test/service/expense_monthly_close_service_test.go`
- `frontend/src/hooks/expense/useExpensePDF.ts`
- `frontend/src/components/features/expense/ExpensePDFDownload.tsx`

### 4.2 修正ファイル
- `backend/go.mod` - PDF生成ライブラリ追加
- `backend/internal/routes/expense_routes.go` - PDFエンドポイント追加
- `backend/internal/service/expense_service.go` - PDF生成機能の統合
- `backend/cmd/batch/main.go` - 月次締めバッチの追加
- `frontend/src/lib/api/expense.ts` - PDF APIクライアント追加
- `frontend/src/components/features/expense/ExpenseDetail.tsx` - PDFダウンロードボタン追加

## 5. テスト戦略

### 5.1 単体テスト
- PDF生成ロジックのテスト
- 月次締め処理のビジネスロジックテスト
- モックを使用したサービス層テスト

### 5.2 統合テスト
- PDFエンドポイントのE2Eテスト
- バッチ処理の動作確認テスト
- 承認フロー全体の統合テスト

### 5.3 E2Eテスト
- PDF生成・ダウンロードのユーザーフロー
- 月次締め処理の管理画面操作

## 6. リスク分析と対策

### 6.1 技術的リスク
| リスク | 影響度 | 発生可能性 | 対策 |
|--------|--------|------------|------|
| PDF生成のパフォーマンス問題 | 高 | 中 | 非同期処理化、キャッシュ活用 |
| 月次締め処理の整合性問題 | 高 | 低 | トランザクション管理、ロールバック機能 |
| ウイルススキャンの処理遅延 | 中 | 中 | 非同期スキャン、タイムアウト設定 |

### 6.2 運用リスク
- **大量データ処理**: バッチサイズ制限とページネーション実装
- **同時実行制御**: 排他制御とロック機構の実装
- **エラーリカバリ**: 再実行可能な設計と詳細ログ出力

## 7. 実装スケジュール

### Phase 1（1-2週間）
1. PDFエクスポート機能の実装
   - ライブラリ導入と基本実装（2日）
   - APIエンドポイント実装（1日）
   - フロントエンド実装（2日）
   - テスト作成（2日）

2. 月次締めバッチ処理
   - サービス実装（2日）
   - スケジューラー設定（1日）
   - テスト作成（2日）

### Phase 2（1週間）
1. ウイルススキャン機能
   - 実装状況調査（1日）
   - 必要に応じた実装（3日）
   - テスト作成（2日）

## 8. 成功基準

1. **機能要件**
   - PDFエクスポートが正常に動作し、日本語表示に対応
   - 月次締め処理が自動実行され、正確な集計結果を生成
   - ファイルアップロード時のセキュリティが確保される

2. **非機能要件**
   - PDF生成が5秒以内に完了（100件以内）
   - 月次締め処理が10分以内に完了（1000件以内）
   - テストカバレッジ80%以上

3. **品質基準**
   - 全ての新機能に対する自動テストの実装
   - エラーハンドリングとログ出力の徹底
   - ドキュメントの更新

## 9. 次のステップ

1. このプランのレビューと承認
2. 開発環境でのPDFライブラリ動作確認
3. Phase 1の実装開始
4. 週次での進捗確認と調整

---

作成日: 2025-07-14
作成者: Claude Code
ステータス: 承認待ち
ブランチ: feature/expense-application-fix