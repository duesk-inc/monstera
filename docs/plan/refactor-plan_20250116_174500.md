# リファクタリング実装計画書 - スキルシート編集ダイアログ

## 計画日時
2025-01-16 17:45:00

## 概要

### 目的と期待効果
**目的**: 編集ダイアログの保存機能のUX改善とコードの簡潔化

**期待効果**:
- ユーザーの混乱を解消（2つの同じ機能のボタンを1つに）
- 誤操作防止（確認ダイアログの追加）
- 操作の柔軟性向上（保存後も編集継続可能）
- コードの保守性向上（約20行の削減）

### スコープ
- 対象ファイル: `frontend/src/components/features/skillSheet/WorkHistoryEditDialog.tsx`
- 影響範囲: 編集ダイアログのみ（他コンポーネントへの影響なし）

## 現状と改善後の比較

### Before
```
[最終ステップのボタン]
├─ [個別保存] → handleIndividualSave() → 保存 → ダイアログは開いたまま
├─ [キャンセル] → onClose()
└─ [保存して閉じる] → handleIndividualSave() → 保存 → ダイアログを閉じる
   ※ 2つの保存ボタンが同じ処理を実行（混乱の原因）
```

### After
```
[最終ステップのボタン]
├─ [キャンセル] → onClose()
└─ [保存する] → 確認ダイアログ → handleSave() → 保存 → ダイアログは開いたまま
   ※ 1つの明確な保存ボタン + 確認ステップ
```

### メトリクスの改善予測
- コード行数: 約920行 → 約900行（-20行）
- 認知負荷: 高 → 低（ボタン選択の迷いがなくなる）
- エラー率: 中 → 低（確認ダイアログで誤操作防止）

## 段階的実装計画

### Phase 1: UIの簡潔化（15分）
**目標**: 重複したボタンを削除し、ラベルを明確化

**タスク**:
1. 「個別保存」ボタンとその関連コードを削除（line 872-891）
2. 「保存して閉じる」ラベルを「保存する」に変更（line 915）
3. 不要なimportとstateのクリーンアップ

**成果物**:
- 1つの保存ボタンのみが表示される編集ダイアログ

**テスト**:
- ボタンが正しく表示されることを確認
- 保存機能が引き続き動作することを確認

### Phase 2: 確認ダイアログの実装（20分）
**目標**: 保存前に確認ダイアログを表示

**タスク**:
1. 確認ダイアログ用のstateを追加
   ```typescript
   const [showSaveConfirm, setShowSaveConfirm] = useState(false);
   ```

2. 保存ボタンのonClickを変更
   ```typescript
   onClick={() => setShowSaveConfirm(true)}
   ```

3. ConfirmDialogコンポーネントを追加
   ```typescript
   <ConfirmDialog
     open={showSaveConfirm}
     title="職務経歴の保存"
     message="編集中の職務経歴を保存しますか？"
     confirmText="保存"
     cancelText="キャンセル"
     onConfirm={handleConfirmSave}
     onCancel={() => setShowSaveConfirm(false)}
   />
   ```

4. 確認後の保存処理を実装
   ```typescript
   const handleConfirmSave = async () => {
     setShowSaveConfirm(false);
     await handleIndividualSave();
   };
   ```

**成果物**:
- 保存前に確認ダイアログが表示される
- ユーザーが意図的に保存を実行できる

**テスト**:
- 確認ダイアログの表示/非表示
- 保存/キャンセルの動作確認

### Phase 3: 保存後の動作改善（15分）
**目標**: 保存後もダイアログを開いたままにする

**タスク**:
1. `handleIndividualSave`から以下の行を削除/変更:
   ```typescript
   // 削除
   onClose();
   
   // 変更前
   showToast: true
   
   // 変更後  
   onSuccess: () => {
     showSuccess('職務経歴を保存しました');
     // ダイアログは開いたまま
   }
   ```

2. 保存成功後のフィードバック強化
   - トースト通知の表示時間を延長
   - 保存ボタンに「保存済み」インジケーターを追加（オプション）

**成果物**:
- 保存後も編集を継続できる
- 明確な成功フィードバック

**テスト**:
- 保存後のダイアログ状態
- トースト通知の表示
- 連続保存の動作

## テスト戦略

### 手動テスト項目
1. **Phase 1完了後**
   - [ ] 保存ボタンが1つだけ表示される
   - [ ] 保存機能が正常に動作する
   
2. **Phase 2完了後**
   - [ ] 保存ボタンクリックで確認ダイアログが表示される
   - [ ] 確認→保存が正常に動作する
   - [ ] キャンセルで何も起きない
   
3. **Phase 3完了後**
   - [ ] 保存後もダイアログが開いている
   - [ ] 成功メッセージが表示される
   - [ ] 再度編集・保存が可能

### 自動テスト（将来的に追加）
- 確認ダイアログの表示テスト
- 保存処理のモックテスト
- エラーハンドリングテスト

## リスク管理

### 技術的リスク
- **リスク**: 既存の保存処理に影響
- **可能性**: 低
- **影響度**: 中
- **緩和策**: 段階的実装とテスト

### スケジュールリスク
- **総実装時間**: 約50分
- **バッファ**: +10分
- **リスク**: 想定外の依存関係
- **緩和策**: 各Phaseは独立して実装可能

### ユーザー影響
- **リスク**: 操作フローの変更による混乱
- **可能性**: 低（改善のため）
- **緩和策**: 明確なラベルと確認メッセージ

## ロールバック計画
各Phaseは独立しているため、問題が発生した場合：
1. 該当Phaseの変更をgit revertで戻す
2. 前のPhaseまでの状態で安定稼働
3. 問題を修正後、再実装

## 移行戦略
- **後方互換性**: 完全に維持（APIやデータ構造の変更なし）
- **段階的移行**: 各Phaseごとにテスト・確認
- **ユーザー通知**: 不要（UX改善のみ）

## 影響を受けるドキュメント
- なし（内部実装の改善のみ）

## 成功基準
1. ✅ 保存ボタンが1つに統一される
2. ✅ 確認ダイアログが表示される
3. ✅ 保存後も編集を継続できる
4. ✅ エラーが発生しない
5. ✅ コードが20行以上削減される

## 実装順序とタイムライン
```
開始
 ├─ Phase 1: UIの簡潔化 (15分)
 │   └─ テスト (5分)
 ├─ Phase 2: 確認ダイアログ (20分)
 │   └─ テスト (5分)
 └─ Phase 3: 保存後の動作 (15分)
     └─ テスト (5分)
完了（総計: 約65分）
```

## 結論
このリファクタリングは低リスクで高い効果が期待できる。段階的実装により、各ステップで動作確認が可能であり、問題が発生してもロールバックが容易。ユーザー体験の大幅な改善とコードの簡潔化を同時に達成できる。