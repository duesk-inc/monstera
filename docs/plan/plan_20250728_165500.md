# 経費申請「作成して提出」機能の500エラー修正計画

## 計画日時
2025-07-28 16:55:00

## 問題の概要
経費申請の「作成して提出」機能実行時に500 Internal Server Errorが発生。承認者設定はデータベースに存在するが、トランザクション内から参照できていない。

## 根本原因
`CreateApprovalFlow`メソッド内で新しい`ExpenseApproverSettingRepository`を作成する際、トランザクションコンテキストが伝播されていない。

```go
// 問題のコード
settingRepo := NewExpenseApproverSettingRepository(r.db, r.logger)
```

## 実装方針
**方針1（選択）**: トランザクション内で承認者設定リポジトリを適切に作成する

### 理由
- 最小限の変更で問題を解決できる
- 既存のアーキテクチャを維持できる
- トランザクションの一貫性を保証できる

## 詳細実装タスク

### タスク1: サービス層でトランザクション用リポジトリを追加 【優先度: 高】
**ファイル**: `backend/internal/service/expense_service.go`

**変更内容**:
```go
// トランザクション内で処理
err = s.db.Transaction(func(tx *gorm.DB) error {
    // リポジトリをトランザクション用に作成
    txExpenseRepo := repository.NewExpenseRepository(tx, s.logger)
    txApprovalRepo := repository.NewExpenseApprovalRepository(tx, s.logger)
    txApproverSettingRepo := repository.NewExpenseApproverSettingRepository(tx, s.logger) // 追加
```

### タスク2: ExpenseApprovalRepositoryの修正 【優先度: 高】
**ファイル**: `backend/internal/repository/expense_approval_repository.go`

**変更内容**:
1. ExpenseApproverSettingRepositoryを依存性として追加
2. CreateApprovalFlowメソッドのシグネチャを変更
3. 内部で新しいリポジトリを作成せず、渡されたものを使用

```go
// CreateApprovalFlow 承認フローを作成（金額に応じて必要な承認者を設定）
func (r *ExpenseApprovalRepositoryImpl) CreateApprovalFlow(
    ctx context.Context, 
    expenseID uuid.UUID, 
    amount int,
    settingRepo ExpenseApproverSettingRepository, // 追加
) error {
    // 既存のコードから以下を削除
    // settingRepo := NewExpenseApproverSettingRepository(r.db, r.logger)
```

### タスク3: インターフェースの更新 【優先度: 高】
**ファイル**: `backend/internal/repository/expense_approval_repository.go`

**変更内容**:
```go
type ExpenseApprovalRepository interface {
    // ... 既存のメソッド ...
    
    // 承認フロー管理
    CreateApprovalFlow(ctx context.Context, expenseID uuid.UUID, amount int, settingRepo ExpenseApproverSettingRepository) error
```

### タスク4: サービス層の呼び出し箇所を修正 【優先度: 高】
**ファイル**: `backend/internal/service/expense_service.go`

**変更内容**:
```go
// 承認フローを作成
if err := txApprovalRepo.CreateApprovalFlow(ctx, expense.ID, expense.Amount, txApproverSettingRepo); err != nil {
```

### タスク5: エラーハンドリングの確認 【優先度: 中】
- 承認者未設定エラーが400 Bad Requestとして返されることを確認
- 既に実装済みのため、動作確認のみ

## ファイル変更計画

### 修正対象ファイル
1. `backend/internal/repository/expense_approval_repository.go`
   - インターフェース定義の変更
   - CreateApprovalFlowメソッドの修正

2. `backend/internal/service/expense_service.go`
   - トランザクション内でExpenseApproverSettingRepositoryを作成
   - CreateApprovalFlow呼び出し時に引数を追加

### 新規作成ファイル
なし

### 削除対象ファイル
なし

## テスト戦略

### 1. 単体テスト
- `CreateApprovalFlow`メソッドのテストを修正
- モックリポジトリを使用したテストを追加

### 2. 統合テスト
- トランザクション内での承認フロー作成テスト
- 承認者未設定時のエラーハンドリングテスト

### 3. エンドポイントテスト
```bash
# 経費申請の作成と提出のテスト
curl -X POST http://localhost:8080/api/v1/expenses \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{...}'

# 作成したIDで提出
curl -X POST http://localhost:8080/api/v1/expenses/{id}/submit \
  -b cookies.txt
```

### 4. E2Eテスト
- ブラウザで「作成して提出」機能の動作確認
- エラーメッセージが適切に表示されることの確認

## リスク分析と対策

### リスク1: 既存のテストが失敗する可能性
**対策**: CreateApprovalFlowを呼び出している全てのテストを修正

### リスク2: パフォーマンスへの影響
**対策**: 追加のリポジトリ作成によるオーバーヘッドは最小限

### リスク3: 他の機能への影響
**対策**: 変更は承認フロー作成部分に限定されるため、影響範囲は限定的

## 実装スケジュール
1. リポジトリ層の修正（30分）
2. サービス層の修正（20分）
3. テストの修正・追加（40分）
4. 動作確認（30分）

合計見積もり時間: 2時間

## 成功基準
1. 「作成して提出」機能が正常に動作する
2. 承認者未設定時に適切なエラーメッセージが表示される
3. 全ての既存テストがパスする
4. トランザクションの一貫性が保たれる

## 次のステップ
1. 実装フェーズで上記タスクを順次実行
2. 各タスク完了後にテストを実行
3. 全体の動作確認を実施