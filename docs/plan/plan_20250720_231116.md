# 実装計画書 - エンジニア社員サイドバー表示修正

**作成日時:** 2025-07-20 23:11:16  
**計画ID:** plan_20250720_231116  
**優先度:** 高（P0）  

## 📋 概要

**問題:** エンジニア社員（engineer_test@duesk.co.jp）でログインしても管理者用サイドバーが表示される

**根本原因:** 単一ロールユーザーのActiveRoleContextが初期化されない

**影響範囲:** 単一ロール（role=4, employee）を持つ全てのエンジニアユーザー

## 🔍 調査結果サマリー

### 問題の流れ
1. **ユーザー情報:** engineer_test@duesk.co.jp（role=4, user_rolesテーブルにレコードなし）
2. **useAuth.ts:** userData.rolesが未定義のため、initializeActiveRole未実行
3. **ActiveRoleContext:** activeRoleがnullのまま
4. **layout.tsx:** activeRole === nullのため、isEngineer = false
5. **結果:** AdminSidebarが選択される

### 特定箇所
- **useAuth.ts:77-79** - 条件分岐で単一ロールユーザーが除外される
- **(authenticated)/layout.tsx:17** - activeRoleの判定ロジック
- **ActiveRoleContext.tsx:110-117** - 最高権限ロールをデフォルト選択

## 🎯 実装方針

### メインアプローチ
**単一ロールユーザーに対してもActiveRoleContextを正しく初期化する**

### 具体的戦略
1. **useAuth.ts修正:** userData.rolesが存在しない場合、userData.roleから配列を作成
2. **既存ロジック活用:** convertRoleNumberToString関数（auth.ts:134-142）を使用
3. **統一的処理:** 単一・複数ロール両方に対応する汎用ロジック
4. **後方互換性:** 既存の複数ロールユーザーには影響なし

## 📋 詳細タスク分解

### 🔴 最優先（P0）
1. **useAuth.ts修正** - 単一ロールユーザーの初期化ロジック追加
2. **手動テスト** - engineer_test@duesk.co.jpでのログイン・サイドバー確認

### 🟡 高優先度（P1）
3. **useAuth.ts単体テスト** - 単一・複数ロールの両方テスト
4. **convertToLocalUser改善** - ロール変換ロジックの統一化
5. **回帰テスト** - 既存機能への影響確認

### 🟢 中優先度（P2）
6. **E2Eテスト追加** - 自動化されたサイドバー表示テスト
7. **他ユーザーでの検証** - 複数の単一ロールユーザーでテスト

### 🔵 低優先度（P3）
8. **ドキュメント更新** - 実装詳細の記録
9. **追加ログ機能** - デバッグ情報の充実

## 📁 ファイル変更計画

### 修正が必要なファイル

#### 1. `frontend/src/hooks/useAuth.ts` ⭐ **主要修正**
**変更内容:**
```typescript
// 現在のロジック（77-79行目）
if (userData.roles && userData.roles.length > 0) {
  initializeActiveRole(userData.roles, userData.defaultRole);
}

// 修正後のロジック
const userRoles = userData.roles && userData.roles.length > 0 
  ? userData.roles 
  : [convertRoleNumberToString(userData.role || 4)]; // 'employee'をデフォルト

initializeActiveRole(userRoles, userData.defaultRole);
```

**影響度:** 高（認証の中核機能）

#### 2. `frontend/src/utils/auth.ts` **補助修正**
**変更内容:**
- convertRoleNumberToString関数の公開化
- エクスポートの追加

**影響度:** 中（既存機能への影響は最小）

### 新規作成が必要なファイル

#### 3. `frontend/src/hooks/__tests__/useAuth.test.ts` **新規作成**
**テストケース:**
- 単一ロールユーザーのactiveRole初期化
- 複数ロールユーザーの既存動作（回帰テスト）
- userData.rolesがnull/undefinedの場合の処理
- 不正なロール値の処理

#### 4. `e2e/tests/authentication-sidebar.spec.ts` **新規作成**
**テストシナリオ:**
- engineer_test@duesk.co.jpでのログイン
- EngineerSidebar表示の確認
- 管理者ユーザーでのAdminSidebar表示（回帰テスト）

## 🧪 テスト戦略

### 1. 単体テスト（Priority: P0）
- **対象:** useAuth.ts, auth.ts
- **フレームワーク:** Jest + Testing Library
- **重要ケース:**
  - 単一ロールユーザーのactiveRole初期化 ⭐
  - 複数ロールユーザーの既存動作（回帰テスト）
  - userData.rolesがnull/undefinedの場合の処理

### 2. 統合テスト（Priority: P1）
- **スコープ:** ログイン → ユーザー情報取得 → ActiveRole初期化 → サイドバー表示
- **重要シナリオ:**
  - engineer_test@duesk.co.jpでのログインフロー ⭐
  - 管理者ユーザーでのログインフロー（回帰）

### 3. E2Eテスト（Priority: P2）
- **フレームワーク:** Playwright
- **テストシナリオ:**
  - エンジニアユーザーログイン → EngineerSidebar表示確認 ⭐
  - 管理者ユーザーログイン → AdminSidebar表示確認

### 4. 手動テスト（Priority: P0）
- **対象ユーザー:** engineer_test@duesk.co.jp, 管理者ユーザー
- **確認項目:** ログイン成功、正しいサイドバー表示、ナビゲーション機能

### 5. テスト実行環境
- **Docker環境:** 全テストの実行
- **ステージング環境:** E2Eテストの実行

## ⚠️ リスク分析と対策

### 🔴 高リスク
#### 認証ロジック変更による既存ユーザーへの影響
- **リスク:** 複数ロールユーザーの動作変更、認証状態の不整合
- **対策:** 
  - 回帰テストの徹底実施
  - 段階的リリース（機能フラグ活用）
  - ロールバック準備

### 🟡 中リスク
#### ロール変換ロジックのエラー
- **リスク:** 不正なロール値の処理、数値→文字列変換の失敗
- **対策:**
  - エラーハンドリングの強化
  - フォールバック処理（'employee'デフォルト）
  - デバッグログの充実

#### ユーザビリティの問題
- **リスク:** ログイン後の画面表示遅延、ユーザーの混乱
- **対策:**
  - パフォーマンステストの実施
  - ユーザーへの事前通知

### 🟢 低リスク
#### パフォーマンスへの影響
- **リスク:** 初期化処理の遅延、メモリ使用量の増加
- **対策:** パフォーマンス監視、最適化の検討

### 🛡️ 総合対策
1. **段階的リリース** - 特定ユーザーでの先行テスト
2. **監視強化** - 認証エラー・ロール初期化の追跡
3. **迅速ロールバック** - 問題発生時の即座対応

## 📈 実装スケジュール

### Phase 1: 主要修正（1-2日）
- useAuth.ts修正
- auth.ts修正
- 手動テストによる動作確認

### Phase 2: テスト実装（1-2日）
- 単体テスト作成
- 統合テスト実装
- 回帰テスト実行

### Phase 3: E2Eテストと検証（1日）
- E2Eテスト作成
- 他ユーザーでの検証
- ドキュメント更新

### Phase 4: デプロイと監視（1日）
- ステージング環境でのテスト
- 本番デプロイ
- 監視とフォローアップ

## 🎯 成功指標

### 機能的指標
- engineer_test@duesk.co.jpでのEngineerSidebar表示
- 既存の複数ロールユーザーの正常動作
- 全ユーザーでの認証エラー0件

### 技術的指標
- 単体テストカバレッジ90%以上
- E2Eテスト成功率100%
- 認証初期化時間の劣化なし（<100ms）

### 運用的指標
- ユーザーからの問い合わせ0件
- ロールバック実行なし
- 認証関連のインシデント0件

## 📚 関連ドキュメント

- **調査結果:** 本セッションでの調査（engineer_test@duesk.co.jpロール確認）
- **コーディング規約:** docs/06_standards/coding-standards.md
- **テスト実装規則:** docs/01_backend/testing/testing-implementation-guide.md
- **セキュリティ実装規則:** docs/06_standards/security-implementation.md

## 📝 備考

- データベース変更は不要
- 破壊的変更なし
- 既存APIは変更せず
- フロントエンドのみの修正で対応可能

---
**次のステップ:** 実装フェーズへ移行し、useAuth.tsの修正から開始