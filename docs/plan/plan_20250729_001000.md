# データベーススキーマ整合性確保の実装計画

## 計画日時
2025-07-29 00:10:00

## 背景
- 経費申請の「作成して提出」機能で発生した500エラーの根本原因は、`expense_summaries`テーブルに`expense_count`カラムが存在しないことだった
- 一時的な対策として、`ExpenseCount`フィールドの更新をコメントアウトし、GORMの`Omit`メソッドでカラムを除外
- しかし、集計機能で申請件数の情報が必要なため、根本的な解決が必要

## 実装方針
データベーススキーマとモデル定義の整合性を確保するため、`expense_summaries`テーブルに`expense_count`カラムを追加する。

### 選択理由
- `ExpenseCount`フィールドは複数の箇所で使用されている
- 月次集計、ダッシュボード表示などで申請件数の情報が必要
- モデルから削除するよりも、データベースに追加する方が機能的に適切

## 詳細実装タスク

### フェーズ1: データベーススキーマの更新【優先度: 高】

#### タスク1.1: マイグレーションファイルの作成
- **ファイル**: `backend/migrations/200065_add_expense_count_to_summaries.up.sql`
- **内容**:
  ```sql
  -- expense_summariesテーブルにexpense_countカラムを追加
  ALTER TABLE expense_summaries 
  ADD COLUMN expense_count INT NOT NULL DEFAULT 0 
  COMMENT '申請件数' 
  AFTER pending_amount;
  
  -- 既存データの件数を更新（オプション）
  UPDATE expense_summaries es
  SET expense_count = (
    SELECT COUNT(*)
    FROM expenses e
    WHERE e.user_id = es.user_id
    AND YEAR(e.expense_date) = es.year
    AND MONTH(e.expense_date) = es.month
    AND e.status != 'draft'
  );
  ```

#### タスク1.2: ロールバック用マイグレーションファイルの作成
- **ファイル**: `backend/migrations/200065_add_expense_count_to_summaries.down.sql`
- **内容**:
  ```sql
  -- expense_countカラムを削除
  ALTER TABLE expense_summaries DROP COLUMN expense_count;
  ```

### フェーズ2: アプリケーションコードの修正【優先度: 高】

#### タスク2.1: updateMonthlySummaryメソッドの修正
- **ファイル**: `backend/internal/service/expense_service.go`
- **変更内容**:
  - コメントアウトした`ExpenseCount`関連のコードを復活
  - `Omit`メソッドの呼び出しを削除

#### タスク2.2: PostgreSQL用マイグレーションの作成
- **ファイル**: `docker/postgres/migrations/200065_add_expense_count_to_summaries.sql`
- **内容**: PostgreSQL構文での同様のマイグレーション

### フェーズ3: テストの追加【優先度: 中】

#### タスク3.1: 月次集計更新のユニットテスト
- **ファイル**: `backend/internal/service/expense_service_test.go`
- **テスト項目**:
  - 新規経費申請時の件数カウント
  - 経費申請キャンセル時の件数減少
  - 承認/却下時の件数処理

#### タスク3.2: 統合テストの追加
- **ファイル**: `backend/test/integration/expense_summary_test.go`
- **テスト項目**:
  - expense_countカラムの更新確認
  - トランザクション内での整合性確認

### フェーズ4: エラーハンドリングの改善【優先度: 中】

#### タスク4.1: データベースエラーの詳細ログ出力
- **ファイル**: `backend/internal/service/expense_service.go`
- **変更内容**:
  - SQLエラーの詳細をログに記録
  - エラーコードとメッセージの改善

#### タスク4.2: 開発環境用デバッグモードの実装
- **ファイル**: `backend/internal/config/config.go`
- **変更内容**:
  - `DEBUG_MODE`環境変数の追加
  - デバッグモード時の詳細エラー出力

### フェーズ5: CI/CDパイプラインの改善【優先度: 低】

#### タスク5.1: スキーマ整合性チェックの追加
- **ファイル**: `.github/workflows/ci.yml`
- **内容**:
  - データベーススキーマとモデル定義の整合性チェック
  - マイグレーション漏れの検出

## ファイル変更計画

### 新規作成ファイル
1. `backend/migrations/200065_add_expense_count_to_summaries.up.sql`
2. `backend/migrations/200065_add_expense_count_to_summaries.down.sql`
3. `docker/postgres/migrations/200065_add_expense_count_to_summaries.sql`
4. `backend/test/integration/expense_summary_test.go`

### 修正対象ファイル
1. `backend/internal/service/expense_service.go`
   - `updateMonthlySummary`メソッドの修正
   - エラーハンドリングの改善

2. `backend/internal/service/expense_service_test.go`
   - 月次集計更新のテスト追加

3. `.env`
   - `LOG_LEVEL=info`に戻す（デバッグ完了後）

4. `docker-compose.yml`
   - ログレベルのデフォルト値を調整

### 削除対象ファイル
なし

## テスト戦略

### 1. 単体テスト
- `updateMonthlySummary`メソッドのテスト
- エラーハンドリングのテスト

### 2. 統合テスト
- マイグレーション実行後の動作確認
- expense_countカラムの更新確認
- トランザクション処理の確認

### 3. E2Eテスト
- 経費申請作成から提出までのフロー
- 月次集計の表示確認
- ダッシュボードでの件数表示確認

### 4. 手動テスト
```bash
# マイグレーション実行
make migrate-up

# テストスクリプトの実行
bash scripts/test_expense_submit_fix.sh

# データベース確認
docker-compose exec postgres psql -U postgres -d monstera -c "SELECT * FROM expense_summaries;"
```

## リスク分析と対策

### リスク1: 既存データの不整合
- **内容**: 既存のexpense_summariesレコードのexpense_countが0のまま
- **対策**: マイグレーションで既存データの件数を計算して更新
- **緊急度**: 中

### リスク2: マイグレーションの失敗
- **内容**: 本番環境でのマイグレーション失敗
- **対策**: ロールバック用SQLの準備、事前のバックアップ
- **緊急度**: 高

### リスク3: パフォーマンスの劣化
- **内容**: 件数カウントによる処理速度の低下
- **対策**: インデックスの最適化、バッチ処理の検討
- **緊急度**: 低

## 実装スケジュール

1. **フェーズ1**: 30分（マイグレーションファイル作成）
2. **フェーズ2**: 30分（コード修正）
3. **フェーズ3**: 1時間（テスト作成）
4. **フェーズ4**: 30分（エラーハンドリング改善）
5. **フェーズ5**: 1時間（CI/CD改善）※オプション

**合計見積もり時間**: 3-4時間

## 成功基準

1. `expense_summaries`テーブルに`expense_count`カラムが追加される
2. 経費申請の作成・提出・キャンセル時に件数が正しく更新される
3. 既存の機能に影響がない
4. 全てのテストがパスする
5. エラーログが適切に出力される

## 次のステップ

1. マイグレーションファイルの作成
2. 開発環境でのマイグレーション実行とテスト
3. コード修正と単体テストの実装
4. 統合テストの実施
5. コードレビューとマージ

## 関連ドキュメント
- [調査結果](./investigate_20250729_000400.md)
- [エラーハンドリング実装規則](../06_standards/error-handling.md)
- [データベース設計・整合性](../03_database/database-design.md)