# バグ修正計画書: 経費申請提出エラーのHTTPステータスコード修正

## 計画日時
2025年1月20日 07:07

## 1. 概要

### バグの影響度と緊急度
- **影響度**: 高 - ユーザー体験に直接影響
- **緊急度**: 高 - フロントエンドの適切なエラーハンドリングを妨げている
- **発生頻度**: 月次・年次上限に達したユーザーで100%発生

### 修正の目的と期待効果
- **目的**: 月次・年次上限超過エラーの適切なHTTPステータスコード返却
- **期待効果**: 
  - フロントエンドで適切なエラーメッセージ表示が可能
  - ユーザーが問題の原因を正しく理解できる
  - システムエラーと業務エラーの明確な区別

### スコープ
- 対象ファイル: `backend/internal/handler/expense_handler.go`
- 対象メソッド: 6箇所のエラーハンドリングswitch文
- 影響範囲: 経費申請提出・更新系API

## 2. 現状分析

### 根本原因の要約
`expense_handler.go`のエラーハンドリングswitch文に、月次・年次上限超過エラーコードのケースが実装されていないため、defaultケースで500エラーが返されている。

### 影響範囲の詳細
- **影響箇所**: expense_handler.go内の6つのメソッド（行397, 1069, 1124, 1171, 1222, 1279）
- **エラーコード**: 
  - `dto.ErrCodeMonthlyLimitExceeded`（未ハンドリング）
  - `dto.ErrCodeYearlyLimitExceeded`（未ハンドリング）
- **定数**: 既に`constants.ErrMonthlyLimitExceeded`と`constants.ErrYearlyLimitExceeded`が定義済み

### 現在の回避策
なし（ユーザーは500エラーを受け取り、適切なエラー内容を把握できない）

## 3. 修正計画

### Phase 1: 緊急対応（ホットフィックス）[所要時間: 約60分]

#### Step 1.1: エラー再現テストケースの作成（15分）
- [ ] 月次上限超過エラーの再現テストを作成
- [ ] 年次上限超過エラーの再現テストを作成
- [ ] 現在のHTTPステータスコード（500）を確認

#### Step 1.2: 暫定的な修正の実装（30分）
- [ ] expense_handler.goの最初のswitch文（行397）に以下を追加：
  ```go
  case dto.ErrCodeMonthlyLimitExceeded:
      RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
      return
  case dto.ErrCodeYearlyLimitExceeded:
      RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
      return
  ```
- [ ] 修正後のテスト実行で400番台のステータスコードを確認

#### Step 1.3: 影響範囲の限定的テスト（15分）
- [ ] 修正したSubmitExpenseメソッドの動作確認
- [ ] 既存の他のエラーハンドリングが影響を受けていないことを確認
- [ ] 既存テストスイートの実行

### Phase 2: 根本修正 [所要時間: 約65分]

#### Step 2.1: 詳細な影響調査（20分）
- [ ] 6つのswitch文を含むメソッドをリストアップ
  - SubmitExpense（行397）
  - 他の5つのメソッド（行1069, 1124, 1171, 1222, 1279）
- [ ] 各メソッドの役割と使用箇所を確認

#### Step 2.2: 修正対象ファイルのバックアップ（5分）
- [ ] 現在の状態をgitでコミット
- [ ] ブランチ名: `fix/expense-limit-error-status`

#### Step 2.3: コア修正の実装（30分）
- [ ] 残り5つのswitch文に同じケースを追加
- [ ] 各修正後に構文エラーがないことを確認

#### Step 2.4: 統合テスト（10分）
- [ ] 全6箇所の修正が正しく動作することを確認
- [ ] go test ./internal/handler/... を実行

### Phase 3: 予防措置 [所要時間: 約45分]

#### Step 3.1: テストケースの追加（20分）
- [ ] 月次上限超過時のHTTPステータスコードテスト
- [ ] 年次上限超過時のHTTPステータスコードテスト
- [ ] エラーメッセージの内容確認テスト

#### Step 3.2: ドキュメント更新（10分）
- [ ] APIドキュメントに上限超過エラーのレスポンス例を追加
- [ ] エラーコード一覧の更新

#### Step 3.3: 同様パターンの検索（15分）
- [ ] 他のハンドラーで同様のswitch文の欠落がないか確認
- [ ] 必要に応じて修正リストを作成

## 4. テスト計画

### Step T1: 単体テスト（20分）
- [ ] 月次上限超過エラー時のステータスコード確認
- [ ] 年次上限超過エラー時のステータスコード確認
- [ ] エラーメッセージの正確性確認

### Step T2: 統合テスト（15分）
- [ ] 経費申請提出APIの全体的な動作確認
- [ ] 他のエラーケースが影響を受けていないことを確認

### Step T3: リグレッションテスト（10分）
- [ ] 既存のテストスイート全体を実行
- [ ] 失敗するテストがないことを確認

## 5. リスク管理

### 技術的リスク
- **リスク**: switch文の追加による予期しない動作
- **緩和策**: 各修正後に個別テストを実施

### 影響範囲のリスク
- **リスク**: フロントエンドが500エラーを前提とした処理をしている可能性
- **緩和策**: フロントエンドチームへの事前通知と調整

### ロールバックプラン
- gitでの修正前状態の保存
- 問題発生時は即座にrevertを実行

## 6. 実装コード例

```go
// 各switch文に追加するコード
case dto.ErrCodeMonthlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrMonthlyLimitExceeded, expenseErr.Message)
    return
case dto.ErrCodeYearlyLimitExceeded:
    RespondStandardErrorWithCode(c, http.StatusBadRequest, constants.ErrYearlyLimitExceeded, expenseErr.Message)
    return
```

## 7. 完了条件

- [ ] 6箇所すべてのswitch文が修正されている
- [ ] 月次・年次上限超過時にHTTP 400が返される
- [ ] すべての既存テストがパスする
- [ ] 新規テストケースが追加されている
- [ ] コードレビューが完了している

## 8. 見積もり時間

- **Phase 1（緊急対応）**: 60分
- **Phase 2（根本修正）**: 65分
- **Phase 3（予防措置）**: 45分
- **テスト**: 45分
- **合計**: 約3時間35分

## 9. 次のアクション

1. この計画の承認を得る
2. `/bug-fix`コマンドを実行して修正を開始
3. 修正完了後、プルリクエストを作成
4. コードレビューを依頼