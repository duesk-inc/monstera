# MinIO移行実装計画

## 計画策定日時
2025-07-26 09:10:00

## 目的
現在のモックS3実装をMinIOベースの実装に移行し、より本番環境に近い開発環境を構築する。

## 実装フェーズ

### フェーズ1: インフラ基盤構築【所要時間: 30分】

#### 1.1 docker-compose.ymlの更新
- MinIOサービスの追加
- ネットワーク設定の確認
- ボリューム設定の追加

#### 1.2 環境変数設定
- .env.exampleの更新
- .envファイルの更新（ローカル）

#### 1.3 Makefileの更新
- MinIO管理コマンドの追加
- 初期設定コマンドの追加

### フェーズ2: バックエンド実装【所要時間: 45分】

#### 2.1 S3サービスのMinIO対応
- backend/internal/service/s3_service.goの更新
- エンドポイント設定の追加
- パススタイル設定の追加

#### 2.2 main.goの更新
- S3サービス初期化ロジックの改善
- 環境変数の読み込み
- エラーハンドリングの強化

#### 2.3 モックサービスの保持
- USE_MOCK_S3フラグによる切り替え
- 既存のmock_s3_service.goは保持

### フェーズ3: フロントエンド実装【所要時間: 30分】

#### 3.1 アップロード処理の実装
- Pre-signed URLへの直接アップロード
- 進捗表示機能
- エラーハンドリング

#### 3.2 既存処理との統合
- 経費申請フローでの動作確認
- エラー時のフォールバック

### フェーズ4: テスト・検証【所要時間: 30分】

#### 4.1 動作確認
- MinIOコンテナの起動確認
- バケット作成確認
- ファイルアップロード・ダウンロードテスト

#### 4.2 統合テスト
- 経費申請フロー全体の動作確認
- エラーケースのテスト

## 実装順序と依存関係

```
フェーズ1（インフラ）
    ↓
フェーズ2（バックエンド）
    ↓
フェーズ3（フロントエンド）
    ↓
フェーズ4（テスト）
```

## リスクと対策

### リスク1: 既存機能への影響
- **対策**: USE_MOCK_S3フラグで切り替え可能にする
- **対策**: 段階的な移行を可能にする

### リスク2: 環境依存の問題
- **対策**: Docker環境での動作を前提とする
- **対策**: 環境変数で柔軟に設定可能にする

### リスク3: パフォーマンスの低下
- **対策**: MinIOのヘルスチェックを実装
- **対策**: 接続プールの適切な設定

## 成功基準

1. MinIOコンテナが正常に起動する
2. ファイルのアップロード・ダウンロードが正常に動作する
3. 経費申請の領収書アップロードが正常に動作する
4. 既存のモック実装との切り替えが可能
5. エラー時の適切なフォールバック

## ロールバック計画

問題が発生した場合：
1. USE_MOCK_S3=true に設定してモック実装に戻す
2. docker-compose.ymlからMinIOサービスをコメントアウト
3. 必要に応じてgit revertで変更を取り消し

## 実装開始前チェックリスト

- [ ] 現在のブランチが正しいことを確認（feature/minio-s3-migration）
- [ ] docker-composeが停止していることを確認
- [ ] .envファイルのバックアップ
- [ ] 既存の動作確認（現状の経費申請フロー）

## 次のアクション

1. この計画の承認を得る
2. フェーズ1から順次実装を開始
3. 各フェーズ完了後に動作確認を実施