# 経費カテゴリテーブル名不一致エラー修正実装計画

## 計画日時
2025-07-25 11:40:00

## 調査結果参照
`docs/investigate/investigate_20250725_113000.md`

## 実装概要
GORMモデル`ExpenseCategoryMaster`が参照するテーブル名と実際のテーブル名の不一致を解消するため、TableNameメソッドを追加する。

## 実装方針

### 選択した解決策
**TableNameメソッドの追加**を選択。理由：
- 最小限のコード変更で問題を解決可能
- 既存データへの影響なし
- 他の機能への影響なし
- リスクが最も低い

### 実装スコープ
1. モデルファイルの修正（TableNameメソッド追加）
2. テストケースの作成・実行
3. ローカル環境での動作確認
4. 他のモデルの命名規則確認

## 詳細実装タスク

### Phase 1: コア機能の修正（必須）
**優先度: High**
1. **ExpenseCategoryMasterモデルの修正**
   - `/backend/internal/model/expense_category.go`にTableNameメソッドを追加
   - コード変更量：約5行

### Phase 2: テスト実装（必須）
**優先度: High**
1. **リポジトリテストの作成**
   - `/backend/internal/repository/expense_category_repository_test.go`を新規作成
   - GetActive()メソッドのテスト
   - GetByID()メソッドのテスト
   - GetActiveOrderByDisplayOrder()メソッドのテスト

2. **API統合テストの確認**
   - `/api/v1/expenses/categories`エンドポイントのテスト
   - 正常系：カテゴリ一覧取得
   - 異常系：認証エラー

### Phase 3: 検証（必須）
**優先度: High**
1. **ローカル環境での動作確認**
   - Docker環境の起動
   - APIエンドポイントの確認（Postman/curl）
   - フロントエンドでの表示確認

2. **既存機能への影響確認**
   - 経費申請一覧の表示
   - 経費申請編集画面の動作
   - カテゴリ関連の他の機能

### Phase 4: 予防措置（推奨）
**優先度: Medium**
1. **他のモデルの確認**
   - 同様の命名規則問題がないか確認
   - 必要に応じて修正

2. **ドキュメント更新**
   - GORMモデル作成時の注意事項を追記

## ファイル変更計画

### 修正対象ファイル
1. `/backend/internal/model/expense_category.go`
   - TableNameメソッドを追加（約5行）

### 新規作成ファイル
1. `/backend/internal/repository/expense_category_repository_test.go`
   - リポジトリレイヤーのテスト（約200行）

### 削除対象ファイル
なし

## テスト戦略

### 単体テスト
1. **リポジトリ層**
   - `expense_category_repository_test.go`で実装
   - モックDBを使用したテスト
   - 主要メソッドのカバレッジ確保

### 統合テスト
1. **APIエンドポイント**
   - 実際のDBを使用した統合テスト
   - 認証・認可を含めた動作確認

### E2Eテスト
1. **フロントエンド動作確認**
   - 経費申請新規作成画面
   - カテゴリドロップダウンの表示・選択

## リスク分析

### 技術的リスク
1. **低リスク**
   - TableNameメソッドは既存の動作に影響しない
   - GORMの標準的な機能を使用

### 運用リスク
1. **低リスク**
   - データベーススキーマの変更なし
   - ダウンタイムなし

### 対策
1. **事前検証**
   - ローカル環境での十分なテスト
   - ステージング環境での確認

2. **ロールバック計画**
   - TableNameメソッドを削除するだけで元に戻せる

## 実装スケジュール

### 見積もり時間
- Phase 1: 15分（コア機能の修正）
- Phase 2: 1時間（テスト実装）
- Phase 3: 30分（検証）
- Phase 4: 30分（予防措置）

**合計: 約2時間15分**

### 実装順序
1. Phase 1: TableNameメソッドの追加
2. Phase 3の一部: 簡易動作確認
3. Phase 2: テスト実装
4. Phase 3の残り: 完全な検証
5. Phase 4: 予防措置（時間があれば）

## 成功基準

1. **機能要件**
   - `/api/v1/expenses/categories`が正常にレスポンスを返す
   - 経費申請新規作成画面でカテゴリが表示される
   - カテゴリの選択が可能

2. **非機能要件**
   - 既存機能への影響なし
   - パフォーマンスの劣化なし
   - テストカバレッジの維持・向上

## 備考

### 命名規則の統一について
今回の問題は、GORMの命名規則とデータベーステーブル名の不一致が原因。今後の開発では：
- 新規モデル作成時はTableNameメソッドを明示的に実装
- マイグレーションファイルとモデルの整合性を確認
- チーム内で命名規則を共有

### 長期的な改善案
1. CI/CDパイプラインにモデル・マイグレーション整合性チェックを追加
2. 開発ガイドラインにGORMモデル作成時の注意事項を追記
3. 定期的なコードレビューで命名規則の確認

## 結論
TableNameメソッドの追加という最小限の変更で問題を解決。リスクが低く、即座に実装可能な解決策を選択した。