# Cognito Localデバッグログ問題の実装計画

計画作成日時: 2025-07-18 13:15:00  
調査ファイル: docs/investigate/investigate_20250718_131000.md  
ブランチ: feature/fix-cognito-debug-logs

## 実装概要

Cognito Localコンテナから大量のデバッグログが出力される問題を解決するため、段階的なアプローチで対応を実施する。

### 実装方針

1. **フェーズ1（短期対応）**: DEBUG環境変数の削除によるログ出力の抑制
2. **フェーズ2（長期対応）**: ポート番号の変更による根本的解決

## 詳細実装タスク

### フェーズ1: 短期対応（DEBUG環境変数の削除）

#### タスク1.1: docker-compose.ymlの修正
- **優先度**: 高
- **作業内容**: cognito-localサービスからDEBUG=1環境変数を削除
- **所要時間**: 10分

#### タスク1.2: 動作確認
- **優先度**: 高
- **作業内容**: 
  - コンテナの再起動
  - ログ出力の確認
  - 認証機能の動作確認
- **所要時間**: 30分

#### タスク1.3: 開発チームへの周知
- **優先度**: 中
- **作業内容**: デバッグログが出力されなくなることを通知
- **所要時間**: 10分

### フェーズ2: 長期対応（ポート番号の変更）

#### タスク2.1: 設定ファイルの修正
- **優先度**: 中
- **作業内容**: 9229→9230へのポート変更
- **対象ファイル**:
  - docker-compose.yml
  - backend/internal/config/cognito.go
  - 各種シェルスクリプト
  - 環境変数設定ファイル
- **所要時間**: 1時間

#### タスク2.2: ドキュメントの更新
- **優先度**: 中
- **作業内容**: 
  - cognito/README.md
  - 各種技術ドキュメント
- **所要時間**: 30分

#### タスク2.3: テストの実施
- **優先度**: 高
- **作業内容**: 
  - 単体テストの実行
  - 統合テストの実行
  - E2Eテストの実行
- **所要時間**: 2時間

#### タスク2.4: 本番環境への影響確認
- **優先度**: 高
- **作業内容**: 本番環境でのポート番号確認と移行計画
- **所要時間**: 1時間

## ファイル変更計画

### フェーズ1での変更

#### 修正ファイル
1. `/docker-compose.yml`
   - cognito-localサービスの環境変数セクションから`DEBUG: 1`を削除

### フェーズ2での変更

#### 修正ファイル
1. `/docker-compose.yml`
   - ports: "9229:9229" → "9230:9229"
   - COGNITO_ENDPOINT: http://cognito-local:9229 → http://cognito-local:9230

2. `/backend/internal/config/cognito.go`
   - ポート番号のハードコード部分を修正（9229→9230）

3. `/backend/test/cognito/test_config.go`
   - テスト用エンドポイントのポート番号を修正

4. `/cognito/README.md`
   - ポート番号の記載を更新
   - curl例のURLを更新

5. `/scripts/auth/test-cognito-login.sh`
   - COGNITO_ENDPOINTのデフォルト値を更新

6. `/scripts/auth/setup-local-cognito.sh`
   - COGNITO_ENDPOINTのデフォルト値を更新

7. `/frontend/src/test/env.setup.js`
   - テスト環境のCOGNITO_ENDPOINTを更新

8. その他ドキュメントファイル
   - ポート番号が記載されている箇所を全て更新

## テスト戦略

### フェーズ1のテスト

1. **動作確認テスト**
   - ログ出力の停止確認
   - 認証機能の正常動作確認
   - ヘルスチェックの状態確認

2. **回帰テスト**
   - 既存の認証テストを実行
   - エラーが発生しないことを確認

### フェーズ2のテスト

1. **単体テスト**
   - backend/test/cognito配下のテストを全て実行
   - 新しいポート番号での接続確認

2. **統合テスト**
   - フロントエンドからバックエンド経由での認証フロー確認
   - 全ての認証関連APIのテスト

3. **E2Eテスト**
   - ログイン・ログアウトフローの確認
   - トークンリフレッシュの確認
   - 権限別アクセス制御の確認

4. **負荷テスト**
   - ポート変更による性能影響の確認

## リスク分析と対策

### リスク1: デバッグ時の問題発見の遅延
- **影響度**: 低
- **発生確率**: 中
- **対策**: 
  - 必要時にDEBUG=1を一時的に有効化する手順を文書化
  - 問題発生時のトラブルシューティングガイドを作成

### リスク2: 他環境との設定不整合
- **影響度**: 高
- **発生確率**: 低
- **対策**: 
  - 全環境の設定を事前に確認
  - 段階的な移行計画の策定
  - ロールバック手順の準備

### リスク3: ポート番号変更時の設定漏れ
- **影響度**: 高
- **発生確率**: 中
- **対策**: 
  - grepによる網羅的な検索実施
  - チェックリストの作成
  - ピアレビューの実施

### リスク4: 開発者の混乱
- **影響度**: 中
- **発生確率**: 中
- **対策**: 
  - 変更内容の詳細な周知
  - 移行期間の設定
  - FAQの準備

## 実装スケジュール

### フェーズ1（即日実施）
- Day 1 AM: docker-compose.yml修正と動作確認
- Day 1 PM: チームへの周知

### フェーズ2（1週間後）
- Day 7: 設定ファイルの修正
- Day 8: テスト実施
- Day 9: ドキュメント更新と最終確認
- Day 10: 本番環境への適用検討

## 成功基準

### フェーズ1
- デバッグログの出力が停止すること
- 認証機能が正常に動作すること
- 既存テストが全てパスすること

### フェーズ2
- 新しいポート番号で全機能が動作すること
- Node.jsデバッガーとの競合が発生しないこと
- 全てのテストがパスすること
- ドキュメントが最新化されていること

## 次のステップ

1. 本計画の承認を得る
2. フェーズ1の実装を開始する
3. フェーズ1の結果を評価し、フェーズ2の実施判断を行う

---

計画作成者: Claude  
承認者: （未定）  
実装担当者: （未定）