# 経費申請の下書き機能実装計画

## 計画日時
2025-07-27 20:42:11

## 概要
調査結果（`docs/investigate/investigate_20250727_202616.md`）に基づき、フロントエンドに下書き機能を実装する計画を策定する。

## 実装方針
**選択した方針**: フロントエンドに下書き機能を実装（調査結果のオプション1）

### 選択理由
1. バックエンドは既に実装済みで、フロントエンドの実装のみで解決
2. 週報との一貫性を保てる
3. ユーザーにとって有用な機能（入力途中の保存）を提供できる
4. 将来的な要件変更に柔軟に対応できる
5. リスクが最も低い

## 実装タスクの詳細

### フェーズ1: 経費申請詳細画面に「提出」ボタンを追加（優先度: 高）

#### タスク1-1: ExpenseFormコンポーネントの拡張
- draftステータスの経費に対して「提出」ボタンを表示
- 提出処理の実装（submitExpense APIの呼び出し）
- 提出後の画面遷移とメッセージ表示

#### タスク1-2: 詳細画面のUI改善
- ステータスに応じたアクションボタンの表示制御
- draft: 編集、削除、提出ボタン
- submitted以降: 編集・提出ボタンを非表示

### フェーズ2: 経費申請一覧でdraft状態を識別しやすくする（優先度: 中）

#### タスク2-1: 一覧画面のステータス表示改善
- draftステータスの項目に視覚的な識別子を追加（アイコン、色など）
- ステータスチップコンポーネントの拡張

#### タスク2-2: フィルター機能の追加
- ステータスによるフィルター機能を追加
- 「下書きのみ」を簡単に表示できるようにする

### フェーズ3: 作成時に「下書き保存」と「作成して提出」の選択肢を提供（優先度: 中）

#### タスク3-1: ExpenseFormコンポーネントの作成モード改善
- 「下書き保存」ボタンの追加（現在の「作成」ボタンを置き換え）
- 「作成して提出」ボタンの追加（作成→即提出）

#### タスク3-2: フォーム送信処理の分岐
- 下書き保存: 作成APIのみ呼び出し
- 作成して提出: 作成API → 提出APIを連続で呼び出し

## ファイル変更計画

### 修正対象ファイル

1. `/frontend/src/components/features/expense/ExpenseForm.tsx`
   - 提出ボタンの追加
   - ステータスに応じたボタン表示制御
   - 作成モードでの2つのボタン追加
   - 提出処理の実装

2. `/frontend/src/hooks/expense/useExpenseSubmit.ts`
   - 提出処理のフック作成または拡張
   - エラーハンドリング
   - 成功時の処理

3. `/frontend/src/components/features/expense/ExpenseHistoryView.tsx`
   - draftステータスの視覚的識別
   - ステータスフィルターの追加

4. `/frontend/src/app/(authenticated)/(engineer)/expenses/page.tsx`
   - フィルター機能の統合
   - UI改善

5. `/frontend/src/components/common/StatusChip.tsx` （存在する場合）
   - draftステータスのスタイル追加
   - アイコンの追加

### 新規作成ファイル（必要に応じて）

1. `/frontend/src/hooks/expense/useExpenseStatusFilter.ts`
   - ステータスフィルター用のカスタムフック

## テスト戦略

### 単体テスト

1. **ExpenseFormコンポーネントのテスト**
   - draftステータスで提出ボタンが表示されることを確認
   - submitted以降のステータスで提出ボタンが非表示になることを確認
   - 下書き保存ボタンのクリック処理
   - 作成して提出ボタンのクリック処理

2. **useExpenseSubmitフックのテスト**
   - 提出API呼び出しの成功ケース
   - エラーハンドリングのテスト
   - ローディング状態の管理

### 統合テスト

1. **作成フローのテスト**
   - 下書き保存 → 一覧でdraft確認 → 詳細で提出
   - 作成して提出 → 一覧でsubmitted確認

2. **エラーケースのテスト**
   - ネットワークエラー時の処理
   - バリデーションエラー時の処理

### E2Eテスト（Docker環境）

1. **フル機能テスト**
   - 経費申請作成（下書き）
   - 一覧画面でのフィルター
   - 詳細画面での提出
   - ステータス変更の確認

## リスク分析と対策

### リスク1: APIエラーハンドリング
**内容**: 提出API呼び出し時のエラー処理が不適切な場合、ユーザーに混乱を与える
**対策**: 
- 適切なエラーメッセージの表示
- リトライ機能の実装
- ローディング状態の明確な表示

### リスク2: 連続API呼び出しの失敗
**内容**: 「作成して提出」で作成は成功したが提出が失敗する場合
**対策**:
- トランザクション的な処理の実装
- 中間状態の適切な処理
- ユーザーへの明確なフィードバック

### リスク3: UIの一貫性
**内容**: 週報と経費申請でUIが異なり、ユーザーが混乱する
**対策**:
- 週報のUIを参考に統一的なデザイン
- 共通コンポーネントの活用

### リスク4: 既存機能への影響
**内容**: 変更により既存の編集・削除機能が動作しなくなる
**対策**:
- 十分なテストカバレッジ
- 段階的なリリース
- フィーチャーフラグの活用（必要に応じて）

## 実装スケジュール

### 推定工数
- フェーズ1: 8時間（1日）
- フェーズ2: 4時間（0.5日）
- フェーズ3: 6時間（0.75日）
- テスト・デバッグ: 6時間（0.75日）
- **合計**: 24時間（3日）

### 推奨実装順序
1. フェーズ1を最優先で実装（最も重要な機能）
2. フェーズ1のテストを完了
3. フェーズ2とフェーズ3を並行実装
4. 統合テスト・E2Eテスト

## 成功基準

1. **機能要件**
   - draftステータスの経費申請を提出できる
   - 新規作成時に下書き保存と即提出を選択できる
   - 一覧画面でdraftステータスを識別できる

2. **非機能要件**
   - APIエラー時の適切なエラーハンドリング
   - ユーザーフレンドリーなUI/UX
   - 既存機能への影響がない

3. **テスト要件**
   - 単体テストカバレッジ80%以上
   - 統合テストの全ケース成功
   - E2Eテストの全シナリオ成功

## 次のステップ

1. 実装フェーズへの移行
2. フェーズ1の詳細設計と実装開始
3. 定期的な進捗確認とレビュー

## 参考資料
- 調査結果: `docs/investigate/investigate_20250727_202616.md`
- 週報の実装: `/frontend/src/components/features/weeklyReport/`
- API仕様: バックエンドのSwaggerドキュメント