# 実装計画書: ログイン後のユーザーメニュー表示不具合修正

## 作成日時
2025-07-19 20:41:51

## 調査結果サマリー
- **問題**: 複数の認証状態管理システムが混在し、TopBarとSharedUserMenuが異なる認証状態を参照している
- **原因**: 3つの異なる認証システム（useAuth、useAuthContext、AuthContext）が存在
- **選択した解決策**: useAuthフックに統一

## 実装方針
### 採用する方法: useAuthフックへの統一

**理由**:
- 変更範囲が限定的でリスクが低い
- 既存のActiveRoleProviderとの連携が保たれる
- ログイン/ログアウト処理の変更が不要
- 実装時間が短い

## 実装タスク詳細

### Phase 1: 認証システムの統一（優先度: 高）

#### Task 1.1: TopBar.tsxの修正
- **内容**: useAuthContextをuseAuthに置き換え
- **作業時間**: 30分
- **影響範囲**: TopBarコンポーネントのみ

#### Task 1.2: providers.tsxのAuthContext修正
- **内容**: AuthContextProviderをuseAuthフックのラッパーとして再実装
- **作業時間**: 1時間
- **影響範囲**: アプリケーション全体の認証状態管理

#### Task 1.3: useQueryErrorHandler.tsの修正
- **内容**: useAuthContextをuseAuthに置き換え、setUser呼び出しの修正
- **作業時間**: 30分
- **影響範囲**: エラーハンドリング処理

### Phase 2: 不要ファイルの削除（優先度: 中）

#### Task 2.1: AuthContext.tsxの削除
- **内容**: /context/AuthContext.tsxファイルを削除
- **作業時間**: 10分
- **影響範囲**: なし（未使用ファイル）

### Phase 3: テスト実施（優先度: 高）

#### Task 3.1: 機能テスト
- ログイン後のユーザーメニュー表示確認
- ログアウト機能の動作確認
- ロール切り替え機能の動作確認
- ページリロード後の認証状態保持確認
- **作業時間**: 1時間

#### Task 3.2: 既存テストの更新
- TopBar.test.tsxの更新（存在する場合）
- **作業時間**: 30分

## ファイル変更計画

### 修正対象ファイル
1. `/frontend/src/components/ui/TopBar.tsx`
   - `useAuthContext` → `useAuth`に変更
   - インポート文の修正

2. `/frontend/src/app/providers.tsx`
   - AuthContextProviderの実装をuseAuthフックのラッパーに変更
   - またはAuthContext関連コードを完全に削除

3. `/frontend/src/hooks/common/useQueryErrorHandler.ts`
   - `useAuthContext` → `useAuth`に変更
   - setUser呼び出しの調整

### 削除対象ファイル
1. `/frontend/src/context/AuthContext.tsx`
   - 完全に削除（未使用のため）

## テスト戦略

### 手動テスト項目
1. **ログイン機能**
   - ログイン成功後、ユーザーメニューに正しい情報が表示される
   - ユーザー名、メールアドレス、ロールが表示される

2. **ログアウト機能**
   - ログアウトボタンクリックで正常にログアウト
   - ログイン画面へリダイレクト

3. **ロール切り替え**
   - 複数ロールを持つユーザーでロール切り替えが機能する

4. **永続性**
   - ブラウザリロード後も認証状態が保持される
   - 別タブでの認証状態同期

### 自動テスト
- 既存のTopBarテストがある場合は、useAuthフックを使用するように更新
- 新規テストケースの追加は必要に応じて実施

## リスク分析と対策

### リスク1: ローカルストレージキーの不整合
- **リスク**: 異なるキー（`user`と`monstera_user`）による認証状態の不整合
- **対策**: providers.tsxの実装を慎重に行い、正しいキーを参照するよう確認

### リスク2: 既存セッションの互換性
- **リスク**: 実装後、既存ユーザーのセッションが無効になる可能性
- **対策**: 移行期間中は両方のキーをチェックする実装を検討

### リスク3: 未発見の依存コンポーネント
- **リスク**: useAuthContextを使用している他のコンポーネントが存在する可能性
- **対策**: 実装前に再度全体検索を実施

## 実装順序と見積もり時間

1. **Phase 1**: 2時間
   - TopBar.tsx修正: 30分
   - providers.tsx修正: 1時間
   - useQueryErrorHandler.ts修正: 30分

2. **Phase 2**: 10分
   - 不要ファイル削除

3. **Phase 3**: 1.5時間
   - 機能テスト: 1時間
   - テスト更新: 30分

**合計見積もり時間**: 3時間40分

## 成功基準
1. ログイン後、ユーザーメニューに正しい情報が表示される
2. ログアウト機能が正常に動作する
3. ロール切り替え機能が正常に動作する（該当ユーザーの場合）
4. ページリロード後も認証状態が保持される
5. 既存の認証関連機能に影響がない

## 次のステップ
1. 実装（IMPLEMENTフェーズ）に移行
2. Phase 1から順次実装を開始
3. 各フェーズ完了後に動作確認を実施

## 作成ブランチ
- ブランチ名: `feature/fix-user-menu`（作成済み）

## 参照ドキュメント
- 調査結果: `docs/investigate/investigate_20250719_202719.md`