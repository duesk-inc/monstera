# 経費申請フロントエンドテスト実装計画

## 計画策定日時
2025-07-14 14:15

## 計画概要

### 背景
調査結果により、経費申請機能のフロントエンドテストが完全に不足していることが判明。バックエンドの充実したテスト（1,779行）と比較して、フロントエンドの品質担保が不十分な状況。

### 目標
週報機能で確立されたテストパターンを参考に、経費申請機能の包括的なフロントエンドテストを段階的に実装する。

## 実装戦略

### Phase 1: 基盤構築（高優先度）
**期間**: 1-2日  
**目標**: 基本的なコンポーネントテストとテストインフラの確立

#### 1.1 コアコンポーネントテスト
1. **ExpenseForm.test.tsx**（最重要）
   - フォーム入力・バリデーション
   - 領収書アップロード機能
   - 自動保存機能
   - エラーハンドリング

2. **ExpenseList.test.tsx**
   - 一覧表示・フィルタリング
   - ページネーション
   - ステータス表示

3. **基本APIモック環境整備**
   - MSWによる経費申請API
   - カテゴリマスタAPI

#### 1.2 テストユーティリティ作成
```
src/__tests__/expense/
├── utils/
│   ├── expenseApiMocks.ts       # MSW API モック
│   ├── expenseMockData.ts       # テストデータ生成
│   ├── expenseTestHelpers.tsx   # テストヘルパー関数
│   └── index.ts                 # エクスポート統合
```

### Phase 2: 機能拡張（中優先度）
**期間**: 2-3日  
**目標**: 残りのコンポーネント・フックテストの実装

#### 2.1 追加コンポーネントテスト
1. **ExpenseDetail.test.tsx**
   - 詳細表示機能
   - 編集・削除アクション
   - 承認状況表示

2. **ReceiptUploader.test.tsx**
   - ファイルアップロード機能
   - ドラッグ&ドロップ
   - プレビュー表示

3. **ExpensePDFDownload.test.tsx**
   - PDF生成・ダウンロード
   - エラーハンドリング

#### 2.2 フックテスト
1. **useExpenseSubmit.test.tsx**
   - 申請送信フロー
   - エラーハンドリング

2. **useCategories.test.tsx**
   - カテゴリデータ取得
   - キャッシュ機能

3. **useAutoSave.test.tsx**
   - 自動保存機能
   - タイマー制御

### Phase 3: 統合・品質強化（低優先度）
**期間**: 2-3日  
**目標**: 統合テスト・E2Eテストの追加

#### 3.1 統合テスト
1. **ExpenseFlow.test.tsx**
   - 作成→編集→提出のフロー
   - エラー状態のハンドリング

2. **ApprovalFlow.test.tsx**
   - 承認・却下のフロー
   - 通知機能

#### 3.2 E2Eテスト強化
1. **expense-e2e.spec.ts**
   - ブラウザでの完全なフロー
   - クロスブラウザテスト

## ファイル変更計画

### 新規作成ファイル（18ファイル）

#### テストファイル（11ファイル）
```
src/__tests__/expense/
├── components/
│   ├── ExpenseForm.test.tsx                 # Phase 1
│   ├── ExpenseList.test.tsx                 # Phase 1
│   ├── ExpenseDetail.test.tsx               # Phase 2
│   ├── ReceiptUploader.test.tsx             # Phase 2
│   └── ExpensePDFDownload.test.tsx          # Phase 2
├── hooks/
│   ├── useExpenseSubmit.test.tsx            # Phase 2
│   ├── useCategories.test.tsx               # Phase 2
│   └── useAutoSave.test.tsx                 # Phase 2
└── integration/
    ├── ExpenseFlow.test.tsx                 # Phase 3
    └── ApprovalFlow.test.tsx                # Phase 3
```

#### テストユーティリティ（7ファイル）
```
src/__tests__/expense/
├── utils/
│   ├── expenseApiMocks.ts                   # Phase 1
│   ├── expenseMockData.ts                   # Phase 1
│   ├── expenseTestHelpers.tsx               # Phase 1
│   └── index.ts                             # Phase 1
├── jest.setup.ts                            # Phase 1
├── setup.test.ts                            # Phase 1
└── types/
    └── index.ts                             # Phase 1
```

### 修正ファイル（2ファイル）
1. **jest.config.js**
   - expense テストパス追加
   - カバレッジ設定調整

2. **package.json**
   - expense専用テストスクリプト追加

## テスト戦略詳細

### 単体テスト戦略
- **カバレッジ目標**: 90%以上
- **テストパターン**: 週報テストパターンを踏襲
- **モック戦略**: MSW + Jest mock
- **アサーション**: @testing-library/jest-dom

### 統合テスト戦略
- **フロー中心**: ユーザージャーニーベース
- **API統合**: 実際のAPIエンドポイントとの連携
- **状態管理**: React Query との統合

### E2Eテスト戦略
- **ツール**: Playwright
- **シナリオ**: クリティカルパス中心
- **環境**: 開発環境での実行

## 技術要件

### 必要な依存関係（既存）
- Jest + React Testing Library ✅
- MSW (Mock Service Worker) ✅
- @testing-library/jest-dom ✅
- TypeScript対応 ✅

### テスト実行環境
```bash
# Phase 1 実行コマンド
npm run test:expense                    # 経費申請テストのみ
npm run test:expense:watch             # ウォッチモード
npm run test:expense:coverage          # カバレッジ付き

# 全体実行
npm run test                           # 全テスト
npm run test:coverage                  # 全体カバレッジ
```

## リスク分析と対策

### 高リスク
1. **ExpenseFormの複雑性**
   - **リスク**: テスト実装の技術的難易度
   - **対策**: 週報のWeeklyReportContainerパターンを参考にモック分割

2. **ファイルアップロードテスト**
   - **リスク**: ブラウザAPI依存の機能テスト
   - **対策**: File APIモック + userEvent.upload活用

### 中リスク
1. **API統合テスト**
   - **リスク**: バックエンドAPIとの同期
   - **対策**: MSWで実APIと同じレスポンス形式を保証

2. **パフォーマンステスト**
   - **リスク**: 大量データでの動作確認
   - **対策**: モックデータ生成器で様々なサイズをテスト

### 低リスク
1. **既存機能への影響**
   - **リスク**: 新規テスト追加による既存テストへの影響
   - **対策**: jest.config.jsでテストパス分離

## 品質保証

### テスト品質指標
1. **カバレッジ**: コンポーネント90%、フック85%、統合75%
2. **テストケース数**: 最低150ケース
3. **実行時間**: 30秒以内（Phase 1-2）

### レビュー基準
1. **テストの可読性**: Given-When-Then パターン
2. **モックの適切性**: 実装詳細ではなく動作をテスト
3. **エラーケース**: 正常系60%、異常系40%の配分

## 実装スケジュール

### Week 1: Phase 1 実装
- **Day 1-2**: ExpenseForm.test.tsx + テストユーティリティ
- **Day 3**: ExpenseList.test.tsx + APIモック
- **Day 4**: 基盤テスト完成・レビュー

### Week 2: Phase 2 実装
- **Day 1**: ExpenseDetail.test.tsx + ReceiptUploader.test.tsx
- **Day 2**: フックテスト3種類
- **Day 3**: ExpensePDFDownload.test.tsx
- **Day 4**: Phase 2 完成・統合テスト

### Week 3: Phase 3 実装
- **Day 1-2**: 統合テスト実装
- **Day 3**: E2Eテスト追加
- **Day 4**: 最終レビュー・ドキュメント更新

## 成功基準

### Phase 1 完了基準
- ExpenseForm・ExpenseListの基本テスト完成
- カバレッジ80%達成
- CI/CDパイプラインでのテスト実行成功

### Phase 2 完了基準
- 全コンポーネント・フックテスト完成
- カバレッジ90%達成
- リグレッションテスト0件

### Phase 3 完了基準
- 統合・E2Eテスト完成
- 品質指標全項目クリア
- ドキュメント更新完了

## 関連ドキュメント

- **参考実装**: `src/__tests__/weekly-report/` パターン
- **コーディング規約**: `docs/06_standards/coding-standards.md`
- **テスト実装規則**: `docs/01_backend/testing/testing-implementation-guide.md`

## 次ステップ

1. **即座実行**: Phase 1の ExpenseForm.test.tsx 作成開始
2. **ブランチ作成**: `feature/frontend-expense-tests`
3. **進捗管理**: 各Phase完了後のレビュー・承認

---

**計画ステータス**: COMPLETED  
**次フェーズ**: IMPLEMENT（Phase 1実装開始）  
**優先実装**: ExpenseForm.test.tsx → ExpenseList.test.tsx → APIモック環境  

**作成ブランチ**: feature/frontend-expense-tests  
**計画ファイル**: docs/plan/plan_20250714_141500.md