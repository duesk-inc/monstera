# ユーザーアイコン「？」表示問題 修正計画

**作成日時**: 2025-07-20 22:31:07  
**計画者**: Claude Code  
**優先度**: 高  
**予想工数**: 0.5日  

## 📋 問題概要

### 現象
- ログイン成功後、ダッシュボード画面のユーザーアイコンが「？」のまま表示される
- ページリフレッシュ後もユーザー名の頭文字が表示されない

### 根本原因
**ローカルストレージキーの不整合によるデータフロー断絶**

1. **ログイン時**: `auth/index.ts`で`'user'`キーに保存
2. **読み取り時**: `utils/auth.ts`で`'monstera_user'`キーから読み取り
3. **結果**: ページリフレッシュ時にユーザー情報が取得できず、アイコンが「？」表示

### 影響範囲
- UserAvatarコンポーネントでの表示異常
- ユーザビリティの低下
- 認証状態復元の不整合

## 🎯 実装方針

### 基本方針
1. **統一性重視**: 既存の統一されたユーザー情報保存処理を使用
2. **最小限変更**: `auth/index.ts`の保存処理のみを修正
3. **既存活用**: 正常動作している`utils/auth.ts`の仕組みを活用
4. **データ変換統一**: API形式からローカル形式への変換を統一

### 修正アプローチ
- `convertToLocalUser()`と`setLocalUser()`を使用した統一された保存処理に変更
- 重複する古い`setUser`関数を削除
- データフローの一元化

## 🛠️ 詳細修正内容

### 修正対象ファイル
**`/frontend/src/lib/api/auth/index.ts`**

### 修正箇所

#### 1. インポート文の追加 (5-18行目付近)
```typescript
// 追加
import { 
  setAuthState,
  clearAuthState,
  removeUser,
  convertToLocalUser,    // 追加
  setUser as setLocalUser // 追加
} from '@/utils/auth';
```

#### 2. 重複関数の削除 (27-31行目)
```typescript
// 削除対象
const setUser = (user: any): void => {
  if (typeof window !== 'undefined') {
    localStorage.setItem('user', JSON.stringify(user));
  }
};
```

#### 3. ログイン時の保存処理修正 (74行目)
```typescript
// 修正前
if (response.data.user) {
  setUser(response.data.user);
}

// 修正後
if (response.data.user) {
  const localUser = convertToLocalUser(response.data.user);
  setLocalUser(localUser);
}
```

#### 4. リフレッシュトークン時の保存処理修正 (158行目)
```typescript
// 修正前
if (response.data.user) {
  setUser(response.data.user);
}

// 修正後
if (response.data.user) {
  const localUser = convertToLocalUser(response.data.user);
  setLocalUser(localUser);
}
```

## 📁 ファイル変更計画

### 修正ファイル
- ✏️ `/frontend/src/lib/api/auth/index.ts` - メイン修正対象

### 新規作成ファイル
- なし

### 削除ファイル
- なし

### 影響確認
- 他ファイルへの影響: なし（内部関数変更のみ）
- APIとの互換性: 維持
- 既存認証フロー: 維持

## 🧪 テスト戦略

### 手動テスト（優先度: 高）
**テスト手順**:
1. ログイン実行
2. ダッシュボードでアイコン確認（名前の頭文字表示）
3. F5でページリフレッシュ
4. アイコンが維持されるか確認
5. 開発者ツールでローカルストレージ確認（`monstera_user`キー）

**期待結果**:
- ログイン後即座にユーザー名頭文字が表示
- リフレッシュ後も表示が維持
- `localStorage['monstera_user']`にユーザー情報が保存

### 統合テスト（優先度: 中）
- ログイン〜ダッシュボード遷移フロー確認
- 複数ブラウザタブでの同期確認
- ログアウト〜再ログインフロー確認

### 単体テスト（優先度: 低）
- `convertToLocalUser`関数のデータ変換確認
- 既存テストスイートで大部分をカバー

## ⚠️ リスク分析と対策

### 高リスク
1. **既存ログインユーザーへの影響**
   - リスク: 現在'user'キーのデータが読み取れなくなる
   - 対策: 再ログインが必要（軽微な影響、一時的）

### 中リスク
2. **並行開発との競合**
   - リスク: 他開発者による同時修正
   - 対策: 最新版確認、マージ確認

3. **TypeScriptエラー**
   - リスク: インポート追加時の型エラー
   - 対策: コンパイラ事前確認

### 低リスク
4. **パフォーマンス影響**
   - リスク: データ変換オーバーヘッド
   - 対策: 既存処理と同等レベル

## 📝 実装手順

### Phase 1: 準備・確認
1. 最新版の取得とマージ確認
2. 開発環境での動作確認
3. バックアップ作成

### Phase 2: 修正実装
1. インポート文の追加
2. 重複関数の削除
3. 保存処理の修正（2箇所）
4. TypeScriptコンパイル確認

### Phase 3: テスト・検証
1. 手動テスト実行
2. 統合テスト実行
3. ローカルストレージ確認
4. 複数ブラウザでの動作確認

### Phase 4: リリース準備
1. コードレビュー
2. ステージング環境でのテスト
3. 本番環境での段階的リリース

## ✅ 受入基準

### 必須条件
- [ ] ログイン後、ユーザーアイコンにユーザー名の頭文字が表示される
- [ ] ページリフレッシュ後もアイコン表示が維持される
- [ ] ローカルストレージの`monstera_user`キーにユーザー情報が保存される
- [ ] 既存の認証フローが正常動作する

### 品質条件
- [ ] TypeScriptエラーが発生しない
- [ ] コンソールエラーが発生しない
- [ ] 既存テストが全て通過する
- [ ] ログイン〜ログアウトフローが正常動作する

### パフォーマンス条件
- [ ] ログイン時間に有意な遅延が発生しない
- [ ] ページ読み込み時間に影響がない

## 🚀 リリース計画

### リリース段階
1. **開発環境**: 修正実装・初期テスト
2. **ステージング環境**: 統合テスト・受入テスト
3. **本番環境**: 段階的リリース

### ロールバック計画
- 変更が1ファイルのみのため、Git revertで即座にロールバック可能
- 影響範囲が限定的で、緊急時対応が容易

## 📊 実装優先度

### 高優先度（必須）
1. ユーザー情報保存処理の修正
2. 重複関数の削除
3. 手動テストでの動作確認

### 中優先度（推奨）
4. 統合テストの実行
5. 複数環境での確認

### 低優先度（任意）
6. 単体テストの追加
7. E2Eテストの実装

## 💡 追加検討事項

### 今後の改善案
1. **エラーハンドリング強化**: データ変換失敗時の処理
2. **キー統一の徹底**: 他の保存処理でも同様のチェック
3. **型安全性向上**: より厳密な型定義の適用

### 監視・メトリクス
- ログイン成功率の監視
- ユーザーアイコン表示率の監視
- ローカルストレージエラーの監視

## 📚 関連ドキュメント

- [認証実装ガイド](../01_backend/implementation/auth-implementation.md)
- [フロントエンド仕様書](../02_frontend/specification.md)
- [エラーハンドリング実装規則](../06_standards/error-handling.md)
- [コーディング規約](../06_standards/coding-standards.md)

---

**実装完了基準**: 上記受入基準を全て満たし、手動テストで正常動作を確認できた段階で完了とする。