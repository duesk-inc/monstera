# 実装計画書: 経費申請API 401認証エラー修正

## 実装計画概要

- **計画作成日時**: 2025-07-24 17:35
- **計画作成者**: Claude Code
- **対象ブランチ**: fix/expense-401-error
- **関連Issue**: 新規作成予定
- **調査報告書**: `docs/investigate/investigate_20250724_172100.md`

## 実装方針

### 選択した解決策: 段階的アプローチ

調査結果に基づき、以下の2段階アプローチを採用します：

1. **フェーズ1（即時修正）**: 最小限の修正で401エラーを解消
2. **フェーズ2（技術的負債解消）**: expense.tsの全面的なリファクタリング

### 理由

- 即座にユーザーの問題を解決する必要がある
- 大規模な変更はリスクが高いため、段階的に実施
- 既存のテストコードへの影響を最小限に抑える

## 詳細実装タスク

### フェーズ1: 即時修正（優先度: 高）

#### タスク1: fetchRequestの修正
- **ファイル**: `/frontend/src/lib/api/expense.ts`
- **修正内容**:
  - localStorage参照を削除（176-182行目）
  - fetchオプションに`credentials: 'include'`を追加
  - 不要なAuthorizationヘッダー設定を削除

#### タスク2: uploadFile関数の修正
- **ファイル**: `/frontend/src/lib/api/expense.ts`
- **修正内容**:
  - localStorage参照を削除（308行目）
  - fetchオプションに`credentials: 'include'`を追加

#### タスク3: deleteUploadedFile関数の修正
- **ファイル**: `/frontend/src/lib/api/expense.ts`
- **修正内容**:
  - localStorage参照を削除（346行目）
  - fetchオプションに`credentials: 'include'`を追加

### フェーズ2: 技術的負債解消（優先度: 中）

#### タスク4: expense.tsのaxios移行
- **ファイル**: `/frontend/src/lib/api/expense.ts`
- **修正内容**:
  - `getAuthClient()`を使用するように全面書き換え
  - fetchベースの実装をaxiosベースに変更
  - エラーハンドリングの統一

#### タスク5: テストコードの更新
- **ファイル**: 
  - `/frontend/src/__tests__/expense/**/*.test.tsx`
  - `/frontend/src/__tests__/expense/utils/*.ts`
- **修正内容**:
  - モック実装の更新
  - テストヘルパーの調整

## ファイル変更計画

### 修正対象ファイル

1. **フェーズ1**:
   - `/frontend/src/lib/api/expense.ts` - fetchRequest、uploadFile、deleteUploadedFile関数の修正

2. **フェーズ2**:
   - `/frontend/src/lib/api/expense.ts` - 全面的な書き換え
   - `/frontend/src/__tests__/expense/**/*.test.tsx` - テストの更新（必要に応じて）

### 新規作成ファイル

なし

### 削除ファイル

なし

## テスト戦略

### フェーズ1のテスト

1. **手動テスト**:
   - 経費申請一覧ページの表示確認
   - 経費申請の作成・更新・削除の動作確認
   - ファイルアップロード機能の確認

2. **既存テストの実行**:
   ```bash
   cd frontend && npm run test -- src/__tests__/expense
   ```

3. **E2Eテスト**:
   - ログイン → 経費申請ページアクセス → 一覧表示の確認

### フェーズ2のテスト

1. **単体テスト**:
   - 新しいaxios実装のテスト追加
   - モックの更新

2. **統合テスト**:
   - hooks/expense/useExpenses.tsの動作確認
   - 他の関連コンポーネントとの統合確認

3. **リグレッションテスト**:
   - 全ての経費関連機能の動作確認

## リスク分析と対策

### リスク1: 他の認証方式への影響
- **影響度**: 低
- **対策**: Cookie認証は既にプロジェクト全体で使用されているため、影響は限定的

### リスク2: テストコードの破損
- **影響度**: 中
- **対策**: フェーズ1では最小限の変更に留め、フェーズ2で段階的に対応

### リスク3: アップロード機能の不具合
- **影響度**: 高
- **対策**: アップロード機能は特に慎重にテストし、問題があれば即座にロールバック

### リスク4: キャッシュの不整合
- **影響度**: 低
- **対策**: ブラウザキャッシュのクリアを推奨、必要に応じてキャッシュバスティング

## 実装スケジュール

### フェーズ1（即日実装）
1. fetchRequest関数の修正（30分）
2. uploadFile/deleteUploadedFile関数の修正（20分）
3. 手動テスト（30分）
4. コミット・PR作成（10分）

**合計**: 約1.5時間

### フェーズ2（後日実装）
1. axios移行の設計（1時間）
2. 実装（2時間）
3. テストコード更新（1時間）
4. 統合テスト（1時間）

**合計**: 約5時間

## 成功基準

### フェーズ1
- 経費申請ページで401エラーが発生しない
- 既存の全ての経費関連機能が正常に動作する
- 既存のテストが全てパスする

### フェーズ2
- expense.tsが他のAPIファイルと同じパターンで実装されている
- コードの保守性が向上している
- パフォーマンスが劣化していない

## 次のステップ

1. GitHub Issueの作成
2. フェーズ1の実装開始
3. PRレビュー・マージ
4. フェーズ2の計画詳細化（別Issue）

## 関連ドキュメント

- 調査報告書: `docs/investigate/investigate_20250724_172100.md`
- 前回の実装記録: `docs/implement/implement_20250724_162134.md`
- API設計規則: `docs/06_standards/api-design.md`

## 計画完了

計画作成者: Claude Code
計画完了時刻: 2025-07-24 17:35
ブランチ: fix/expense-401-error