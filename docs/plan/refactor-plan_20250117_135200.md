# APIクライアント リファクタリング実装計画書

**作成日時**: 2025-01-17 13:52
**計画対象**: frontend/src/lib/api ディレクトリ
**計画作成**: Claude Code (Refactor-Plan)
**推定総工数**: 18-26時間

## 1. リファクタリング概要

### 1.1 目的と期待効果

**目的**:
- APIクライアント実装の統一化
- 保守性とテスタビリティの向上
- 技術的負債の解消

**期待効果**:
- コード量30%削減
- 新規開発者のオンボーディング時間50%短縮
- バグ発生率40%低減

### 1.2 スコープ

**対象**:
- `/frontend/src/lib/api/` 配下の全ファイル
- `/frontend/src/lib/axios.ts`
- APIクライアントを使用する全コンポーネント

**対象外**:
- バックエンドAPI実装
- 認証ロジックの根本的な変更
- データベース構造

## 2. 実装計画（ToDoリスト形式）

### Phase 1: 環境変数と設定の統一（推定: 3時間）

#### Step 1.1: 環境変数の調査と整理（30分）
- [ ] 現在の環境変数使用状況を調査
  - `grep -r "NEXT_PUBLIC_API" frontend/`
  - 使用箇所のリストアップ
- [ ] docker-compose.ymlの環境変数を確認
- [ ] 本番環境の設定を確認（可能な範囲で）
- [ ] 環境変数マッピング表を作成

#### Step 1.2: .env.exampleの更新（15分）
- [ ] 新しい環境変数の追加
  ```
  NEXT_PUBLIC_API_HOST=http://localhost:8080
  NEXT_PUBLIC_API_VERSION=v1
  ```
- [ ] レガシー変数に非推奨コメントを追加
- [ ] READMEに移行ガイドを追記

#### Step 1.3: 環境変数読み込みロジックの実装（45分）
- [ ] `/lib/api/config/env.ts`を新規作成
- [ ] 環境変数の優先順位ロジックを実装
- [ ] デフォルト値の設定
- [ ] 単体テストを作成
- [ ] `npm test env.test.ts`で動作確認

#### Step 1.4: 既存コードの段階的移行（1時間）
- [ ] `/lib/api/client.ts`の環境変数参照を更新
- [ ] `/lib/api/index.ts`の環境変数参照を更新
- [ ] `/lib/api/config.ts`の環境変数参照を更新
- [ ] `npm run dev`で動作確認
- [ ] コンソールログで環境変数の読み込みを確認

#### Step 1.5: ドキュメント更新（30分）
- [ ] 環境変数設定ガイドを作成
- [ ] トラブルシューティングガイドを追加
- [ ] チーム向け移行手順書を作成

### Phase 2: インポートパス統一（推定: 5時間）

#### Step 2.1: 現状のインポートパス調査（30分）
- [ ] インポートパターンの全リストアップ
  ```bash
  grep -r "from '@/lib/axios'" frontend/src/
  grep -r "from '@/lib/api" frontend/src/
  ```
- [ ] 影響ファイル数のカウント
- [ ] インポートマップを作成

#### Step 2.2: 統一APIエクスポートファイルの作成（1時間）
- [ ] `/lib/api/index.ts`を統一エントリポイントに改修
- [ ] 必要な全エクスポートを集約
- [ ] 型定義のエクスポートも含める
- [ ] JSDOCコメントで使用方法を記載

#### Step 2.3: テストファイルの準備（1時間）
- [ ] 主要なAPIコール箇所のE2Eテストを作成
- [ ] モックサーバーの設定
- [ ] テストケースの実行確認
  ```bash
  npm run test:e2e -- --grep "api-client"
  ```

#### Step 2.4: 一括置換スクリプトの作成と実行（1.5時間）
- [ ] 置換スクリプト`scripts/unify-imports.js`を作成
- [ ] ドライラン機能を実装
- [ ] バックアップ作成機能を追加
- [ ] スクリプトをドライランモードで実行
- [ ] 変更内容を確認
- [ ] 本番実行
  ```bash
  node scripts/unify-imports.js --dry-run
  node scripts/unify-imports.js --execute
  ```

#### Step 2.5: 動作確認とテスト（1時間）
- [ ] `npm run dev`で開発サーバー起動
- [ ] 主要な画面の動作確認
  - ログイン画面
  - ダッシュボード
  - 週報画面
  - 経費申請画面
- [ ] `npm run test`で単体テスト実行
- [ ] `npm run test:e2e`でE2Eテスト実行
- [ ] エラーログの確認

### Phase 3: ファクトリパターン統合（推定: 8時間）

#### Step 3.1: ファクトリパターンの設計（1時間）
- [ ] 現在の3つの実装パターンを分析
- [ ] 統合後のアーキテクチャ図を作成
- [ ] インターフェース定義を作成
- [ ] 設計レビュー用ドキュメント作成

#### Step 3.2: 統合ファクトリの実装（2時間）
- [ ] `/lib/api/factory/index.ts`を新規作成
- [ ] シングルトンパターンの実装
- [ ] キャッシング機構の実装
- [ ] 環境別クライアント生成ロジック
- [ ] 単体テストの作成

#### Step 3.3: インターセプターの統合（2時間）
- [ ] 認証インターセプターの統合
- [ ] エラーハンドリングインターセプターの統合
- [ ] ロギングインターセプターの統合
- [ ] リトライインターセプターの統合
- [ ] インターセプターの実行順序を定義
- [ ] 重複防止ロジックの実装

#### Step 3.4: 既存コードの移行（2時間）
- [ ] `/lib/api/client.ts`を新ファクトリ使用に更新
- [ ] `/lib/api/index.ts`から重複コードを削除
- [ ] `/lib/api/config.ts`を非推奨マーク
- [ ] 各API実装ファイルを新クライアント使用に更新
  - [ ] workHistory.ts
  - [ ] weeklyReport.ts
  - [ ] expense.ts
  - [ ] skillSheet.ts
  - [ ] notification.ts

#### Step 3.5: 互換性レイヤーの実装（1時間）
- [ ] 既存のAPIを維持する互換性レイヤーを作成
- [ ] 非推奨警告の実装
- [ ] 移行期間の設定（3ヶ月）
- [ ] 移行ガイドの作成

### Phase 4: 不要コード削除とクリーンアップ（推定: 2時間）

#### Step 4.1: 削除対象の特定（30分）
- [ ] 使用されていないファイルの特定
  - `/lib/axios.ts`
  - `/lib/api/config.ts`（互換性レイヤー経由）
- [ ] 未使用のインポートを検出
- [ ] デッドコードの検出

#### Step 4.2: 段階的削除（1時間）
- [ ] `/lib/axios.ts`を削除
- [ ] 旧設定ファイルを削除
- [ ] 未使用のユーティリティ関数を削除
- [ ] コメントアウトされたコードを削除
- [ ] 各削除後に`npm run build`で確認

#### Step 4.3: 最終クリーンアップ（30分）
- [ ] ESLintの実行と修正
  ```bash
  npm run lint -- --fix
  ```
- [ ] Prettierの実行
  ```bash
  npm run format
  ```
- [ ] import順序の整理
- [ ] 不要なconsole.logの削除

## 3. テスト戦略

### 3.1 単体テスト
```bash
# 各Phaseごとに実行
npm run test -- --watch
```

**テストケース**:
- [ ] 環境変数の読み込みテスト
- [ ] APIクライアント生成テスト
- [ ] インターセプター動作テスト
- [ ] エラーハンドリングテスト
- [ ] リトライ機能テスト

### 3.2 統合テスト
```bash
# Phase完了ごとに実行
npm run test:integration
```

**テストシナリオ**:
- [ ] 認証フロー全体
- [ ] APIコール→エラー→リトライ
- [ ] 401エラー→トークンリフレッシュ→再試行

### 3.3 E2Eテスト
```bash
# 全Phase完了後に実行
npm run test:e2e
```

**重要な画面フロー**:
- [ ] ログイン→ダッシュボード表示
- [ ] 週報の作成・編集・削除
- [ ] 経費申請の全フロー
- [ ] エラー発生時の挙動

### 3.4 パフォーマンステスト
- [ ] APIレスポンス時間の計測
- [ ] メモリ使用量の確認
- [ ] バンドルサイズの確認

## 4. ロールバック計画

### 4.1 Phase単位のロールバック

#### Phase 1のロールバック（5分）
```bash
# 環境変数を元に戻す
git checkout -- frontend/.env.example
git checkout -- frontend/src/lib/api/config/env.ts
npm run dev  # 動作確認
```

#### Phase 2のロールバック（10分）
```bash
# インポートパスを元に戻す
git checkout -- frontend/src/**/*.ts frontend/src/**/*.tsx
npm run dev  # 動作確認
```

#### Phase 3のロールバック（15分）
```bash
# ファクトリパターン変更を元に戻す
git checkout -- frontend/src/lib/api/
npm run build  # ビルド確認
npm run dev    # 動作確認
```

#### Phase 4のロールバック（5分）
```bash
# 削除したファイルを復元
git checkout -- frontend/src/lib/axios.ts
git checkout -- frontend/src/lib/api/config.ts
```

### 4.2 完全ロールバック手順
```bash
# 全変更を破棄
git stash
git checkout main
git pull origin main

# または特定のコミットに戻る
git reset --hard <commit-hash>

# 依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# 動作確認
npm run dev
```

## 5. リスク管理

### 5.1 技術的リスクと対策

| リスク | 可能性 | 影響度 | 対策 | 検知方法 |
|--------|--------|--------|------|----------|
| 認証フローの破損 | 中 | 高 | 段階的移行、E2Eテスト | ログイン失敗率監視 |
| APIコールのタイムアウト | 低 | 中 | タイムアウト値の調整 | APMツール |
| インターセプター重複 | 中 | 低 | 重複チェックロジック | デバッグログ |
| 環境変数の誤設定 | 高 | 中 | バリデーション実装 | 起動時チェック |

### 5.2 スケジュールリスク

**バッファ時間の確保**:
- 各Phase: +20%のバッファ
- 全体: +2日間の予備日

**並行作業の考慮**:
- 他チームメンバーの作業とのコンフリクト回避
- マージタイミングの調整

## 6. 成功指標と検証方法

### 6.1 定量的指標

| 指標 | 現状 | 目標 | 測定方法 |
|------|------|------|----------|
| コード行数 | 1,500行 | 1,050行 | `cloc`コマンド |
| 重複コード率 | 25% | 5% | SonarQube |
| テストカバレッジ | 45% | 80% | Jest coverage |
| ビルド時間 | 45秒 | 30秒 | CI/CDログ |
| バンドルサイズ | 450KB | 400KB | webpack-bundle-analyzer |

### 6.2 定性的指標

- [ ] コードレビュー時間が短縮されたか
- [ ] 新規開発者が理解しやすくなったか
- [ ] バグ報告が減少したか
- [ ] 開発速度が向上したか

## 7. タイムライン

### Week 1（Phase 1 & 2）
- Day 1: Phase 1完了（環境変数統一）
- Day 2-3: Phase 2実施（インポートパス統一）
- Day 4: Phase 2のテストと修正
- Day 5: コードレビューと調整

### Week 2（Phase 3 & 4）
- Day 1-3: Phase 3実施（ファクトリパターン統合）
- Day 4: Phase 4実施（クリーンアップ）
- Day 5: 総合テストとドキュメント更新

### Week 3（最終調整）
- Day 1-2: パフォーマンステスト
- Day 3: 本番環境デプロイ準備
- Day 4: 段階的デプロイ
- Day 5: 監視とフォローアップ

## 8. コミュニケーション計画

### 8.1 ステークホルダーへの連絡

**Phase開始前**:
- [ ] チームへの事前通知（Slack）
- [ ] 作業時間帯の共有
- [ ] 影響範囲の説明

**Phase完了後**:
- [ ] 完了報告
- [ ] 変更内容のサマリー
- [ ] 次Phaseの予告

### 8.2 ドキュメント更新

- [ ] README.mdの更新
- [ ] API使用ガイドの作成
- [ ] トラブルシューティングガイド
- [ ] 移行ガイド

## 9. 次のステップ

1. **この計画書のレビューと承認**
   - チームメンバーとの共有
   - フィードバックの収集
   - 計画の調整

2. **Phase 1の実装開始**
   - `refactor-implement`コマンドの実行
   - Step 1.1から順次実施

3. **進捗の追跡**
   - 日次スタンドアップでの報告
   - 問題発生時の即座のエスカレーション

---

**計画作成者**: Claude Code
**承認者**: （未承認）
**最終更新**: 2025-01-17 13:52