# APIクライアント最適化リファクタリング計画

**計画作成日時**: 2025-08-17 20:42:07  
**対象**: Monstera Frontend APIクライアント  
**フェーズ**: Phase 4 - 最適化リファクタリング

## エグゼクティブサマリー

Phase 3で実装した統合ファクトリパターンを基盤として、以下の3つの主要課題を解決する段階的なリファクタリングを実施します：

1. **APIクライアント生成の重複** - 5ファイルで異なる実装を統一
2. **設定の分散** - withCredentials設定を単一箇所に集約
3. **エラーハンドリングの非一貫性** - 統一エラー処理パターンの実装

## リファクタリング ToDo リスト

### Phase 4-1: 設定の集約（所要時間: 2時間）

#### ステップ 1.1: 統一設定モジュールの作成
- [ ] `/lib/api/config/unified.ts`を作成
- [ ] デフォルト設定を一元管理する`DEFAULT_API_CONFIG`を定義
- [ ] 環境別設定のオーバーライド機能を実装
- **テスト方法**: `npm run dev`で起動し、開発者ツールのNetworkタブでwithCredentialsが設定されていることを確認

#### ステップ 1.2: withCredentials設定の統一
- [ ] `/lib/api/factory/index.ts`の設定を統一設定から参照に変更
- [ ] `/lib/api/config.ts`の設定を統一設定から参照に変更
- [ ] `/lib/api/auth/index.ts`の4箇所の設定を統一設定から参照に変更
- **テスト方法**: 各ファイルでimportが正しく、設定が適用されることを確認

#### ステップ 1.3: タイムアウト設定の統一
- [ ] 全APIクライアントのタイムアウト設定を統一
- [ ] 環境変数`NEXT_PUBLIC_API_TIMEOUT`のサポート追加
- **テスト方法**: 環境変数を設定して、タイムアウトが反映されることを確認

### Phase 4-2: APIクライアント生成の統一（所要時間: 3時間）

#### ステップ 2.1: createApiClient使用箇所の調査
- [ ] 全ての`createApiClient`呼び出し箇所をリストアップ
- [ ] 各呼び出しのパラメータパターンを分析
- [ ] 統一可能な共通パラメータを特定
- **テスト方法**: grepコマンドで全使用箇所が特定されることを確認

#### ステップ 2.2: 統一ファクトリメソッドの強化
- [ ] `UnifiedApiFactory.createClient()`にプリセットタイプを追加
- [ ] 認証用、管理者用、公開用のプリセット定義
- [ ] 既存の5ファイルの実装をプリセットに移行
- **テスト方法**: 各プリセットタイプで正しいヘッダーが設定されることを確認

#### ステップ 2.3: 既存実装の段階的移行
- [ ] `/lib/api/auth/index.ts`の4箇所を統一ファクトリに移行
- [ ] 移行後の動作確認（ログイン、ログアウト、トークンリフレッシュ）
- [ ] 不要になったcreateApiClient呼び出しの削除
- **テスト方法**: 認証フローが正常に動作することを確認

#### ステップ 2.4: 型定義の統一
- [ ] `ApiClientConfig`型を拡張してプリセットタイプを含める
- [ ] ジェネリクスを使用した型安全性の向上
- **テスト方法**: TypeScriptのコンパイルエラーがないことを確認

### Phase 4-3: エラーハンドリングの標準化（所要時間: 4時間）

#### ステップ 3.1: 統一エラーレスポンス型の定義
- [ ] `/lib/api/types/error.ts`を作成
- [ ] `StandardErrorResponse`インターフェースの定義
- [ ] エラーコードの列挙型定義
- **テスト方法**: 型定義がコンパイルエラーなしで使用できることを確認

#### ステップ 3.2: グローバルエラーハンドラーの実装
- [ ] `/lib/api/error/handler.ts`を作成
- [ ] 統一エラー処理関数`handleApiError`の拡張
- [ ] エラー種別に応じた処理の分岐実装
- **テスト方法**: 各種エラー（401, 403, 404, 500）で適切な処理が実行されることを確認

#### ステップ 3.3: エラーインターセプターの統一
- [ ] レスポンスインターセプターでの統一エラー処理実装
- [ ] 既存の個別エラー処理を統一ハンドラーに移行
- [ ] エラーログの構造化
- **テスト方法**: APIエラー時に統一されたエラーメッセージが表示されることを確認

#### ステップ 3.4: 既存APIモジュールの移行
- [ ] `/lib/api/user.ts`のエラー処理を統一パターンに移行
- [ ] `/lib/api/expense.ts`のエラー処理を統一パターンに移行
- [ ] `/lib/api/weeklyReport.ts`のエラー処理を統一パターンに移行
- [ ] 他の13ファイルも順次移行
- **テスト方法**: 各APIでエラー時に統一フォーマットのレスポンスが返ることを確認

### Phase 4-4: パフォーマンス最適化（所要時間: 2時間）

#### ステップ 4.1: インターセプターチェーンの最適化
- [ ] 重複インターセプターの検出と削除
- [ ] インターセプター実行順序の最適化
- [ ] 不要なインターセプターの条件付き登録
- **テスト方法**: Chrome DevToolsでAPIリクエストの処理時間が10ms以内であることを確認

#### ステップ 4.2: キャッシュ戦略の調整
- [ ] キャッシュヒット率のメトリクス実装
- [ ] LRUキャッシュサイズの動的調整
- [ ] キャッシュ無効化戦略の実装
- **テスト方法**: 同一APIへの連続リクエストでキャッシュが使用されることを確認

#### ステップ 4.3: バンドルサイズの最適化
- [ ] 未使用エクスポートの削除
- [ ] 動的インポートの活用
- [ ] Tree-shakingの最適化
- **テスト方法**: `npm run build`でバンドルサイズが削減されることを確認

### Phase 4-5: テストとドキュメント（所要時間: 3時間）

#### ステップ 5.1: ユニットテストの作成
- [ ] 統一設定モジュールのテスト作成
- [ ] ファクトリパターンのテスト作成
- [ ] エラーハンドラーのテスト作成
- **テスト方法**: `npm test`で全テストがパスすることを確認

#### ステップ 5.2: 統合テストの作成
- [ ] 認証フローの統合テスト
- [ ] エラー処理フローの統合テスト
- [ ] キャッシュ機能の統合テスト
- **テスト方法**: `npm run test:integration`で統合テストがパスすることを確認

#### ステップ 5.3: 移行ガイドの作成
- [ ] 開発者向け移行ガイドの作成
- [ ] APIクライアント使用のベストプラクティス文書化
- [ ] トラブルシューティングガイドの作成
- **テスト方法**: ドキュメントレビューで内容の正確性を確認

## リスク評価と対策

### 技術的リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 既存APIの破損 | 高 | 低 | 段階的移行、後方互換性維持 |
| パフォーマンス劣化 | 中 | 低 | ベンチマークテスト実施 |
| 型定義の不整合 | 低 | 中 | strictモード有効化、型テスト |

### ビジネスリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| サービス停止 | 高 | 極低 | Feature Flagによる段階的ロールアウト |
| 開発遅延 | 中 | 低 | バッファ時間の確保 |

## 実装スケジュール

| フェーズ | 作業内容 | 所要時間 | 開始条件 |
|---------|----------|----------|----------|
| 4-1 | 設定の集約 | 2時間 | 即座に開始可能 |
| 4-2 | APIクライアント生成の統一 | 3時間 | 4-1完了後 |
| 4-3 | エラーハンドリングの標準化 | 4時間 | 4-2完了後 |
| 4-4 | パフォーマンス最適化 | 2時間 | 4-3完了後 |
| 4-5 | テストとドキュメント | 3時間 | 4-4完了後 |

**総所要時間**: 14時間（約2営業日）

## 成功指標

1. **コード品質**
   - 重複コード削減率: 80%以上
   - 型カバレッジ: 95%以上
   - テストカバレッジ: 85%以上

2. **パフォーマンス**
   - APIレスポンス時間: 10%改善
   - バンドルサイズ: 5%削減
   - キャッシュヒット率: 90%以上

3. **保守性**
   - 新規API追加時間: 50%削減
   - バグ修正時間: 30%削減
   - コードレビュー時間: 20%削減

## 移行チェックリスト

### 移行前の準備
- [ ] 現在のコードベースのバックアップ
- [ ] 本番環境のメトリクス記録
- [ ] ステークホルダーへの通知

### 移行中の確認
- [ ] 各ステップでのテスト実行
- [ ] パフォーマンスメトリクスの監視
- [ ] エラーログの監視

### 移行後の検証
- [ ] 全機能の動作確認
- [ ] パフォーマンス改善の測定
- [ ] ドキュメントの最終確認

## 次のステップ

1. **即座に実施可能**: Phase 4-1（設定の集約）から開始
2. **レビュー**: この計画をチームでレビュー
3. **承認**: ステークホルダーの承認取得
4. **実装開始**: ToDoリストに従って段階的に実装

---

**計画完了時刻**: 2025-08-17 20:42:07  
**ファイル**: `docs/plan/refactor-plan_20250817_204207.md`