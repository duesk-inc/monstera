# 実装計画書：ウイルススキャンエラーおよびバリデーションエラーの修正

## 計画概要
- **計画日時**: 2025-07-26 00:10:00
- **計画者**: Claude
- **対象機能**: 経費申請の領収書アップロードおよび申請作成
- **対象ブランチ**: fix/receipt-upload-s3key-error（既存ブランチで継続）
- **調査報告書**: [investigate_20250726_000000.md](../investigate/investigate_20250726_000000.md)

## 実装方針

### 1. バリデーションエラーの修正（高優先度）
フロントエンドで事前バリデーションを実装し、descriptionフィールドの最小文字数（10文字）を満たすようにする。

### 2. ウイルススキャンエラーの修正（中優先度）
開発環境でウイルススキャンを無効化できるよう、環境変数での制御を実装する。

## 実装タスク

### Phase 1: バリデーションエラーの修正（優先度: 高）

#### タスク1.1: ExpenseFormコンポーネントの修正
- **ファイル**: `/frontend/src/components/features/expense/ExpenseForm.tsx`
- **内容**:
  - descriptionフィールドにバリデーションロジックを追加
  - 文字数カウンターの表示
  - エラーメッセージの表示
  - 送信ボタンの無効化制御

#### タスク1.2: バリデーションメッセージの定義
- **ファイル**: `/frontend/src/constants/validation.ts`（新規作成）
- **内容**:
  - エラーメッセージの定数定義
  - バリデーションルールの定数定義

#### タスク1.3: 単体テストの追加
- **ファイル**: `/frontend/src/__tests__/expense/components/ExpenseForm.test.tsx`
- **内容**:
  - バリデーション機能のテストケース追加
  - エラー表示のテストケース追加

### Phase 2: ウイルススキャンエラーの修正（優先度: 中）

#### タスク2.1: main.goの修正
- **ファイル**: `/backend/cmd/server/main.go`
- **内容**:
  - 環境変数`DISABLE_VIRUS_SCAN`のチェック追加
  - 条件付きでウイルススキャンサービスの初期化
  - nilチェックの追加

#### タスク2.2: 環境変数の追加
- **ファイル**: `/backend/.env.example`
- **内容**:
  - `DISABLE_VIRUS_SCAN=true`のサンプル追加
  - コメントで使用方法を説明

#### タスク2.3: MockVirusScanServiceの実装
- **ファイル**: `/backend/internal/service/mock_virus_scan_service.go`（新規作成）
- **内容**:
  - 開発環境用のモックサービス実装
  - 常に"clean"を返す実装
  - ログ出力でモック使用を明示

#### タスク2.4: 統合テストの追加
- **ファイル**: `/backend/internal/service/expense_service_test.go`
- **内容**:
  - ウイルススキャンが無効の場合のテスト
  - モックサービスの動作確認テスト

## ファイル変更計画

### 修正するファイル
1. `/frontend/src/components/features/expense/ExpenseForm.tsx`
   - バリデーションロジックの追加
   - UI要素の追加（文字数カウンター、エラーメッセージ）

2. `/backend/cmd/server/main.go`
   - 環境変数チェックの追加
   - 条件付きサービス初期化

3. `/backend/.env.example`
   - 新しい環境変数の追加

4. `/frontend/src/__tests__/expense/components/ExpenseForm.test.tsx`
   - テストケースの追加

5. `/backend/internal/service/expense_service_test.go`
   - テストケースの追加

### 新規作成するファイル
1. `/frontend/src/constants/validation.ts`
   - バリデーション関連の定数定義

2. `/backend/internal/service/mock_virus_scan_service.go`
   - モックサービスの実装

## テスト戦略

### 単体テスト
1. **フロントエンド**
   - ExpenseFormのバリデーション機能
   - エラーメッセージの表示
   - 文字数カウンターの動作
   - 送信ボタンの有効/無効切り替え

2. **バックエンド**
   - MockVirusScanServiceの動作
   - 環境変数による切り替え

### 統合テスト
1. **API統合テスト**
   - バリデーションエラー時のレスポンス確認
   - ウイルススキャン無効時の動作確認

### E2Eテスト
1. **経費申請フロー**
   - descriptionフィールドのバリデーション動作
   - 正常な申請作成フロー

## リスク分析と対策

### リスク1: 既存テストへの影響
- **リスク**: バリデーション追加により既存のテストが失敗する可能性
- **対策**: 
  - 既存テストの修正を同時に実施
  - テストデータを10文字以上に更新

### リスク2: 環境変数の設定ミス
- **リスク**: 本番環境でウイルススキャンが無効化される可能性
- **対策**:
  - デフォルトは有効（環境変数が明示的に設定された場合のみ無効）
  - 起動時のログで状態を明示
  - ドキュメントに注意事項を記載

### リスク3: ユーザビリティの低下
- **リスク**: 10文字制限により使いづらくなる可能性
- **対策**:
  - 文字数カウンターでユーザーをガイド
  - 適切なプレースホルダーテキスト
  - わかりやすいエラーメッセージ

## 実装スケジュール

### Day 1（高優先度）
- タスク1.1〜1.3: バリデーションエラーの修正

### Day 2（中優先度）
- タスク2.1〜2.4: ウイルススキャンエラーの修正

### Day 3（テスト・調整）
- 全体の動作確認
- ドキュメント更新

## 成功基準

1. **バリデーションエラーの解消**
   - descriptionが10文字未満の場合、フォーム送信前にエラー表示
   - ユーザーフレンドリーなエラーメッセージ
   - 送信ボタンの適切な制御

2. **ウイルススキャンエラーの解消**
   - 開発環境でエラーログが出力されない
   - 環境変数による制御が正常に動作
   - 本番環境への影響がない

## 参考資料
- [調査報告書](../investigate/investigate_20250726_000000.md)
- [エラーハンドリング実装規則](../06_standards/error-handling.md)
- [コーディング規約](../06_standards/coding-standards.md)

## 次のステップ
実装フェーズ（IMPLEMENT）への移行