# 週報提出時の型変換エラー修正実装計画

## 計画作成日時
2025-07-12 14:58:55

## 概要
週報提出時（POST /api/v1/weekly-reports）および更新時（PUT /api/v1/weekly-reports/:id）に発生する型変換エラーを修正する実装計画。

## 調査結果サマリー
- **問題**: Gin Contextに格納された "role" が `*model.Role` 型だが、文字列として扱おうとしてエラー発生
- **影響範囲**: 週報の作成・更新機能が利用不可
- **根本原因**: 認証ミドルウェアで設定される型とハンドラーで期待する型の不一致

## 実装方針

### 1. 短期的対応（今回実装）
週報ハンドラーの型変換処理を修正し、`*model.Role` 型に対応する安全な型変換を実装。

### 2. 中長期的対応（将来の改善案）
- システム全体で一貫した型の使用
- ロール情報取得のヘルパー関数実装
- 他のハンドラーの型アサーションチェック

## 詳細実装タスク

### タスク1: weekly_report_handler.goの修正【優先度: 高】
**作業内容**:
1. Create メソッド（81行目付近）の型変換修正
2. Update メソッド（306行目付近）の型変換修正
3. 型安全な変換ロジックの実装

**実装詳細**:
```go
// ユーザーロールの文字列表現を取得する共通処理
var userRoleStr string
if userRole != nil {
    switch v := userRole.(type) {
    case string:
        userRoleStr = v
    case *model.Role:
        if v != nil {
            userRoleStr = v.String()
        } else {
            userRoleStr = "unknown"
        }
    default:
        userRoleStr = "unknown"
    }
} else {
    userRoleStr = "unknown"
}
```

**所要時間**: 30分

### タスク2: 単体テストの追加【優先度: 高】
**作業内容**:
1. 型変換処理のテストケース作成
2. string型、*model.Role型、nil値のパターンをカバー
3. 既存テストへの影響確認

**テストケース**:
- 文字列型のロールが正しく処理される
- *model.Role型のロールが正しく文字列に変換される
- nilの場合に "unknown" が設定される
- 想定外の型の場合に "unknown" が設定される

**所要時間**: 45分

### タスク3: 手動動作確認【優先度: 高】
**作業内容**:
1. ローカル環境での週報作成機能の動作確認
2. 週報更新機能の動作確認
3. デバッグログの出力確認

**確認項目**:
- 週報作成APIが正常に動作すること
- 週報更新APIが正常に動作すること
- デバッグログにロール情報が正しく記録されること
- エラーログが出力されないこと

**所要時間**: 30分

### タスク4: リグレッションテストの実施【優先度: 中】
**作業内容**:
1. 既存の週報関連テストの実行
2. 認証関連機能への影響確認
3. 他のデバッグログ使用箇所の動作確認

**所要時間**: 20分

## ファイル変更計画

### 修正対象ファイル
1. **backend/internal/handler/weekly_report_handler.go**
   - 81行目付近: Create メソッドの型変換処理
   - 306行目付近: Update メソッドの型変換処理

### 新規作成ファイル（オプション）
1. **backend/internal/handler/weekly_report_handler_test.go**
   - ハンドラーレベルの単体テスト（必要に応じて）

## テスト戦略

### 1. 単体テスト
- **対象**: 型変換ロジック
- **ツール**: Go標準のtesting パッケージ
- **カバレッジ目標**: 新規追加コードの100%

### 2. 統合テスト
- **対象**: 週報作成・更新API
- **方法**: HTTPテストクライアントを使用
- **環境**: Docker環境でのテスト実行

### 3. 手動テスト
- **対象**: UI経由での週報作成・更新
- **環境**: ローカル開発環境
- **確認項目**: エラーなく動作すること

## リスク分析と対策

### リスク1: 他のハンドラーで同様のエラー
**可能性**: 中
**影響度**: 高
**対策**: 
- 今回の修正を確認後、他のハンドラーをGrep検索
- 同様のパターンがあれば追加修正を検討

### リスク2: 型変換ロジックの複雑化
**可能性**: 低
**影響度**: 低
**対策**: 
- シンプルな実装を心がける
- コメントで意図を明確化
- 将来的にヘルパー関数への移行を検討

### リスク3: パフォーマンスへの影響
**可能性**: 極低
**影響度**: 極低
**対策**: 
- 型チェックは軽量な処理のため影響なし
- 念のためレスポンスタイムを確認

## 実装スケジュール

1. **Phase 1: コード修正** (30分)
   - weekly_report_handler.go の2箇所を修正

2. **Phase 2: テスト実装** (45分)
   - 単体テストの追加
   - 既存テストの実行

3. **Phase 3: 動作確認** (30分)
   - ローカル環境での手動テスト
   - デバッグログの確認

4. **Phase 4: 最終確認** (20分)
   - リグレッションテスト
   - コードレビュー準備

**総所要時間**: 約2時間5分

## 成功基準

1. 週報作成APIが正常に動作する
2. 週報更新APIが正常に動作する
3. 型変換エラーが発生しない
4. 全テストがパスする
5. デバッグログに正しいロール情報が記録される

## 次のステップ

1. 実装フェーズへ移行
2. コード修正の実施
3. テストの追加と実行
4. 動作確認
5. プルリクエストの作成

## 関連ドキュメント
- 調査結果: `/docs/investigate/investigate_20250712_143844.md`
- 週報基本設計: `/docs/05_design/weekly-report-basic-design.md`
- エラーハンドリング規則: `/docs/06_standards/error-handling.md`