# バグ修正計画書 - 経費一覧画面のNETWORK_ERROR（401誤報告）

## 実行日時
2025-08-21 01:00

## 概要

### バグの影響度と緊急度
- **影響度**: 高（全ユーザーに影響）
- **緊急度**: 高（認証機能に関わる重要バグ）
- **発生頻度**: 間欠的（認証トークン送信失敗時）

### 修正の目的と期待効果
- 401認証エラーを正しく処理し、適切なエラーメッセージを表示
- ユーザーに混乱を与える500エラーの誤表示を解消
- 認証エラー時の適切な再ログイン誘導を実現

### スコープ
- フロントエンドのエラーハンドリング修正
- 認証トークン送信の一貫性改善
- 関連するテストケースの追加

## 現状分析

### 根本原因の要約
1. **直接的原因**: `frontend/src/lib/api/error/handler.ts:166-173`で、その他のエラーを一律500として処理
2. **間接的原因**: 認証トークンが正しく送信されない場合がある
3. **構造的問題**: エラーハンドリングがHTTPステータスコードを適切に保持していない

### 影響範囲の詳細
- **影響を受ける機能**:
  - 経費一覧画面（/expenses）
  - 経費カテゴリドロップダウン
  - 経費申請フォーム
  - その他の認証が必要な全API呼び出し

- **影響を受けるファイル**:
  - `frontend/src/lib/api/error/handler.ts`
  - `frontend/src/lib/api/expense.ts`
  - その他APIクライアントを使用する全ファイル

### 現在の回避策
なし（ユーザーは手動でページをリロードする必要がある）

## 修正計画（細分化された実装ステップ）

### Phase 1: 緊急対応（ホットフィックス）- 合計1時間

#### Step 1.1: エラー再現テストケースの作成（15分）
```typescript
// frontend/src/lib/api/error/__tests__/handler.test.ts
describe('convertToStandardError', () => {
  it('should handle 401 error correctly', () => {
    const axiosError = {
      response: {
        status: 401,
        data: { message: 'Unauthorized' }
      }
    };
    const result = handler.convertToStandardError(axiosError);
    expect(result.status).toBe(401);
    expect(result.error.code).toBe(ApiErrorCode.UNAUTHORIZED);
  });
});
```

#### Step 1.2: 暫定的な修正の実装（30分）
**修正箇所**: `frontend/src/lib/api/error/handler.ts:101-174`

```typescript
private convertToStandardError(error: AxiosError): StandardErrorResponse {
  // レスポンスがある場合
  if (error.response) {
    const response = error.response as AxiosResponse;
    
    // 既に標準エラーレスポンス形式の場合
    if (isStandardErrorResponse(response.data)) {
      return response.data;
    }
    
    // HTTPステータスコードからエラーコードを取得
    const errorCode = getErrorCodeFromStatus(response.status);
    const message = this.extractErrorMessage(response) || getErrorMessage(errorCode);
    
    return createErrorResponse(
      errorCode,
      message,
      response.status,  // 元のステータスコードを保持
      {
        originalError: response.data,
        url: error.config?.url,
        method: error.config?.method,
      }
    );
  }
  
  // ネットワークエラーの場合
  if (error.code === 'ERR_NETWORK') {
    return createErrorResponse(
      ApiErrorCode.NETWORK_ERROR,
      'ネットワークエラーが発生しました。接続を確認してください。',
      0,
      {
        originalError: error.message,
        url: error.config?.url,
      }
    );
  }
  
  // タイムアウトの場合
  if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {
    return createErrorResponse(
      ApiErrorCode.TIMEOUT,
      'リクエストがタイムアウトしました。',
      504,
      {
        timeout: error.config?.timeout,
        url: error.config?.url,
      }
    );
  }
  
  // キャンセルされた場合
  if (error.code === 'ERR_CANCELED') {
    return createErrorResponse(
      ApiErrorCode.CANCELLED,
      'リクエストがキャンセルされました。',
      0,
      {
        url: error.config?.url,
      }
    );
  }
  
  // その他のエラー（ステータスコードを保持）
  const statusCode = error.response?.status || 0;
  const errorCode = statusCode > 0 ? getErrorCodeFromStatus(statusCode) : ApiErrorCode.UNKNOWN_ERROR;
  
  return createErrorResponse(
    errorCode,
    error.message || '予期しないエラーが発生しました。',
    statusCode,  // 0または実際のステータスコード
    {
      originalError: error,
      url: error.config?.url,
    }
  );
}
```

#### Step 1.3: 影響範囲の限定的テスト（15分）
```bash
# 単体テスト実行
npm test -- handler.test.ts

# 経費関連のテスト実行
npm test -- expense

# 開発サーバーで動作確認
npm run dev
# ブラウザで /expenses にアクセスして確認
```

### Phase 2: 根本修正 - 合計1時間15分

#### Step 2.1: 詳細な影響調査（20分）
```bash
# エラーハンドラーを使用している箇所を検索
grep -r "handleApiError\|GlobalApiErrorHandler" frontend/src/

# convertToStandardErrorの参照箇所を確認
grep -r "convertToStandardError" frontend/src/
```

#### Step 2.2: 修正対象ファイルのバックアップ（5分）
```bash
# 現在の状態をコミット
git add -A
git commit -m "chore: backup before error handler fix"
```

#### Step 2.3: コア修正の実装（30分）
1. エラーハンドラーの完全な修正
2. 認証エラー時の特別処理追加
3. ログ出力の改善

#### Step 2.4: 関連箇所の修正（各10分）
1. `frontend/src/lib/api/expense.ts` - エラーハンドリング改善
2. `frontend/src/hooks/expense/useCategories.ts` - エラー処理の確認
3. その他影響を受けるファイル

### Phase 3: 予防措置 - 合計1時間5分

#### Step 3.1: 入力検証の強化（20分）
- Axiosエラーの型チェック強化
- レスポンスの存在確認
- ステータスコードの妥当性検証

#### Step 3.2: エラーメッセージの改善（10分）
```typescript
// より具体的なエラーメッセージ
const ERROR_MESSAGES = {
  401: '認証の有効期限が切れました。再度ログインしてください。',
  403: 'このリソースへのアクセス権限がありません。',
  404: '要求されたリソースが見つかりません。',
  500: 'サーバーエラーが発生しました。しばらく時間をおいて再度お試しください。',
};
```

#### Step 3.3: 同様パターンの検索（15分）
```bash
# 固定の500エラーを返している箇所を検索
grep -r "status.*500\|500.*status" frontend/src/

# エラーハンドリングパターンを確認
grep -r "catch.*error" frontend/src/lib/api/
```

#### Step 3.4: 予防的修正（各箇所10分）
発見された問題箇所を個別に修正

## テスト計画（段階的実行）

### Step T1: 単体テスト追加（20分）
```typescript
// 追加するテストケース
- 401エラーの処理
- 403エラーの処理
- 404エラーの処理
- 500エラーの処理
- ネットワークエラーの処理
- タイムアウトエラーの処理
```

### Step T2: 統合テスト（15分）
```typescript
// 経費カテゴリ取得のテスト
- 認証成功時のカテゴリ取得
- 認証失敗時のエラー処理
- ネットワークエラー時の処理
```

### Step T3: リグレッションテスト（10分）
```bash
# 全テストスイートの実行
npm test

# E2Eテスト（存在する場合）
npm run test:e2e
```

## リスク管理

### 技術的リスク
- **リスクレベル**: 中
- **内容**: エラーハンドラーは多くの箇所で使用されており、修正による予期しない影響の可能性
- **緩和策**: 
  - 段階的な修正実施
  - 十分なテストカバレッジ
  - デバッグログによる動作確認

### 影響範囲のリスク
- **リスクレベル**: 低
- **内容**: 修正は主にエラー処理部分に限定
- **緩和策**: 
  - 正常系の処理には影響しない設計
  - エラーケースのみの修正

### パフォーマンスリスク
- **リスクレベル**: 極低
- **内容**: エラー処理の変更によるパフォーマンス影響はほぼなし
- **緩和策**: 不要

## ロールバック計画

### 即座のロールバック手順
```bash
# 修正前の状態に戻す
git revert HEAD

# または特定のコミットに戻す
git reset --hard <commit-hash>

# 本番環境の場合
git cherry-pick <hotfix-commit>
```

### Feature Flag（オプション）
```typescript
// 環境変数による切り替え
const USE_NEW_ERROR_HANDLER = process.env.NEXT_PUBLIC_USE_NEW_ERROR_HANDLER === 'true';

if (USE_NEW_ERROR_HANDLER) {
  // 新しいエラーハンドリング
} else {
  // 既存のエラーハンドリング
}
```

## 影響を受けるドキュメント

1. `docs/06_standards/error-handling.md` - エラーハンドリング規約
2. `frontend/CLAUDE.md` - フロントエンド開発仕様
3. `docs/API_CLIENT_MIGRATION_GUIDE.md` - APIクライアント移行ガイド

## 実装優先順位

1. **緊急**: Phase 1（ホットフィックス）- 即座に実施
2. **高**: Phase 2（根本修正）- 24時間以内
3. **中**: Phase 3（予防措置）- 1週間以内

## 成功基準

1. 401エラーが正しく401として表示される
2. 適切なエラーメッセージが表示される
3. 経費一覧画面でNETWORK_ERROR（500）が表示されない
4. 全テストがパスする
5. リグレッションが発生しない

## 次のステップ

**`/bug-fix` コマンドを実行して修正を実装**

```bash
/bug-fix
```

修正実装時は、この計画書に従って段階的に進めてください。