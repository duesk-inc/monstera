# バグ修正計画書 - 経費一覧表示NETWORK_ERROR

## 概要

### バグの影響度と緊急度
- **影響度**: 高 - 経費一覧画面が表示されない業務停止レベルの障害
- **緊急度**: 高 - 経費申請後に一覧が確認できない
- **影響ユーザー**: 全ユーザー（経費申請機能を使用する全従業員）

### 修正の目的と期待効果
- 経費申請後の一覧表示を正常に動作させる
- データマッピングエラーを解消し、安定した動作を確保
- 同様のエラーの再発防止

### スコープ
- フロントエンド修正のみ（バックエンドは正常動作確認済み）
- 影響ファイル: 
  - `frontend/src/lib/api/expense.ts`
  - `frontend/src/utils/expenseMappers.ts`

## 現状分析

### 根本原因の要約
フロントエンドのデータマッピング処理において、バックエンドからのレスポンス構造とフロントエンドが期待する構造が不一致。具体的には`response.data.data`の構造または存在が期待と異なる。

### 影響範囲の詳細
1. **直接影響**
   - 経費一覧取得API: `getExpenses()`関数
   - 経費一覧取得API: `getExpenseList()`関数
   - データマッパー: `mapBackendExpenseListToExpenseList()`関数

2. **間接影響**
   - 経費一覧画面の表示
   - 経費申請後の画面遷移
   - 経費関連の統計表示

### 現在の回避策
なし（手動でページリロードしても同じエラーが発生）

## 修正計画

### Phase 1: 緊急対応（ホットフィックス）- 所要時間: 60分

#### Step 1.1: エラー再現テストケースの作成（15分）
```typescript
// frontend/src/__tests__/utils/expenseMappers.test.ts
describe('mapBackendExpenseListToExpenseList', () => {
  it('should handle undefined response', () => {
    const result = mapBackendExpenseListToExpenseList(undefined);
    expect(result.items).toEqual([]);
  });
  
  it('should handle null items', () => {
    const result = mapBackendExpenseListToExpenseList({ items: null });
    expect(result.items).toEqual([]);
  });
});
```

#### Step 1.2: 暫定的な修正の実装（30分）

**修正箇所1: frontend/src/lib/api/expense.ts**
```typescript
// Line 195-212の修正
export async function getExpenseList(
  params: ExpenseSearchParams = {},
  signal?: AbortSignal
): Promise<ExpenseListResponse> {
  try {
    DebugLogger.info(
      { category: 'API', operation: 'GetExpenseList' },
      'Getting expense list',
      { params }
    );

    const client = createPresetApiClient('auth');
    const response = await client.get(EXPENSE_API_ENDPOINTS.EXPENSES, { params, signal });
    
    // デバッグログ追加
    DebugLogger.info(
      { category: 'API', operation: 'GetExpenseList' },
      'Raw response received',
      { 
        hasData: !!response.data,
        hasDataData: !!response.data?.data,
        dataStructure: response.data ? Object.keys(response.data) : []
      }
    );
    
    // レスポンス構造の確認と修正
    const responseData = response.data?.data || response.data;
    
    // nullチェック追加
    if (!responseData) {
      DebugLogger.warn(
        { category: 'API', operation: 'GetExpenseList' },
        'Empty response data, returning default'
      );
      return {
        items: [],
        total: 0,
        page: 1,
        limit: params.limit || 20,
        totalPages: 0
      };
    }
    
    const result = mapBackendExpenseListToExpenseList(responseData);
    
    DebugLogger.info(
      { category: 'API', operation: 'GetExpenseList' },
      'Expense list retrieved successfully',
      { count: result.items.length }
    );
    
    return result;
  } catch (error) {
    DebugLogger.error({ category: 'EXPENSE_API', operation: 'GetExpenseList' }, 'Failed to get expense list', error);
    throw handleApiError(error, '経費一覧取得');
  }
}
```

**修正箇所2: frontend/src/utils/expenseMappers.ts**
```typescript
// Line 50-58の修正
export function mapBackendExpenseListToExpenseList(
  backendResponse: ExpenseListBackendResponse | undefined | null
): ExpenseListResponse {
  // 防御的プログラミング：nullチェックとデフォルト値
  if (!backendResponse) {
    console.warn('mapBackendExpenseListToExpenseList: Received null/undefined response');
    return {
      items: [],
      total: 0,
      page: 1,
      limit: 20,
      totalPages: 0,
    };
  }

  // itemsプロパティの存在確認
  if (!backendResponse.items || !Array.isArray(backendResponse.items)) {
    console.warn('mapBackendExpenseListToExpenseList: Invalid items property', backendResponse);
    return {
      items: [],
      total: backendResponse.total || 0,
      page: backendResponse.page || 1,
      limit: backendResponse.limit || 20,
      totalPages: backendResponse.total_pages || 0,
    };
  }

  try {
    return {
      items: backendResponse.items.map(mapBackendExpenseToExpenseData),
      total: backendResponse.total || 0,
      page: backendResponse.page || 1,
      limit: backendResponse.limit || 20,
      totalPages: backendResponse.total_pages || 0,
    };
  } catch (error) {
    console.error('Error mapping expense list:', error);
    return {
      items: [],
      total: 0,
      page: 1,
      limit: 20,
      totalPages: 0,
    };
  }
}
```

#### Step 1.3: 影響範囲の限定的テスト（15分）
```bash
# フロントエンドテスト実行
cd frontend
npm test -- --testPathPattern=expense

# 開発サーバーで動作確認
npm run dev
# ブラウザで経費申請→一覧表示の動作確認
```

### Phase 2: 根本修正 - 所要時間: 75分

#### Step 2.1: 詳細な影響調査（20分）
- `getExpenses()`関数の確認（同じ修正が必要）
- 他のAPIでの同様のパターンを検索
- バックエンドのレスポンス形式の再確認

#### Step 2.2: 修正対象ファイルのバックアップ（5分）
```bash
git add -A
git commit -m "WIP: バグ修正前の状態を保存"
```

#### Step 2.3: コア修正の実装（30分）
- `getExpenses()`関数にも同様の修正を適用
- 共通のレスポンス処理ユーティリティの作成

```typescript
// frontend/src/utils/apiResponseUtils.ts (新規作成)
export function extractDataFromResponse<T>(response: any): T | null {
  // 共通のレスポンスデータ抽出ロジック
  if (response?.data?.data) {
    return response.data.data;
  }
  if (response?.data) {
    return response.data;
  }
  return null;
}
```

#### Step 2.4: 関連箇所の修正（20分）
- `getExpenses()`関数の修正
- 他の経費関連APIの確認と必要に応じた修正

### Phase 3: 予防措置 - 所要時間: 65分

#### Step 3.1: 入力検証の強化（20分）
- TypeScriptの型定義を厳密化
- ランタイム型チェックの追加

#### Step 3.2: エラーメッセージの改善（10分）
- より具体的なエラーメッセージの実装
- デバッグ情報の充実

#### Step 3.3: 同様パターンの検索（15分）
```bash
# 他のマッパー関数を検索
grep -r "mapBackend.*To" frontend/src/utils/
# response.data.dataパターンの使用箇所を検索
grep -r "response\.data\.data" frontend/src/
```

#### Step 3.4: 予防的修正（20分）
- 発見された類似パターンの修正
- 共通ユーティリティの適用

## テスト計画

### Step T1: 単体テスト追加（20分）
- エラーケースのテスト追加
- 正常系のテスト確認
- エッジケースのテスト追加

### Step T2: 統合テスト（15分）
- 経費申請→一覧表示の E2E テスト
- APIモックを使用した統合テスト

### Step T3: リグレッションテスト（10分）
```bash
# 全テストスイートの実行
cd frontend
npm test
npm run type-check
```

## リスク管理

### 技術的リスク
- **リスク**: データ構造の変更による他機能への影響
- **緩和策**: 防御的プログラミングとフォールバック処理

### 影響範囲のリスク
- **リスク**: 経費関連の他の画面への波及
- **緩和策**: 段階的な修正と各段階でのテスト

### ロールバック計画
1. Git でのコミット前状態への復帰
2. 修正前のデプロイ済みバージョンへの切り戻し
3. バックアップからの復元

## 影響を受けるドキュメント
- なし（実装修正のみ）

## 推定作業時間
- **Phase 1（緊急対応）**: 60分
- **Phase 2（根本修正）**: 75分
- **Phase 3（予防措置）**: 65分
- **テスト**: 45分
- **合計**: 約4時間

## 実装優先順位
1. **最優先**: Phase 1.2（暫定修正）- 即座に実装
2. **高**: Phase 2.3（コア修正）
3. **中**: Phase 3（予防措置）
4. **低**: ドキュメント更新

## 成功基準
1. 経費申請後の一覧表示が正常に動作する
2. エラーログが出力されない
3. 既存テストが全てパスする
4. パフォーマンスの劣化がない

## 次のアクション
1. この計画の承認を得る
2. Phase 1 の緊急対応を即座に実施
3. 動作確認後、Phase 2, 3 を順次実施