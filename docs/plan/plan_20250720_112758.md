# ユーザーメニュー表示不具合修正実装計画

## 計画日時
2025-07-20 11:27:58

## 概要
admin@duesk.co.jp でログイン後、ユーザーメニューが正しく表示されない問題を修正する。

## 調査結果サマリー
- **問題1**: ？アイコンの重複表示（HelpIconとUserAvatarの'?'）
- **問題2**: ログイン済みなのに「ログイン」リンクが表示される
- **問題3**: 認証初期化中のローディング状態が未実装

## 実装方針
認証初期化中の不適切なUI表示を防ぐため、ローディング状態を適切に管理する。

## 実装タスク

### 1. SharedLayoutWrapperの修正（高優先度）
**ファイル**: `/frontend/src/components/common/layout/SharedLayoutWrapper.tsx`
**変更内容**:
```typescript
// TopBarにisLoadingを渡す
<TopBar
  onMenuClick={handleDrawerToggle}
  onUserMenuClick={handleUserMenuOpen}
  isMobile={isMobile}
  isAdmin={isAdmin}
  isLoading={isLoading}  // 追加
/>
```

### 2. TopBarの修正（高優先度）
**ファイル**: `/frontend/src/components/ui/TopBar.tsx`
**変更内容**:
1. propsにisLoadingを追加
```typescript
interface TopBarProps {
  onMenuClick: () => void;
  onUserMenuClick: (event: React.MouseEvent<HTMLElement>) => void;
  isMobile: boolean;
  isAdmin?: boolean;
  isLoading?: boolean;  // 追加
}
```

2. HelpIconの条件付き表示
```typescript
{/* ユーザーがログインしている場合のみ表示 */}
{user && !isLoading && (
  <IconButton 
    sx={{ 
      display: { xs: 'none', sm: 'inline-flex' }, 
      color: 'text.secondary',
      mx: 1
    }}
  >
    <HelpIcon fontSize="small" />
  </IconButton>
)}
```

3. UserAvatarにisLoadingを渡す
```typescript
<UserAvatar 
  user={user}
  size="small"
  isLoading={isLoading}  // 追加
  sx={{ 
    cursor: 'pointer',
    bgcolor: user ? 'primary.main' : 'grey.400',
  }}
/>
```

### 3. UserAvatarの修正（中優先度）
**ファイル**: `/frontend/src/components/common/layout/UserAvatar.tsx`
**変更内容**:
1. propsにisLoadingを追加
```typescript
interface UserAvatarProps extends Omit<AvatarProps, 'children'> {
  user: User | null;
  size?: 'small' | 'medium' | 'large';
  isLoading?: boolean;  // 追加
}
```

2. ローディング状態の表示
```typescript
import { CircularProgress } from '@mui/material';

const getInitials = () => {
  if (isLoading) return '';  // ローディング中は空文字
  if (!user) return '?';
  // 既存のロジック...
};

return (
  <Avatar
    sx={{
      ...sizes[size],
      cursor: 'pointer',
      fontWeight: 'bold',
      ...sx
    }}
    {...props}
  >
    {isLoading ? (
      <CircularProgress 
        size={sizes[size].width * 0.5} 
        sx={{ color: 'white' }}
      />
    ) : (
      getInitials()
    )}
  </Avatar>
);
```

## ファイル変更計画

### 修正ファイル
1. `/frontend/src/components/common/layout/SharedLayoutWrapper.tsx`
2. `/frontend/src/components/ui/TopBar.tsx`
3. `/frontend/src/components/common/layout/UserAvatar.tsx`

### 新規作成ファイル
なし

### 削除ファイル
なし

## テスト戦略

### 1. 単体テスト
- **UserAvatar.test.tsx**: 
  - isLoading=trueの場合、CircularProgressが表示されることを確認
  - isLoading=falseの場合、従来通りの表示を確認
- **TopBar.test.tsx**: 
  - isLoading=trueの場合、HelpIconが非表示になることを確認
  - user=nullの場合、HelpIconが非表示になることを確認

### 2. 統合テスト
- SharedLayoutWrapperからTopBarへのisLoadingプロパティの伝達確認
- 認証初期化フローの確認（useAuth → SharedLayoutWrapper → TopBar → UserAvatar）

### 3. E2Eテスト
- ログイン直後の表示確認：
  1. ログイン画面でcredentialsを入力
  2. ログインボタンをクリック
  3. ダッシュボードへ遷移
  4. ユーザーメニューに「？」が1つだけ表示されることを確認
  5. 「ログイン」リンクが表示されないことを確認

- 初回アクセス時の表示確認：
  1. ブラウザのキャッシュをクリア
  2. 認証済みページにアクセス
  3. ローディング中の表示を確認
  4. 認証完了後の正常表示を確認

## リスク分析と対策

### 1. 既存ページへの影響
**リスク**: TopBarを使用している全ページに影響する可能性
**対策**: 
- isLoadingをオプショナルプロパティとして実装
- デフォルト値を設定して後方互換性を確保
- 段階的なリリースとモニタリング

### 2. ローディング表示によるUX低下
**リスク**: 頻繁なローディング表示がユーザー体験を損なう
**対策**: 
- 短時間（100ms以下）のローディングは表示しない
- デバウンス処理の検討
- ローディングアニメーションの最適化

### 3. TypeScriptの型エラー
**リスク**: 新しいプロパティ追加による型エラー
**対策**: 
- オプショナルプロパティとして定義
- 既存のテストを実行して型チェック
- `npm run typecheck`の実行

### 4. 認証フローへの予期しない影響
**リスク**: 認証処理の変更による副作用
**対策**: 
- 既存の認証ロジックは変更しない
- 表示のみの変更に留める
- 全ての認証関連テストを実行

## 実装スケジュール

1. **Phase 1 (即時対応)**: 30分
   - SharedLayoutWrapperの修正
   - TopBarの修正
   - UserAvatarの修正

2. **Phase 2 (テスト)**: 30分
   - 単体テストの作成・実行
   - 統合テストの実行
   - 手動での動作確認

3. **Phase 3 (検証)**: 20分
   - 全ページでの動作確認
   - TypeScriptの型チェック
   - Lintチェック

## 成功基準

1. ？アイコンが1つだけ表示される
2. ログイン済みユーザーに「ログイン」リンクが表示されない
3. 認証初期化中は適切なローディング表示
4. 既存の認証フローに影響がない
5. 全てのテストがパスする

## 次のステップ

実装フェーズ（IMPLEMENT）に移行し、上記タスクを順次実装する。