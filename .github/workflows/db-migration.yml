name: Database Migration Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/migrations/**'
      - '.github/workflows/db-migration.yml'
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/migrations/**'
  workflow_dispatch:

env:
  GO_VERSION: '1.22'
  POSTGRES_VERSION: '15-alpine'

jobs:
  migration-validation:
    name: Migration Validation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install golang-migrate
      run: |
        go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

    - name: Validate migration files
      run: |
        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“‹ Checking migration file naming convention..."
        
        # æ¨™æº–ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯
        if [ -d "backend/migrations" ]; then
          for file in backend/migrations/*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ ! "$filename" =~ ^[0-9]{6}_[a-z_]+\.(up|down)\.sql$ ]]; then
                echo "âš ï¸  Non-standard filename in migrations/: $filename"
              fi
            fi
          done
        fi
        
        # PostgreSQLå°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯
        if [ -d "backend/migrations/postgresql-versions" ]; then
          for file in backend/migrations/postgresql-versions/*.sql; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ ! "$filename" =~ ^[0-9]{6}_[a-z_]+\.(up|down)\.postgresql\.sql$ ]]; then
                echo "âŒ Invalid filename: $filename"
                echo "Expected format: NNNNNN_description.{up|down}.postgresql.sql"
                exit 1
              fi
            fi
          done
        fi
        
        echo "âœ… All migration files follow naming convention"

    - name: Check migration pairs
      run: |
        echo "ğŸ” Checking up/down migration pairs..."
        
        # æ¨™æº–ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if [ -d "backend/migrations" ]; then
          cd backend/migrations
          for up_file in *.up.sql; do
            if [ -f "$up_file" ]; then
              down_file="${up_file/.up.sql/.down.sql}"
              if [ ! -f "$down_file" ]; then
                echo "âŒ Missing down migration for: $up_file"
                exit 1
              fi
            fi
          done
          cd ../..
        fi
        
        # PostgreSQLå°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if [ -d "backend/migrations/postgresql-versions" ]; then
          cd backend/migrations/postgresql-versions
          for up_file in *.up.postgresql.sql; do
            if [ -f "$up_file" ]; then
              down_file="${up_file/.up.postgresql.sql/.down.postgresql.sql}"
              if [ ! -f "$down_file" ]; then
                echo "âŒ Missing down migration for: $up_file"
                exit 1
              fi
            fi
          done
          cd ../../..
        fi
        
        echo "âœ… All migrations have proper up/down pairs"

    - name: Validate SQL syntax
      run: |
        echo "ğŸ” Validating SQL syntax..."
        
        # ç°¡æ˜“çš„ãªSQLã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯
        check_sql_files() {
          local dir=$1
          if [ -d "$dir" ]; then
            for file in "$dir"/*.sql; do
              if [ -f "$file" ]; then
                if grep -E '(DROP\s+DATABASE|TRUNCATE\s+TABLE|DELETE\s+FROM\s+[^W])' "$file" | grep -v WHERE | grep -v "CASCADE" > /dev/null; then
                  echo "âš ï¸  Potentially dangerous operation without WHERE clause in: $file"
                fi
              fi
            done
          fi
        }
        
        check_sql_files "backend/migrations"
        check_sql_files "backend/migrations/postgresql-versions"
        
        echo "âœ… SQL syntax validation completed"

  migration-test:
    name: Migration Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: monstera_test
          POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C.UTF-8"
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d monstera_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install golang-migrate
      run: |
        go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

    - name: Run migrations up
      env:
        DATABASE_URL: "postgres://postgres:postgres@localhost:5432/monstera_test?sslmode=disable"
      run: |
        echo "â¬†ï¸  Running all migrations up..."
        
        # ä½¿ç”¨ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’æ±ºå®š
        if [ -d "backend/migrations/postgresql-versions" ] && [ "$(ls -A backend/migrations/postgresql-versions/*.sql 2>/dev/null)" ]; then
          MIGRATION_PATH="backend/migrations/postgresql-versions"
          echo "Using PostgreSQL-specific migrations from: $MIGRATION_PATH"
        else
          MIGRATION_PATH="backend/migrations"
          echo "Using standard migrations from: $MIGRATION_PATH"
        fi
        
        migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" up
        
        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        CURRENT_VERSION=$(migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" version 2>&1)
        echo "Current migration version: $CURRENT_VERSION"

    - name: Verify database schema
      env:
        PGPASSWORD: postgres
      run: |
        echo "ğŸ“Š Verifying database schema..."
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
        psql -h localhost -U postgres -d monstera_test -c "\dt" > tables.txt
        
        # å¿…é ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
        REQUIRED_TABLES=(
          "users"
          "profiles"
          "clients"
          "projects"
          "invoices"
          "expenses"
          "leave_requests"
          "weekly_reports"
          "daily_records"
        )
        
        for table in "${REQUIRED_TABLES[@]}"; do
          if ! grep -q "$table" tables.txt; then
            echo "âŒ Required table missing: $table"
            exit 1
          fi
        done
        
        echo "âœ… All required tables exist"

    - name: Test migration rollback
      env:
        DATABASE_URL: "postgres://postgres:postgres@localhost:5432/monstera_test?sslmode=disable"
      run: |
        echo "â¬‡ï¸  Testing migration rollback (down 1)..."
        
        # ä½¿ç”¨ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’æ±ºå®š
        if [ -d "backend/migrations/postgresql-versions" ] && [ "$(ls -A backend/migrations/postgresql-versions/*.sql 2>/dev/null)" ]; then
          MIGRATION_PATH="backend/migrations/postgresql-versions"
        else
          MIGRATION_PATH="backend/migrations"
        fi
        
        # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²
        BEFORE_VERSION=$(migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" version 2>&1)
        
        # 1ã¤ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" down 1
        
        # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        AFTER_VERSION=$(migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" version 2>&1)
        
        echo "Before rollback: $BEFORE_VERSION"
        echo "After rollback: $AFTER_VERSION"
        
        # å†åº¦æœ€æ–°ã¾ã§é©ç”¨
        migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" up
        
        echo "âœ… Migration rollback test passed"

    - name: Test idempotency
      env:
        DATABASE_URL: "postgres://postgres:postgres@localhost:5432/monstera_test?sslmode=disable"
      run: |
        echo "ğŸ”„ Testing migration idempotency..."
        
        # ä½¿ç”¨ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’æ±ºå®š
        if [ -d "backend/migrations/postgresql-versions" ] && [ "$(ls -A backend/migrations/postgresql-versions/*.sql 2>/dev/null)" ]; then
          MIGRATION_PATH="backend/migrations/postgresql-versions"
        else
          MIGRATION_PATH="backend/migrations"
        fi
        
        # åŒã˜ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‹ç¢ºèª
        migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" up || true
        
        echo "âœ… Idempotency test passed"

    - name: Schema dump
      env:
        PGPASSWORD: postgres
      run: |
        echo "ğŸ’¾ Dumping schema for review..."
        
        pg_dump -h localhost -U postgres -d monstera_test --schema-only > schema.sql
        
        # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        echo "Schema dumped to schema.sql"

    - name: Upload schema dump
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: schema-dump
        path: schema.sql

  migration-performance:
    name: Migration Performance Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: monstera_perf
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d monstera_perf"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install golang-migrate
      run: |
        go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

    - name: Measure migration performance
      env:
        DATABASE_URL: "postgres://postgres:postgres@localhost:5432/monstera_perf?sslmode=disable"
      run: |
        echo "â±ï¸  Measuring migration performance..."
        
        # ä½¿ç”¨ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’æ±ºå®š
        if [ -d "backend/migrations/postgresql-versions" ] && [ "$(ls -A backend/migrations/postgresql-versions/*.sql 2>/dev/null)" ]; then
          MIGRATION_PATH="backend/migrations/postgresql-versions"
          echo "Using PostgreSQL-specific migrations from: $MIGRATION_PATH"
        else
          MIGRATION_PATH="backend/migrations"
          echo "Using standard migrations from: $MIGRATION_PATH"
        fi
        
        # é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        START_TIME=$(date +%s)
        
        # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        migrate -path "$MIGRATION_PATH" -database "$DATABASE_URL" up
        
        # çµ‚äº†æ™‚åˆ»ã‚’è¨˜éŒ²
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "âœ… All migrations completed in ${DURATION} seconds"
        
        # è­¦å‘Šé–¾å€¤ï¼ˆ60ç§’ï¼‰
        if [ $DURATION -gt 60 ]; then
          echo "âš ï¸  Warning: Migrations took longer than 60 seconds"
        fi

    - name: Check index usage
      env:
        PGPASSWORD: postgres
      run: |
        echo "ğŸ“Š Checking index usage statistics..."
        
        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
        psql -h localhost -U postgres -d monstera_perf << EOF > index_stats.txt
        SELECT 
          schemaname,
          tablename,
          indexname,
          idx_scan,
          idx_tup_read,
          idx_tup_fetch
        FROM pg_stat_user_indexes
        ORDER BY idx_scan DESC;
        EOF
        
        echo "Index statistics saved to index_stats.txt"

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          index_stats.txt

  migration-summary:
    name: Migration Summary
    runs-on: ubuntu-latest
    needs: [migration-validation, migration-test, migration-performance]
    if: always()
    steps:
    - name: Create migration summary
      run: |
        echo "## ğŸ—„ï¸ Database Migration Check Summary" > migration-summary.md
        echo "" >> migration-summary.md
        echo "| Check | Status |" >> migration-summary.md
        echo "|-------|--------|" >> migration-summary.md
        
        # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ç¢ºèª
        if [ "${{ needs.migration-validation.result }}" == "success" ]; then
          echo "| Migration Validation | âœ… Passed |" >> migration-summary.md
        else
          echo "| Migration Validation | âŒ Failed |" >> migration-summary.md
        fi
        
        if [ "${{ needs.migration-test.result }}" == "success" ]; then
          echo "| Migration Test | âœ… Passed |" >> migration-summary.md
        else
          echo "| Migration Test | âŒ Failed |" >> migration-summary.md
        fi
        
        if [ "${{ needs.migration-performance.result }}" == "success" ]; then
          echo "| Performance Test | âœ… Passed |" >> migration-summary.md
        else
          echo "| Performance Test | âŒ Failed |" >> migration-summary.md
        fi
        
        echo "" >> migration-summary.md
        echo "ğŸ“‹ è©³ç´°ãªçµæœã¯Artifactsã‚’ã”ç¢ºèªãã ã•ã„ã€‚" >> migration-summary.md
        
        cat migration-summary.md

    - name: Upload migration summary
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: migration-summary
        path: migration-summary.md