# NEW-FEATURE-PLAN フェーズ

# ユーザの入力
#$ARGUMENTS

## 目的
調査結果を基に、新規機能の詳細設計と実装計画を策定する。

## 注意事項
- **Model: Opus** - アーキテクチャ設計には深い検討が必要なため、必ずultrathinkで考察すること
- Serenaで既存パターンを参照し、プロジェクトの一貫性を保つこと
- 段階的な実装計画を立て、各段階でのリスクを最小化すること

## 必要な入力ファイル
- `docs/investigate/new-feature-investigate_{TIMESTAMP}.md` - 調査結果

## Serena活用ポイント
```bash
# 1. 設計パターンの確認
read_memory("implementation_patterns_*")
read_memory("common_pitfalls_*")

# 2. 既存構造の確認
get_symbols_overview("backend/internal")
get_symbols_overview("frontend/src")

# 3. 影響範囲の特定
find_referencing_symbols("変更予定のシンボル")
```

## タスクに含まれるべきTODO
1. ユーザの指示を理解し、計画開始をコンソールで通知
2. 最新の調査結果ファイルを読み込み
3. **ultrathinkでアーキテクチャ設計を深く検討**
4. Serenaで既存の設計パターンを確認
5. データモデル設計（新規テーブル、カラム追加など）
6. API設計（エンドポイント、リクエスト/レスポンス形式）
7. ビジネスロジック設計（サービス層の構成）
8. UI/UXコンポーネント設計
9. セキュリティ設計（認証・認可、入力検証）
10. テスト計画（単体、統合、E2E）
11. 実装タスクの分解と優先順位付け
12. マイグレーション計画（必要な場合）
13. ロールバック計画
14. 計画を `docs/plan/new-feature-plan_{TIMESTAMP}.md` に保存
15. 新しい設計パターンをSerenaメモリに記録
16. `afplay /System/Library/Sounds/Sosumi.aiff` で完了通知
17. 計画ファイル名をコンソール出力

## 設計ドキュメント構成
1. **概要**
   - 機能の目的と価値
   - ユーザーストーリー
2. **アーキテクチャ設計**
   - システム構成図
   - データフロー
3. **詳細設計**
   - データモデル
   - API仕様
   - ビジネスロジック
   - UI/UX設計
4. **実装計画（細分化されたステップ）**
   
   **Phase 1: データベース層の実装**
   - Step 1.1: マイグレーションファイル作成（15分）
     - テーブル定義の作成
     - インデックスの設定
     - 単体でマイグレーション実行確認
   - Step 1.2: モデル定義（10分）
     - GORMモデルの作成
     - バリデーションルール追加
     - コンパイル確認
   - Step 1.3: シードデータ作成（10分）
     - テスト用データ作成
     - 開発環境で投入確認
   
   **Phase 2: リポジトリ層の実装**
   - Step 2.1: リポジトリインターフェース定義（10分）
     - CRUD操作の定義
     - カスタムクエリの定義
   - Step 2.2: リポジトリ実装（各20分）
     - Create機能実装と単体テスト
     - Read機能実装と単体テスト
     - Update機能実装と単体テスト
     - Delete機能実装と単体テスト
   - Step 2.3: モックリポジトリ作成（15分）
     - テスト用モック実装
     - インターフェース準拠確認
   
   **Phase 3: サービス層の実装**
   - Step 3.1: DTOの定義（10分）
     - リクエストDTO作成
     - レスポンスDTO作成
     - バリデーションルール追加
   - Step 3.2: サービスインターフェース定義（10分）
     - ビジネスロジックの定義
   - Step 3.3: コアビジネスロジック実装（各25分）
     - 作成処理と単体テスト
     - 取得処理と単体テスト
     - 更新処理と単体テスト
     - 削除処理と単体テスト
   - Step 3.4: 複雑なビジネスルール（各15分）
     - 権限チェック実装
     - 状態遷移ロジック
     - 通知処理（必要な場合）
   
   **Phase 4: API層の実装**
   - Step 4.1: ハンドラー作成（各15分）
     - POSTエンドポイント実装
     - GETエンドポイント実装
     - PUT/PATCHエンドポイント実装
     - DELETEエンドポイント実装
   - Step 4.2: ミドルウェア適用（10分）
     - 認証ミドルウェア設定
     - バリデーションミドルウェア
   - Step 4.3: ルート登録（5分）
     - ルーティング設定
     - 動作確認（curl/Postman）
   - Step 4.4: エラーハンドリング（15分）
     - エラーレスポンス統一
     - ログ出力設定
   
   **Phase 5: フロントエンド実装**
   - Step 5.1: APIクライアント作成（15分）
     - API関数の実装
     - 型定義の追加
     - エラーハンドリング
   - Step 5.2: 状態管理（20分）
     - Redux/Zustandストア設定
     - アクション定義
     - セレクター作成
   - Step 5.3: UIコンポーネント作成（各20分）
     - 一覧表示コンポーネント
     - 詳細表示コンポーネント
     - 作成/編集フォーム
     - 削除確認ダイアログ
   - Step 5.4: 各コンポーネントの単体テスト（各10分）
     - 表示テスト
     - インタラクションテスト
   - Step 5.5: ページ統合（15分）
     - ルーティング設定
     - レイアウト適用
     - ナビゲーション追加
   
   **Phase 6: 統合とテスト**
   - Step 6.1: APIとフロントエンド接続（15分）
     - エンドツーエンド動作確認
     - エラーケースの確認
   - Step 6.2: 統合テスト作成（20分）
     - APIテストケース作成
     - E2Eテストケース作成
   - Step 6.3: パフォーマンステスト（15分）
     - 負荷テスト実施
     - レスポンスタイム測定
   - Step 6.4: セキュリティチェック（10分）
     - 権限テスト
     - 入力検証テスト
   
   **Phase 7: デプロイ準備**
   - Step 7.1: 環境変数設定（10分）
     - 本番環境設定追加
     - シークレット設定
   - Step 7.2: ドキュメント作成（15分）
     - API仕様書更新
     - 運用手順書作成
   - Step 7.3: リリースノート作成（10分）
     - 機能説明
     - 既知の制限事項
   
5. **リスク管理**
   - 技術的リスク
   - 対策案

## 出力ファイル
- `docs/plan/new-feature-plan_{TIMESTAMP}.md`

## 最終出力形式
### 計画策定完了の場合
status: SUCCESS
next: NEW-FEATURE-IMPLEMENT
details: "新規機能の実装計画策定完了。new-feature-plan_{TIMESTAMP}.mdに詳細記録。実装フェーズへ移行。"

### 設計見直しが必要な場合
status: NEED_REDESIGN
next: NEW-FEATURE-INVESTIGATE
details: "設計課題発見。new-feature-plan_{TIMESTAMP}.mdに詳細記録。再調査が必要。"

### 段階的実装が必要な場合
status: PHASED_IMPLEMENTATION
next: NEW-FEATURE-IMPLEMENT
details: "段階的実装計画策定。new-feature-plan_{TIMESTAMP}.mdに詳細記録。Phase 1から実装開始。"