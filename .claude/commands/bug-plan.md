# BUG-PLAN フェーズ

# ユーザの入力
#$ARGUMENTS

## 目的
調査結果に基づき、安全で効果的なバグ修正計画を策定する。影響範囲を明確にし、段階的な修正アプローチを設計する。

## 注意事項
- **Model: Opus** - バグ修正設計には必ず**ultrathink**で深く検討すること
- 段階的な修正計画を立て、各段階でテスト可能にすること
- 既存機能への影響を最小限に抑えること
- 緊急度に応じた優先順位付けを行うこと

## 必要な入力ファイル
- `docs/investigate/bug-investigate_{TIMESTAMP}.md` - 調査結果

## Serena活用ポイント
```bash
# 1. 既存パターンの確認
read_memory("common_pitfalls_*")
read_memory("*_pattern")

# 2. 影響範囲の詳細確認
find_referencing_symbols("修正対象", depth=2)

# 3. テスト状況の確認
search_for_pattern("test.*修正対象")
```

## タスクに含まれるべきTODO
1. ユーザの指示を理解し、計画開始をコンソールで通知
2. 最新の調査結果を読み込み
3. **ultrathinkでバグ修正戦略を深く検討**
4. 修正目標の明確化
   - バグの完全な解消
   - パフォーマンスへの影響最小化
   - 後方互換性の維持
5. 修正方針の決定
   - 修正アプローチ（パッチ修正 vs 根本修正）
   - 適用する修正パターン
   - エラーハンドリングの改善
6. 段階的修正計画
   - 緊急修正（ホットフィックス）
   - 根本修正（必要な場合）
   - 予防措置（同様のバグ防止）
7. テスト戦略
   - バグ再現テストの追加
   - 既存テストへの影響確認
   - リグレッションテスト計画
8. リスク評価
   - 修正による副作用のリスク
   - デグレーションのリスク
   - パフォーマンスへの影響
9. ロールバック計画
10. 影響を受けるドキュメントのリスト
11. 計画を `docs/plan/bug-plan_{TIMESTAMP}.md` に保存
12. 修正パターンをSerenaメモリに記録
13. `afplay /System/Library/Sounds/Sosumi.aiff` で完了通知
14. 計画ファイル名をコンソール出力

## バグ修正計画の構成
1. **概要**
   - バグの影響度と緊急度
   - 修正の目的と期待効果
   - スコープ
2. **現状分析**
   - 根本原因の要約
   - 影響範囲の詳細
   - 現在の回避策（あれば）
3. **修正計画（細分化された実装ステップ）**
   
   **Phase 1: 緊急対応（ホットフィックス）**
   - Step 1.1: エラー再現テストケースの作成（15分）
     - 最小限の再現コードを作成
     - 単体で実行・確認可能
   - Step 1.2: 暫定的な修正の実装（30分）
     - エラーハンドリングの追加
     - 単体テストで動作確認
   - Step 1.3: 影響範囲の限定的テスト（15分）
     - 修正箇所の直接的な動作確認
     - 既存テストの実行
   
   **Phase 2: 根本修正**
   - Step 2.1: 詳細な影響調査（20分）
     - `find_referencing_symbols()`で全参照箇所をリスト化
     - 各参照箇所の使用パターンを確認
   - Step 2.2: 修正対象ファイルのバックアップ（5分）
     - 現在の状態をgitでコミット
   - Step 2.3: コア修正の実装（30分）
     - 根本原因の修正
     - 単体での動作確認
   - Step 2.4: 関連箇所の修正（各10分）
     - 参照箇所1つずつ個別に修正
     - 各修正後に動作確認
   
   **Phase 3: 予防措置**
   - Step 3.1: 入力検証の強化（20分）
     - バリデーション追加
     - 単体テストで確認
   - Step 3.2: エラーメッセージの改善（10分）
     - ユーザーフレンドリーなメッセージ
     - ログ出力の確認
   - Step 3.3: 同様パターンの検索（15分）
     - `search_for_pattern()`で類似コード検索
     - 発見箇所のリスト化
   - Step 3.4: 予防的修正（各箇所10分）
     - 1箇所ずつ修正
     - 個別に動作確認
   
4. **テスト計画（段階的実行）**
   - Step T1: 単体テスト追加（20分）
     - バグ再現テスト
     - 修正確認テスト
   - Step T2: 統合テスト（15分）
     - 関連機能のテスト
     - エンドツーエンドシナリオ
   - Step T3: リグレッションテスト（10分）
     - 既存テストスイートの実行
     - 失敗テストの個別対応
   
5. **リスク管理**
   - 技術的リスク
   - 影響範囲のリスク
   - 緩和策

## 出力ファイル
- `docs/plan/bug-plan_{TIMESTAMP}.md`

## 最終出力形式
### 計画策定完了の場合
status: SUCCESS
next: BUG-FIX
details: "バグ修正計画策定完了。bug-plan_{TIMESTAMP}.mdに詳細記録。修正フェーズへ移行。"

### 緊急修正が必要な場合
status: URGENT_FIX
next: BUG-FIX
details: "緊急修正が必要。bug-plan_{TIMESTAMP}.mdに詳細記録。即座に修正フェーズへ移行。"

### より深い分析が必要な場合
status: NEED_ANALYSIS
next: ROOT-CAUSE-ANALYSIS
details: "追加分析が必要。bug-plan_{TIMESTAMP}.mdに初期計画記録。詳細分析へ移行。"