# エラーハンドラーステータスコード修正計画パターン

## 作成日
2025-08-21

## 問題パターン
エラーハンドラーが元のHTTPステータスコードを保持せず、固定値（500など）を返してしまう

## 修正パターン

### Phase 1: 緊急対応
1. **エラー再現テストの作成**（15分）
   - 各HTTPステータスコードのテストケース作成
   - 特に401, 403, 404, 500を重点的に

2. **暫定修正の実装**（30分）
   ```typescript
   // その他のエラー処理を改善
   const statusCode = error.response?.status || 0;
   const errorCode = statusCode > 0 ? getErrorCodeFromStatus(statusCode) : ApiErrorCode.UNKNOWN_ERROR;
   
   return createErrorResponse(
     errorCode,
     error.message || '予期しないエラーが発生しました。',
     statusCode,  // 元のステータスコードを保持
     { originalError: error }
   );
   ```

3. **影響範囲テスト**（15分）
   - 単体テスト実行
   - 手動での動作確認

### Phase 2: 根本修正
1. **影響調査**（20分）
   - エラーハンドラー使用箇所の特定
   - 参照箇所の確認

2. **完全な修正実装**（30分）
   - 全エラーケースで元のステータスコード保持
   - 認証エラーの特別処理

3. **関連箇所の修正**（各10分）
   - 影響を受けるファイルの個別修正

### Phase 3: 予防措置
1. **検証強化**（20分）
   - 型チェックの強化
   - ステータスコード妥当性検証

2. **メッセージ改善**（10分）
   - ユーザーフレンドリーなメッセージ

3. **類似問題の検索と修正**（25分）
   - 固定ステータスコードの検索
   - 発見箇所の修正

## テスト戦略
1. **単体テスト**
   - 各HTTPステータスコードの処理確認
   - エッジケースのテスト

2. **統合テスト**
   - API呼び出しからエラー表示まで
   - 認証フローのテスト

3. **リグレッションテスト**
   - 既存機能への影響確認

## リスク管理
- **技術的リスク**: 中（多数の使用箇所）
- **緩和策**: 段階的修正、十分なテスト
- **ロールバック**: git revertで即座に復元可能

## 成功基準
1. 元のHTTPステータスコードが正しく保持される
2. 適切なエラーメッセージが表示される
3. 全テストがパスする
4. リグレッションなし

## 教訓
- エラーハンドラーでは常に元のステータスコードを保持する
- デフォルトケースで固定値を返さない
- 十分なテストケースで各ステータスコードの処理を確認